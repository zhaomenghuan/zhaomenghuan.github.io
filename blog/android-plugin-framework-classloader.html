<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Android 插件化原理学习 —— 基于 ClassLoader 的插件加载机制 | 匠心博客</title>
    <meta name="description" content="小青年,匠心,小青年博客,匠心博客,前端开发,android,技术宅,菜鸟教程,一个神奇的博客。">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.685c010a.css" as="style"><link rel="preload" href="/assets/js/app.f3e141ba.js" as="script"><link rel="preload" href="/assets/js/12.9aca40f8.js" as="script"><link rel="preload" href="/assets/js/18.c373a36e.js" as="script"><link rel="preload" href="/assets/js/34.124c31c0.js" as="script"><link rel="prefetch" href="/assets/js/1.1950ec81.js"><link rel="prefetch" href="/assets/js/10.7f857e71.js"><link rel="prefetch" href="/assets/js/100.e03c01d2.js"><link rel="prefetch" href="/assets/js/101.7b790a2f.js"><link rel="prefetch" href="/assets/js/102.a7aa77f9.js"><link rel="prefetch" href="/assets/js/103.d473991c.js"><link rel="prefetch" href="/assets/js/104.9fe8785c.js"><link rel="prefetch" href="/assets/js/105.7291ae49.js"><link rel="prefetch" href="/assets/js/106.2c35a2f4.js"><link rel="prefetch" href="/assets/js/107.a71ccb64.js"><link rel="prefetch" href="/assets/js/108.9d6f54a8.js"><link rel="prefetch" href="/assets/js/109.e77d12ca.js"><link rel="prefetch" href="/assets/js/11.5378ae65.js"><link rel="prefetch" href="/assets/js/13.ce2b655c.js"><link rel="prefetch" href="/assets/js/14.7488ca24.js"><link rel="prefetch" href="/assets/js/15.9c07ac98.js"><link rel="prefetch" href="/assets/js/16.8f57294c.js"><link rel="prefetch" href="/assets/js/17.4f7ae4ec.js"><link rel="prefetch" href="/assets/js/19.c7be2474.js"><link rel="prefetch" href="/assets/js/2.7f7e5268.js"><link rel="prefetch" href="/assets/js/20.f8833113.js"><link rel="prefetch" href="/assets/js/21.e71dd521.js"><link rel="prefetch" href="/assets/js/22.92dc7b77.js"><link rel="prefetch" href="/assets/js/23.285557d3.js"><link rel="prefetch" href="/assets/js/24.a803551c.js"><link rel="prefetch" href="/assets/js/25.dbeaa19d.js"><link rel="prefetch" href="/assets/js/26.9ca97076.js"><link rel="prefetch" href="/assets/js/27.d1a2911b.js"><link rel="prefetch" href="/assets/js/28.25c216b3.js"><link rel="prefetch" href="/assets/js/29.9dc30af4.js"><link rel="prefetch" href="/assets/js/30.1e9d6e06.js"><link rel="prefetch" href="/assets/js/31.3d7dbe62.js"><link rel="prefetch" href="/assets/js/32.36371ba7.js"><link rel="prefetch" href="/assets/js/33.78edc66d.js"><link rel="prefetch" href="/assets/js/35.a5470008.js"><link rel="prefetch" href="/assets/js/36.acde7543.js"><link rel="prefetch" href="/assets/js/37.f6648812.js"><link rel="prefetch" href="/assets/js/38.1885784f.js"><link rel="prefetch" href="/assets/js/39.af4b4bbd.js"><link rel="prefetch" href="/assets/js/4.61024115.js"><link rel="prefetch" href="/assets/js/40.ec6e88a9.js"><link rel="prefetch" href="/assets/js/41.67d4e8b7.js"><link rel="prefetch" href="/assets/js/42.7de428af.js"><link rel="prefetch" href="/assets/js/43.b4f51fa8.js"><link rel="prefetch" href="/assets/js/44.487d119d.js"><link rel="prefetch" href="/assets/js/45.2206665b.js"><link rel="prefetch" href="/assets/js/46.125163cc.js"><link rel="prefetch" href="/assets/js/47.8722f507.js"><link rel="prefetch" href="/assets/js/48.b8bfe77f.js"><link rel="prefetch" href="/assets/js/49.77fac897.js"><link rel="prefetch" href="/assets/js/5.3395f0b5.js"><link rel="prefetch" href="/assets/js/50.d68289a2.js"><link rel="prefetch" href="/assets/js/51.d9d70556.js"><link rel="prefetch" href="/assets/js/52.6a2c9e02.js"><link rel="prefetch" href="/assets/js/53.ff13cf8b.js"><link rel="prefetch" href="/assets/js/54.7e844902.js"><link rel="prefetch" href="/assets/js/55.80aa3d86.js"><link rel="prefetch" href="/assets/js/56.a4124774.js"><link rel="prefetch" href="/assets/js/57.55eb7355.js"><link rel="prefetch" href="/assets/js/58.7d0e2bc5.js"><link rel="prefetch" href="/assets/js/59.9cdd695c.js"><link rel="prefetch" href="/assets/js/6.77e8533c.js"><link rel="prefetch" href="/assets/js/60.54318be9.js"><link rel="prefetch" href="/assets/js/61.82e1ea82.js"><link rel="prefetch" href="/assets/js/62.b065e499.js"><link rel="prefetch" href="/assets/js/63.bb770dde.js"><link rel="prefetch" href="/assets/js/64.996fdbfd.js"><link rel="prefetch" href="/assets/js/65.54f3baf3.js"><link rel="prefetch" href="/assets/js/66.38d28ab3.js"><link rel="prefetch" href="/assets/js/67.5cf5a3bc.js"><link rel="prefetch" href="/assets/js/68.f2418476.js"><link rel="prefetch" href="/assets/js/69.162d06c4.js"><link rel="prefetch" href="/assets/js/7.a2cd9d6c.js"><link rel="prefetch" href="/assets/js/70.80f1252b.js"><link rel="prefetch" href="/assets/js/71.970dda3c.js"><link rel="prefetch" href="/assets/js/72.a073c997.js"><link rel="prefetch" href="/assets/js/73.674106d1.js"><link rel="prefetch" href="/assets/js/74.a0336873.js"><link rel="prefetch" href="/assets/js/75.37fbb329.js"><link rel="prefetch" href="/assets/js/76.a9439343.js"><link rel="prefetch" href="/assets/js/77.d52439f1.js"><link rel="prefetch" href="/assets/js/78.fbffcd6c.js"><link rel="prefetch" href="/assets/js/79.c6d73001.js"><link rel="prefetch" href="/assets/js/8.f0af9f9c.js"><link rel="prefetch" href="/assets/js/80.eab87966.js"><link rel="prefetch" href="/assets/js/81.9931436f.js"><link rel="prefetch" href="/assets/js/82.b29080c9.js"><link rel="prefetch" href="/assets/js/83.d94ed517.js"><link rel="prefetch" href="/assets/js/84.600be30f.js"><link rel="prefetch" href="/assets/js/85.a6938cc3.js"><link rel="prefetch" href="/assets/js/86.7dec6ed4.js"><link rel="prefetch" href="/assets/js/87.5d2c1dc9.js"><link rel="prefetch" href="/assets/js/88.8f2410d4.js"><link rel="prefetch" href="/assets/js/89.fe8c04e8.js"><link rel="prefetch" href="/assets/js/9.f542ab97.js"><link rel="prefetch" href="/assets/js/90.f25166a8.js"><link rel="prefetch" href="/assets/js/91.038ee701.js"><link rel="prefetch" href="/assets/js/92.19e610e0.js"><link rel="prefetch" href="/assets/js/93.22cd83c8.js"><link rel="prefetch" href="/assets/js/94.7495cfa6.js"><link rel="prefetch" href="/assets/js/95.f149c41d.js"><link rel="prefetch" href="/assets/js/96.cee91e1f.js"><link rel="prefetch" href="/assets/js/97.27a1bb57.js"><link rel="prefetch" href="/assets/js/98.67d4f125.js"><link rel="prefetch" href="/assets/js/99.35daa60c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.685c010a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">匠心博客</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/index.html" class="nav-link">博文</a></div><div class="nav-item"><a href="/book/index.html" class="nav-link">专栏</a></div><div class="nav-item"><a href="/note/index.html" class="nav-link">笔记</a></div><div class="nav-item"><a href="/nav/index.html" class="nav-link">导航</a></div><div class="nav-item"><a href="/about/index.html" class="nav-link">关于</a></div> <a href="https://github.com/zhaomenghuan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/index.html" class="nav-link">博文</a></div><div class="nav-item"><a href="/book/index.html" class="nav-link">专栏</a></div><div class="nav-item"><a href="/note/index.html" class="nav-link">笔记</a></div><div class="nav-item"><a href="/nav/index.html" class="nav-link">导航</a></div><div class="nav-item"><a href="/about/index.html" class="nav-link">关于</a></div> <a href="https://github.com/zhaomenghuan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>Android 插件化原理学习 —— 基于 ClassLoader 的插件加载机制</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/android-plugin-framework-classloader.html#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/android-plugin-framework-classloader.html#虚拟机基础" class="sidebar-link">虚拟机基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/android-plugin-framework-classloader.html#dalvik-虚拟机" class="sidebar-link">Dalvik 虚拟机</a></li><li class="sidebar-sub-header"><a href="/blog/android-plugin-framework-classloader.html#dalvik-与-art" class="sidebar-link">Dalvik 与 ART</a></li></ul></li><li><a href="/blog/android-plugin-framework-classloader.html#android-编译工具" class="sidebar-link">Android 编译工具</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/android-plugin-framework-classloader.html#dex2jar" class="sidebar-link">dex2jar</a></li><li class="sidebar-sub-header"><a href="/blog/android-plugin-framework-classloader.html#jd-gui" class="sidebar-link">jd-gui</a></li><li class="sidebar-sub-header"><a href="/blog/android-plugin-framework-classloader.html#apktool" class="sidebar-link">apktool</a></li><li class="sidebar-sub-header"><a href="/blog/android-plugin-framework-classloader.html#classyshark" class="sidebar-link">ClassyShark</a></li></ul></li><li><a href="/blog/android-plugin-framework-classloader.html#classloader-基础" class="sidebar-link">ClassLoader 基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/android-plugin-framework-classloader.html#classloader-家族" class="sidebar-link">ClassLoader 家族</a></li><li class="sidebar-sub-header"><a href="/blog/android-plugin-framework-classloader.html#dexclassloader-实例" class="sidebar-link">DexClassLoader 实例</a></li></ul></li><li><a href="/blog/android-plugin-framework-classloader.html#hook-apk-加载" class="sidebar-link">Hook APK 加载</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/android-plugin-framework-classloader.html#重新认识-activitythread" class="sidebar-link">重新认识 ActivityThread</a></li><li class="sidebar-sub-header"><a href="/blog/android-plugin-framework-classloader.html#创建插件的-loadedapk-对象" class="sidebar-link">创建插件的 LoadedApk 对象</a></li><li class="sidebar-sub-header"><a href="/blog/android-plugin-framework-classloader.html#还原插件中的-activity" class="sidebar-link">还原插件中的 Activity</a></li></ul></li><li><a href="/blog/android-plugin-framework-classloader.html#参考" class="sidebar-link">参考</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="android-插件化原理学习-——-基于-classloader-的插件加载机制">Android 插件化原理学习 —— 基于 ClassLoader 的插件加载机制</h1> <h2 id="前言">前言</h2> <p>前面<a href="https://zhaomenghuan.github.io/blog/android-plugin-framework-proxy-hook.html" target="_blank" rel="noopener noreferrer">《Android 插件化原理学习 —— Hook 机制之动态代理》<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>一文中我们探索了一下动态代理 hook 实现了 <strong>启动没有在 AndroidManifest.xml 中显式声明的 Activity</strong> 的功能。我们加载的是应用内部的一个 Activity，但是通常 Android 插件化及沙箱机制都是加载外部的文件，这时我们还需要其他的机制保证插件加载，大部分插件化框架都是基于 ClassLoader 实现对插件的加载。在学习 ClassLoader 之前我们最好对一些基本的概念有些认识。</p> <h2 id="虚拟机基础">虚拟机基础</h2> <h3 id="dalvik-虚拟机">Dalvik 虚拟机</h3> <p>Java 虚拟机，简称 JVM (Java Virtual Machine)。JVM 字节码由 .class 文件组成，每个文件一个 class，JVM 在运行的时候为每一个类装载字节码。</p> <p>Dalvik 虚拟机，简称 DVM (Dalvik Virtual Machine）。Dalvik 虚拟机运行的程序只包含一个.dex 文件，这个文件包含了程序中所有的类。Java 编译器创建了 JVM 字节码之后，Dalvik 的 dx 编译器删除 .class 文件，重新把它们编译成 Dalvik 字节码，然后把它们写进一个.dex 文件中。</p> <p>大多数虚拟机包括 JVM 都是一种<a href="https://zh.wikipedia.org/wiki/%E5%A0%86%E6%A0%88%E7%BB%93%E6%9E%84%E6%9C%BA%E5%99%A8" target="_blank" rel="noopener noreferrer">堆栈机器<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，而 Dalvik 虚拟机则是<a href="https://zh.wikipedia.org/wiki/%E5%AF%84%E5%AD%98%E5%99%A8%E6%9C%BA" target="_blank" rel="noopener noreferrer">寄存器机<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。两种架构各有优劣，一般而言，基于堆栈的机器需要更多指令，而基于寄存器的机器指令更长。</p> <p><img src="/assets/img/jvm-dvm.3afc0f04.png" alt></p> <p>Dalvik 虚拟机的功能：</p> <ul><li>Dalvik 主要是完成对象生命周期管理，堆栈管理，线程管理，安全和异常管理，以及垃圾回收等等重要功能。</li> <li>Dalvik 负责进程隔离和线程管理，每一个 Android 应用在底层都会对应一个独立的 Dalvik 虚拟机实例，其代码在虚拟机的解释下得以执行。</li> <li>不同于 Java 虚拟机运行 java 字节码，Dalvik 虚拟机运行的是其专有的文件格式 dex。</li> <li>dex 文件格式可以减少整体文件尺寸，提高 I/O 操作的类查找速度。</li> <li>odex 是为了在运行过程中进一步提高性能，对 dex 文件的进一步优化。</li> <li>所有的 Android 应用的线程都对应一个 Linux 线程，虚拟机因而可以更多的依赖操作系统的线程调度和管理机制。</li> <li>有一个特殊的虚拟机进程 Zygote，他是虚拟机实例的孵化器。它在系统启动的时候就会产生，它会完成虚拟机的初始化、库的加载、预制类库和初始化的操作。如果系统需要一个新的虚拟机实例，它会迅速复制自身，以最快的速度提供给系统。对于一些只读的系统库，所有虚拟机实例都和 Zygote 共享一块内存区域。</li></ul> <h3 id="dalvik-与-art">Dalvik 与 ART</h3> <p>从 Android 5.0 版起，Android Runtime（ART）替换 Dalvik 成为系统内默认虚拟机。（这不代表你的手机用的 6.0 系统，使用的就是 ART 虚拟机，国产 Android 系统中很多升级为 6.0 系统的任然使用的是 Dalvik）。</p> <p>Android Runtime（缩写为 ART），是一种在 Android 操作系统上的运行环境，由 Google 公司研发，并在 2013 年作为 Android 4.4 系统中的一项测试功能正式对外发布，在 Android 5.0 及后续 Android 版本中作为正式的运行时库取代了以往的 Dalvik 虚拟机。ART 能够把应用程序的字节码转换为机器码，是 Android 所使用的一种新的虚拟机。它与 Dalvik 的主要不同在于：Dalvik 采用的是 JIT 技术，而 ART 采用 Ahead-of-time（AOT）技术。ART 同时也改善了性能、垃圾回收（Garbage Collection）、应用程序除错以及性能分析。</p> <ul><li>JIT：Dalvik 虚拟机运行 App 的机制，运行期实时翻译（Just In Time）。</li> <li>AOT：ART 虚拟机对 App 运行的优化机制，它在应用安装时就提前（Ahead-Of-Time）做好了字节码到机器码的翻译工作。</li></ul> <p><img src="/assets/img/android-dvm.345e8e34.png" alt></p> <p>获取手机的虚拟机类型：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">CharSequence</span> <span class="token function">getCurrentRuntimeValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> <span class="token constant">SELECT_RUNTIME_PROPERTY</span> <span class="token operator">=</span> <span class="token string">&quot;persist.sys.dalvik.vm.lib&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> <span class="token constant">LIB_DALVIK</span> <span class="token operator">=</span> <span class="token string">&quot;libdvm.so&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> <span class="token constant">LIB_ART</span> <span class="token operator">=</span> <span class="token string">&quot;libart.so&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> <span class="token constant">LIB_ART_D</span> <span class="token operator">=</span> <span class="token string">&quot;libartd.so&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> systemProperties <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;android.os.SystemProperties&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Method</span> get <span class="token operator">=</span> systemProperties<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span>
                    <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>get <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token string">&quot;未获取到&quot;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token class-name">String</span> value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> get<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>
                        systemProperties<span class="token punctuation">,</span> <span class="token constant">SELECT_RUNTIME_PROPERTY</span><span class="token punctuation">,</span>
                    <span class="token comment">/* Assuming default is */</span><span class="token string">&quot;Dalvik&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">LIB_DALVIK</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token string">&quot;Dalvik&quot;</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">LIB_ART</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token string">&quot;ART&quot;</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">LIB_ART_D</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token string">&quot;ART debug build&quot;</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">return</span> value<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token string">&quot;IllegalAccessException&quot;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token string">&quot;IllegalArgumentException&quot;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token string">&quot;InvocationTargetException&quot;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">&quot;SystemProperties.get(String key, String def) method is not found&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;SystemProperties class is not found&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="android-编译工具">Android 编译工具</h2> <p>我们从上面可以知道 Android Dalvik/ART 虚拟机，不是 JVM，也不能直接加载 jar 文件，而是加载 dex 文件，那么我们如何获取能够加载的 dex 文件呢？</p> <p>我们可以使用 Android SDK 的 dx 工具把 jar 文件优化成 dex 文件。dx 工具在 Android SDK build-tools 中可以找到，然后执行下面的方法即可：</p> <div class="language-java extra-class"><pre class="language-java"><code># 配置环境变量
export <span class="token constant">PATH</span><span class="token operator">=</span>$<span class="token constant">PATH</span><span class="token operator">:</span><span class="token operator">/</span><span class="token class-name">Users</span><span class="token operator">/</span>zhaomenghuan<span class="token operator">/</span><span class="token class-name">Library</span><span class="token operator">/</span><span class="token class-name">Android</span><span class="token operator">/</span>sdk<span class="token operator">/</span>build<span class="token operator">-</span>tools<span class="token operator">/</span><span class="token number">26.0</span><span class="token number">.2</span>
dx <span class="token operator">--</span>dex <span class="token operator">--</span>output<span class="token operator">=</span>plugin<span class="token punctuation">.</span>dex plugin<span class="token punctuation">.</span>jar
</code></pre></div><p>俗话说&quot;工欲善其事，必先利其器&quot;，如果我们需要对 Android 编译时或者运行时理解更深刻，少不了会学习编译相关的技术，这里我们介绍一下相关常用的工具。</p> <h3 id="dex2jar">dex2jar</h3> <p>开源地址：<a href="https://github.com/pxb1988/dex2jar" target="_blank" rel="noopener noreferrer">https://github.com/pxb1988/dex2jar<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>dex2jar 包含以下组件：</p> <ul><li>dex-reader/writer：旨在读/写 Dalvik 可执行文件（.dex / .odex），它具有与 ASM 类似的轻量级 API；</li> <li>d2j-dex2jar：转换 .dex 文件到 .class 文件（压缩为 jar）；</li> <li>d2j-smali/baksmali：将 dex 分解为 smali 文件，并从 smali 文件中组装 dex;</li></ul> <p>例如上述 dx 工具将 jar 转成 dex 也可以使用 dex2jar 实现：</p> <p>添加可执行权限：</p> <div class="language- extra-class"><pre class="language-text"><code>chmod a+x d2j_invoke.sh
chmod a+x d2j-dex2jar.sh
chmod a+x d2j-jar2dex.sh
</code></pre></div><p>dex 转 jar：</p> <div class="language- extra-class"><pre class="language-text"><code>./d2j-dex2jar.sh classes.dex
</code></pre></div><p>jar 转 dex：</p> <div class="language- extra-class"><pre class="language-text"><code>./d2j-jar2dex.sh plugin.jar
</code></pre></div><h3 id="jd-gui">jd-gui</h3> <p>开源地址：<a href="https://github.com/java-decompiler/jd-gui" target="_blank" rel="noopener noreferrer">https://github.com/java-decompiler/jd-gui<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><img src="/assets/img/jd-gui.801bd684.png" alt></p> <h3 id="apktool">apktool</h3> <p>开源地址：<a href="https://ibotpeaches.github.io/Apktool/" target="_blank" rel="noopener noreferrer">https://ibotpeaches.github.io/Apktool/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>我们可以通过 dex2jar + jd-gui 进行 jar/dex 的反编译，那么对于资源我们如何去处理呢？</p> <p>我们可以使用 apktool 反编译资源：</p> <div class="language- extra-class"><pre class="language-text"><code>apktool d xxx.apk
</code></pre></div><p>修改后重新打包命令：</p> <div class="language- extra-class"><pre class="language-text"><code>apktool b xxx -o Newxxx.apk
</code></pre></div><h3 id="classyshark">ClassyShark</h3> <p>开源地址：<a href="https://github.com/google/android-classyshark" target="_blank" rel="noopener noreferrer">https://github.com/google/android-classyshark<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><img src="/assets/img/classyshark.87cfc8de.png" alt></p> <h2 id="classloader-基础">ClassLoader 基础</h2> <p>我们知道，Java 源文件（.java）经过编译器编译之后，会转换成 Java 字节码（.class），然后最终被 Java 虚拟机（JVM）执行，然而程序是如何加载这些字节码文件到内存中呢？这就用到了 ClassLoader，即类加载器。ClassLoader 类加载器负责读取 Java 字节代码，并转换成 java.lang.Class 类的一个实例。从而只有 class 文件被载入到了内存之后，才能被其程序所引用。所以 ClassLoader 就是用来动态加载 class 文件到内存当中用的。</p> <p>传统 Java 时代的插件化：</p> <p><img src="/assets/img/JavaPlugin.9a2f14c3.png" alt></p> <p>从服务端下载一个 jar，然后构造一个对应路径的 ClassLoader，在直接调用 main 方法，或者反射其他入口方法即可。 Jar 直接运行在 JVM 上，直接和 JVM 交互。</p> <h3 id="classloader-家族">ClassLoader 家族</h3> <p>Android 中的常用几种类加载器类型继承关系划分可以用一组关系图来表示：</p> <p><img src="data:image/png;base64,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" alt></p> <ul><li>DexClassLoader：可以加载文件系统上的 jar、dex、apk</li> <li>PathClassLoader：只能加载已安装的 apk 的 dex</li></ul> <h4 id="dexclassloader-简介">DexClassLoader 简介</h4> <p>DexClassLoader 是一个可以从包含 classes.dex 实体的.jar 或.apk 文件中加载 classes 的类加载器，可以用于实现 dex 的动态加载、代码热更新等等。Android 里面 dex 字节码运行在 Dalvik 虚拟机上。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">DexClassLoader</span><span class="token punctuation">(</span><span class="token class-name">String</span> dexPath<span class="token punctuation">,</span> <span class="token class-name">String</span> optimizedDirectory<span class="token punctuation">,</span> <span class="token class-name">String</span> librarySearchPath<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> parent<span class="token punctuation">)</span>
</code></pre></div><p>参数详解：</p> <ul><li>dexPath：dex 文件路径列表，多个路径使用”:”分隔</li> <li>optimizedDirectory：经过优化的 dex 文件（odex）文件输出目录</li> <li>librarySearchPath：动态库路径（将被添加到 app 动态库搜索路径列表中）</li> <li>parent：这是一个 ClassLoader，这个参数的主要作用是保留 java 中 ClassLoader 的委托机制（优先父类加载器加载 classes，由上而下的加载机制，防止重复加载类字节码）</li></ul> <h4 id="pathclassloader-简介">PathClassLoader 简介</h4> <p>PathClassLoader 提供一个简单的 ClassLoader 实现，可以操作在本地文件系统的文件列表或目录中的 classes，但不可以从网络中加载 classes。PathClassLoader 提供两个常用构造方法:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">PathClassLoader</span><span class="token punctuation">(</span><span class="token class-name">String</span> dexPath<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> parent<span class="token punctuation">)</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">PathClassLoader</span><span class="token punctuation">(</span><span class="token class-name">String</span> dexPath<span class="token punctuation">,</span> <span class="token class-name">String</span> librarySearchPath<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> parent<span class="token punctuation">)</span>
</code></pre></div><p>参数详解：</p> <ul><li>dexPath：文件或者目录的列表</li> <li>librarySearchPath：包含 lib 库的目录列表</li> <li>parent：父类加载器</li></ul> <h4 id="dexclassloader-与-pathclassloader-的区别">DexClassLoader 与 PathClassLoader 的区别</h4> <p>PathClassLoader 与 DexClassLoader 这两个类的构造函数的第 2 个参数 optimizedDirectory 的值不一样，PathClassLoader 里面 optimizedDirectory 参数值为 null。</p> <p>DexClassLoader 可以指定自己的 optimizedDirectory，可以将 dex 复制到内部路径的 optimizedDirectory，所以它可以加载外部的 dex。</p> <h3 id="dexclassloader-实例">DexClassLoader 实例</h3> <h4 id="定义一个插件">定义一个插件</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>com<span class="token punctuation">.</span>agree<span class="token punctuation">.</span>plugin</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">Context</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>widget<span class="token punctuation">.</span></span><span class="token class-name">Toast</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ToastUtil</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Toast</span><span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string">&quot;我是一个插件&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Toast</span><span class="token punctuation">.</span><span class="token constant">LENGTH_SHORT</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过 gradle 脚本编译生成 Jar 文件：</p> <div class="language-java extra-class"><pre class="language-java"><code>task <span class="token function">makeJar</span><span class="token punctuation">(</span>type<span class="token operator">:</span> <span class="token class-name">Jar</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    from <span class="token function">zipTree</span><span class="token punctuation">(</span><span class="token function">file</span><span class="token punctuation">(</span>'build<span class="token operator">/</span>intermediates<span class="token operator">/</span>bundles<span class="token operator">/</span>release<span class="token operator">/</span>classes<span class="token punctuation">.</span>jar'<span class="token punctuation">)</span><span class="token punctuation">)</span>
    from <span class="token function">fileTree</span><span class="token punctuation">(</span>dir<span class="token operator">:</span> 'src<span class="token operator">/</span>main'<span class="token punctuation">,</span> includes<span class="token operator">:</span> <span class="token punctuation">[</span>'assets<span class="token comment">/**'])
    baseName = &quot;plugin&quot;
    destinationDir = file(rootProject.ext.releaseDirsPath)
    exclude('android/', 'BuildConfig.class', 'R.class')
    exclude {
        it.name.startsWith('R$');
    }
}

makeJar.dependsOn(build)
</span></code></pre></div><h4 id="dexclassloader-加载插件反射调用">DexClassLoader 加载插件反射调用</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// dex压缩文件的路径（可以是 apk,jar,zip 格式）</span>
<span class="token class-name">String</span> dexPath <span class="token operator">=</span> <span class="token class-name">Environment</span><span class="token punctuation">.</span><span class="token function">getExternalStorageDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">File</span><span class="token punctuation">.</span>separator <span class="token operator">+</span> <span class="token string">&quot;plugin.dex&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// dex解压释放后的目录</span>
<span class="token class-name">File</span> dexOutputDirFile <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getDir</span><span class="token punctuation">(</span><span class="token string">&quot;dex&quot;</span><span class="token punctuation">,</span> <span class="token constant">MODE_PRIVATE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 定义DexClassLoader</span>
<span class="token comment">// 第一个参数：是dex压缩文件的路径</span>
<span class="token comment">// 第二个参数：是dex解压缩后存放的目录</span>
<span class="token comment">// 第三个参数：是C/C++依赖的本地库文件目录,可以为null</span>
<span class="token comment">// 第四个参数：是上一级的类加载器</span>
<span class="token class-name">DexClassLoader</span> dexClassLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DexClassLoader</span><span class="token punctuation">(</span>dexPath<span class="token punctuation">,</span> dexOutputDirFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用DexClassLoader加载类</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clz <span class="token operator">=</span> dexClassLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">&quot;cn.com.agree.plugin.ToastUtil&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> instance  <span class="token operator">=</span> clz<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Method</span> showToast <span class="token operator">=</span> clz<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">&quot;show&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    showToast<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里也可以使用接口的方式去调用，插件里面通过 ToastUtil 实现 IToast 中的方法，然后在 host App 中使用接口调用。</p> <h2 id="hook-apk-加载">Hook APK 加载</h2> <h3 id="重新认识-activitythread">重新认识 ActivityThread</h3> <p>在之前的文章中简单介绍了 Activity 启动过程，但是我们没有深入去探讨 APK 是怎么被启动的，在 Java / iOS Objective-C 中我们一般都是 main 方法开始执行的，但是很奇怪 Android 中我们并没有看到 main 方法，是不是 Android 中没有 main 方法呢？如果没有 main 方法，那么 Android 应用是从哪里启动的呢？</p> <p>带着这个问题我们重新看看 ActivityThread 类，这个类在 Android 源码中，默认无法直接从 Android Studio 点进去阅读，我们可以在线阅读或者对本地的 Android SDK 或者 Android Studio 做些手脚（如替换为 Android.jar 去除@hide 注解的版本：<a href="https://github.com/anggrayudi/android-hidden-api" target="_blank" rel="noopener noreferrer">https://github.com/anggrayudi/android-hidden-api<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>），这里我使用在线地址：<a href="http://androidxref.com/" target="_blank" rel="noopener noreferrer">http://androidxref.com/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 查看 Android 源码。</p> <p>ActivityThread 的 main 函数如下：</p> <p>xref: <a href="http://androidxref.com/8.1.0_r33/xref/frameworks/base/core/java/android/app/ActivityThread.java#main" target="_blank" rel="noopener noreferrer">/frameworks/base/core/java/android/app/ActivityThread.java#main<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token number">6459</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">6460</span>        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">,</span> <span class="token string">&quot;ActivityThreadMain&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6461</span>
<span class="token number">6462</span>        <span class="token comment">// CloseGuard defaults to true and can be quite spammy.  We</span>
<span class="token number">6463</span>        <span class="token comment">// disable it here, but selectively enable it later (via</span>
<span class="token number">6464</span>        <span class="token comment">// StrictMode) on debug builds, but using DropBox, not logs.</span>
<span class="token number">6465</span>        <span class="token class-name">CloseGuard</span><span class="token punctuation">.</span><span class="token function">setEnabled</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6466</span>
<span class="token number">6467</span>        <span class="token class-name">Environment</span><span class="token punctuation">.</span><span class="token function">initForCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6468</span>
<span class="token number">6469</span>        <span class="token comment">// Set the reporter for event logging in libcore</span>
<span class="token number">6470</span>        <span class="token class-name">EventLogger</span><span class="token punctuation">.</span><span class="token function">setReporter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EventLoggingReporter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6471</span>
<span class="token number">6472</span>        <span class="token comment">// Make sure TrustedCertificateStore looks in the right place for CA certificates</span>
<span class="token number">6473</span>        <span class="token keyword">final</span> <span class="token class-name">File</span> configDir <span class="token operator">=</span> <span class="token class-name">Environment</span><span class="token punctuation">.</span><span class="token function">getUserConfigDirectory</span><span class="token punctuation">(</span><span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">myUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6474</span>        <span class="token class-name">TrustedCertificateStore</span><span class="token punctuation">.</span><span class="token function">setDefaultUserDirectory</span><span class="token punctuation">(</span>configDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6475</span>
<span class="token number">6476</span>        <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token function">setArgV0</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;pre-initialized&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6477</span>
<span class="token number">6478</span>        <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">prepareMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6479</span>
<span class="token number">6480</span>        <span class="token class-name">ActivityThread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6481</span>        thread<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6482</span>
<span class="token number">6483</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>sMainThreadHandler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">6484</span>            sMainThreadHandler <span class="token operator">=</span> thread<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6485</span>        <span class="token punctuation">}</span>
<span class="token number">6486</span>
<span class="token number">6487</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">6488</span>            <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMessageLogging</span><span class="token punctuation">(</span><span class="token keyword">new</span>
<span class="token number">6489</span>                    <span class="token class-name">LogPrinter</span><span class="token punctuation">(</span><span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token constant">DEBUG</span><span class="token punctuation">,</span> <span class="token string">&quot;ActivityThread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6490</span>        <span class="token punctuation">}</span>
<span class="token number">6491</span>
<span class="token number">6492</span>        <span class="token comment">// End of event ActivityThreadMain.</span>
<span class="token number">6493</span>        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6494</span>        <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6495</span>
<span class="token number">6496</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Main thread loop unexpectedly exited&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6497</span>    <span class="token punctuation">}</span>
</code></pre></div><p>在其中有两句话可以证明 handler 在 UI 线程之所以不需要初始化 looper 的原因：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">prepareMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在 main 函数中主要进行的是初始化的操作，初始化过程包括 looper，运行环境，logger 等一系列东西，在其中有个重要的方法 thread.attach(false)：</p> <p>xref: <a href="http://androidxref.com/8.1.0_r33/xref/frameworks/base/core/java/android/app/ActivityThread.java#attach" target="_blank" rel="noopener noreferrer">/frameworks/base/core/java/android/app/ActivityThread.java#attach<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token number">6478</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">attach</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> system<span class="token punctuation">,</span> <span class="token keyword">long</span> startSeq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">6479</span>        sCurrentActivityThread <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token number">6480</span>        mSystemThread <span class="token operator">=</span> system<span class="token punctuation">;</span>
<span class="token number">6481</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>system<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">6482</span>            <span class="token class-name">ViewRootImpl</span><span class="token punctuation">.</span><span class="token function">addFirstDrawHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">6483</span>                <span class="token annotation punctuation">@Override</span>
<span class="token number">6484</span>                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 检查jit是否能用</span>
<span class="token number">6485</span>                    <span class="token function">ensureJitEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6486</span>                <span class="token punctuation">}</span>
<span class="token number">6487</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6488</span>            <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>ddm<span class="token punctuation">.</span></span>DdmHandleAppName</span><span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;pre-initialized&gt;&quot;</span><span class="token punctuation">,</span>
<span class="token number">6489</span>                                                    <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">myUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6490</span>            <span class="token class-name">RuntimeInit</span><span class="token punctuation">.</span><span class="token function">setApplicationObject</span><span class="token punctuation">(</span>mAppThread<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 获得IActivityManager的一个实例，IActivityManager其实算是一个binder对象，负责跟底层沟通</span>
<span class="token number">6491</span>            <span class="token keyword">final</span> <span class="token class-name">IActivityManager</span> mgr <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6492</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 关联到 ApllicationThread类</span>
<span class="token number">6493</span>                mgr<span class="token punctuation">.</span><span class="token function">attachApplication</span><span class="token punctuation">(</span>mAppThread<span class="token punctuation">,</span> startSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6494</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">6495</span>                <span class="token keyword">throw</span> ex<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6496</span>            <span class="token punctuation">}</span>
<span class="token number">6497</span>            <span class="token comment">// 添加GC监察者</span>
<span class="token number">6498</span>            <span class="token class-name">BinderInternal</span><span class="token punctuation">.</span><span class="token function">addGcWatcher</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">6499</span>                <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">6500</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mSomeActivitiesChanged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">6501</span>                        <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token number">6502</span>                    <span class="token punctuation">}</span>
<span class="token number">6503</span>                    <span class="token class-name">Runtime</span> runtime <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6504</span>                    <span class="token keyword">long</span> dalvikMax <span class="token operator">=</span> runtime<span class="token punctuation">.</span><span class="token function">maxMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6505</span>                    <span class="token keyword">long</span> dalvikUsed <span class="token operator">=</span> runtime<span class="token punctuation">.</span><span class="token function">totalMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> runtime<span class="token punctuation">.</span><span class="token function">freeMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6506</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>dalvikUsed <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">*</span>dalvikMax<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">6507</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_MEMORY_TRIM</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Dalvik max=&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>dalvikMax<span class="token operator">/</span><span class="token number">1024</span><span class="token punctuation">)</span>
<span class="token number">6508</span>                                <span class="token operator">+</span> <span class="token string">&quot; total=&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>runtime<span class="token punctuation">.</span><span class="token function">totalMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1024</span><span class="token punctuation">)</span>
<span class="token number">6509</span>                                <span class="token operator">+</span> <span class="token string">&quot; used=&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>dalvikUsed<span class="token operator">/</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6510</span>                        mSomeActivitiesChanged <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token number">6511</span>                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token number">6512</span>                            mgr<span class="token punctuation">.</span><span class="token function">releaseSomeActivities</span><span class="token punctuation">(</span>mAppThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6513</span>                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">6514</span>                            <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6515</span>                        <span class="token punctuation">}</span>
<span class="token number">6516</span>                    <span class="token punctuation">}</span>
<span class="token number">6517</span>                <span class="token punctuation">}</span>
<span class="token number">6518</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6519</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">6520</span>            <span class="token comment">// Don't set application object here -- if the system crashes,</span>
<span class="token number">6521</span>            <span class="token comment">// we can't display an alert, we just want to die die die.</span>
<span class="token number">6522</span>            <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>ddm<span class="token punctuation">.</span></span>DdmHandleAppName</span><span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">&quot;system_process&quot;</span><span class="token punctuation">,</span>
<span class="token number">6523</span>                    <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">myUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6524</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token number">6525</span>                mInstrumentation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Instrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6526</span>                mInstrumentation<span class="token punctuation">.</span><span class="token function">basicInit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6527</span>                <span class="token class-name">ContextImpl</span> context <span class="token operator">=</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">.</span><span class="token function">createAppContext</span><span class="token punctuation">(</span>
<span class="token number">6528</span>                        <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">getSystemContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mPackageInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6529</span>                mInitialApplication <span class="token operator">=</span> context<span class="token punctuation">.</span>mPackageInfo<span class="token punctuation">.</span><span class="token function">makeApplication</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6530</span>                mInitialApplication<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6531</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">6532</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
<span class="token number">6533</span>                        <span class="token string">&quot;Unable to instantiate Application():&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6534</span>            <span class="token punctuation">}</span>
<span class="token number">6535</span>        <span class="token punctuation">}</span>
<span class="token number">6536</span>
<span class="token number">6537</span>        <span class="token comment">// add dropbox logging to libcore</span>
<span class="token number">6538</span>        <span class="token class-name">DropBox</span><span class="token punctuation">.</span><span class="token function">setReporter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DropBoxReporter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6539</span>
<span class="token number">6540</span>        <span class="token class-name">ViewRootImpl<span class="token punctuation">.</span>ConfigChangedCallback</span> configChangedCallback
<span class="token number">6541</span>                <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Configuration</span> globalConfig<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
<span class="token number">6542</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mResourcesManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">6543</span>                <span class="token comment">// We need to apply this change to the resources immediately, because upon returning</span>
<span class="token number">6544</span>                <span class="token comment">// the view hierarchy will be informed about it.</span>
<span class="token number">6545</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>mResourcesManager<span class="token punctuation">.</span><span class="token function">applyConfigurationToResourcesLocked</span><span class="token punctuation">(</span>globalConfig<span class="token punctuation">,</span>
<span class="token number">6546</span>                        <span class="token keyword">null</span> <span class="token comment">/* compat */</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">6547</span>                    <span class="token function">updateLocaleListFromAppContext</span><span class="token punctuation">(</span>mInitialApplication<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token number">6548</span>                            mResourcesManager<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLocales</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6549</span>
<span class="token number">6550</span>                    <span class="token comment">// This actually changed the resources! Tell everyone about it.</span>
<span class="token number">6551</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingConfiguration <span class="token operator">==</span> <span class="token keyword">null</span>
<span class="token number">6552</span>                            <span class="token operator">||</span> mPendingConfiguration<span class="token punctuation">.</span><span class="token function">isOtherSeqNewer</span><span class="token punctuation">(</span>globalConfig<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">6553</span>                        mPendingConfiguration <span class="token operator">=</span> globalConfig<span class="token punctuation">;</span>
<span class="token number">6554</span>                        <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">H</span><span class="token punctuation">.</span><span class="token constant">CONFIGURATION_CHANGED</span><span class="token punctuation">,</span> globalConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6555</span>                    <span class="token punctuation">}</span>
<span class="token number">6556</span>                <span class="token punctuation">}</span>
<span class="token number">6557</span>            <span class="token punctuation">}</span>
<span class="token number">6558</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token number">6559</span>        <span class="token class-name">ViewRootImpl</span><span class="token punctuation">.</span><span class="token function">addConfigCallback</span><span class="token punctuation">(</span>configChangedCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6560</span>    <span class="token punctuation">}</span>
</code></pre></div><p>我们可以继续一步步去找 ActivityThread#main 在哪里被调用了，我们可以一直找到 Zygote 的初始化环节，这里我们暂不做深入探究。</p> <p>点击 Launcher 中应用图标将会执行以下的流程：</p> <p><img src="/assets/img/launch-app.8a0cbbdf.png" alt></p> <p>在 <a href="http://localhost:8080/blog/android-plugin-framework-proxy-hook.html#%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86" target="_blank" rel="noopener noreferrer">Android 插件化原理学习 —— Hook 机制之动态代理#动态代理<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中，我们通过 Hook Activity 类的 mInstrumentation 属性，重写了 execStartActivity 方法，从而实现 Activity 的 &quot;移花接木&quot;，经过 AMS 验证后，启动 Activity 会调用 ActivityThread 的 scheduleLaunchActivity 方法， 最终实际调用的是 <code>mH.sendMessage(msg);</code>，我们 Hook ActivityThread 类的 mH 属性，重写了的 handleMessage 方法，从而实现 Activity 还原。</p> <p>xref: <a href="http://androidxref.com/8.1.0_r33/xref/frameworks/base/core/java/android/app/ActivityThread.java#handleMessage" target="_blank" rel="noopener noreferrer">/frameworks/base/core/java/android/app/ActivityThread.java#handleMessage<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token number">1580</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1581</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_MESSAGES</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;&gt;&gt;&gt; handling: &quot;</span> <span class="token operator">+</span> <span class="token function">codeToString</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1582</span>            <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1583</span>                <span class="token keyword">case</span> <span class="token constant">LAUNCH_ACTIVITY</span><span class="token operator">:</span> <span class="token punctuation">{</span>
<span class="token number">1584</span>                    <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">,</span> <span class="token string">&quot;activityStart&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1585</span>                    <span class="token keyword">final</span> <span class="token class-name">ActivityClientRecord</span> r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ActivityClientRecord</span><span class="token punctuation">)</span> msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
<span class="token number">1586</span>
<span class="token number">1587</span>                    r<span class="token punctuation">.</span>packageInfo <span class="token operator">=</span> <span class="token function">getPackageInfoNoCheck</span><span class="token punctuation">(</span>
<span class="token number">1588</span>                            r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span> r<span class="token punctuation">.</span>compatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1589</span>                    <span class="token function">handleLaunchActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;LAUNCH_ACTIVITY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1590</span>                    <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1591</span>                <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre></div><p>我们之前在这里改了 r 对象的 intent 属性，将我们需要真正的 Activity 恢复回来了，但是我们没有探究这里的 r.packageInfo 和 handleLaunchActivity 方法。</p> <p>我们首先看看 ActivityClientRecord 对象：</p> <p>xref: <a href="http://androidxref.com/8.1.0_r33/xref/frameworks/base/core/java/android/app/ActivityThread.java#ActivityClientRecord" target="_blank" rel="noopener noreferrer">/frameworks/base/core/java/android/app/ActivityThread.java#ActivityClientRecord<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token number">340</span>    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ActivityClientRecord</span> <span class="token punctuation">{</span>
<span class="token number">341</span>        <span class="token class-name">IBinder</span> token<span class="token punctuation">;</span>
<span class="token number">342</span>        <span class="token keyword">int</span> ident<span class="token punctuation">;</span>
<span class="token number">343</span>        <span class="token class-name">Intent</span> intent<span class="token punctuation">;</span>
<span class="token number">344</span>        <span class="token class-name">String</span> referrer<span class="token punctuation">;</span>
<span class="token number">345</span>        <span class="token class-name">IVoiceInteractor</span> voiceInteractor<span class="token punctuation">;</span>
<span class="token number">346</span>        <span class="token class-name">Bundle</span> state<span class="token punctuation">;</span>
<span class="token number">347</span>        <span class="token class-name">PersistableBundle</span> persistentState<span class="token punctuation">;</span>
<span class="token number">348</span>        <span class="token class-name">Activity</span> activity<span class="token punctuation">;</span>
<span class="token number">349</span>        <span class="token class-name">Window</span> window<span class="token punctuation">;</span>
<span class="token number">350</span>        <span class="token class-name">Activity</span> parent<span class="token punctuation">;</span>
<span class="token number">351</span>        <span class="token class-name">String</span> embeddedID<span class="token punctuation">;</span>
<span class="token number">352</span>        <span class="token class-name">Activity<span class="token punctuation">.</span>NonConfigurationInstances</span> lastNonConfigurationInstances<span class="token punctuation">;</span>
<span class="token number">353</span>        <span class="token keyword">boolean</span> paused<span class="token punctuation">;</span>
<span class="token number">354</span>        <span class="token keyword">boolean</span> stopped<span class="token punctuation">;</span>
<span class="token number">355</span>        <span class="token keyword">boolean</span> hideForNow<span class="token punctuation">;</span>
<span class="token number">356</span>        <span class="token class-name">Configuration</span> newConfig<span class="token punctuation">;</span>
<span class="token number">357</span>        <span class="token class-name">Configuration</span> createdConfig<span class="token punctuation">;</span>
<span class="token number">358</span>        <span class="token class-name">Configuration</span> overrideConfig<span class="token punctuation">;</span>
<span class="token number">359</span>        <span class="token comment">// Used for consolidating configs before sending on to Activity.</span>
<span class="token number">360</span>        <span class="token keyword">private</span> <span class="token class-name">Configuration</span> tmpConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">361</span>        <span class="token comment">// Callback used for updating activity override config.</span>
<span class="token number">362</span>        <span class="token class-name">ViewRootImpl<span class="token punctuation">.</span>ActivityConfigCallback</span> configCallback<span class="token punctuation">;</span>
<span class="token number">363</span>        <span class="token class-name">ActivityClientRecord</span> nextIdle<span class="token punctuation">;</span>
<span class="token number">364</span>
<span class="token number">365</span>        <span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">;</span>
<span class="token number">366</span>
<span class="token number">367</span>        <span class="token class-name">ActivityInfo</span> activityInfo<span class="token punctuation">;</span>
<span class="token number">368</span>        <span class="token class-name">CompatibilityInfo</span> compatInfo<span class="token punctuation">;</span>
<span class="token number">369</span>        <span class="token class-name">LoadedApk</span> packageInfo<span class="token punctuation">;</span>
<span class="token number">370</span>
<span class="token number">371</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResultInfo</span><span class="token punctuation">&gt;</span></span> pendingResults<span class="token punctuation">;</span>
<span class="token number">372</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReferrerIntent</span><span class="token punctuation">&gt;</span></span> pendingIntents<span class="token punctuation">;</span>
<span class="token number">373</span>
<span class="token number">374</span>        <span class="token keyword">boolean</span> startsNotResumed<span class="token punctuation">;</span>
<span class="token number">375</span>        <span class="token keyword">boolean</span> isForward<span class="token punctuation">;</span>
<span class="token number">376</span>        <span class="token keyword">int</span> pendingConfigChanges<span class="token punctuation">;</span>
<span class="token number">377</span>        <span class="token keyword">boolean</span> onlyLocalRequest<span class="token punctuation">;</span>
<span class="token number">378</span>
<span class="token number">379</span>        <span class="token class-name">Window</span> mPendingRemoveWindow<span class="token punctuation">;</span>
<span class="token number">380</span>        <span class="token class-name">WindowManager</span> mPendingRemoveWindowManager<span class="token punctuation">;</span>
<span class="token number">381</span>        <span class="token keyword">boolean</span> mPreserveWindow<span class="token punctuation">;</span>
<span class="token number">382</span>
<span class="token number">383</span>        <span class="token comment">// Set for relaunch requests, indicates the order number of the relaunch operation, so it</span>
<span class="token number">384</span>        <span class="token comment">// can be compared with other lifecycle operations.</span>
<span class="token number">385</span>        <span class="token keyword">int</span> relaunchSeq <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">386</span>
<span class="token number">387</span>        <span class="token comment">// Can only be accessed from the UI thread. This represents the latest processed message</span>
<span class="token number">388</span>        <span class="token comment">// that is related to lifecycle events/</span>
<span class="token number">389</span>        <span class="token keyword">int</span> lastProcessedSeq <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">390</span>
<span class="token number">391</span>        <span class="token class-name">ActivityClientRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">392</span>            parent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token number">393</span>            embeddedID <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token number">394</span>            paused <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token number">395</span>            stopped <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token number">396</span>            hideForNow <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token number">397</span>            nextIdle <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token number">398</span>            configCallback <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Configuration</span> overrideConfig<span class="token punctuation">,</span> <span class="token keyword">int</span> newDisplayId<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
<span class="token number">399</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>activity <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">400</span>                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
<span class="token number">401</span>                            <span class="token string">&quot;Received config update for non-existing activity&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">402</span>                <span class="token punctuation">}</span>
<span class="token number">403</span>                activity<span class="token punctuation">.</span>mMainThread<span class="token punctuation">.</span><span class="token function">handleActivityConfigurationChanged</span><span class="token punctuation">(</span>
<span class="token number">404</span>                        <span class="token keyword">new</span> <span class="token class-name">ActivityConfigChangeData</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> overrideConfig<span class="token punctuation">)</span><span class="token punctuation">,</span> newDisplayId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">405</span>            <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token number">406</span>        <span class="token punctuation">}</span>
<span class="token number">407</span>
<span class="token number">408</span>        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isPreHoneycomb</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">409</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>activity <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">410</span>                <span class="token keyword">return</span> activity<span class="token punctuation">.</span><span class="token function">getApplicationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>targetSdkVersion
<span class="token number">411</span>                        <span class="token operator">&lt;</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Build</span><span class="token punctuation">.</span><span class="token constant">VERSION_CODES</span><span class="token punctuation">.</span><span class="token constant">HONEYCOMB</span><span class="token punctuation">;</span>
<span class="token number">412</span>            <span class="token punctuation">}</span>
<span class="token number">413</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token number">414</span>        <span class="token punctuation">}</span>
<span class="token number">415</span>
<span class="token number">416</span>        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isPersistable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">417</span>            <span class="token keyword">return</span> activityInfo<span class="token punctuation">.</span>persistableMode <span class="token operator">==</span> <span class="token class-name">ActivityInfo</span><span class="token punctuation">.</span><span class="token constant">PERSIST_ACROSS_REBOOTS</span><span class="token punctuation">;</span>
<span class="token number">418</span>        <span class="token punctuation">}</span>
<span class="token number">419</span>
<span class="token number">420</span>        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">421</span>            <span class="token comment">// ...</span>
<span class="token number">427</span>        <span class="token punctuation">}</span>
<span class="token number">428</span>
<span class="token number">429</span>        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getStateString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">430</span>             <span class="token comment">// ...</span>
<span class="token number">453</span>        <span class="token punctuation">}</span>
<span class="token number">454</span>    <span class="token punctuation">}</span>
</code></pre></div><p>ActivityClientRecord 用来记录一系列关于 activity 的相关变量的信息，并将 ActivityClientRecord 对象通过 handler 发送，通过 handleLaunchActivity 处理启动 Activity。handleLaunchActivity 里面调用了 performLaunchActivity 方法：</p> <p>xref: <a href="http://androidxref.com/8.1.0_r33/xref/frameworks/base/core/java/android/app/ActivityThread.java#performLaunchActivity" target="_blank" rel="noopener noreferrer">/frameworks/base/core/java/android/app/ActivityThread.java#performLaunchActivity<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token number">2644</span>    <span class="token keyword">private</span> <span class="token class-name">Activity</span> <span class="token function">performLaunchActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityClientRecord</span> r<span class="token punctuation">,</span> <span class="token class-name">Intent</span> customIntent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">2647</span>        <span class="token class-name">ActivityInfo</span> aInfo <span class="token operator">=</span> r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">;</span>
<span class="token number">2648</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>packageInfo <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">2649</span>            r<span class="token punctuation">.</span>packageInfo <span class="token operator">=</span> <span class="token function">getPackageInfo</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span> r<span class="token punctuation">.</span>compatInfo<span class="token punctuation">,</span>
<span class="token number">2650</span>                    <span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">CONTEXT_INCLUDE_CODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2651</span>        <span class="token punctuation">}</span>
<span class="token number">2652</span>
<span class="token number">2653</span>        <span class="token class-name">ComponentName</span> component <span class="token operator">=</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2654</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>component <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">2655</span>            component <span class="token operator">=</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">resolveActivity</span><span class="token punctuation">(</span>
<span class="token number">2656</span>                mInitialApplication<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2657</span>            r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2658</span>        <span class="token punctuation">}</span>
<span class="token number">2659</span>
<span class="token number">2660</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>targetActivity <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">2661</span>            component <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
<span class="token number">2662</span>                    r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>targetActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2663</span>        <span class="token punctuation">}</span>
<span class="token number">2664</span>
<span class="token number">2665</span>        <span class="token class-name">ContextImpl</span> appContext <span class="token operator">=</span> <span class="token function">createBaseContextForActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2666</span>        <span class="token class-name">Activity</span> activity <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token number">2667</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 创建Activity</span>
<span class="token number">2668</span>            <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ClassLoader</span> cl <span class="token operator">=</span> appContext<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2669</span>            activity <span class="token operator">=</span> mInstrumentation<span class="token punctuation">.</span><span class="token function">newActivity</span><span class="token punctuation">(</span>
<span class="token number">2670</span>                    cl<span class="token punctuation">,</span> component<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2671</span>            <span class="token class-name">StrictMode</span><span class="token punctuation">.</span><span class="token function">incrementExpectedActivityCount</span><span class="token punctuation">(</span>activity<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2672</span>            r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2673</span>            r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">prepareToEnterProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2674</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>state <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">2675</span>                r<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">setClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2676</span>            <span class="token punctuation">}</span>
<span class="token number">2677</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">2678</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mInstrumentation<span class="token punctuation">.</span><span class="token function">onException</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">2679</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
<span class="token number">2680</span>                    <span class="token string">&quot;Unable to instantiate activity &quot;</span> <span class="token operator">+</span> component
<span class="token number">2681</span>                    <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2682</span>            <span class="token punctuation">}</span>
<span class="token number">2683</span>        <span class="token punctuation">}</span>
            <span class="token comment">// ...</span>
<span class="token number">2783</span>
<span class="token number">2784</span>        <span class="token keyword">return</span> activity<span class="token punctuation">;</span>
<span class="token number">2785</span>    <span class="token punctuation">}</span>
</code></pre></div><p>这里可以很明显地看到，系统通过待启动的 Activity 的类名 className，然后使用 ClassLoader 对象 cl 把这个类加载进虚拟机，最后使用反射创建了这个 Activity 类的实例对象。要想干预这个 ClassLoader（告知它我们的路径或者替换他），我们首先得看看这玩意到底是从哪里创建的。</p> <p>这里比较关键的是 ActivityClientRecord 里面的 packageInfo 属性，最终都是通过 getPackageInfo 调用。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token number">2071</span>    <span class="token keyword">private</span> <span class="token class-name">LoadedApk</span> <span class="token function">getPackageInfo</span><span class="token punctuation">(</span><span class="token class-name">ApplicationInfo</span> aInfo<span class="token punctuation">,</span> <span class="token class-name">CompatibilityInfo</span> compatInfo<span class="token punctuation">,</span>
<span class="token number">2072</span>            <span class="token class-name">ClassLoader</span> baseLoader<span class="token punctuation">,</span> <span class="token keyword">boolean</span> securityViolation<span class="token punctuation">,</span> <span class="token keyword">boolean</span> includeCode<span class="token punctuation">,</span>
<span class="token number">2073</span>            <span class="token keyword">boolean</span> registerPackage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 获取 userId 信息</span>
<span class="token number">2074</span>        <span class="token keyword">final</span> <span class="token keyword">boolean</span> differentUser <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">myUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2075</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mResourcesManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">2076</span>            <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoadedApk</span><span class="token punctuation">&gt;</span></span> ref<span class="token punctuation">;</span>
<span class="token number">2077</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>differentUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">2078</span>                <span class="token comment">// Caching not supported across users</span>
<span class="token number">2079</span>                ref <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token number">2080</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>includeCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 从缓存中取</span>
<span class="token number">2081</span>                ref <span class="token operator">=</span> mPackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2082</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">2083</span>                ref <span class="token operator">=</span> mResourcePackages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2084</span>            <span class="token punctuation">}</span>
<span class="token number">2085</span>
<span class="token number">2086</span>            <span class="token class-name">LoadedApk</span> packageInfo <span class="token operator">=</span> ref <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> ref<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token number">2087</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>packageInfo <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>packageInfo<span class="token punctuation">.</span>mResources <span class="token operator">!=</span> <span class="token keyword">null</span>
<span class="token number">2088</span>                    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>packageInfo<span class="token punctuation">.</span>mResources<span class="token punctuation">.</span><span class="token function">getAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isUpToDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">2089</span>                <span class="token comment">// 缓存没有命中，直接 new</span>
<span class="token number">2094</span>                packageInfo <span class="token operator">=</span>
<span class="token number">2095</span>                    <span class="token keyword">new</span> <span class="token class-name">LoadedApk</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> aInfo<span class="token punctuation">,</span> compatInfo<span class="token punctuation">,</span> baseLoader<span class="token punctuation">,</span>
<span class="token number">2096</span>                            securityViolation<span class="token punctuation">,</span> includeCode <span class="token operator">&amp;&amp;</span>
<span class="token number">2097</span>                            <span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span><span class="token class-name">ApplicationInfo</span><span class="token punctuation">.</span><span class="token constant">FLAG_HAS_CODE</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> registerPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2098</span>
<span class="token number">2099</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>mSystemThread <span class="token operator">&amp;&amp;</span> <span class="token string">&quot;android&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">2100</span>                    packageInfo<span class="token punctuation">.</span><span class="token function">installSystemApplicationInfo</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">,</span>
<span class="token number">2101</span>                            <span class="token function">getSystemContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mPackageInfo<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2102</span>                <span class="token punctuation">}</span>
<span class="token number">2103</span>
<span class="token number">2104</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>differentUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">2105</span>                    <span class="token comment">// Caching not supported across users</span>
<span class="token number">2106</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>includeCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 保存缓存</span>
<span class="token number">2107</span>                    mPackages<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
<span class="token number">2108</span>                            <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoadedApk</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>packageInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2109</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">2110</span>                    mResourcePackages<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>aInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
<span class="token number">2111</span>                            <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoadedApk</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>packageInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2112</span>                <span class="token punctuation">}</span>
<span class="token number">2113</span>            <span class="token punctuation">}</span>
<span class="token number">2114</span>            <span class="token keyword">return</span> packageInfo<span class="token punctuation">;</span>
<span class="token number">2115</span>        <span class="token punctuation">}</span>
<span class="token number">2116</span>    <span class="token punctuation">}</span>
</code></pre></div><p>从上述分析中我们得知，在获取 LoadedApk 的过程中使用了一份缓存数据 mPackages：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">ArrayMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">WeakReference</span><span class="token punctuation">&lt;</span><span class="token class-name">LoadedApk</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> mPackages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这个缓存数据是一个 Map，从包名到 LoadedApk 的一个映射。正常情况下，我们的插件肯定不会存在于这个对象里面；但是如果我们手动把我们插件的信息添加到里面呢？系统在查找缓存的过程中，会直接命中缓存！进而使用我们添加进去的 LoadedApk 的 ClassLoader 来加载这个特定的 Activity 类！这样我们就能接管我们自己插件类的加载过程了！</p> <p>这个缓存对象 mPackages 存在于 ActivityThread 类中；老方法，我们首先获取这个对象：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 先获取到当前的ActivityThread对象</span>
<span class="token class-name">Object</span> currentActivityThread <span class="token operator">=</span> <span class="token class-name">RefInvoke</span><span class="token punctuation">.</span><span class="token function">getStaticFieldObject</span><span class="token punctuation">(</span><span class="token string">&quot;android.app.ActivityThread&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sCurrentActivityThread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 获取包的缓存</span>
<span class="token class-name">Map</span> mPackages <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span> <span class="token class-name">RefInvoke</span><span class="token punctuation">.</span><span class="token function">getFieldObject</span><span class="token punctuation">(</span>currentActivityThread<span class="token punctuation">,</span> <span class="token string">&quot;mPackages&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>拿到这个 Map 之后接下来怎么办呢？我们需要填充这个 map，把插件的信息塞进这个 map 里面，以便系统在查找的时候能命中缓存。但是这个填充这个 Map 我们出了需要包名之外，还需要一个 LoadedApk 对象；如何创建一个 LoadedApk 对象呢？</p> <h3 id="创建插件的-loadedapk-对象">创建插件的 LoadedApk 对象</h3> <p>我们当然可以直接反射调用它的构造函数直接创建出需要的对象，但是万一哪里有疏漏，构造参数填错了怎么办？又或者 Android 的不同版本使用了不同的参数，导致我们创建出来的对象与系统创建出的对象不一致，无法 work 怎么办？</p> <p>因此我们需要使用与系统完全相同的方式创建 LoadedApk 对象；从上文分析得知，系统创建 LoadedApk 对象是通过 getPackageInfo 来完成的，因此我们可以调用这个函数来创建 LoadedApk 对象；但是这个函数是 private 的，我们无法使用。</p> <p>有的童鞋可能会有疑问了，private 不是也能反射到吗？我们确实能够调用这个函数，但是 private 表明这个函数是内部实现，或许那一天 Google 高兴，把这个函数改个名字我们就直接 GG 了；但是 public 函数不同，public 被导出的函数你无法保证是否有别人调用它，因此大部分情况下不会修改；我们最好调用 public 函数来保证尽可能少的遇到兼容性问题。（当然，如果实在木有路可以考虑调用私有方法，自己处理兼容性问题，这个我们以后也会遇到）</p> <p>间接调用 getPackageInfo 这个私有函数的 public 函数有同名的 getPackageInfo 系列和 getPackageInfoNoCheck；简单查看源代码发现，getPackageInfo 除了获取包的信息，还检查了包的一些组件；为了绕过这些验证，我们选择使用 getPackageInfoNoCheck 获取 LoadedApk 信息。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">LoadedApk</span> <span class="token function">getPackageInfoNoCheck</span><span class="token punctuation">(</span><span class="token class-name">ApplicationInfo</span> ai<span class="token punctuation">,</span>
    <span class="token class-name">CompatibilityInfo</span> compatInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getPackageInfo</span><span class="token punctuation">(</span>ai<span class="token punctuation">,</span> compatInfo<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="获取-applicationinfo-信息">获取 ApplicationInfo 信息</h4> <p>ApplicationInfo 类提供了一个应用的基本信息。这些信息是从 AndroidManifest.xml 的 <code>&lt;application&gt;</code> 标签获取的。可以通过 PackageParser 获取 ApplicationInfo 的信息。这个类的兼容性很差；Google 几乎在每一个 Android 版本都对这个类动刀子，如果坚持使用系统的解析方式，必须写一系列兼容行代码。DroidPlugin 和 VirtualApp 就选择了这种方式。</p> <ul><li>PackageParser 类中 parseBaseApk()方法，会解析指定路径 apk 的 AndroidManifest.xml 文件。</li> <li>PackageParser 类中 的 generateApplicationInfo 方法来生成 ApplicationInfo 并返回。</li></ul> <p>由于 PackageParser 是@hide 的，因此我们需要通过反射进行调用。我们根据这个 generateApplicationInfo 方法的签名：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ApplicationInfo</span> <span class="token function">generateApplicationInfo</span><span class="token punctuation">(</span><span class="token class-name">Package</span> p<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token class-name">PackageUserState</span> state<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span>
</code></pre></div><p>可以写出调用 generateApplicationInfo 的反射代码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ApplicationInfo</span> <span class="token function">generateApplicationInfo</span><span class="token punctuation">(</span><span class="token class-name">File</span> apkFile<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchMethodException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">InstantiationException</span><span class="token punctuation">,</span> <span class="token class-name">InvocationTargetException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchFieldException</span> <span class="token punctuation">{</span>

    <span class="token comment">// 找出需要反射的核心类: android.content.pm.PackageParser</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> packageParserClass <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;android.content.pm.PackageParser&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取PackageParser$Package类</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> packageParser$<span class="token class-name">PackageClass</span> <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;android.content.pm.PackageParser$Package&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> packageUserStateClass <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;android.content.pm.PackageUserState&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Method</span> generateApplicationInfoMethod <span class="token operator">=</span> packageParserClass<span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">&quot;generateApplicationInfo&quot;</span><span class="token punctuation">,</span>
            packageParser$<span class="token class-name">PackageClass</span><span class="token punctuation">,</span>
            <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
            packageUserStateClass<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 首先, 我们得创建出一个Package对象出来供这个方法调用</span>
    <span class="token comment">// 而这个需要得对象可以通过 android.content.pm.PackageParser#parsePackage 这个方法返回得 Package对象得字段获取得到</span>
    <span class="token comment">// 创建出一个PackageParser对象供使用</span>
    <span class="token class-name">Object</span> packageParser <span class="token operator">=</span> packageParserClass<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 调用 PackageParser.parsePackage 解析apk的信息</span>
    <span class="token class-name">Method</span> parsePackageMethod <span class="token operator">=</span> packageParserClass<span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">&quot;parsePackage&quot;</span><span class="token punctuation">,</span> <span class="token class-name">File</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 实际上是一个 android.content.pm.PackageParser.Package 对象</span>
    <span class="token class-name">Object</span> packageObj <span class="token operator">=</span> parsePackageMethod<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>packageParser<span class="token punctuation">,</span> apkFile<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 第三个参数 mDefaultPackageUserState 我们直接使用默认构造函数构造一个出来即可</span>
    <span class="token class-name">Object</span> defaultPackageUserState <span class="token operator">=</span> packageUserStateClass<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 反射 generateApplicationInfo 得到ApplicationInfo对象</span>
    <span class="token class-name">ApplicationInfo</span> applicationInfo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ApplicationInfo</span><span class="token punctuation">)</span> generateApplicationInfoMethod<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>packageParser<span class="token punctuation">,</span>
            packageObj<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> defaultPackageUserState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> apkPath <span class="token operator">=</span> apkFile<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    applicationInfo<span class="token punctuation">.</span>sourceDir <span class="token operator">=</span> apkPath<span class="token punctuation">;</span>
    applicationInfo<span class="token punctuation">.</span>publicSourceDir <span class="token operator">=</span> apkPath<span class="token punctuation">;</span>

    <span class="token keyword">return</span> applicationInfo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="获取-loadedapk-信息">获取 LoadedApk 信息</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">hookLoadedApkInActivityThread</span><span class="token punctuation">(</span><span class="token class-name">File</span> apkFile<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span>
    <span class="token class-name">NoSuchMethodException</span><span class="token punctuation">,</span> <span class="token class-name">InvocationTargetException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchFieldException</span><span class="token punctuation">,</span> <span class="token class-name">InstantiationException</span> <span class="token punctuation">{</span>

    <span class="token comment">// 先获取到当前的ActivityThread对象</span>
    <span class="token class-name">Object</span> currentActivityThread <span class="token operator">=</span> <span class="token class-name">RefInvoke</span><span class="token punctuation">.</span><span class="token function">getStaticFieldObject</span><span class="token punctuation">(</span><span class="token string">&quot;android.app.ActivityThread&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sCurrentActivityThread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取包的缓存对象</span>
    <span class="token class-name">Map</span> mPackages <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span> <span class="token class-name">RefInvoke</span><span class="token punctuation">.</span><span class="token function">getFieldObject</span><span class="token punctuation">(</span>currentActivityThread<span class="token punctuation">,</span> <span class="token string">&quot;mPackages&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取 ApplicationInfo</span>
    <span class="token class-name">ApplicationInfo</span> applicationInfo <span class="token operator">=</span> <span class="token function">generateApplicationInfo</span><span class="token punctuation">(</span>apkFile<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取 CompatibilityInfo</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> compatibilityInfoClass <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;android.content.res.CompatibilityInfo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> defaultCompatibilityInfo <span class="token operator">=</span> <span class="token class-name">RefInvoke</span><span class="token punctuation">.</span><span class="token function">getStaticFieldObject</span><span class="token punctuation">(</span>compatibilityInfoClass<span class="token punctuation">,</span> <span class="token string">&quot;DEFAULT_COMPATIBILITY_INFO&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 构建 LoadedApk</span>
    <span class="token class-name">Object</span> loadedApk <span class="token operator">=</span> <span class="token class-name">RefInvoke</span><span class="token punctuation">.</span><span class="token function">invokeInstanceMethod</span><span class="token punctuation">(</span>currentActivityThread<span class="token punctuation">,</span> <span class="token string">&quot;getPackageInfoNoCheck&quot;</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">ApplicationInfo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> compatibilityInfoClass<span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>applicationInfo<span class="token punctuation">,</span> defaultCompatibilityInfo<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 由于是弱引用, 因此我们必须在某个地方存一份, 不然容易被GC; 那么就前功尽弃了.</span>
    sLoadedApk<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>applicationInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> loadedApk<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">WeakReference</span> weakReference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token punctuation">(</span>loadedApk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mPackages<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>applicationInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> weakReference<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="还原插件中的-activity">还原插件中的 Activity</h3> <p>通过 Hook ActivityThread 类的 mH 属性，重写了的 handleMessage 方法实现 Activity 还原，对于插件内的 Activity 我们需要通过包名获取</p> <p>xref: <a href="http://androidxref.com/8.1.0_r33/xref/frameworks/base/core/java/android/app/ActivityThread.java#handleMessage" target="_blank" rel="noopener noreferrer">/frameworks/base/core/java/android/app/ActivityThread.java#handleMessage<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;接受到消息了msg:&quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what <span class="token operator">==</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Object</span> obj <span class="token operator">=</span> msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
            <span class="token class-name">Intent</span> intent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">)</span> <span class="token class-name">RefInvoke</span><span class="token punctuation">.</span><span class="token function">getFieldObject</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">&quot;intent&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Intent</span> targetIntent <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getParcelableExtra</span><span class="token punctuation">(</span><span class="token class-name">StubActivity</span><span class="token punctuation">.</span><span class="token constant">TARGET_COMPONENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            intent<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span>targetIntent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 根据包名获取 LoadedApk 的信息; 因此这里我们需要手动填上, 从而能够命中缓存</span>
            <span class="token class-name">ActivityInfo</span> activityInfo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ActivityInfo</span><span class="token punctuation">)</span> <span class="token class-name">RefInvoke</span><span class="token punctuation">.</span><span class="token function">getFieldObject</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">&quot;activityInfo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName <span class="token operator">=</span> targetIntent<span class="token punctuation">.</span><span class="token function">getPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> targetIntent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> targetIntent<span class="token punctuation">.</span><span class="token function">getPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    mBaseHandler<span class="token punctuation">.</span><span class="token function">handleMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>至此，我们完成了对插件中 Activity 的动态加载，但是暂时无法加载插件中的资源，我们可以通过自定义 ClassLoader 实现，本节暂时先写到这里，后续文章再介绍四大组件和资源加载的实现方式。</p> <p>本文学习案例地址：<a href="https://github.com/zhaomenghuan/android-plugin-framework/tree/master/classloader-loadapk" target="_blank" rel="noopener noreferrer">classloader-loadapk<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="参考">参考</h2> <ul><li>本文 Android 源码以 <a href="http://androidxref.com/8.1.0_r33/" target="_blank" rel="noopener noreferrer">8.1.0_r33<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 为准，最新版本见：<a href="http://androidxref.com/" target="_blank" rel="noopener noreferrer">http://androidxref.com/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://blog.csdn.net/u010825468/article/details/78958520" target="_blank" rel="noopener noreferrer">Android 应用获取手机的虚拟机类型<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.jianshu.com/p/dda9ff90a3c5" target="_blank" rel="noopener noreferrer">Mac 环境下反编译 apk<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://segmentfault.com/a/1190000004062952" target="_blank" rel="noopener noreferrer">Android 动态加载入门 简单加载模式<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://weishu.me/2016/04/05/understand-plugin-framework-classloader/" target="_blank" rel="noopener noreferrer">Android 插件化原理解析——插件加载机制<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <div data-v-3bd334e8><p class="descript" data-v-3bd334e8>写这些代码也许就一两个小时的事，写一篇大家好接受的文章需要几天的酝酿，如果文章对您有帮助请我喝杯咖啡吧！</p> <img src="/supportme.png" class="pay-code" data-v-3bd334e8> <div data-v-3bd334e8><div id="container"></div></div> <div class="footer" data-v-4f0df4b0 data-v-3bd334e8><p data-v-4f0df4b0>站点总访问量： 站点总访客数：</p> <p data-v-4f0df4b0>博客内容遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" data-v-4f0df4b0>知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></p> <p data-v-4f0df4b0>赵梦欢 © 2015 - 2023</p></div></div></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.f3e141ba.js" defer></script><script src="/assets/js/12.9aca40f8.js" defer></script><script src="/assets/js/18.c373a36e.js" defer></script><script src="/assets/js/34.124c31c0.js" defer></script>
  </body>
</html>
