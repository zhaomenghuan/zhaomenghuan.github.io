<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>cordova 研习笔记(二) —— cordova 6.X 源码解读 | 匠心博客</title>
    <meta name="description" content="小青年,匠心,小青年博客,匠心博客,前端开发,android,技术宅,菜鸟教程,一个神奇的博客。">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.685c010a.css" as="style"><link rel="preload" href="/assets/js/app.f3e141ba.js" as="script"><link rel="preload" href="/assets/js/69.162d06c4.js" as="script"><link rel="preload" href="/assets/js/18.c373a36e.js" as="script"><link rel="preload" href="/assets/js/34.124c31c0.js" as="script"><link rel="prefetch" href="/assets/js/1.1950ec81.js"><link rel="prefetch" href="/assets/js/10.7f857e71.js"><link rel="prefetch" href="/assets/js/100.e03c01d2.js"><link rel="prefetch" href="/assets/js/101.7b790a2f.js"><link rel="prefetch" href="/assets/js/102.a7aa77f9.js"><link rel="prefetch" href="/assets/js/103.d473991c.js"><link rel="prefetch" href="/assets/js/104.9fe8785c.js"><link rel="prefetch" href="/assets/js/105.7291ae49.js"><link rel="prefetch" href="/assets/js/106.2c35a2f4.js"><link rel="prefetch" href="/assets/js/107.a71ccb64.js"><link rel="prefetch" href="/assets/js/108.9d6f54a8.js"><link rel="prefetch" href="/assets/js/109.e77d12ca.js"><link rel="prefetch" href="/assets/js/11.5378ae65.js"><link rel="prefetch" href="/assets/js/12.9aca40f8.js"><link rel="prefetch" href="/assets/js/13.ce2b655c.js"><link rel="prefetch" href="/assets/js/14.7488ca24.js"><link rel="prefetch" href="/assets/js/15.9c07ac98.js"><link rel="prefetch" href="/assets/js/16.8f57294c.js"><link rel="prefetch" href="/assets/js/17.4f7ae4ec.js"><link rel="prefetch" href="/assets/js/19.c7be2474.js"><link rel="prefetch" href="/assets/js/2.7f7e5268.js"><link rel="prefetch" href="/assets/js/20.f8833113.js"><link rel="prefetch" href="/assets/js/21.e71dd521.js"><link rel="prefetch" href="/assets/js/22.92dc7b77.js"><link rel="prefetch" href="/assets/js/23.285557d3.js"><link rel="prefetch" href="/assets/js/24.a803551c.js"><link rel="prefetch" href="/assets/js/25.dbeaa19d.js"><link rel="prefetch" href="/assets/js/26.9ca97076.js"><link rel="prefetch" href="/assets/js/27.d1a2911b.js"><link rel="prefetch" href="/assets/js/28.25c216b3.js"><link rel="prefetch" href="/assets/js/29.9dc30af4.js"><link rel="prefetch" href="/assets/js/30.1e9d6e06.js"><link rel="prefetch" href="/assets/js/31.3d7dbe62.js"><link rel="prefetch" href="/assets/js/32.36371ba7.js"><link rel="prefetch" href="/assets/js/33.78edc66d.js"><link rel="prefetch" href="/assets/js/35.a5470008.js"><link rel="prefetch" href="/assets/js/36.acde7543.js"><link rel="prefetch" href="/assets/js/37.f6648812.js"><link rel="prefetch" href="/assets/js/38.1885784f.js"><link rel="prefetch" href="/assets/js/39.af4b4bbd.js"><link rel="prefetch" href="/assets/js/4.61024115.js"><link rel="prefetch" href="/assets/js/40.ec6e88a9.js"><link rel="prefetch" href="/assets/js/41.67d4e8b7.js"><link rel="prefetch" href="/assets/js/42.7de428af.js"><link rel="prefetch" href="/assets/js/43.b4f51fa8.js"><link rel="prefetch" href="/assets/js/44.487d119d.js"><link rel="prefetch" href="/assets/js/45.2206665b.js"><link rel="prefetch" href="/assets/js/46.125163cc.js"><link rel="prefetch" href="/assets/js/47.8722f507.js"><link rel="prefetch" href="/assets/js/48.b8bfe77f.js"><link rel="prefetch" href="/assets/js/49.77fac897.js"><link rel="prefetch" href="/assets/js/5.3395f0b5.js"><link rel="prefetch" href="/assets/js/50.d68289a2.js"><link rel="prefetch" href="/assets/js/51.d9d70556.js"><link rel="prefetch" href="/assets/js/52.6a2c9e02.js"><link rel="prefetch" href="/assets/js/53.ff13cf8b.js"><link rel="prefetch" href="/assets/js/54.7e844902.js"><link rel="prefetch" href="/assets/js/55.80aa3d86.js"><link rel="prefetch" href="/assets/js/56.a4124774.js"><link rel="prefetch" href="/assets/js/57.55eb7355.js"><link rel="prefetch" href="/assets/js/58.7d0e2bc5.js"><link rel="prefetch" href="/assets/js/59.9cdd695c.js"><link rel="prefetch" href="/assets/js/6.77e8533c.js"><link rel="prefetch" href="/assets/js/60.54318be9.js"><link rel="prefetch" href="/assets/js/61.82e1ea82.js"><link rel="prefetch" href="/assets/js/62.b065e499.js"><link rel="prefetch" href="/assets/js/63.bb770dde.js"><link rel="prefetch" href="/assets/js/64.996fdbfd.js"><link rel="prefetch" href="/assets/js/65.54f3baf3.js"><link rel="prefetch" href="/assets/js/66.38d28ab3.js"><link rel="prefetch" href="/assets/js/67.5cf5a3bc.js"><link rel="prefetch" href="/assets/js/68.f2418476.js"><link rel="prefetch" href="/assets/js/7.a2cd9d6c.js"><link rel="prefetch" href="/assets/js/70.80f1252b.js"><link rel="prefetch" href="/assets/js/71.970dda3c.js"><link rel="prefetch" href="/assets/js/72.a073c997.js"><link rel="prefetch" href="/assets/js/73.674106d1.js"><link rel="prefetch" href="/assets/js/74.a0336873.js"><link rel="prefetch" href="/assets/js/75.37fbb329.js"><link rel="prefetch" href="/assets/js/76.a9439343.js"><link rel="prefetch" href="/assets/js/77.d52439f1.js"><link rel="prefetch" href="/assets/js/78.fbffcd6c.js"><link rel="prefetch" href="/assets/js/79.c6d73001.js"><link rel="prefetch" href="/assets/js/8.f0af9f9c.js"><link rel="prefetch" href="/assets/js/80.eab87966.js"><link rel="prefetch" href="/assets/js/81.9931436f.js"><link rel="prefetch" href="/assets/js/82.b29080c9.js"><link rel="prefetch" href="/assets/js/83.d94ed517.js"><link rel="prefetch" href="/assets/js/84.600be30f.js"><link rel="prefetch" href="/assets/js/85.a6938cc3.js"><link rel="prefetch" href="/assets/js/86.7dec6ed4.js"><link rel="prefetch" href="/assets/js/87.5d2c1dc9.js"><link rel="prefetch" href="/assets/js/88.8f2410d4.js"><link rel="prefetch" href="/assets/js/89.fe8c04e8.js"><link rel="prefetch" href="/assets/js/9.f542ab97.js"><link rel="prefetch" href="/assets/js/90.f25166a8.js"><link rel="prefetch" href="/assets/js/91.038ee701.js"><link rel="prefetch" href="/assets/js/92.19e610e0.js"><link rel="prefetch" href="/assets/js/93.22cd83c8.js"><link rel="prefetch" href="/assets/js/94.7495cfa6.js"><link rel="prefetch" href="/assets/js/95.f149c41d.js"><link rel="prefetch" href="/assets/js/96.cee91e1f.js"><link rel="prefetch" href="/assets/js/97.27a1bb57.js"><link rel="prefetch" href="/assets/js/98.67d4f125.js"><link rel="prefetch" href="/assets/js/99.35daa60c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.685c010a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">匠心博客</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/index.html" class="nav-link">博文</a></div><div class="nav-item"><a href="/book/index.html" class="nav-link">专栏</a></div><div class="nav-item"><a href="/note/index.html" class="nav-link">笔记</a></div><div class="nav-item"><a href="/nav/index.html" class="nav-link">导航</a></div><div class="nav-item"><a href="/about/index.html" class="nav-link">关于</a></div> <a href="https://github.com/zhaomenghuan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/index.html" class="nav-link">博文</a></div><div class="nav-item"><a href="/book/index.html" class="nav-link">专栏</a></div><div class="nav-item"><a href="/note/index.html" class="nav-link">笔记</a></div><div class="nav-item"><a href="/nav/index.html" class="nav-link">导航</a></div><div class="nav-item"><a href="/about/index.html" class="nav-link">关于</a></div> <a href="https://github.com/zhaomenghuan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>cordova 研习笔记(二) —— cordova 6.X 源码解读</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/learn-cordovajs-code.html#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/learn-cordovajs-code.html#源码结构" class="sidebar-link">源码结构</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/learn-cordovajs-code.html#模块机制" class="sidebar-link">模块机制</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/learn-cordovajs-code.html#事件通道" class="sidebar-link">事件通道</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/learn-cordovajs-code.html#工具模块" class="sidebar-link">工具模块</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/learn-cordovajs-code.html#cordova-模块" class="sidebar-link">cordova 模块</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/learn-cordovajs-code.html#参考" class="sidebar-link">参考</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/learn-cordovajs-code.html#写在后面" class="sidebar-link">写在后面</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="cordova-研习笔记-二-——-cordova-6-x-源码解读">cordova 研习笔记(二) —— cordova 6.X 源码解读</h1> <h2 id="前言">前言</h2> <p>cordova(PhoneGap) 是一个优秀的经典的中间件框架，网上对其源代码解读的文章确实不多，本系列文章试着解读一下，以便对 cordova 框架的原理理解得更深入。本文源码为 cordova android 版本<code>6.1.2</code>。</p> <h2 id="源码结构">源码结构</h2> <p>我们使用 IDE 的代码折叠功能先从整体上把握代码结构。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/*
* 版权申明及注释部分
*/</span>
<span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>;</code>是保证导入的其它 js 脚本，使用工具压缩 js 文件时不出错。一个自执行匿名函数包裹，防止内部变量污染到外部命名空间。阅读过 jQuery 源码的人都知道，jQuery 的也是相同的结构，只是 jQuery 定义的匿名函数多了两个参数 window 和 undefined，然后调用的时候只传入 window，这样，window 可以在 jQuery 内部安全使用，而 undefined 也的确表示未定义（有些浏览器实现允许重定义 undefined）。</p> <p>继续展开代码，可以看到如下的结构：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">var</span> <span class="token constant">PLATFORM_VERSION_BUILD_LABEL</span> <span class="token operator">=</span> <span class="token string">'6.1.2'</span><span class="token punctuation">;</span>

<span class="token comment">// 模块化系统</span>
<span class="token comment">/* ------------------------------------------------------------- */</span>
<span class="token keyword">var</span> require<span class="token punctuation">,</span> <span class="token comment">// 加载使用module</span>
    define<span class="token punctuation">;</span>  <span class="token comment">// 定义注册module</span>

<span class="token comment">// require|define 的逻辑</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Export for use in node</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> module <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> require <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>require <span class="token operator">=</span> require<span class="token punctuation">;</span>
    module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>define <span class="token operator">=</span> define<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* ------------------------------------------------------------- */</span>

<span class="token comment">// 事件的处理和回调，外部访问cordova.js的入口</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;cordova&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>

<span class="token comment">// JS-&gt;Native的具体交互形式</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;cordova/android/nativeapiprovider&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>

<span class="token comment">// 通过prompt()和Native交互</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;cordova/android/promptbasednativeapi&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>

<span class="token comment">// 用于plugin中校验参数，比如argscheck.checkArgs('fFO', 'Camera.getPicture', arguments); 参数应该是2个函数1个对象</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;cordova/argscheck&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>

<span class="token comment">// JS-&gt;Native交互时对ArrayBuffer进行uint8ToBase64（WebSockets二进制流）</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;cordova/base64&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>

<span class="token comment">// 对象属性操作，比如把一个对象的属性Merge到另外一个对象</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;cordova/builder&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>

<span class="token comment">// 事件通道</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;cordova/channel&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>

<span class="token comment">// 执行JS-&gt;Native交互</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;cordova/exec&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>

<span class="token comment">// 用于Plugin中往已经有的模块上添加方法</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;cordova/exec/proxy&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>

<span class="token comment">// 初始化处理</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;cordova/init&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;cordova/init_b&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>

<span class="token comment">// 把定义的模块clobber到一个对象，在初始化的时候会赋给window</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;cordova/modulemapper&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;cordova/modulemapper_b&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>

<span class="token comment">// 平台启动处理</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;cordova/platform&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>

<span class="token comment">// 清缓存、loadUrl、退出程序等</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;cordova/plugin/android/app&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>

<span class="token comment">// 载所有cordova_plugins.js中定义的模块，执行完成后会触发</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;cordova/pluginloader&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;cordova/pluginloader_b&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>

<span class="token comment">// 获取绝对URL，InAppBrowser中会用到</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;cordova/urlutil&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>

<span class="token comment">// 工具类</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;cordova/utils&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>

<span class="token comment">// 所有模块注册完之后，导入cordova至全局环境中</span>
window<span class="token punctuation">.</span>cordova <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cordova'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 初始化启动</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cordova/init'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>从上可以清晰的看出，在 cordova 内部，首先是定义了两个公共的 require 和 define 函数，然后是使用 define 注册所有模块，再通过 window.cordova=require('cordova')导入库文件至全局执行环境中。</p> <h2 id="模块机制">模块机制</h2> <p>类似于 Java 的 package/import，在 JavaScript 中也有类似的 define/require，它用来异步加载 module 化的 js，从而提高运行效率。模块化加载的必要性，起源于 nodejs 的出现。但是 JavaScript 并没有内置模块系统，所以就出现了很多规范。  主要有 2 种：<a href="http://wiki.commonjs.org/wiki/Modules/1.1" target="_blank" rel="noopener noreferrer">CommonJS<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 和 <a href="http://en.wikipedia.org/wiki/Asynchronous_module_definition" target="_blank" rel="noopener noreferrer">AMD（Asynchronous Module Definition）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。还有国内兴起的<a href="https://github.com/cmdjs/specification/blob/master/draft/module.md" target="_blank" rel="noopener noreferrer">CMD（Common Module Definition）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 。CommonJS 主要面对的是服务器，代表是<a href="http://nodejs.org/" target="_blank" rel="noopener noreferrer">Node.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>；AMD 针对浏览器进行了优化，主要实现<a href="http://www.requirejs.org/" target="_blank" rel="noopener noreferrer">require.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>；CMD 是<a href="http://seajs.org/docs/" target="_blank" rel="noopener noreferrer">seajs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>cordova-js 最开始采用的是 require.js 作者写的<a href="http://github.com/jrburke/almond" target="_blank" rel="noopener noreferrer">almond.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（兼容 AMD 和 CommonJS），但之后由于特殊需求（比如模块不存在的时候要 throw 异常），最终从 almond.js fork 过来实现了一个简易 CommonJS 风格的模块系统，同时提供了和 nodejs 之间很好的交互。在 cordova.js 中可以直接使用 define()和 require()，在其他文件可以通过 cordova.define()和 cordova.require()来调用。所以 src/scripts/require.js 中定义的就是一个精简的 JavaScript 模块系统。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// cordova.js内部使用的全局函数require/define</span>
<span class="token keyword">var</span> require<span class="token punctuation">,</span> define<span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 初始化一个空对象，缓存所有的模块</span>
  <span class="token keyword">var</span> modules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 正在build中的模块ID的栈</span>
    requireStack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// 标示正在build中模块ID的Map</span>
    inProgressModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token constant">SEPARATOR</span> <span class="token operator">=</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">;</span>

  <span class="token comment">// 模块build</span>
  <span class="token keyword">function</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 备份工厂方法</span>
    <span class="token keyword">var</span> factory <span class="token operator">=</span> module<span class="token punctuation">.</span>factory<span class="token punctuation">,</span>
      <span class="token comment">// 对require对象进行特殊处理</span>
      <span class="token function-variable function">localRequire</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> resultantId <span class="token operator">=</span> id<span class="token punctuation">;</span>
        <span class="token comment">//Its a relative path, so lop off the last portion and add the id (minus &quot;./&quot;)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>id<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          resultantId <span class="token operator">=</span>
            module<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> module<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token constant">SEPARATOR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
            <span class="token constant">SEPARATOR</span> <span class="token operator">+</span>
            id<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span>resultantId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 给模块定义一个空的exports对象，防止工厂类方法中的空引用</span>
    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 删除工厂方法</span>
    <span class="token keyword">delete</span> module<span class="token punctuation">.</span>factory<span class="token punctuation">;</span>
    <span class="token comment">// 调用备份的工厂方法（参数必须是require,exports,module）</span>
    <span class="token function">factory</span><span class="token punctuation">(</span>localRequire<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 返回工厂方法中实现的module.exports对象</span>
    <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 加载使用模块</span>
  <span class="token function-variable function">require</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果模块不存在抛出异常</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>modules<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token string">&quot;module &quot;</span> <span class="token operator">+</span> id <span class="token operator">+</span> <span class="token string">&quot; not found&quot;</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果模块正在build中抛出异常</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token keyword">in</span> inProgressModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> cycle <span class="token operator">=</span>
        requireStack<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>inProgressModules<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;-&gt;&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;-&gt;&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
      <span class="token keyword">throw</span> <span class="token string">&quot;Cycle in require graph: &quot;</span> <span class="token operator">+</span> cycle<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果模块存在工厂方法说明还未进行build（require嵌套）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>modules<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>factory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 标示该模块正在build</span>
        inProgressModules<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> requireStack<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token comment">// 将该模块压入请求栈</span>
        requireStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 模块build，成功后返回module.exports</span>
        <span class="token keyword">return</span> <span class="token function">build</span><span class="token punctuation">(</span>modules<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// build完成后删除当前请求</span>
        <span class="token keyword">delete</span> inProgressModules<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
        requireStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// build完的模块直接返回module.exports</span>
    <span class="token keyword">return</span> modules<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 定义注册模块</span>
  <span class="token function-variable function">define</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> factory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果已经存在抛出异常</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>modules<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token string">&quot;module &quot;</span> <span class="token operator">+</span> id <span class="token operator">+</span> <span class="token string">&quot; already defined&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 模块以ID为索引包含ID和工厂方法</span>
    modules<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">id</span><span class="token operator">:</span> id<span class="token punctuation">,</span>
      <span class="token literal-property property">factory</span><span class="token operator">:</span> factory
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 移除模块</span>
  define<span class="token punctuation">.</span><span class="token function-variable function">remove</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">delete</span> modules<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 返回所有模块</span>
  define<span class="token punctuation">.</span>moduleMap <span class="token operator">=</span> modules<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>首先在外部 cordova 环境中定义 require 和 define 两个变量，用来存储实现导入功能的函数和实现注册功能的函数。然后用一个立即调用的匿名函数来实例化这两个变量，在这个匿名函数内部，缓存了所有的功能模块。注册模块时，如果已经注册了，就直接抛出异常，防止无意中重定义，如确实需要重定义，可先调用 define.remove。</p> <p>从内部私有函数 build 中，可以看出，调用工厂函数时， <code>factory(localRequire, module.exports, module);</code>第一个参数<code>localRequire</code>实质还是调用全局的<code>require()</code>函数，只是把 ID 稍微加工了一下支持相对路径。cordova.js 没有用到相对路径的 require，但在一些 Plugin 的 js 中有，比如<code>Contact.js</code> 中 <code>ContactError = require('./ContactError');</code></p> <p>这里我们写个测试用例：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;module.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;text/javascript&quot;</span><span class="token operator">&gt;</span>
    <span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'plugin.first'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'first plugin'</span><span class="token punctuation">,</span>
            <span class="token function-variable function">show</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;call &quot;</span><span class="token operator">+</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'plugin.second'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> first <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;plugin.first&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        first<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;plugin.second&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// call first plugin</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>注：module.js 为上述 cordova 的模块代码。</p> <p>上面例子中我们定义了两个模块，这里是写在同一个页面下，在实际中我们自然希望写在两个不同的文件中，然后按需加载。我们上一篇文章中说明了 cordova 的插件使用方法，我们会发现<code>cordova_plugins.js</code>中定义了 cordova 插件的 id、路径等变量，并且该文件定义了一个 id 为<code>cordova/plugin_list</code>的模块，我们在 cordova.js 中可以看到有这个模块的引用。</p> <p>定义了 require 和 define 并赋值后，是将 cordova 所有模块一一注册，例如：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;cordova&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 工厂函数内部实现代码</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这里需要注意的是，**define 只是注册模块，不会调用其 factory。**factory 函数在这个时候并没有实际执行，而只是定义，并作为一个参数传递给 define 函数。所有模块注册完之后，通过：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>window<span class="token punctuation">.</span>cordova <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;cordova&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>导入至全局环境。</p> <p>因为是注册后第一次导入，所以在执行<code>require('cordova')</code>时，<code>modules['cordova'].factory</code>的值是注册时的工厂函数，转变为 boolean 值时为 true，从而在这里会通过 build 调用这个工厂函数，并将这个工厂函数从注册缓存里面删除，接下来的就是去执行 cordova 的这个 factory 函数了。</p> <h2 id="事件通道">事件通道</h2> <p>作为观察者模式(Observer)的一种变形，很多 MV*框架（比如：Vue.js、Backbone.js）中都提供发布/订阅模型来对代码进行解耦。cordova.js 中也提供了一个自定义的 pub-sub 模型，基于该模型提供了一些事件通道，用来控制通道中的事件什么时候以什么样的顺序被调用，以及各个事件通道的调用。</p> <p>src/common/channel.js 的代码结构也是一个很经典的定义结构（构造函数、实例、修改函数原型共享实例方法），它提供事件通道上事件的订阅（subscribe）、撤消订阅（unsubscribe）、调用（fire）。pub-sub 模型用于定义和控制对 cordova 初始化的事件的触发以及此后的自定义事件。</p> <p>页面加载和 Cordova 启动期间的事件顺序如下：</p> <ul><li><strong>onDOMContentLoaded</strong> ——（内部事件通道）页面加载后 DOM 解析完成</li> <li><strong>onNativeReady</strong> ——（内部事件通道）Cordova 的 native 准备完成</li> <li><strong>onCordovaReady</strong> ——（内部事件通道）所有 Cordova 的 JavaScript 对象被创建完成可以开始加载插件</li> <li><strong>onDeviceReady</strong> —— Cordova 全部准备完成</li> <li><strong>onResume</strong> —— 应用重新返回前台</li> <li><strong>onPause</strong> —— 应用暂停退到后台</li></ul> <p>可以通过下面的事件进行监听：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;deviceready&quot;</span><span class="token punctuation">,</span> myDeviceReadyListener<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;resume&quot;</span><span class="token punctuation">,</span> myResumeListener<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;pause&quot;</span><span class="token punctuation">,</span> myPauseListener<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>DOM 生命周期事件应用于保存和恢复状态：</p> <ul><li>window.onload</li> <li>window.onunload</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;cordova/channel&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> utils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;cordova/utils&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nextGuid <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token comment">// 事件通道的构造函数</span>
  <span class="token keyword">var</span> <span class="token function-variable function">Channel</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> sticky</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 通道名称</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
      <span class="token comment">// 通道上的所有事件处理函数Map（索引为guid）</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>handlers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token comment">// 通道的状态（0：非sticky, 1:sticky但未调用, 2:sticky已调用）</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> sticky <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token comment">// 对于sticky事件通道备份传给fire()的参数</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>fireArgs <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token comment">// 当前通道上的事件处理函数的个数</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>numHandlers <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token comment">// 订阅第一个事件或者取消订阅最后一个事件时调用自定义的处理</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>onHasSubscribersChange <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 事件通道外部接口</span>
    channel <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token comment">// 把指定的函数h订阅到c的各个通道上，保证h在每个通道的最后被执行</span>
      <span class="token function-variable function">join</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">h<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> len <span class="token operator">=</span> c<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
          i <span class="token operator">=</span> len<span class="token punctuation">,</span>
          <span class="token function-variable function">f</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Can only use join with sticky channels.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          c<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>len<span class="token punctuation">)</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// 创建事件通道</span>
      <span class="token function-variable function">create</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>channel<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Channel</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// 创建sticky事件通道</span>
      <span class="token function-variable function">createSticky</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>channel<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Channel</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>

      <span class="token comment">// 保存deviceready事件之前要调用的事件</span>
      <span class="token literal-property property">deviceReadyChannelsArray</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">deviceReadyChannelsMap</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>

      <span class="token comment">// 设置deviceready事件之前必须要完成的事件</span>
      <span class="token function-variable function">waitForInitialization</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">feature</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>feature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">var</span> c <span class="token operator">=</span> channel<span class="token punctuation">[</span>feature<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createSticky</span><span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>deviceReadyChannelsMap<span class="token punctuation">[</span>feature<span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>deviceReadyChannelsArray<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>

      <span class="token comment">// 初始化代码已经完成</span>
      <span class="token function-variable function">initializationComplete</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">feature</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deviceReadyChannelsMap<span class="token punctuation">[</span>feature<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          c<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 校验事件处理函数</span>
  <span class="token keyword">function</span> <span class="token function">checkSubscriptionArgument</span><span class="token punctuation">(</span><span class="token parameter">argument</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token keyword">typeof</span> argument <span class="token operator">!==</span> <span class="token string">&quot;function&quot;</span> <span class="token operator">&amp;&amp;</span>
      <span class="token keyword">typeof</span> argument<span class="token punctuation">.</span>handleEvent <span class="token operator">!==</span> <span class="token string">&quot;function&quot;</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token string">&quot;Must provide a function or an EventListener object &quot;</span> <span class="token operator">+</span>
          <span class="token string">&quot;implementing the handleEvent interface.&quot;</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 向事件通道订阅事件处理函数(subscribe部分）
   * f:事件处理函数 c:事件的上下文
   */</span>
  <span class="token class-name">Channel</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">subscribe</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>
    <span class="token parameter">eventListenerOrFunction<span class="token punctuation">,</span>
    eventListener</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 校验事件处理函数</span>
    <span class="token function">checkSubscriptionArgument</span><span class="token punctuation">(</span>eventListenerOrFunction<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> handleEvent<span class="token punctuation">,</span> guid<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      eventListenerOrFunction <span class="token operator">&amp;&amp;</span>
      <span class="token keyword">typeof</span> eventListenerOrFunction <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 接收到一个实现handleEvent接口的EventListener对象</span>
      handleEvent <span class="token operator">=</span> eventListenerOrFunction<span class="token punctuation">.</span>handleEvent<span class="token punctuation">;</span>
      eventListener <span class="token operator">=</span> eventListenerOrFunction<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 接收到处理事件的回调函数</span>
      handleEvent <span class="token operator">=</span> eventListenerOrFunction<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 如果是被订阅过的sticky事件，就直接调用</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">handleEvent</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>eventListener <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fireArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    guid <span class="token operator">=</span> eventListenerOrFunction<span class="token punctuation">.</span>observer_guid<span class="token punctuation">;</span>
    <span class="token comment">// 如果事件有上下文，要先把事件函数包装一下带上上下文</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> eventListener <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      handleEvent <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>eventListener<span class="token punctuation">,</span> handleEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 自增长的ID</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>guid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      guid <span class="token operator">=</span> <span class="token string">&quot;&quot;</span> <span class="token operator">+</span> nextGuid<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 把自增长的ID反向设置给函数，以后撤消订阅或内部查找用</span>
    handleEvent<span class="token punctuation">.</span>observer_guid <span class="token operator">=</span> guid<span class="token punctuation">;</span>
    eventListenerOrFunction<span class="token punctuation">.</span>observer_guid <span class="token operator">=</span> guid<span class="token punctuation">;</span>

    <span class="token comment">// 判断该guid索引的事件处理函数是否存在（保证订阅一次）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>handlers<span class="token punctuation">[</span>guid<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 订阅到该通道上（索引为guid）</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>handlers<span class="token punctuation">[</span>guid<span class="token punctuation">]</span> <span class="token operator">=</span> handleEvent<span class="token punctuation">;</span>
      <span class="token comment">// 通道上的事件处理函数的个数增1</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>numHandlers<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>numHandlers <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 订阅第一个事件时调用自定义的处理（比如：第一次按下返回按钮提示“再按一次...”）</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onHasSubscribersChange <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onHasSubscribersChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * 撤消订阅通道上的某个函数（guid）
   */</span>
  <span class="token class-name">Channel</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">unsubscribe</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">eventListenerOrFunction</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 事件处理函数校验</span>
    <span class="token function">checkSubscriptionArgument</span><span class="token punctuation">(</span>eventListenerOrFunction<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> handleEvent<span class="token punctuation">,</span> guid<span class="token punctuation">,</span> handler<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      eventListenerOrFunction <span class="token operator">&amp;&amp;</span>
      <span class="token keyword">typeof</span> eventListenerOrFunction <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 接收到一个实现handleEvent接口的EventListener对象</span>
      handleEvent <span class="token operator">=</span> eventListenerOrFunction<span class="token punctuation">.</span>handleEvent<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 接收到处理事件的回调函数</span>
      handleEvent <span class="token operator">=</span> eventListenerOrFunction<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 事件处理函数的guid索引</span>
    guid <span class="token operator">=</span> handleEvent<span class="token punctuation">.</span>observer_guid<span class="token punctuation">;</span>
    <span class="token comment">// 事件处理函数</span>
    handler <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handlers<span class="token punctuation">[</span>guid<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 从该通道上撤消订阅（索引为guid）</span>
      <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handlers<span class="token punctuation">[</span>guid<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// 通道上的事件处理函数的个数减1</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>numHandlers<span class="token operator">--</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>numHandlers <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 撤消订阅最后一个事件时调用自定义的处理</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onHasSubscribersChange <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onHasSubscribersChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * 调用所有被发布到该通道上的函数
   */</span>
  <span class="token class-name">Channel</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">fire</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> fail <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      fireArgs <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// sticky事件被调用时，标示为已经调用过</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>fireArgs <span class="token operator">=</span> fireArgs<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>numHandlers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 把该通道上的所有事件处理函数拿出来放到一个数组中</span>
      <span class="token keyword">var</span> toCall <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> item <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handlers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        toCall<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>handlers<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 依次调用通道上的所有事件处理函数</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> toCall<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        toCall<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> fireArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// sticky事件是一次性全部被调用的，调用完成后就清空</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>numHandlers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>numHandlers <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>handlers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onHasSubscribersChange <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onHasSubscribersChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * 创建事件通道（publish部分）
   */</span>
  <span class="token comment">//（内部事件通道）页面加载后DOM解析完成</span>
  channel<span class="token punctuation">.</span><span class="token function">createSticky</span><span class="token punctuation">(</span><span class="token string">&quot;onDOMContentLoaded&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//（内部事件通道）Cordova的native准备完成</span>
  channel<span class="token punctuation">.</span><span class="token function">createSticky</span><span class="token punctuation">(</span><span class="token string">&quot;onNativeReady&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//（内部事件通道）所有Cordova的JavaScript对象被创建完成可以开始加载插件</span>
  channel<span class="token punctuation">.</span><span class="token function">createSticky</span><span class="token punctuation">(</span><span class="token string">&quot;onCordovaReady&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//（内部事件通道）所有自动load的插件js已经被加载完成（待删除）</span>
  channel<span class="token punctuation">.</span><span class="token function">createSticky</span><span class="token punctuation">(</span><span class="token string">&quot;onPluginsReady&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Cordova全部准备完成</span>
  channel<span class="token punctuation">.</span><span class="token function">createSticky</span><span class="token punctuation">(</span><span class="token string">&quot;onDeviceReady&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 应用重新返回前台</span>
  channel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;onResume&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 应用暂停退到后台</span>
  channel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;onPause&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 设置deviceready事件之前必须要完成的事件</span>
  channel<span class="token punctuation">.</span><span class="token function">waitForInitialization</span><span class="token punctuation">(</span><span class="token string">&quot;onCordovaReady&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  channel<span class="token punctuation">.</span><span class="token function">waitForInitialization</span><span class="token punctuation">(</span><span class="token string">&quot;onDOMContentLoaded&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> channel<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>我们可以写一个测试用例：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;channel.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;text/javascript&quot;</span><span class="token operator">&gt;</span>
    <span class="token keyword">var</span> test <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">'onTest'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 订阅事件（此处test = channel.onTest）</span>
    test<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'test fire'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 触发事件（此处test = channel.onTest）</span>
    test<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>但是很多时候我们希望能够传递参数，通过阅读上面的源码可以得知：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>eventListenerOrFunction <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> eventListenerOrFunction <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 接收到一个实现handleEvent接口的EventListener对象</span>
  handleEvent <span class="token operator">=</span> eventListenerOrFunction<span class="token punctuation">.</span>handleEvent<span class="token punctuation">;</span>
  eventListener <span class="token operator">=</span> eventListenerOrFunction<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// 接收到处理事件的回调函数</span>
  handleEvent <span class="token operator">=</span> eventListenerOrFunction<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们上面的例子中我们传递的是一个方法，这里我们也可以传递一个 EventListener 对象。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 创建事件通道</span>
channel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;onTest&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 订阅事件</span>
channel<span class="token punctuation">.</span>onTest<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">&quot; fire&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建 Event 对象</span>
<span class="token keyword">var</span> event <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createEvent</span><span class="token punctuation">(</span><span class="token string">&quot;Events&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 初始化事件</span>
event<span class="token punctuation">.</span><span class="token function">initEvent</span><span class="token punctuation">(</span><span class="token string">&quot;onTest&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 绑定数据</span>
event<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;test&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 触发事件</span>
channel<span class="token punctuation">.</span>onTest<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="工具模块">工具模块</h2> <p>我们在写插件的时候如果熟悉 cordova 自带的工具函数，可以更加方便的拓展自己的插件。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;cordova/utils&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> utils <span class="token operator">=</span> exports<span class="token punctuation">;</span>
    <span class="token comment">// 定义对象属性（或方法）的setter/getter</span>
    utils<span class="token punctuation">.</span><span class="token function-variable function">defineGetterSetter</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> getFunc<span class="token punctuation">,</span> opt_setFunc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
    <span class="token comment">// 定义对象属性（或方法）的getter</span>
    utils<span class="token punctuation">.</span>defineGetter <span class="token operator">=</span> utils<span class="token punctuation">.</span>defineGetterSetter<span class="token punctuation">;</span>
    <span class="token comment">// Array IndexOf 方法</span>
    utils<span class="token punctuation">.</span><span class="token function-variable function">arrayIndexOf</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
    <span class="token comment">// Array remove 方法</span>
    utils<span class="token punctuation">.</span><span class="token function-variable function">arrayRemove</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
    <span class="token comment">// 类型判断</span>
    utils<span class="token punctuation">.</span><span class="token function-variable function">typeName</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
    <span class="token comment">// 数组判断</span>
    utils<span class="token punctuation">.</span>isArray <span class="token operator">=</span> Array<span class="token punctuation">.</span>isArray <span class="token operator">||</span>
        <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> utils<span class="token punctuation">.</span><span class="token function">typeName</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'Array'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// Date判断</span>
    utils<span class="token punctuation">.</span><span class="token function-variable function">isDate</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
    <span class="token comment">// 深度拷贝</span>
    utils<span class="token punctuation">.</span><span class="token function-variable function">clone</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
    <span class="token comment">// 函数包装调用</span>
    utils<span class="token punctuation">.</span><span class="token function-variable function">close</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> func<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
    <span class="token comment">//  内部私有函数，产生随机数</span>
    <span class="token keyword">function</span> <span class="token function">UUIDcreatePart</span><span class="token punctuation">(</span><span class="token parameter">length</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
    <span class="token comment">// 创建 UUID (通用唯一识别码)</span>
    utils<span class="token punctuation">.</span><span class="token function-variable function">createUUID</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
    <span class="token comment">// 继承</span>
    utils<span class="token punctuation">.</span>extend <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
    <span class="token comment">// 调试</span>
    utils<span class="token punctuation">.</span><span class="token function-variable function">alert</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>UUIDcreatePart 函数用来随机产生一个 16 进制的号码，接受一个表示号码长度的参数（实际上是最终号码长度的一半），一般用途是做为元素的唯一 ID。</li> <li>utils.isArray 在这里不使用 instanceof 来判断是不是 Array 类型，主要是考虑到跨域或者多个 frame 的情况，多个 frame 时每个 frame 都会有自己的 Array 构造函数，从而得出不正确的结论。使用'[object Array]'来判断是根据 ECMA 标准中的返回值来进行的，事实上，这里不需要类型转换，而可以用全等“===”来判断。</li> <li>utils.close 函数，封装函数的调用，将执行环境作为一个参数，调用的函数为第二个参数，调用函数本身的参数为后续参数。</li></ul> <p><strong>原型继承实现详解</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>utils<span class="token punctuation">.</span>extend <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// proxy used to establish prototype chain</span>
  <span class="token keyword">var</span> <span class="token function-variable function">F</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// extend Child from Parent</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">Child<span class="token punctuation">,</span> Parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">F</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token class-name">Parent</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span>
    <span class="token class-name">Child</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Child<span class="token punctuation">.</span>__super__ <span class="token operator">=</span> <span class="token class-name">Parent</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span>
    <span class="token class-name">Child</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> Child<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这里的继承是通过原型链的方式实现，我们可以通过下述方式调用：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> <span class="token function-variable function">Parent</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;Parent&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">Parent</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getName</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token function-variable function">Child</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;Child&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

utils<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>Child<span class="token punctuation">,</span> Parent<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> child <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Child</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ES5 中有一个<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object/create" target="_blank" rel="noopener noreferrer">Object.create<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>方法，我们可以使用这个函数实现继承：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 创建一个新的对象</span>
Object<span class="token punctuation">.</span>create <span class="token operator">=</span>
  Object<span class="token punctuation">.</span>create <span class="token operator">||</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">proto</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> <span class="token function-variable function">F</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token class-name">F</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> proto<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 实现继承</span>
<span class="token keyword">var</span> <span class="token function-variable function">extend</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">Child<span class="token punctuation">,</span> Parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 拷贝Parent原型对象</span>
  <span class="token class-name">Child</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Parent</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 将Child原型对象构造函数重置</span>
  <span class="token class-name">Child</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> Child<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 实例</span>
<span class="token keyword">var</span> <span class="token function-variable function">Parent</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;Parent&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">Parent</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getName</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token function-variable function">Child</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;Child&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">extend</span><span class="token punctuation">(</span>Child<span class="token punctuation">,</span> Parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> child <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Child</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>原型链的概念对于初学者而言可能有点绕，但是我们把握<strong>构造函数</strong>、<strong>实例化对象</strong>、<strong>原型对象</strong>三者的关系就很简单了。我们以此为例说明：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 构造函数</span>
<span class="token keyword">var</span> <span class="token function-variable function">Child</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;Child&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 原型对象Child.prototype</span>
<span class="token class-name">Child</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getName</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 实例化对象</span>
<span class="token keyword">var</span> child <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Child</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>原型对象是构造函数的 prototype 属性，是所有实例化对象共享属性和方法的原型对象。</li> <li>实例化对象通过 new 构造函数得到，都继承了原型对象的属性和方法。</li> <li>如何访（qiu）问（jie）原型对象？若已知构造函数 Child，则可以通过<code>Child.prototype</code>得到；若已知实例化对象 child，则可以通过<code>child.__proto__</code>或者<code>Object.getPrototypeOf(child)</code>得到，也通过 Object.setPrototypeOf 方法来重写对象的原型。</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">Child</span><span class="token punctuation">.</span>prototype <span class="token operator">===</span> child<span class="token punctuation">.</span>__proto__<span class="token punctuation">;</span> <span class="token comment">// true</span>
child<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
</code></pre></div><ul><li>原型对象中有个隐式的 constructor，指向了构造函数本身，也就是我们可以通过<code>Child.prototype.constructor</code>（虽然看似多此一举，但是经常需要重新设置构造函数）或<code>child.__proto__.constructor</code>或者<code>Object.getPrototypeOf(child).constructor</code>得到构造函数。</li> <li>instanceof 和 Object.isPrototypeOf()可以判断两个对象是否是继承关系</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>child <span class="token keyword">instanceof</span> <span class="token class-name">Child</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
<span class="token class-name">Child</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">isPrototypeOf</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
</code></pre></div><p>至此<strong>构造函数</strong>、<strong>实例化对象</strong>、<strong>原型对象</strong>三者的关系我们已经很清除了，再回过头看看上面继承的实现就很简单了。</p> <p>我们可以通过<code>instanceof</code>来检验是否满足继承关系：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>child <span class="token keyword">instanceof</span> <span class="token class-name">Child</span> <span class="token operator">&amp;&amp;</span> child <span class="token keyword">instanceof</span> <span class="token class-name">Parent</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
</code></pre></div><p>其实上述继承的思路很简单：</p> <p>1.首先获得父类原型对象的方法，这里的 F 对象作为中间变量引用拷贝 Parent.prototype 对象（即和 Parent.prototype 共享同一内存空间）；例如我们修改上述的 Object.create 为：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Object<span class="token punctuation">.</span><span class="token function-variable function">create</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">proto</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> <span class="token function-variable function">F</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token class-name">F</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> proto<span class="token punctuation">;</span>
  <span class="token class-name">F</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">setName</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>此时 Parent.prototype、Child.prototype、child 都拥有的 setName 方法，但是我们应当避免这样做，这也是为什么我们不直接通过<code>Child.prototype = Parent.prototype</code>获得；通过实例化中间对象 F 间接得到 Parent.prototype 的方法，此时通过 Object.create 方法获得的对象和 Parent.prototype 不再是共享内存空间。Child 通过<code>extend(Child, Parent)</code>从 Parent.prototype 对象获得一份新的拷贝。实质是因为我们通过 new 一个构造函数获得的实例化对象是获得了一个新的内存空间，子对象互不影响；</p> <p>2.对子类进行修正，我们通过拷贝获得了父类的一个备份，此时子类原型对象下的 constructor 属性依然是父类的构造函数，显然不符合我们的要求，我们需要重置，同时有时候我们希望保留对父类的引用，如 cordova 这里用一个<code>__super__</code>属性保存。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Child<span class="token punctuation">.</span>__super__ <span class="token operator">=</span> <span class="token class-name">Parent</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span>
<span class="token class-name">Child</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> Child<span class="token punctuation">;</span>
</code></pre></div><p>其实继承的本质我们是希望能实现以下功能：</p> <ul><li>父类有的我都有，我也能重载，但不至于影响到父类的属性和方法</li> <li>除了继承之外，我也能添加自己的方法和属性</li></ul> <p>我们可以利用 es6 新特性实现同样的效果：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Parent</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;Parent&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Child</span> <span class="token keyword">extends</span> <span class="token class-name">Parent</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;Child&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> child <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Child</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>super 关键字在这里表示父类的构造函数，用来新建父类的 this 对象。在子类的构造函数中，只有调用 super 之后，才可以使用 this 关键字，否则会报错。这是因为子类实例的构建，是基于对父类实例加工，只有 super 方法才能返回父类实例。</p> <h2 id="cordova-模块">cordova 模块</h2> <p>本文最后一部分我们来看看 cordova 模块，cordova 模块是事件的处理和回调，外部访问 cordova.js 的入口。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;cordova&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>cordova <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>cordova <span class="token keyword">instanceof</span> <span class="token class-name">HTMLElement</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;cordova already defined&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 导入事件通道模块</span>
  <span class="token keyword">var</span> channel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cordova/channel'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 导入平台模块</span>
  <span class="token keyword">var</span> platform <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cordova/platform'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 保存addEventListener、removeEventListener的原生实现</span>
  <span class="token keyword">var</span> m_document_addEventListener <span class="token operator">=</span> document<span class="token punctuation">.</span>addEventListener<span class="token punctuation">;</span>
  <span class="token keyword">var</span> m_document_removeEventListener <span class="token operator">=</span> document<span class="token punctuation">.</span>removeEventListener<span class="token punctuation">;</span>
  <span class="token keyword">var</span> m_window_addEventListener <span class="token operator">=</span> window<span class="token punctuation">.</span>addEventListener<span class="token punctuation">;</span>
  <span class="token keyword">var</span> m_window_removeEventListener <span class="token operator">=</span> window<span class="token punctuation">.</span>removeEventListener<span class="token punctuation">;</span>

  <span class="token comment">// 缓存所有的事件处理函数</span>
  <span class="token keyword">var</span> documentEventHandlers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      windowEventHandlers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 重新定义addEventListener、removeEventListener，方便后面注册添加pause、resume、deviceReady等事件</span>
  document<span class="token punctuation">.</span><span class="token function-variable function">addEventListener</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">evt<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> capture</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
  window<span class="token punctuation">.</span><span class="token function-variable function">addEventListener</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">evt<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> capture</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
  document<span class="token punctuation">.</span><span class="token function-variable function">removeEventListener</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">evt<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> capture</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
  window<span class="token punctuation">.</span><span class="token function-variable function">removeEventListener</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">evt<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> capture</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">createEvent</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>

  <span class="token keyword">var</span> cordova <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">define</span><span class="token operator">:</span> define<span class="token punctuation">,</span>
    <span class="token literal-property property">require</span><span class="token operator">:</span> require<span class="token punctuation">,</span>
    <span class="token literal-property property">version</span><span class="token operator">:</span> <span class="token constant">PLATFORM_VERSION_BUILD_LABEL</span><span class="token punctuation">,</span>
    <span class="token literal-property property">platformVersion</span><span class="token operator">:</span> <span class="token constant">PLATFORM_VERSION_BUILD_LABEL</span><span class="token punctuation">,</span>
    <span class="token literal-property property">platformId</span><span class="token operator">:</span> platform<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
    <span class="token function-variable function">addWindowEventHandler</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">addStickyDocumentEventHandler</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">addDocumentEventHandler</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">removeWindowEventHandler</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">removeDocumentEventHandler</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">getOriginalHandlers</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">fireDocumentEvent</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> data<span class="token punctuation">,</span> bNoDetach</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">fireWindowEvent</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">callbackId</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2000000000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">callbacks</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">callbackStatus</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">callbackSuccess</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">callbackId<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">callbackError</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">callbackId<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">callbackFromNative</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">callbackId<span class="token punctuation">,</span> isSuccess<span class="token punctuation">,</span> status<span class="token punctuation">,</span> args<span class="token punctuation">,</span> keepCallback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">addConstructor</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">func</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 暴露cordova对象给外部</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> cordova<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这里我们以 document Event 为例说明一下 cordova 模块中关于事件的处理：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 保存addEventListener、removeEventListener的原生实现</span>
<span class="token keyword">var</span> m_document_addEventListener <span class="token operator">=</span> document<span class="token punctuation">.</span>addEventListener<span class="token punctuation">;</span>
<span class="token keyword">var</span> m_document_removeEventListener <span class="token operator">=</span> document<span class="token punctuation">.</span>removeEventListener<span class="token punctuation">;</span>
<span class="token comment">// 缓存事件处理函数</span>
<span class="token keyword">var</span> documentEventHandlers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 重新定义addEventListener</span>
document<span class="token punctuation">.</span><span class="token function-variable function">addEventListener</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">evt<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> capture</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> e <span class="token operator">=</span> evt<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> documentEventHandlers<span class="token punctuation">[</span>e<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        documentEventHandlers<span class="token punctuation">[</span>e<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">m_document_addEventListener</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>document<span class="token punctuation">,</span> evt<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> capture<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 重新定义removeEventListener</span>
document<span class="token punctuation">.</span><span class="token function-variable function">removeEventListener</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">evt<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> capture</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> e <span class="token operator">=</span> evt<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// If unsubscribing from an event that is handled by a plugin</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> documentEventHandlers<span class="token punctuation">[</span>e<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">&quot;undefined&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        documentEventHandlers<span class="token punctuation">[</span>e<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">unsubscribe</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">m_document_removeEventListener</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>document<span class="token punctuation">,</span> evt<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> capture<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 创建 Event 对象</span>
<span class="token keyword">function</span> <span class="token function">createEvent</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> event <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createEvent</span><span class="token punctuation">(</span><span class="token string">'Events'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    event<span class="token punctuation">.</span><span class="token function">initEvent</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token keyword">in</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                event<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> event<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> codova <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token comment">// 创建事件通道</span>
    <span class="token function-variable function">addStickyDocumentEventHandler</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>documentEventHandlers<span class="token punctuation">[</span>event<span class="token punctuation">]</span> <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">createSticky</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">addDocumentEventHandler</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>documentEventHandlers<span class="token punctuation">[</span>event<span class="token punctuation">]</span> <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 取消事件通道</span>
    <span class="token function-variable function">removeDocumentEventHandler</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">delete</span> documentEventHandlers<span class="token punctuation">[</span>event<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 发布事件消息</span>
    <span class="token function-variable function">fireDocumentEvent</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> data<span class="token punctuation">,</span> bNoDetach</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> evt <span class="token operator">=</span> <span class="token function">createEvent</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> documentEventHandlers<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> bNoDetach <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                documentEventHandlers<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Fire deviceready on listeners that were registered before cordova.js was loaded.</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token string">'deviceready'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        document<span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    documentEventHandlers<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            document<span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> cordova<span class="token punctuation">;</span>
</code></pre></div><p>在初始化启动模块<code>cordova/init</code>中有这样的代码：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 注册pause、resume、deviceReady事件</span>
channel<span class="token punctuation">.</span>onPause <span class="token operator">=</span> cordova<span class="token punctuation">.</span><span class="token function">addDocumentEventHandler</span><span class="token punctuation">(</span><span class="token string">&quot;pause&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
channel<span class="token punctuation">.</span>onResume <span class="token operator">=</span> cordova<span class="token punctuation">.</span><span class="token function">addDocumentEventHandler</span><span class="token punctuation">(</span><span class="token string">&quot;resume&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
channel<span class="token punctuation">.</span>onActivated <span class="token operator">=</span> cordova<span class="token punctuation">.</span><span class="token function">addDocumentEventHandler</span><span class="token punctuation">(</span><span class="token string">&quot;activated&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
channel<span class="token punctuation">.</span>onDeviceReady <span class="token operator">=</span> cordova<span class="token punctuation">.</span><span class="token function">addStickyDocumentEventHandler</span><span class="token punctuation">(</span><span class="token string">&quot;deviceready&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 监听DOMContentLoaded事件并发布事件消息</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token string">&quot;complete&quot;</span> <span class="token operator">||</span> document<span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token string">&quot;interactive&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  channel<span class="token punctuation">.</span>onDOMContentLoaded<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
    <span class="token string">&quot;DOMContentLoaded&quot;</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      channel<span class="token punctuation">.</span>onDOMContentLoaded<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token boolean">false</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 原生层加载完成事件</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>_nativeReady<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  channel<span class="token punctuation">.</span>onNativeReady<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 加载完成发布时间事件消息</span>
channel<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  modulemapper<span class="token punctuation">.</span><span class="token function">mapModules</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>
  platform<span class="token punctuation">.</span>initialize <span class="token operator">&amp;&amp;</span> platform<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  channel<span class="token punctuation">.</span>onCordovaReady<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  channel<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;cordova&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fireDocumentEvent</span><span class="token punctuation">(</span><span class="token string">&quot;deviceready&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> channel<span class="token punctuation">.</span>deviceReadyChannelsArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> platformInitChannelsArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这里通过 addDocumentEventHandler 及 addStickyDocumentEventHandler 创建了事件通道，并通过 fireDocumentEvent 或者 fire 发布事件消息，这样我们就可以通过 document.addEventListener 订阅监听事件了。</p> <p>如果我们要创建一个自定义事件 Test,我们可以这样做：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 创建事件通道</span>
cordova<span class="token punctuation">.</span><span class="token function">addWindowEventHandler</span><span class="token punctuation">(</span><span class="token string">&quot;Test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 发布事件消息</span>
cordova<span class="token punctuation">.</span><span class="token function">fireWindowEvent</span><span class="token punctuation">(</span><span class="token string">&quot;Test&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">time</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 订阅事件消息</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;Test&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="参考">参考</h2> <p><a href="http://rensanning.iteye.com/blog/2163892" target="_blank" rel="noopener noreferrer">Cordova 3.x 入门 - 目录<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="http://www.cnblogs.com/linjisong/archive/2012/08/16/2642233.html" target="_blank" rel="noopener noreferrer">PhoneGap 源码分析<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="写在后面">写在后面</h2> <p>本文至此已经说完了 cordova 的模块机制和事件机制，已经 cordova 的工具模块，了解这些后写起插件来才能得心应手，对于原理实现部分不属于本文的范畴，下一篇会详细讲解 cordova 原理实现。敬请关注，不过近来在写毕设，估计一时半会儿也不会写完，本文前前后后已是拖了半个月。如果觉得本文对您有帮助，不妨打赏支持。</p> <div data-v-3bd334e8><p class="descript" data-v-3bd334e8>写这些代码也许就一两个小时的事，写一篇大家好接受的文章需要几天的酝酿，如果文章对您有帮助请我喝杯咖啡吧！</p> <img src="/supportme.png" class="pay-code" data-v-3bd334e8> <div data-v-3bd334e8><div id="container"></div></div> <div class="footer" data-v-4f0df4b0 data-v-3bd334e8><p data-v-4f0df4b0>站点总访问量： 站点总访客数：</p> <p data-v-4f0df4b0>博客内容遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" data-v-4f0df4b0>知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></p> <p data-v-4f0df4b0>赵梦欢 © 2015 - 2023</p></div></div></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.f3e141ba.js" defer></script><script src="/assets/js/69.162d06c4.js" defer></script><script src="/assets/js/18.c373a36e.js" defer></script><script src="/assets/js/34.124c31c0.js" defer></script>
  </body>
</html>
