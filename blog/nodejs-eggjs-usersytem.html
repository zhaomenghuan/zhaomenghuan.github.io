<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>基于 Egg.js 框架的 Node.js 服务构建之用户管理设计 | 匠心博客</title>
    <meta name="description" content="小青年,匠心,小青年博客,匠心博客,前端开发,android,技术宅,菜鸟教程,一个神奇的博客。">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.685c010a.css" as="style"><link rel="preload" href="/assets/js/app.f3e141ba.js" as="script"><link rel="preload" href="/assets/js/76.a9439343.js" as="script"><link rel="preload" href="/assets/js/18.c373a36e.js" as="script"><link rel="preload" href="/assets/js/34.124c31c0.js" as="script"><link rel="prefetch" href="/assets/js/1.1950ec81.js"><link rel="prefetch" href="/assets/js/10.7f857e71.js"><link rel="prefetch" href="/assets/js/100.e03c01d2.js"><link rel="prefetch" href="/assets/js/101.7b790a2f.js"><link rel="prefetch" href="/assets/js/102.a7aa77f9.js"><link rel="prefetch" href="/assets/js/103.d473991c.js"><link rel="prefetch" href="/assets/js/104.9fe8785c.js"><link rel="prefetch" href="/assets/js/105.7291ae49.js"><link rel="prefetch" href="/assets/js/106.2c35a2f4.js"><link rel="prefetch" href="/assets/js/107.a71ccb64.js"><link rel="prefetch" href="/assets/js/108.9d6f54a8.js"><link rel="prefetch" href="/assets/js/109.e77d12ca.js"><link rel="prefetch" href="/assets/js/11.5378ae65.js"><link rel="prefetch" href="/assets/js/12.9aca40f8.js"><link rel="prefetch" href="/assets/js/13.ce2b655c.js"><link rel="prefetch" href="/assets/js/14.7488ca24.js"><link rel="prefetch" href="/assets/js/15.9c07ac98.js"><link rel="prefetch" href="/assets/js/16.8f57294c.js"><link rel="prefetch" href="/assets/js/17.4f7ae4ec.js"><link rel="prefetch" href="/assets/js/19.c7be2474.js"><link rel="prefetch" href="/assets/js/2.7f7e5268.js"><link rel="prefetch" href="/assets/js/20.f8833113.js"><link rel="prefetch" href="/assets/js/21.e71dd521.js"><link rel="prefetch" href="/assets/js/22.92dc7b77.js"><link rel="prefetch" href="/assets/js/23.285557d3.js"><link rel="prefetch" href="/assets/js/24.a803551c.js"><link rel="prefetch" href="/assets/js/25.dbeaa19d.js"><link rel="prefetch" href="/assets/js/26.9ca97076.js"><link rel="prefetch" href="/assets/js/27.d1a2911b.js"><link rel="prefetch" href="/assets/js/28.25c216b3.js"><link rel="prefetch" href="/assets/js/29.9dc30af4.js"><link rel="prefetch" href="/assets/js/30.1e9d6e06.js"><link rel="prefetch" href="/assets/js/31.3d7dbe62.js"><link rel="prefetch" href="/assets/js/32.36371ba7.js"><link rel="prefetch" href="/assets/js/33.78edc66d.js"><link rel="prefetch" href="/assets/js/35.a5470008.js"><link rel="prefetch" href="/assets/js/36.acde7543.js"><link rel="prefetch" href="/assets/js/37.f6648812.js"><link rel="prefetch" href="/assets/js/38.1885784f.js"><link rel="prefetch" href="/assets/js/39.af4b4bbd.js"><link rel="prefetch" href="/assets/js/4.61024115.js"><link rel="prefetch" href="/assets/js/40.ec6e88a9.js"><link rel="prefetch" href="/assets/js/41.67d4e8b7.js"><link rel="prefetch" href="/assets/js/42.7de428af.js"><link rel="prefetch" href="/assets/js/43.b4f51fa8.js"><link rel="prefetch" href="/assets/js/44.487d119d.js"><link rel="prefetch" href="/assets/js/45.2206665b.js"><link rel="prefetch" href="/assets/js/46.125163cc.js"><link rel="prefetch" href="/assets/js/47.8722f507.js"><link rel="prefetch" href="/assets/js/48.b8bfe77f.js"><link rel="prefetch" href="/assets/js/49.77fac897.js"><link rel="prefetch" href="/assets/js/5.3395f0b5.js"><link rel="prefetch" href="/assets/js/50.d68289a2.js"><link rel="prefetch" href="/assets/js/51.d9d70556.js"><link rel="prefetch" href="/assets/js/52.6a2c9e02.js"><link rel="prefetch" href="/assets/js/53.ff13cf8b.js"><link rel="prefetch" href="/assets/js/54.7e844902.js"><link rel="prefetch" href="/assets/js/55.80aa3d86.js"><link rel="prefetch" href="/assets/js/56.a4124774.js"><link rel="prefetch" href="/assets/js/57.55eb7355.js"><link rel="prefetch" href="/assets/js/58.7d0e2bc5.js"><link rel="prefetch" href="/assets/js/59.9cdd695c.js"><link rel="prefetch" href="/assets/js/6.77e8533c.js"><link rel="prefetch" href="/assets/js/60.54318be9.js"><link rel="prefetch" href="/assets/js/61.82e1ea82.js"><link rel="prefetch" href="/assets/js/62.b065e499.js"><link rel="prefetch" href="/assets/js/63.bb770dde.js"><link rel="prefetch" href="/assets/js/64.996fdbfd.js"><link rel="prefetch" href="/assets/js/65.54f3baf3.js"><link rel="prefetch" href="/assets/js/66.38d28ab3.js"><link rel="prefetch" href="/assets/js/67.5cf5a3bc.js"><link rel="prefetch" href="/assets/js/68.f2418476.js"><link rel="prefetch" href="/assets/js/69.162d06c4.js"><link rel="prefetch" href="/assets/js/7.a2cd9d6c.js"><link rel="prefetch" href="/assets/js/70.80f1252b.js"><link rel="prefetch" href="/assets/js/71.970dda3c.js"><link rel="prefetch" href="/assets/js/72.a073c997.js"><link rel="prefetch" href="/assets/js/73.674106d1.js"><link rel="prefetch" href="/assets/js/74.a0336873.js"><link rel="prefetch" href="/assets/js/75.37fbb329.js"><link rel="prefetch" href="/assets/js/77.d52439f1.js"><link rel="prefetch" href="/assets/js/78.fbffcd6c.js"><link rel="prefetch" href="/assets/js/79.c6d73001.js"><link rel="prefetch" href="/assets/js/8.f0af9f9c.js"><link rel="prefetch" href="/assets/js/80.eab87966.js"><link rel="prefetch" href="/assets/js/81.9931436f.js"><link rel="prefetch" href="/assets/js/82.b29080c9.js"><link rel="prefetch" href="/assets/js/83.d94ed517.js"><link rel="prefetch" href="/assets/js/84.600be30f.js"><link rel="prefetch" href="/assets/js/85.a6938cc3.js"><link rel="prefetch" href="/assets/js/86.7dec6ed4.js"><link rel="prefetch" href="/assets/js/87.5d2c1dc9.js"><link rel="prefetch" href="/assets/js/88.8f2410d4.js"><link rel="prefetch" href="/assets/js/89.fe8c04e8.js"><link rel="prefetch" href="/assets/js/9.f542ab97.js"><link rel="prefetch" href="/assets/js/90.f25166a8.js"><link rel="prefetch" href="/assets/js/91.038ee701.js"><link rel="prefetch" href="/assets/js/92.19e610e0.js"><link rel="prefetch" href="/assets/js/93.22cd83c8.js"><link rel="prefetch" href="/assets/js/94.7495cfa6.js"><link rel="prefetch" href="/assets/js/95.f149c41d.js"><link rel="prefetch" href="/assets/js/96.cee91e1f.js"><link rel="prefetch" href="/assets/js/97.27a1bb57.js"><link rel="prefetch" href="/assets/js/98.67d4f125.js"><link rel="prefetch" href="/assets/js/99.35daa60c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.685c010a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">匠心博客</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/index.html" class="nav-link">博文</a></div><div class="nav-item"><a href="/book/index.html" class="nav-link">专栏</a></div><div class="nav-item"><a href="/note/index.html" class="nav-link">笔记</a></div><div class="nav-item"><a href="/nav/index.html" class="nav-link">导航</a></div><div class="nav-item"><a href="/about/index.html" class="nav-link">关于</a></div> <a href="https://github.com/zhaomenghuan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/index.html" class="nav-link">博文</a></div><div class="nav-item"><a href="/book/index.html" class="nav-link">专栏</a></div><div class="nav-item"><a href="/note/index.html" class="nav-link">笔记</a></div><div class="nav-item"><a href="/nav/index.html" class="nav-link">导航</a></div><div class="nav-item"><a href="/about/index.html" class="nav-link">关于</a></div> <a href="https://github.com/zhaomenghuan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>基于 Egg.js 框架的 Node.js 服务构建之用户管理设计</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/nodejs-eggjs-usersytem.html#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/nodejs-eggjs-usersytem.html#为什么是-egg-js-？" class="sidebar-link">为什么是 Egg.js ？</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/nodejs-eggjs-usersytem.html#orm-设计选型" class="sidebar-link">ORM 设计选型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/nodejs-eggjs-usersytem.html#什么是-orm" class="sidebar-link">什么是 ORM ?</a></li><li class="sidebar-sub-header"><a href="/blog/nodejs-eggjs-usersytem.html#sequelize-框架" class="sidebar-link">sequelize 框架</a></li><li class="sidebar-sub-header"><a href="/blog/nodejs-eggjs-usersytem.html#egg-sequelize-插件" class="sidebar-link">egg-sequelize 插件</a></li></ul></li><li><a href="/blog/nodejs-eggjs-usersytem.html#用户认证选型" class="sidebar-link">用户认证选型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/nodejs-eggjs-usersytem.html#json-web-token（jwt）规范" class="sidebar-link">JSON Web Token（JWT）规范</a></li><li class="sidebar-sub-header"><a href="/blog/nodejs-eggjs-usersytem.html#egg-jwt-插件" class="sidebar-link">egg-jwt 插件</a></li></ul></li><li><a href="/blog/nodejs-eggjs-usersytem.html#后记" class="sidebar-link">后记</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/nodejs-eggjs-usersytem.html#参考" class="sidebar-link">参考</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="基于-egg-js-框架的-node-js-服务构建之用户管理设计">基于 Egg.js 框架的 Node.js 服务构建之用户管理设计</h1> <h2 id="前言">前言</h2> <p>近来公司需要构建一套 EMM（Enterprise Mobility Management）的管理平台，就这种面向企业的应用管理本身需要考虑的需求是十分复杂的，技术层面管理端和服务端构建是架构核心，客户端本身初期倒不需要那么复杂，作为<s>移动端的负责人</s>（其实也就是一个打杂的小组长），这个平台架构我自然是免不了去参与的，作为一个前端 jser 来公司这边总是接到这种不太像前端的工作，要是以前我可能会有些抵触这种业务层面需要考虑的很多，技术实现本身又不太容易积累技术成长的活。这一年我成长了太多，总是尝试着去做一些可能自己谈不上喜欢但还是有意义的事情，所以这次接手这个任务还是想好好把这个事情做好，所以想考虑参与到 EMM 服务端构建。其实话又说回来，任何事只要想去把它做好，怎么会存在有意义还是没意义的区别呢？</p> <p>考虑到基于 Node.js 构建的服务目前越来越流行，也方便后续放在平台容器云上构建微服务，另外作为一个前端 jser 出身的程序员，使用 Node.js 来构建服务格外熟悉。之前学习过一段时间 Egg.js，这次毫不犹豫的选择了基于 Egg.js 框架来搭建。</p> <h2 id="为什么是-egg-js-？">为什么是 Egg.js ？</h2> <p>去年在 gitchat <a href="http://gitbook.cn/books/598144f5e64f69311fe1a813/index.html" target="_blank" rel="noopener noreferrer">JavaScript 进阶之 Vue.js + Node.js 入门实战开发<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中安利过 Egg.js，那个时候是初接触 Egg.js，但是还是被它惊艳到了，<strong>Egg 继承于 Koa，奉行『约定优于配置』，按照一套统一的约定进行应用开发，插件机制也比较完善</strong>。虽然说 Egg 继承于 Koa，大家可能觉得完全可以自己基于 Koa 去实现一套，没必要基于这个框架去搞，但是其实自己去设计一套这样的框架，最终也是需要去借鉴各家所长，时间成本上短期是划不来的。Koa 是一个小而精的框架，而 Egg 正如文档说的<strong>为企业级框架和应用而生</strong>，对于我们快速搭建一个完备的企业级应用还是很方便的。Egg 功能已经比较完善，另外如果没有实现的功能，自己根据 Koa 社区提供的插件封装一下也是不难的。</p> <h2 id="orm-设计选型">ORM 设计选型</h2> <p>在数据库选择上本次项目考虑使用 MySQL，而不是 MongoDB，开始使用的是 egg-mysql 插件，写了一部分后发现 service 里面写了太多东西，表字段修改会影响太多代码，在设计上缺乏对 Model 的管理，看到资料说可以引入 ORM 框架，比如 sequelize，而 Egg 官方恰好提供了 egg-sequelize 插件。</p> <h3 id="什么是-orm">什么是 ORM ?</h3> <p>首先了解一下什么是 ORM ?</p> <blockquote><p>对象关系映射（英语：Object Relational Mapping，简称 ORM，或 O/RM，或 O/R mapping），是一种程序设计技术，用于实现面向对象编程语言里不同类型系统的数据之间的转换。从效果上说，它其实是创建了一个可在编程语言里使用的“虚拟对象数据库”。</p></blockquote> <p>类似于 J2EE 中的 DAO 设计模式，将程序中的数据对象自动地转化为关系型数据库中对应的表和列，数据对象间的引用也可以通过这个工具转化为表。这样就可以很好的解决我遇到的那个问题，对于表结构修改和数据对象操作是两个独立的部分，从而使得代码更好维护。其实是否选择 ORM 框架，和以前前端是选择模板引擎还是手动拼字符串一样，ORM 框架避免了在开发的时候手动拼接 SQL 语句，可以防止 SQL 注入，另外也将数据库和数据 CRUD 解耦，更换数据库也相对更容易。</p> <h3 id="sequelize-框架">sequelize 框架</h3> <p>sequelize 是 Node.js 社区比较流行的一个 ORM 框架，相关文档：</p> <ul><li>sequelize.js 文档：<a href="http://docs.sequelizejs.com/" target="_blank" rel="noopener noreferrer">http://docs.sequelizejs.com/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h4 id="sequelize-使用">sequelize 使用</h4> <p><strong>安装：</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>$ npm install <span class="token operator">--</span>save sequelize
</code></pre></div><p><strong>建立连接：</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Sequelize <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;sequelize&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 完整用法</span>
<span class="token keyword">const</span> sequelize <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sequelize</span><span class="token punctuation">(</span><span class="token string">&quot;database&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;username&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;password&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">dialect</span><span class="token operator">:</span> <span class="token string">&quot;mysql&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;sqlite&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;postgres&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;mssql&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">operatorsAliases</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token literal-property property">pool</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">max</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token literal-property property">min</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token literal-property property">acquire</span><span class="token operator">:</span> <span class="token number">30000</span><span class="token punctuation">,</span>
    <span class="token literal-property property">idle</span><span class="token operator">:</span> <span class="token number">10000</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// SQLite only</span>
  <span class="token literal-property property">storage</span><span class="token operator">:</span> <span class="token string">&quot;path/to/database.sqlite&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 简单用法</span>
<span class="token keyword">const</span> sequelize <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sequelize</span><span class="token punctuation">(</span><span class="token string">&quot;postgres://user:pass@example.com:5432/dbname&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>校验连接是否正确：</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>sequelize
  <span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Connection has been established successfully.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to connect to the database:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>定义 Model ：</strong></p> <p>定义一个 Model 的基本语法：</p> <div class="language-js extra-class"><pre class="language-js"><code>sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> attributes <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> options <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>例如：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> User <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>对于一个 Model 字段类型设计，主要考虑以下几个方面：</p> <p>Sequelize 默认会添加 createdAt 和 updatedAt，这样可以很方便的知道数据创建和更新的时间。如果不想使用可以通过设置 attributes 的 timestamps: false；</p> <p>Sequelize 支持丰富的数据类型，例如：STRING、CHAR、TEXT、INTEGER、FLOAT、DOUBLE、BOOLEAN、DATE、UUID
、JSON 等多种不同的数据类型，具体可以看文档：<a href="http://docs.sequelizejs.com/variable/index.html#static-variable-DataTypes" target="_blank" rel="noopener noreferrer">DataTypes<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>Getters &amp; setters 支持，当我们需要对字段进行处理的时候十分有用，例如：对字段值大小写转换处理。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Employee <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;employee&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
    <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> title <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDataValue</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDataValue</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; (&quot;</span> <span class="token operator">+</span> title <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
    <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token function">set</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setDataValue</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span> val<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>字段校验有两种类型：非空校验及类型校验，Sequelize 中非空校验通过字段的 allowNull 属性判定，类型校验是通过 validate 进行判定，底层是通过 <a href="https://github.com/chriso/validator.js" target="_blank" rel="noopener noreferrer">validator.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 实现的。如果模型的特定字段设置为允许 null（allowNull：true），并且该值已设置为 null，则 validate 属性不生效。例如，有一个字符串字段，allowNull 设置为 true，validate 验证其长度至少为 5 个字符，但也允许为空。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> ValidateMe <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
    <span class="token literal-property property">validate</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">is</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;^[a-z]+$&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;i&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// will only allow letters</span>
      <span class="token literal-property property">is</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[a-z]+$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">,</span> <span class="token comment">// same as the previous example using real RegExp</span>
      <span class="token literal-property property">not</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;[a-z]&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;i&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// will not allow letters</span>
      <span class="token literal-property property">isEmail</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// checks for email format (foo@bar.com)</span>
      <span class="token literal-property property">isUrl</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// checks for url format (http://foo.com)</span>
      <span class="token literal-property property">isIP</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// checks for IPv4 (129.89.23.1) or IPv6 format</span>
      <span class="token literal-property property">isIPv4</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// checks for IPv4 (129.89.23.1)</span>
      <span class="token literal-property property">isIPv6</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// checks for IPv6 format</span>
      <span class="token literal-property property">isAlpha</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// will only allow letters</span>
      <span class="token literal-property property">isAlphanumeric</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// will only allow alphanumeric characters, so &quot;_abc&quot; will fail</span>
      <span class="token literal-property property">isNumeric</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// will only allow numbers</span>
      <span class="token literal-property property">isInt</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// checks for valid integers</span>
      <span class="token literal-property property">isFloat</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// checks for valid floating point numbers</span>
      <span class="token literal-property property">isDecimal</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// checks for any numbers</span>
      <span class="token literal-property property">isLowercase</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// checks for lowercase</span>
      <span class="token literal-property property">isUppercase</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// checks for uppercase</span>
      <span class="token literal-property property">notNull</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// won't allow null</span>
      <span class="token literal-property property">isNull</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// only allows null</span>
      <span class="token literal-property property">notEmpty</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// don't allow empty strings</span>
      <span class="token literal-property property">equals</span><span class="token operator">:</span> <span class="token string">&quot;specific value&quot;</span><span class="token punctuation">,</span> <span class="token comment">// only allow a specific value</span>
      <span class="token literal-property property">contains</span><span class="token operator">:</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span> <span class="token comment">// force specific substrings</span>
      <span class="token literal-property property">notIn</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// check the value is not one of these</span>
      <span class="token literal-property property">isIn</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// check the value is one of these</span>
      <span class="token literal-property property">notContains</span><span class="token operator">:</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">,</span> <span class="token comment">// don't allow specific substrings</span>
      <span class="token literal-property property">len</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// only allow values with length between 2 and 10</span>
      <span class="token literal-property property">isUUID</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token comment">// only allow uuids</span>
      <span class="token literal-property property">isDate</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// only allow date strings</span>
      <span class="token literal-property property">isAfter</span><span class="token operator">:</span> <span class="token string">&quot;2011-11-05&quot;</span><span class="token punctuation">,</span> <span class="token comment">// only allow date strings after a specific date</span>
      <span class="token literal-property property">isBefore</span><span class="token operator">:</span> <span class="token string">&quot;2011-11-05&quot;</span><span class="token punctuation">,</span> <span class="token comment">// only allow date strings before a specific date</span>
      <span class="token literal-property property">max</span><span class="token operator">:</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token comment">// only allow values &lt;= 23</span>
      <span class="token literal-property property">min</span><span class="token operator">:</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token comment">// only allow values &gt;= 23</span>
      <span class="token literal-property property">isCreditCard</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// check for valid credit card numbers</span>

      <span class="token comment">// custom validations are also possible:</span>
      <span class="token function">isEven</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Only even values are allowed!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// we also are in the model's context here, so this.otherField</span>
          <span class="token comment">// would get the value of otherField if it existed</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>最后我们说明一个最重要的字段<strong>主键 id</strong> 的设计， 需要通过字段 <code>primaryKey: true</code> 指定为主键。MySQL 里面主键设计主要有两种方式：<strong>自动递增</strong>；<strong>UUID</strong>。</p> <p>自动递增设置 <code>autoIncrement: true</code> 即可，对于一般的小型系统这种方式是最方便，查询效率最高的，但是这种不利于分布式集群部署，这种基本用过 MySQL 里面应用都用过，这里不做深入讨论。</p> <p>UUID, 又名全球独立标识(Globally Unique Identifier)，UUID 是 128 位(长度固定)unsigned integer, 能够保证在空间(Space)与时间(Time)上的唯一性。而且无需注册机制保证, 可以按需随时生成。据 WIKI, 随机算法生成的 UUID 的重复概率为 170 亿分之一。Sequelize 数据类型中有 UUID，UUID1，UUID4 三种类型，基于<a href="https://github.com/kelektiv/node-uuid" target="_blank" rel="noopener noreferrer">node-uuid<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 遵循 <a href="http://www.ietf.org/rfc/rfc4122.txt" target="_blank" rel="noopener noreferrer">RFC4122<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。例如：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> User <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">UUID</span><span class="token punctuation">,</span>
    <span class="token literal-property property">primaryKey</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token literal-property property">defaultValue</span><span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">UUID1</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这样 id 默认值生成一个 uuid 字符串，例如：'1c572360-faca-11e7-83ee-9d836d45ff41'，很多时候我们不太想要这个 <code>-</code> 字符，我们可以通过设置 defaultValue 实现，例如：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> uuidv1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;uuid/v1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> User <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">UUID</span><span class="token punctuation">,</span>
    <span class="token literal-property property">primaryKey</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token function-variable function">defaultValue</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">uuidv1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">-</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>使用 Model 对象：</strong></p> <p>对于 Model 对象操作，Sequelize 提供了一系列的方法：</p> <ul><li>find：搜索数据库中的一个特定元素，可以通过 findById 或 findOne；</li> <li>findOrCreate：搜索特定元素或在不可用时创建它；</li> <li>findAndCountAll：搜索数据库中的多个元素，返回数据和总数；</li> <li>findAll：在数据库中搜索多个元素；</li> <li>复杂的过滤/ OR / NOT 查询；</li> <li>使用 limit(限制)，offset(偏移量)，order(顺序)和 group(组)操作数据集;</li> <li>count：计算数据库中元素的出现次数；</li> <li>max：获取特定表格中特定属性的最大值；</li> <li>min：获取特定表格中特定属性的最小值；</li> <li>sum：特定属性的值求和；</li> <li>create：创建数据库 Model 实例；</li> <li>update：更新数据库 Model 实例；</li> <li>destroy：销毁数据库 Model 实例。</li></ul> <p>通过上述提供的一系列方法可以实现数据的增删改查（CRUD），例如：</p> <div class="language-js extra-class"><pre class="language-js"><code>User<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">&quot;fnord&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">job</span><span class="token operator">:</span> <span class="token string">&quot;omnomnom&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    User<span class="token punctuation">.</span><span class="token function">findOrCreate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">&quot;fnord&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">defaults</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">job</span><span class="token operator">:</span> <span class="token string">&quot;something else&quot;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">spread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">,</span> created</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
      user<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">plain</span><span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>created<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*
    In this example, findOrCreate returns an array like this:
    [ {
        username: 'fnord',
        job: 'omnomnom',
        id: 2,
        createdAt: Fri Mar 22 2013 21: 28: 34 GMT + 0100(CET),
        updatedAt: Fri Mar 22 2013 21: 28: 34 GMT + 0100(CET)
      },
      false
    ]
    */</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="egg-sequelize-插件">egg-sequelize 插件</h3> <p>文档：egg-sequelize：<a href="https://github.com/eggjs/egg-sequelize" target="_blank" rel="noopener noreferrer">https://github.com/eggjs/egg-sequelize<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h5 id="源码简析">源码简析</h5> <p>这里我们暂时先不分析 egg 插件规范，暂时先只看看 egg-sequelize/lib/loader.js 里面的实现：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Sequelize <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;sequelize&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">MODELS</span> <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">&quot;loadedModels&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> chalk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;chalk&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Sequelize</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">log</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>logging <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> sql <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">Executed \(.+?\):\s{0,1}</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>logging<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[model]&quot;</span><span class="token punctuation">,</span> chalk<span class="token punctuation">.</span><span class="token function">magenta</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> defaultConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">logging</span><span class="token operator">:</span> app<span class="token punctuation">.</span>logger<span class="token punctuation">,</span>
    <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">3306</span><span class="token punctuation">,</span>
    <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">benchmark</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">define</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">freezeTableName</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token literal-property property">underscored</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> config <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>defaultConfig<span class="token punctuation">,</span> app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>sequelize<span class="token punctuation">)</span><span class="token punctuation">;</span>

  app<span class="token punctuation">.</span>Sequelize <span class="token operator">=</span> Sequelize<span class="token punctuation">;</span>

  <span class="token keyword">const</span> sequelize <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sequelize</span><span class="token punctuation">(</span>
    config<span class="token punctuation">.</span>database<span class="token punctuation">,</span>
    config<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
    config<span class="token punctuation">.</span>password<span class="token punctuation">,</span>
    config
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// app.sequelize</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token string">&quot;model&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> sequelize<span class="token punctuation">,</span>
    <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">loadModel</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

  app<span class="token punctuation">.</span><span class="token function">beforeStart</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">yield</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">loadModel</span><span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> modelDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>baseDir<span class="token punctuation">,</span> <span class="token string">&quot;app/model&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span>loader<span class="token punctuation">.</span><span class="token function">loadToApp</span><span class="token punctuation">(</span>modelDir<span class="token punctuation">,</span> <span class="token constant">MODELS</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">inject</span><span class="token operator">:</span> app<span class="token punctuation">,</span>
    <span class="token literal-property property">caseStyle</span><span class="token operator">:</span> <span class="token string">&quot;upper&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">ignore</span><span class="token operator">:</span> <span class="token string">&quot;index.js&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> name <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>app<span class="token punctuation">[</span><span class="token constant">MODELS</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> klass <span class="token operator">=</span> app<span class="token punctuation">[</span><span class="token constant">MODELS</span><span class="token punctuation">]</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// only this Sequelize Model class</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;sequelize&quot;</span> <span class="token keyword">in</span> klass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      app<span class="token punctuation">.</span>model<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> klass<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token string">&quot;classMethods&quot;</span> <span class="token keyword">in</span> klass<span class="token punctuation">.</span>options <span class="token operator">||</span>
        <span class="token string">&quot;instanceMethods&quot;</span> <span class="token keyword">in</span> klass<span class="token punctuation">.</span>options
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        app<span class="token punctuation">.</span>logger
          <span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> model has classMethods/instanceMethods, but it was removed supports in Sequelize V4.\
see: http://docs.sequelizejs.com/manual/tutorial/models-definition.html#expansion-of-models</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> name <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>app<span class="token punctuation">[</span><span class="token constant">MODELS</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> klass <span class="token operator">=</span> app<span class="token punctuation">[</span><span class="token constant">MODELS</span><span class="token punctuation">]</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;associate&quot;</span> <span class="token keyword">in</span> klass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      klass<span class="token punctuation">.</span><span class="token function">associate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>很明显在插件初始化的时候进行了 Sequelize 对象的实例化，并将 Sequelize 对象挂载在 app 对象下，即我们可以通过 app.Sequelize 访问 Sequelize 对象，同时我们可以通过 app.model 对 Sequelize 实例化进行访问，app/model 文件夹下存放 model 对象文件。</p> <h5 id="用户-model-设计">用户 Model 设计</h5> <p>这里我们以 egg-sequelize 的使用为例加以说明。</p> <p><strong>安装：</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> i <span class="token parameter variable">--save</span> egg-sequelize
$ <span class="token function">npm</span> <span class="token function">install</span> <span class="token parameter variable">--save</span> mysql2 <span class="token comment"># For both mysql and mariadb dialects</span>
</code></pre></div><p><strong>配置：</strong></p> <p>app/config/plugin.js 配置：</p> <div class="language-js extra-class"><pre class="language-js"><code>exports<span class="token punctuation">.</span>sequelize <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">enable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token keyword">package</span><span class="token operator">:</span> <span class="token string">&quot;egg-sequelize&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>app/config/config.default.js 配置：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 数据库信息配置</span>
exports<span class="token punctuation">.</span>sequelize <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 数据库类型</span>
  <span class="token literal-property property">dialect</span><span class="token operator">:</span> <span class="token string">&quot;mysql&quot;</span><span class="token punctuation">,</span>
  <span class="token comment">// host</span>
  <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span>
  <span class="token comment">// 端口号</span>
  <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token string">&quot;3306&quot;</span><span class="token punctuation">,</span>
  <span class="token comment">// 用户名</span>
  <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span>
  <span class="token comment">// 密码</span>
  <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">&quot;xxx&quot;</span><span class="token punctuation">,</span>
  <span class="token comment">// 数据库名</span>
  <span class="token literal-property property">database</span><span class="token operator">:</span> <span class="token string">&quot;AEMM&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>Model 层：</strong></p> <p>直接使用 Sequelize 虽然可以，但是存在一些问题。团队开发时，有人喜欢自己加 timestamp，有人又喜欢自增主键，并且自定义表名。一个大型 Web App 通常都有几十个映射表，一个映射表就是一个 Model。如果按照各自喜好，那业务代码就不好写。Model 不统一，很多代码也无法复用。所以我们需要一个统一的模型，强迫所有 Model 都遵守同一个规范，这样不但实现简单，而且容易统一风格。</p> <p>我们首先要定义的就是 Model 存放的文件夹必须在 models 内，并且以 Model 名字命名，例如：Pet.js，User.js 等等。其次，每个 Model 必须遵守一套规范：</p> <ul><li>统一主键，名称必须是 id，类型必须是 UUID；</li> <li>所有字段默认为 NULL，除非显式指定；</li> <li>统一 timestamp 机制，每个 Model 必须有 createdAt、updatedAt 和 version，分别记录创建时间、修改时间和版本号。</li></ul> <p>所以，我们不要直接使用 Sequelize 的 API，而是通过 db.js 间接地定义 Model。例如，User.js 应该定义如下：</p> <p>app/db.js：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> uuidv1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;uuid/v1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">generateUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">uuidv1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">-</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">defineModel</span><span class="token punctuation">(</span><span class="token parameter">app<span class="token punctuation">,</span> name<span class="token punctuation">,</span> attributes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">UUID</span> <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>Sequelize<span class="token punctuation">;</span>

  <span class="token keyword">let</span> attrs <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> value <span class="token operator">=</span> attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">[</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      value<span class="token punctuation">.</span>allowNull <span class="token operator">=</span> value<span class="token punctuation">.</span>allowNull <span class="token operator">||</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      attrs<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      attrs<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> value<span class="token punctuation">,</span>
        <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  attrs<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">UUID</span><span class="token punctuation">,</span>
    <span class="token literal-property property">primaryKey</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">defaultValue</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">generateUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">createdAt</span><span class="token operator">:</span> <span class="token string">&quot;createdAt&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">updatedAt</span><span class="token operator">:</span> <span class="token string">&quot;updatedAt&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">version</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">freezeTableName</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> defineModel <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>我们定义的 defineModel 就是为了强制实现上述规则。</p> <p>app/model/User.js：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">DATE</span><span class="token punctuation">,</span> <span class="token constant">BOOLEAN</span> <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>Sequelize<span class="token punctuation">;</span>

  <span class="token keyword">const</span> User <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">defineModel</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token string">&quot;users&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token literal-property property">unique</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 用户名</span>
    <span class="token literal-property property">email</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token literal-property property">unique</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 邮箱</span>
    <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 密码</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token comment">// 姓名</span>
    <span class="token literal-property property">sex</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token comment">// 用户性别：1男性, 2女性, 0未知</span>
    <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token comment">// 年龄</span>
    <span class="token literal-property property">avatar</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token comment">// 头像</span>
    <span class="token literal-property property">company</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token comment">// 公司</span>
    <span class="token literal-property property">department</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token comment">// 部门</span>
    <span class="token literal-property property">telePhone</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token comment">// 联系电话</span>
    <span class="token literal-property property">mobilePhone</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token comment">// 手机号码</span>
    <span class="token literal-property property">info</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token comment">// 备注说明</span>
    <span class="token literal-property property">roleId</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token comment">// 角色id</span>
    <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token comment">// 用户状态</span>
    <span class="token literal-property property">token</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token comment">// 认证 token</span>
    <span class="token literal-property property">lastSignInAt</span><span class="token operator">:</span> <span class="token constant">DATE</span> <span class="token comment">// 上次登录时间</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> User<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>在数据库操作设计中，我们一般是通过脚本提前生成表结构，如果手动写创建表的 SQL，每次修改表结构其实是一件麻烦事。Sequelize 提供了<a href="http://docs.sequelizejs.com/manual/tutorial/migrations.html" target="_blank" rel="noopener noreferrer">Migrations<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 帮助创建或迁移数据库，egg-sequelize 里面也提供了方便的方法。如果是开发阶段，可以使用下面的方法自动执行：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// {app_root}/app.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>env <span class="token operator">===</span> <span class="token string">&quot;local&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    app<span class="token punctuation">.</span><span class="token function">beforeStart</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">yield</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">force</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>当然也可以在 package.json 里面添加下面的脚本：</p> <table><thead><tr><th style="text-align:center">命令</th> <th style="text-align:center">说明</th></tr></thead> <tbody><tr><td style="text-align:center">npm run migrate:new</td> <td style="text-align:center">在 ./migrations/ 中创建一个 迁移文件 to</td></tr> <tr><td style="text-align:center">npm run migrate:up</td> <td style="text-align:center">执行迁移</td></tr> <tr><td style="text-align:center">npm run migrate:down</td> <td style="text-align:center">回滚一次迁移</td></tr></tbody></table> <p>package.json：</p> <div class="language-json extra-class"><pre class="language-json"><code>...
<span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">&quot;migrate:new&quot;</span><span class="token operator">:</span> <span class="token string">&quot;egg-sequelize migration:create --name init&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;migrate:up&quot;</span><span class="token operator">:</span> <span class="token string">&quot;egg-sequelize db:migrate&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;migrate:down&quot;</span><span class="token operator">:</span> <span class="token string">&quot;egg-sequelize db:migrate:undo&quot;</span>
<span class="token punctuation">}</span>
...
</code></pre></div><p>执行 npm run migrate:new 后修改 migrations 文件夹下的文件：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">UUID</span><span class="token punctuation">,</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">DATE</span><span class="token punctuation">,</span> <span class="token constant">BOOLEAN</span> <span class="token punctuation">}</span> <span class="token operator">=</span> Sequelize<span class="token punctuation">;</span>

    <span class="token keyword">await</span> queryInterface<span class="token punctuation">.</span><span class="token function">createTable</span><span class="token punctuation">(</span><span class="token string">&quot;users&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">UUID</span><span class="token punctuation">,</span>
        <span class="token literal-property property">primaryKey</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 用户 ID（主键）</span>
      <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> 
        <span class="token literal-property property">unique</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> 
        <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span> 
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 用户名</span>
      <span class="token literal-property property">email</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> 
        <span class="token literal-property property">unique</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> 
        <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 邮箱</span>
      <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> 
        <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span> 
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 登录密码</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token comment">// 姓名</span>
      <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token comment">// 用户年龄</span>
      <span class="token literal-property property">info</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token comment">// 备注说明</span>
      <span class="token literal-property property">sex</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token comment">// 用户性别：1男性, 2女性, 0未知</span>
      <span class="token literal-property property">telePhone</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token comment">// 联系电话</span>
      <span class="token literal-property property">mobilePhone</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token comment">// 手机号码</span>
      <span class="token literal-property property">roleId</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token comment">// 角色ID</span>
      <span class="token literal-property property">location</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token comment">// 常住地</span>
      <span class="token literal-property property">avatar</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token comment">// 头像</span>
      <span class="token literal-property property">company</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token comment">// 公司</span>
      <span class="token literal-property property">department</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token comment">// 部门</span>
      <span class="token literal-property property">emailVerified</span><span class="token operator">:</span> <span class="token constant">BOOLEAN</span><span class="token punctuation">,</span> <span class="token comment">// 邮箱验证</span>
      <span class="token literal-property property">token</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token comment">// 身份认证令牌</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 用户状态：1启用, 0禁用, 2隐藏, 3删除</span>
      <span class="token literal-property property">createdAt</span><span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span> <span class="token comment">// 用户创建时间</span>
      <span class="token literal-property property">updatedAt</span><span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span> <span class="token comment">// 用户信息更新时间</span>
      <span class="token literal-property property">lastSignInAt</span><span class="token operator">:</span> <span class="token constant">DATE</span> <span class="token comment">// 上次登录时间</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token keyword">async</span> <span class="token function">down</span><span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> queryInterface<span class="token punctuation">.</span><span class="token function">dropTable</span><span class="token punctuation">(</span><span class="token string">&quot;users&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="用户认证选型">用户认证选型</h2> <p>所谓用户认证（Authentication），就是让用户登录，并且在接下来的一段时间内让用户访问网站时可以使用其账户，而不需要再次登录的机制。</p> <blockquote><p>小知识：可别把用户认证和用户授权（Authorization）搞混了。用户授权指的是规定并允许用户使用自己的权限，例如发布帖子、管理站点等。</p></blockquote> <p>用户认证主要分为两个部分：</p> <ul><li>用户通过用户名和密码登录生成并且获取 Token；</li> <li>用户通过 Token 验证用户身份获取相关信息。</li></ul> <h3 id="json-web-token（jwt）规范">JSON Web Token（JWT）规范</h3> <p><a href="https://jwt.io/" target="_blank" rel="noopener noreferrer">JSON Web Token<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（JWT）是一个非常轻巧的<a href="https://tools.ietf.org/html/draft-ietf-oauth-json-web-token-32" target="_blank" rel="noopener noreferrer">规范<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。这个规范允许我们使用 JWT 在用户和服务器之间传递安全可靠的信息。</p> <h4 id="jwt-的组成">JWT 的组成</h4> <p>一个 JWT 实际上就是一个字符串，它由三部分组成，头部、载荷与签名。</p> <p><strong>头部（Header）</strong></p> <p>JWT 需要一个头部，头部用于描述关于该 JWT 的最基本的信息，例如其类型以及签名所用的算法等。这也可以被表示成一个 JSON 对象。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;typ&quot;</span><span class="token operator">:</span> <span class="token string">&quot;JWT&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;alg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HS256&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在这里，我们说明了这是一个 JWT，并且我们所用的签名算法是 HS256 算法。对它也要进行 Base64 编码，之后的字符串就成了 JWT 的 Header（头部）。</p> <div class="language- extra-class"><pre class="language-text"><code>eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9
</code></pre></div><p>这里我们使用 base64url 模块进行 Base64 编码来得到这个字符串，测试代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> base64url <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;base64url&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> header <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">typ</span><span class="token operator">:</span> <span class="token string">&quot;JWT&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">alg</span><span class="token operator">:</span> <span class="token string">&quot;HS256&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;header: &quot;</span> <span class="token operator">+</span> <span class="token function">base64url</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// header: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9</span>
</code></pre></div><blockquote><p>小知识：Base64 是一种编码，也就是说，它是可以被翻译回原来的样子来的。它并不是一种加密过程。</p></blockquote> <p><strong>载荷（Payload）</strong></p> <p>说白了就是我们需要包含的数据，类似于网络请求的请求体 body，例如：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;iss&quot;</span><span class="token operator">:</span> <span class="token string">&quot;zhaomenghaun&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;sub&quot;</span><span class="token operator">:</span> <span class="token string">&quot;*@agree.com.cn&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;aud&quot;</span><span class="token operator">:</span> <span class="token string">&quot;www.agree.com.cn&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;exp&quot;</span><span class="token operator">:</span> <span class="token number">1526875179</span><span class="token punctuation">,</span>
  <span class="token property">&quot;iat&quot;</span><span class="token operator">:</span> <span class="token number">1526871579</span><span class="token punctuation">,</span>
  <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;49a9dd505c9d11e8b5e86b9776bb3c4f&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里面的前五个字段都是由 JWT 的标准所定义的。</p> <ul><li>iss: 该 JWT 的签发者</li> <li>sub: 该 JWT 所面向的用户</li> <li>aud: 接收该 JWT 的一方</li> <li>exp(expires): 什么时候过期，这里是一个 Unix 时间戳</li> <li>iat(issued at): 在什么时候签发的</li></ul> <p>将下面的 JSON 对象进行<strong>base64 编码</strong>可以得到下面的字符串，这个字符串我们将它称作 JWT 的 Payload（载荷）。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> base64url <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;base64url&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> payload <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">&quot;49a9dd505c9d11e8b5e86b9776bb3c4f&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">iat</span><span class="token operator">:</span> <span class="token number">1526871579</span><span class="token punctuation">,</span>
  <span class="token literal-property property">exp</span><span class="token operator">:</span> <span class="token number">1526875179</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;payload: &quot;</span> <span class="token operator">+</span> <span class="token function">base64url</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// payload: eyJpZCI6IjQ5YTlkZDUwNWM5ZDExZThiNWU4NmI5Nzc2YmIzYzRmIiwiaWF0IjoxNTI2ODcxNTc5LCJleHAiOjE1MjY4NzUxNzl9</span>
</code></pre></div><p><strong>签名（Signature）</strong></p> <p>将上面的两个编码后的字符串都用句号.连接在一起（头部在前），就形成了:</p> <div class="language- extra-class"><pre class="language-text"><code>eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpZCI6IjQ5YTlkZDUwNWM5ZDExZThiNWU4NmI5Nzc2YmIzYzRmIiwiaWF0IjoxNTI2ODcxNTc5LCJleHAiOjE1MjY4NzUxNzl9
</code></pre></div><p>最后，我们将上面拼接完的字符串用 HS256 算法进行加密。在加密的时候，我们还需要提供一个密钥（secret）。我们可以使用 <a href="https://github.com/brianloveswords/node-jwa" target="_blank" rel="noopener noreferrer">node-jwa<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 进行 HS256 算法加密。如果我们用 123456 作为密钥的话，那么就可以得到我们加密后的内容，这一部分又叫做签名。最后一步签名的过程，实际上是对头部以及载荷内容进行签名。</p> <p><img src="https://blog.leapoahead.com/2015/09/06/understanding-jwt/sig1.png" alt></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> jwa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;jwa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> hmac <span class="token operator">=</span> <span class="token function">jwa</span><span class="token punctuation">(</span><span class="token string">&quot;HS256&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> secret <span class="token operator">=</span> <span class="token string">&quot;123456&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> signature <span class="token operator">=</span> hmac<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>
  <span class="token string">&quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpZCI6IjQ5YTlkZDUwNWM5ZDExZThiNWU4NmI5Nzc2YmIzYzRmIiwiaWF0IjoxNTI2ODcxNTc5LCJleHAiOjE1MjY4NzUxNzl9&quot;</span><span class="token punctuation">,</span>
  secret
<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;signature: &quot;</span> <span class="token operator">+</span> signature<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// signature: JtrTx9QaN3BD1QkZhY58MTu6WHn_vQwRBxO9VwJgkhE</span>
</code></pre></div><p>最后将这一部分签名也拼接在被签名的字符串后面，我们就得到了完整的 JWT，如下：</p> <div class="language- extra-class"><pre class="language-text"><code>eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpZCI6IjQ5YTlkZDUwNWM5ZDExZThiNWU4NmI5Nzc2YmIzYzRmIiwiaWF0IjoxNTI2ODcxNTc5LCJleHAiOjE1MjY4NzUxNzl9.JtrTx9QaN3BD1QkZhY58MTu6WHn_vQwRBxO9VwJgkhE
</code></pre></div><p>整个完整过程走下来我们需要思考一下问题，Token 是否安全，是否可以传输敏感信息？</p> <p>我们现在明白了一个 token 是由 Header 的 Base64 编码 + Payload 的 Base64 编码 + Signature 三段组成，当其他人拿到我们的 Token，可以通过 Token 前两段 Base64 解码得到 Header 和 Payload 对象，这里我们通过 <a href="https://github.com/auth0/node-jsonwebtoken" target="_blank" rel="noopener noreferrer">node-jsonwebtoken<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 模块 decode 方法直接 &quot;破解&quot; 我们的 Token。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;jsonwebtoken&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> decoded <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>
  <span class="token string">&quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpZCI6IjQ5YTlkZDUwNWM5ZDExZThiNWU4NmI5Nzc2YmIzYzRmIiwiaWF0IjoxNTI2ODcxNTc5LCJleHAiOjE1MjY4NzUxNzl9.JtrTx9QaN3BD1QkZhY58MTu6WHn_vQwRBxO9VwJgkhE&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">complete</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;jsonwebtoken: &quot;</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>decoded<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// jsonwebtoken: {&quot;header&quot;:{&quot;typ&quot;:&quot;JWT&quot;,&quot;alg&quot;:&quot;HS256&quot;},&quot;payload&quot;:{&quot;id&quot;:&quot;49a9dd505c9d11e8b5e86b9776bb3c4f&quot;,&quot;iat&quot;:1526871579,&quot;exp&quot;:1526875179},&quot;signature&quot;:&quot;JtrTx9QaN3BD1QkZhY58MTu6WHn_vQwRBxO9VwJgkhE&quot;}</span>
</code></pre></div><p>所以我们的 payload 不能里面不能包含诸如密码这种敏感信息，对于我们这里的 id 是一串 uuid，即使拿到也无法直接判定相关内容，从而不会直接泄露我们的内容。</p> <p>一般而言，加密算法对于不同的输入产生的输出总是不一样的。对于两个不同的输入，产生同样的输出的概率极其地小。如果有人对头部以及载荷的内容解码之后进行修改，再进行编码的话，那么新的头部和载荷的签名和之前的签名就将是不一样的，而且如果不知道服务器加密的时候用的密钥的话，得出来的签名也一定会是不一样的。</p> <p>所以服务端拿到 JWT 后，首先会校验签名是否过期，以及对头部和载荷的内容用同一算法（通过 JWT 的头部 alg 字段指定）再次签名得到的 JWT 和用户传递的 JWT 是否一致。如果服务器应用对头部和载荷再次以同样方法签名之后发现，自己计算出来的签名和接受到的签名不一样，那么就说明这个 Token 的内容被别人动过的，我们应该拒绝这个 Token，返回一个 HTTP 401 Unauthorized 响应。</p> <h3 id="egg-jwt-插件">egg-jwt 插件</h3> <p>文档：<a href="https://github.com/okoala/egg-jwt" target="_blank" rel="noopener noreferrer">https://github.com/okoala/egg-jwt<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>egg-jwt 基于 <a href="https://github.com/auth0/node-jsonwebtoken" target="_blank" rel="noopener noreferrer">node-jsonwebtoken<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 实现，完整文档可以参考 <a href="https://github.com/auth0/node-jsonwebtoken" target="_blank" rel="noopener noreferrer">https://github.com/auth0/node-jsonwebtoken<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。jwt 对象挂载在 app 对象下，可以通过 app.jwt 访问 jwt 的三个方法：</p> <ul><li>jwt.sign(payload, secretOrPrivateKey, [options, callback])————生成 token 字符串</li> <li>jwt.verify(token, secretOrPublicKey, [options, callback])————校验 token 合法性</li> <li>jwt.decode(token [, options])————token 译码</li></ul> <p><strong>安装：</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> i egg-jwt <span class="token parameter variable">--save</span>
</code></pre></div><p><strong>配置：</strong></p> <p>app/config/plugin.js 配置：</p> <div class="language-js extra-class"><pre class="language-js"><code>exports<span class="token punctuation">.</span>jwt <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">enable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token keyword">package</span><span class="token operator">:</span> <span class="token string">&quot;egg-jwt&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>app/config/config.default.js 配置：</p> <div class="language-js extra-class"><pre class="language-js"><code>exports<span class="token punctuation">.</span>jwt <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">enable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token literal-property property">secret</span><span class="token operator">:</span> <span class="token string">&quot;xxxxxxxxxxxxx&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>调用：</strong></p> <p>请求头：</p> <div class="language- extra-class"><pre class="language-text"><code>Authorization: Bearer {access_token}
</code></pre></div><p>注：access_token 为登录后返回的 token 值。</p> <p>app/service/user.js：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 生成 Token
 * @param {Object} data
 */</span>
<span class="token function">createToken</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> app<span class="token punctuation">.</span>jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>jwt<span class="token punctuation">.</span>secret<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">expiresIn</span><span class="token operator">:</span> <span class="token string">&quot;12h&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 验证token的合法性
 * @param {String} token
 */</span>
<span class="token function">verifyToken</span><span class="token punctuation">(</span><span class="token parameter">token</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    app<span class="token punctuation">.</span>jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>jwt<span class="token punctuation">.</span>secret<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> decoded</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/*
          err = {
            name: 'TokenExpiredError',
            message: 'jwt expired',
            expiredAt: 1408621000
          }
        */</span>
        result<span class="token punctuation">.</span>verify <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span>message <span class="token operator">=</span> err<span class="token punctuation">.</span>message<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        result<span class="token punctuation">.</span>verify <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span>message <span class="token operator">=</span> decoded<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>extend/helper.js：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 获取 Token</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">getAccessToken</span> <span class="token operator">=</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> bearerToken <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>header<span class="token punctuation">.</span>authorization<span class="token punctuation">;</span>
  <span class="token keyword">return</span> bearerToken <span class="token operator">&amp;&amp;</span> bearerToken<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;Bearer &quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 校验 Token</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">verifyToken</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> userId</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> token <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAccessToken</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> verifyResult <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">verifyToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>verifyResult<span class="token punctuation">.</span>verify<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token number">401</span><span class="token punctuation">,</span> verifyResult<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">!=</span> verifyResult<span class="token punctuation">.</span>message<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token number">401</span><span class="token punctuation">,</span> <span class="token string">&quot;用户 ID 与 Token 不一致&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 处理成功响应</span>
exports<span class="token punctuation">.</span>success <span class="token operator">=</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> message <span class="token operator">=</span> <span class="token string">&quot;请求成功&quot;</span><span class="token punctuation">,</span> status <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token literal-property property">message</span><span class="token operator">:</span> message<span class="token punctuation">,</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span> result
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> status<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 处理失败响应</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">error</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> code<span class="token punctuation">,</span> message</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">code</span><span class="token operator">:</span> code<span class="token punctuation">,</span>
    <span class="token literal-property property">message</span><span class="token operator">:</span> message
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> code<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>controller 中调用：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 生成Token</span>
<span class="token keyword">let</span> token <span class="token operator">=</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">createToken</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> user<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 校验Token合法性</span>
<span class="token keyword">let</span> isVerify <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">verifyToken</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>isVerify<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 合法逻辑</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样对于需要进行身份认证的 restful API，就可以通过 token 进行认证，从而实现用户认证和授权。</p> <h2 id="后记">后记</h2> <p>本文原本是想通过用户管理的设计来说明在构建 Node.js 服务过程遇到的问题以及收获，太久没有写文章，思维一时无法发散，只能平铺直叙在设计过程用到的插件的基本用法和一些设计上的思考，发出来不求能够助人，但求能够帮助自己梳理清楚思路，写完发现自己的认知也确实明晰了很多，很多之前的疑惑豁然开朗。</p> <p>很多没有写文章了，这半年来主要负责混合式移动端架构设计和模块开发的工作，摸爬滚打快一年，主要精力都花在做下面这一套 JS SDK 和原生基座。</p> <p><img src="http://oo1uw74rb.bkt.clouddn.com/agreesdk-doc.png" alt></p> <p>这半年看了很多框架源码，也尝试写了一些基本架构和内部文档和笔记，但是没有在开源社区总结和分享，回头看终究有些遗憾，虽然可以拿一直很忙没时间去安慰自己，但是回过头来看其实时间挤一下也还是有的，所以后续将抽出更多时间去归档，毕竟写出来真的会理解的更深刻。</p> <h2 id="参考">参考</h2> <ul><li><a href="https://blog.leapoahead.com/2015/09/06/understanding-jwt/" target="_blank" rel="noopener noreferrer">JSON Web Token - 在 Web 应用间安全地传递信息<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://blog.leapoahead.com/2015/09/07/user-authentication-with-jwt/" target="_blank" rel="noopener noreferrer">八幅漫画理解使用 JSON Web Token 设计单点登录系统<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <div data-v-3bd334e8><p class="descript" data-v-3bd334e8>写这些代码也许就一两个小时的事，写一篇大家好接受的文章需要几天的酝酿，如果文章对您有帮助请我喝杯咖啡吧！</p> <img src="/supportme.png" class="pay-code" data-v-3bd334e8> <div data-v-3bd334e8><div id="container"></div></div> <div class="footer" data-v-4f0df4b0 data-v-3bd334e8><p data-v-4f0df4b0>站点总访问量： 站点总访客数：</p> <p data-v-4f0df4b0>博客内容遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" data-v-4f0df4b0>知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></p> <p data-v-4f0df4b0>赵梦欢 © 2015 - 2023</p></div></div></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.f3e141ba.js" defer></script><script src="/assets/js/76.a9439343.js" defer></script><script src="/assets/js/18.c373a36e.js" defer></script><script src="/assets/js/34.124c31c0.js" defer></script>
  </body>
</html>
