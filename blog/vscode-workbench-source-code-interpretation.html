<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>vscode 定制开发 —— Workbench 源码解读及实战 | 匠心博客</title>
    <meta name="description" content="小青年,匠心,小青年博客,匠心博客,前端开发,android,技术宅,菜鸟教程,一个神奇的博客。">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.685c010a.css" as="style"><link rel="preload" href="/assets/js/app.f3e141ba.js" as="script"><link rel="preload" href="/assets/js/17.4f7ae4ec.js" as="script"><link rel="preload" href="/assets/js/18.c373a36e.js" as="script"><link rel="preload" href="/assets/js/34.124c31c0.js" as="script"><link rel="prefetch" href="/assets/js/1.1950ec81.js"><link rel="prefetch" href="/assets/js/10.7f857e71.js"><link rel="prefetch" href="/assets/js/100.e03c01d2.js"><link rel="prefetch" href="/assets/js/101.7b790a2f.js"><link rel="prefetch" href="/assets/js/102.a7aa77f9.js"><link rel="prefetch" href="/assets/js/103.d473991c.js"><link rel="prefetch" href="/assets/js/104.9fe8785c.js"><link rel="prefetch" href="/assets/js/105.7291ae49.js"><link rel="prefetch" href="/assets/js/106.2c35a2f4.js"><link rel="prefetch" href="/assets/js/107.a71ccb64.js"><link rel="prefetch" href="/assets/js/108.9d6f54a8.js"><link rel="prefetch" href="/assets/js/109.e77d12ca.js"><link rel="prefetch" href="/assets/js/11.5378ae65.js"><link rel="prefetch" href="/assets/js/12.9aca40f8.js"><link rel="prefetch" href="/assets/js/13.ce2b655c.js"><link rel="prefetch" href="/assets/js/14.7488ca24.js"><link rel="prefetch" href="/assets/js/15.9c07ac98.js"><link rel="prefetch" href="/assets/js/16.8f57294c.js"><link rel="prefetch" href="/assets/js/19.c7be2474.js"><link rel="prefetch" href="/assets/js/2.7f7e5268.js"><link rel="prefetch" href="/assets/js/20.f8833113.js"><link rel="prefetch" href="/assets/js/21.e71dd521.js"><link rel="prefetch" href="/assets/js/22.92dc7b77.js"><link rel="prefetch" href="/assets/js/23.285557d3.js"><link rel="prefetch" href="/assets/js/24.a803551c.js"><link rel="prefetch" href="/assets/js/25.dbeaa19d.js"><link rel="prefetch" href="/assets/js/26.9ca97076.js"><link rel="prefetch" href="/assets/js/27.d1a2911b.js"><link rel="prefetch" href="/assets/js/28.25c216b3.js"><link rel="prefetch" href="/assets/js/29.9dc30af4.js"><link rel="prefetch" href="/assets/js/30.1e9d6e06.js"><link rel="prefetch" href="/assets/js/31.3d7dbe62.js"><link rel="prefetch" href="/assets/js/32.36371ba7.js"><link rel="prefetch" href="/assets/js/33.78edc66d.js"><link rel="prefetch" href="/assets/js/35.a5470008.js"><link rel="prefetch" href="/assets/js/36.acde7543.js"><link rel="prefetch" href="/assets/js/37.f6648812.js"><link rel="prefetch" href="/assets/js/38.1885784f.js"><link rel="prefetch" href="/assets/js/39.af4b4bbd.js"><link rel="prefetch" href="/assets/js/4.61024115.js"><link rel="prefetch" href="/assets/js/40.ec6e88a9.js"><link rel="prefetch" href="/assets/js/41.67d4e8b7.js"><link rel="prefetch" href="/assets/js/42.7de428af.js"><link rel="prefetch" href="/assets/js/43.b4f51fa8.js"><link rel="prefetch" href="/assets/js/44.487d119d.js"><link rel="prefetch" href="/assets/js/45.2206665b.js"><link rel="prefetch" href="/assets/js/46.125163cc.js"><link rel="prefetch" href="/assets/js/47.8722f507.js"><link rel="prefetch" href="/assets/js/48.b8bfe77f.js"><link rel="prefetch" href="/assets/js/49.77fac897.js"><link rel="prefetch" href="/assets/js/5.3395f0b5.js"><link rel="prefetch" href="/assets/js/50.d68289a2.js"><link rel="prefetch" href="/assets/js/51.d9d70556.js"><link rel="prefetch" href="/assets/js/52.6a2c9e02.js"><link rel="prefetch" href="/assets/js/53.ff13cf8b.js"><link rel="prefetch" href="/assets/js/54.7e844902.js"><link rel="prefetch" href="/assets/js/55.80aa3d86.js"><link rel="prefetch" href="/assets/js/56.a4124774.js"><link rel="prefetch" href="/assets/js/57.55eb7355.js"><link rel="prefetch" href="/assets/js/58.7d0e2bc5.js"><link rel="prefetch" href="/assets/js/59.9cdd695c.js"><link rel="prefetch" href="/assets/js/6.77e8533c.js"><link rel="prefetch" href="/assets/js/60.54318be9.js"><link rel="prefetch" href="/assets/js/61.82e1ea82.js"><link rel="prefetch" href="/assets/js/62.b065e499.js"><link rel="prefetch" href="/assets/js/63.bb770dde.js"><link rel="prefetch" href="/assets/js/64.996fdbfd.js"><link rel="prefetch" href="/assets/js/65.54f3baf3.js"><link rel="prefetch" href="/assets/js/66.38d28ab3.js"><link rel="prefetch" href="/assets/js/67.5cf5a3bc.js"><link rel="prefetch" href="/assets/js/68.f2418476.js"><link rel="prefetch" href="/assets/js/69.162d06c4.js"><link rel="prefetch" href="/assets/js/7.a2cd9d6c.js"><link rel="prefetch" href="/assets/js/70.80f1252b.js"><link rel="prefetch" href="/assets/js/71.970dda3c.js"><link rel="prefetch" href="/assets/js/72.a073c997.js"><link rel="prefetch" href="/assets/js/73.674106d1.js"><link rel="prefetch" href="/assets/js/74.a0336873.js"><link rel="prefetch" href="/assets/js/75.37fbb329.js"><link rel="prefetch" href="/assets/js/76.a9439343.js"><link rel="prefetch" href="/assets/js/77.d52439f1.js"><link rel="prefetch" href="/assets/js/78.fbffcd6c.js"><link rel="prefetch" href="/assets/js/79.c6d73001.js"><link rel="prefetch" href="/assets/js/8.f0af9f9c.js"><link rel="prefetch" href="/assets/js/80.eab87966.js"><link rel="prefetch" href="/assets/js/81.9931436f.js"><link rel="prefetch" href="/assets/js/82.b29080c9.js"><link rel="prefetch" href="/assets/js/83.d94ed517.js"><link rel="prefetch" href="/assets/js/84.600be30f.js"><link rel="prefetch" href="/assets/js/85.a6938cc3.js"><link rel="prefetch" href="/assets/js/86.7dec6ed4.js"><link rel="prefetch" href="/assets/js/87.5d2c1dc9.js"><link rel="prefetch" href="/assets/js/88.8f2410d4.js"><link rel="prefetch" href="/assets/js/89.fe8c04e8.js"><link rel="prefetch" href="/assets/js/9.f542ab97.js"><link rel="prefetch" href="/assets/js/90.f25166a8.js"><link rel="prefetch" href="/assets/js/91.038ee701.js"><link rel="prefetch" href="/assets/js/92.19e610e0.js"><link rel="prefetch" href="/assets/js/93.22cd83c8.js"><link rel="prefetch" href="/assets/js/94.7495cfa6.js"><link rel="prefetch" href="/assets/js/95.f149c41d.js"><link rel="prefetch" href="/assets/js/96.cee91e1f.js"><link rel="prefetch" href="/assets/js/97.27a1bb57.js"><link rel="prefetch" href="/assets/js/98.67d4f125.js"><link rel="prefetch" href="/assets/js/99.35daa60c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.685c010a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">匠心博客</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/index.html" class="nav-link">博文</a></div><div class="nav-item"><a href="/book/index.html" class="nav-link">专栏</a></div><div class="nav-item"><a href="/note/index.html" class="nav-link">笔记</a></div><div class="nav-item"><a href="/nav/index.html" class="nav-link">导航</a></div><div class="nav-item"><a href="/about/index.html" class="nav-link">关于</a></div> <a href="https://github.com/zhaomenghuan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/index.html" class="nav-link">博文</a></div><div class="nav-item"><a href="/book/index.html" class="nav-link">专栏</a></div><div class="nav-item"><a href="/note/index.html" class="nav-link">笔记</a></div><div class="nav-item"><a href="/nav/index.html" class="nav-link">导航</a></div><div class="nav-item"><a href="/about/index.html" class="nav-link">关于</a></div> <a href="https://github.com/zhaomenghuan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>vscode 定制开发 —— Workbench 源码解读及实战</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/vscode-workbench-source-code-interpretation.html#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/vscode-workbench-source-code-interpretation.html#electron-基础准备" class="sidebar-link">Electron 基础准备</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/vscode-workbench-source-code-interpretation.html#快速入门" class="sidebar-link">快速入门</a></li><li class="sidebar-sub-header"><a href="/blog/vscode-workbench-source-code-interpretation.html#主进程和渲染器进程" class="sidebar-link">主进程和渲染器进程</a></li><li class="sidebar-sub-header"><a href="/blog/vscode-workbench-source-code-interpretation.html#进程间通讯" class="sidebar-link">进程间通讯</a></li></ul></li><li><a href="/blog/vscode-workbench-source-code-interpretation.html#vs-code-依赖注入原理" class="sidebar-link">VS Code 依赖注入原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/vscode-workbench-source-code-interpretation.html#依赖注入基本概念" class="sidebar-link">依赖注入基本概念</a></li><li class="sidebar-sub-header"><a href="/blog/vscode-workbench-source-code-interpretation.html#原理与实现" class="sidebar-link">原理与实现</a></li></ul></li><li><a href="/blog/vscode-workbench-source-code-interpretation.html#workbench-启动流程" class="sidebar-link">Workbench 启动流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/vscode-workbench-source-code-interpretation.html#main-js" class="sidebar-link">main.js</a></li><li class="sidebar-sub-header"><a href="/blog/vscode-workbench-source-code-interpretation.html#vs-code-electron-main-main-ts" class="sidebar-link">vs/code/electron-main/main.ts</a></li><li class="sidebar-sub-header"><a href="/blog/vscode-workbench-source-code-interpretation.html#vs-code-electron-main-app-ts" class="sidebar-link">vs/code/electron-main/app.ts</a></li><li class="sidebar-sub-header"><a href="/blog/vscode-workbench-source-code-interpretation.html#vs-code-electron-main-windows-ts" class="sidebar-link">vs/code/electron-main/windows.ts</a></li><li class="sidebar-sub-header"><a href="/blog/vscode-workbench-source-code-interpretation.html#vs-workbench-electron-browser-main-ts" class="sidebar-link">vs/workbench/electron-browser/main.ts</a></li><li class="sidebar-sub-header"><a href="/blog/vscode-workbench-source-code-interpretation.html#vs-workbench-browser-workbench-ts" class="sidebar-link">vs/workbench/browser/workbench.ts</a></li></ul></li><li><a href="/blog/vscode-workbench-source-code-interpretation.html#拓展-workbench" class="sidebar-link">拓展 Workbench</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/vscode-workbench-source-code-interpretation.html#继承-part-类" class="sidebar-link">继承 Part 类</a></li><li class="sidebar-sub-header"><a href="/blog/vscode-workbench-source-code-interpretation.html#修改-workbench-与-layout" class="sidebar-link">修改 Workbench 与 Layout</a></li></ul></li><li><a href="/blog/vscode-workbench-source-code-interpretation.html#后记" class="sidebar-link">后记</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/vscode-workbench-source-code-interpretation.html#参考" class="sidebar-link">参考</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="vscode-定制开发-——-workbench-源码解读及实战">vscode 定制开发 —— Workbench 源码解读及实战</h1> <h2 id="前言">前言</h2> <p>VS Code 插件开发前前后后也看了一段时间，之前尝试对 ActivityBar 做过一些拓展，但是对于一些涉及 UI 改造的高级功能没有多少头绪，在研究了基于 VS Code 开发的类似产品如快应用开发工具、TaoBao Editor 等，有一些思路，然后慢慢摸索出一些思路。目前关于界面二次改造的文章真的比较稀少，本文试着做一些讲解。</p> <p>之前写过一篇 vscode 定制开发的基础文章，如果对 VS Code 定制开发暂时还没有了解的，可以戳这里：<a href="https://zhaomenghuan.js.org/blog/vscode-custom-development-basic-preparation.html" target="_blank" rel="noopener noreferrer">vscode 定制开发——基础准备<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h2 id="electron-基础准备">Electron 基础准备</h2> <p><img src="/assets/img/electron-architecture.876dcbba.png" alt></p> <p>之前我们简单了解了一下 Electron 是基于 Chromium + Node.js 的架构。</p> <h3 id="快速入门">快速入门</h3> <p>前面我们说过 VS Code 的主界面是通过 Electron 渲染的，VSCode 的工作区即是一个 Electron 的 BrowserWindow，我们可以从<a href="https://electronjs.org/docs/tutorial/first-app" target="_blank" rel="noopener noreferrer">打造你的第一个 Electron 应用<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 学习 Electron 的最简例子如下：</p> <div class="language- extra-class"><pre class="language-text"><code>electron-quick-start/
├── package.json
├── main.js
├── renderer.js
└── index.html
</code></pre></div><p>main.js：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> BrowserWindow <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">&quot;electron&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">createWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 创建浏览器窗口</span>
  <span class="token keyword">let</span> win <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrowserWindow</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    width<span class="token operator">:</span> <span class="token number">800</span><span class="token punctuation">,</span>
    height<span class="token operator">:</span> <span class="token number">600</span><span class="token punctuation">,</span>
    webPreferences<span class="token operator">:</span> <span class="token punctuation">{</span>
      nodeIntegration<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 加载index.html文件</span>
  win<span class="token punctuation">.</span><span class="token function">loadFile</span><span class="token punctuation">(</span><span class="token string">&quot;index.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

app<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;ready&quot;</span><span class="token punctuation">,</span> createWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>具体参考：<a href="https://electronjs.org/docs/tutorial/first-app" target="_blank" rel="noopener noreferrer">打造你的第一个 Electron 应用<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="主进程和渲染器进程">主进程和渲染器进程</h3> <p><img src="/assets/img/electron-process.84269172.png" alt></p> <p>Electron 和 Chromium 类似，分为主进程(main process)和渲染器进程(renderer processes)。</p> <p><strong>主进程</strong>：Electron 运行 package.json 的 main 脚本的进程被称为主进程。一个 Electron 应用总是有且只有一个主进程。主进程使用 BrowserWindow 实例创建页面。与创建 GUI 相关的接口只应该由主进程来调用。</p> <p><strong>渲染进程</strong>：Electron 里的每个页面都有它自己的进程，叫作渲染进程。由于 Electron 使用了 Chromium 来展示 web 页面，所以 Chromium 的多进程架构也被使用到。每个 BrowserWindow 实例都在自己的渲染进程里运行页面，当一个 BrowserWindow 实例被销毁后，相应的渲染进程也会被终止。</p> <p>在页面中调用与 GUI 相关的原生 API 是不被允许的，因为在 web 页面里操作原生的 GUI 资源是非常危险的，而且容易造成资源泄露。如果你想在 web 页面里使用 GUI 操作，其对应的渲染进程必须与主进程进行通讯，请求主进程进行相关的 GUI 操作。</p> <h3 id="进程间通讯">进程间通讯</h3> <p>Electron 为主进程和渲染进程通信提供了多种实现方式:</p> <ul><li>利用 <a href="https://electronjs.org/docs/api/ipc-main" target="_blank" rel="noopener noreferrer">ipcMain<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 和 <a href="https://electronjs.org/docs/api/ipc-renderer" target="_blank" rel="noopener noreferrer">ipcRenderer<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 模块进行 IPC 方式通信</li> <li>利用 <a href="https://electronjs.org/docs/api/remote" target="_blank" rel="noopener noreferrer">remote<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 模块进行 RPC 方式通信</li></ul> <p>这里我使用 <a href="https://simulatedgreg.gitbooks.io/electron-vue/content/cn/" target="_blank" rel="noopener noreferrer">electron-vue<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 为例验证 Electron 进程间通讯方式。</p> <h4 id="利用-ipcmain-和-ipcrenderer-模块进行-ipc-方式通信">利用 ipcMain 和 ipcRenderer 模块进行 IPC 方式通信</h4> <p><strong>主进程向渲染进程发送消息</strong>：从主进程到渲染器进程的消息传递，主进程利用 <code>BrowerWindow.webContents.send()</code> 发送消息，渲染进程利用 <code>ipcRenderer</code> 接收消息。</p> <p>主进程：</p> <div class="language-js extra-class"><pre class="language-js"><code>mainWindow<span class="token punctuation">.</span>webContents<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;did-finish-load&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  mainWindow<span class="token punctuation">.</span>webContents<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>
    <span class="token string">&quot;sendMessageFromMainProcesses&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;主进程向渲染进程发送消息&quot;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>渲染进程：</p> <div class="language-js extra-class"><pre class="language-js"><code>electron<span class="token punctuation">.</span>ipcRenderer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;sendMessageFromMainProcesses&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> message</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>渲染进程向主进程发送消息</strong>：从渲染器进程到主进程的消息传递，渲染进程可以通过 <code>ipcRenderer</code> 模块的 <code>send</code> 方法向主进程发送异步消息及 <code>sendSync</code> 方法向主进程发送同步消息，主进程利用 ipcMain 接收消息，并通过 <code>event.sender.send</code> 或者 <code>event.reply(...)</code> 设置回复消息。</p> <blockquote><p>ipcRenderer.send(channel[, arg1][, arg2][, ...])</p></blockquote> <p>发送异步消息</p> <p>参数：</p> <ul><li>channel String</li> <li>...args any[]</li></ul> <p>通过 channel 发送异步消息到主进程，可以携带任意参数。 在内部，参数会被序列化为 JSON，因此参数对象上的函数和原型链不会被发送。</p> <p>渲染进程：</p> <div class="language-js extra-class"><pre class="language-js"><code>electron<span class="token punctuation">.</span>ipcRenderer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>
  <span class="token string">&quot;sendMessageFromRendererProcesses&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;渲染进程向主进程发送异步消息&quot;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>主进程：</p> <div class="language-js extra-class"><pre class="language-js"><code>electron<span class="token punctuation">.</span>ipcMain<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;sendMessageFromRendererProcesses&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> message</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;sendMessageFromMainProcesses&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;回应异步消息：&quot;</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>ipcRenderer.sendSync(channel[, arg1][, arg2][, ...])</p></blockquote> <p>发送同步消息</p> <p>参数：</p> <ul><li>channel String</li> <li>...args any[]</li></ul> <p>返回值：any - 由 ipcMain 处理程序发送过来的值。</p> <p>通过 channel 发送同步消息到主进程，可以携带任意参数。在内部，参数会被序列化为 JSON，因此参数对象上的函数和原型链不会被发送。主进程可以使用 ipcMain 监听 channel 来接收这些消息，并通过 event.returnValue 设置回复消息。</p> <p>注意: 发送同步消息将会阻塞整个渲染进程，你应该避免使用这种方式 - 除非你知道你在做什么。</p> <p>渲染进程：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> reply <span class="token operator">=</span> electron<span class="token punctuation">.</span>ipcRenderer<span class="token punctuation">.</span><span class="token function">sendSync</span><span class="token punctuation">(</span>
  <span class="token string">&quot;sendMessageSyncFromRendererProcesses&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;渲染进程向主进程发送同步消息&quot;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>主进程：</p> <div class="language-js extra-class"><pre class="language-js"><code>electron<span class="token punctuation">.</span>ipcMain<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;sendMessageFromRendererProcesses&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> message</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span>returnValue <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">回应同步消息：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>无论是 <code>BrowerWindow.webContents.send()</code> 还是 <code>ipcMain</code> 和 <code>ipcRenderer</code>，都是 <code>EventEmitter</code> 类的实例，<code>EventEmitter</code> 类由 NodeJS 中的 <code>events</code> 模块导出。</p> <h4 id="利用-remote-模块进行-rpc-方式通信">利用 remote 模块进行 RPC 方式通信</h4> <p>remote 模块为渲染进程（web 页面）和主进程通信（IPC）提供了一种简单方法。在 Electron 中, GUI 相关的模块 (如 dialog、menu 等) 仅在主进程中可用, 在渲染进程中不可用。 为了在渲染进程中使用它们, ipc 模块是向主进程发送进程间消息所必需的。 使用 remote 模块, 你可以调用 main 进程对象的方法, 而不必显式发送进程间消息, 类似于 Java 的 RMI 。</p> <p>在渲染进程中，可以通过 <code>require('electron').remote</code> 获取到 remote 对象，通过 remote 对象可以让渲染进程访问/使用主进程的模块。例如从渲染进程创建浏览器窗口：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> BrowserWindow <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;electron&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>remote<span class="token punctuation">;</span>
<span class="token keyword">let</span> win <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrowserWindow</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">800</span><span class="token punctuation">,</span> <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">600</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
win<span class="token punctuation">.</span><span class="token function">loadURL</span><span class="token punctuation">(</span><span class="token string">&quot;https://github.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>RMI 的技术原理</strong></p> <p>官方文档在 remote 模块的介绍中提到了它的实现类似于 Java 中的 RMI，那么 RMI 是什么？ remote 的黑魔法是否藏在这里面？</p> <p>RMI (Remote Method Invoke) 远程方法调用是一种计算机之间利用远程对象互相调用实现双方通讯的一种通讯机制。使用这种机制，某一台计算机上的对象可以调用另外一台计算机上的对象来获取远程数据。</p> <p>如果使用 http 协议来实现远程方法调用，我们可能会这么实现：</p> <p><img src="/assets/img/rmi-base.ba9aeab1.png" alt></p> <p>虽然 RMI 底层并不是使用 http 协议，但大致的思路是差不多的。</p> <p>RMI 的流程：</p> <p><img src="/assets/img/rmi-process.73d0126e.png" alt></p> <p><strong>远程对象(Remote Objects)</strong></p> <p><code>remote</code> 模块返回的每个对象 (包括函数) 表示主进程中的一个对象 (我们称它为远程对象或远程函数)。当调用远程对象的方法时, 调用远程函数, 或者使用远程构造函数 (函数) 创建新对象时, 实际上是在发送同步进程消息。</p> <p>在这个示例中, <code>BrowserWindow</code> 和 <code>win</code> 都是远程对象, <code>new BrowserWindow</code> 在渲染过程中没有创建 <code>BrowserWindow</code> 对象。取而代之的是，它在主进程中创建了一个 <code>BrowserWindow</code> 对象，并且在渲染进程中返回相应的远程对象，即 <code>win</code> 对象。</p> <p>注意：</p> <ul><li>当远程对象被第一次引用时，只有可枚举的属性可以通过远程访问。</li> <li>当通过 <code>remote</code> 模块访问时，数组和缓冲区在 <code>IPC</code> 上复制。 在渲染进程中修改它们不会在主进程中修改它们，反之亦然。</li></ul> <p>Electron 确保只要渲染进程中的远程对象一直存在（换句话说，没有被回收），主进程中的相应对象就不会被释放。 当远程对象被垃圾回收后，主进程中的相应对象将被解除引用。如果远程对象在渲染进程中泄露（例如存储在映射中，但从未释放），则主进程中的相应对象也将被泄漏，所以您应该非常小心，不要泄漏远程对象，但是，字符串和数字等主要值的类型是通过复制发送的。</p> <p>我们也可以通过 <code>remote</code> 对象访问到主过程中的内置模块，因此可以像 <code>electron</code> 模块一样直接使用它们：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;electron&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>remote<span class="token punctuation">.</span>app<span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>主进程调用渲染进程的函数</strong></p> <p>反过来可以使用 <a href="https://electronjs.org/docs/api/web-contents#contentsexecutejavascriptcode-usergesture-callback" target="_blank" rel="noopener noreferrer"><code>webContents.executeJavascript</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 执行渲染进程中的方法。</p> <div class="language-js extra-class"><pre class="language-js"><code>mainWindow<span class="token punctuation">.</span>webContents
  <span class="token punctuation">.</span><span class="token function">executeJavaScript</span><span class="token punctuation">(</span><span class="token string">'axios.get(&quot;http://www.httpbin.org/get&quot;)'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="vs-code-依赖注入原理">VS Code 依赖注入原理</h2> <h3 id="依赖注入基本概念">依赖注入基本概念</h3> <p>控制反转(Inversion of Control, 简称 IoC)，将原本在程序中手动创建对象的控制权转移至第三方，例如 IoC 容器，即可由 IoC 容器来管理对象的生命周期、依赖关系等。IoC 主要的实现方式有两种：依赖查找，依赖注入。</p> <p>依赖注入 (Dependency Injection) 是一种设计模式。在 VSCode 的源码中随处可见，所以这里简单介绍下。首先看依赖注入的定义：</p> <blockquote><p>在软件工程中，依赖注入是一种为一类对象提供依赖的对象的设计模式。被依赖的对象称为 Service，注入则是指将被依赖的对象 Service 传递给使用服务的对象(称为 Client)，从而客户 Client 不需要主动去建立(new)依赖的服务 Service，也不需要通过工厂模式去获取依赖的服务 Service。</p></blockquote> <p>如果在 Class Client 中，有 Class Service 的实例，则称 Class Client 对 Class Service 有一个依赖。例如下面类 Client 中用到一个 Service 对象，我们就说类 Client 对类 Service 有一个依赖。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>
  <span class="token class-name">Service</span> service<span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token class-name">Client</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Service</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>仔细看这段代码我们会发现存在一些问题：</p> <ul><li>如果现在要改变 service 生成方式，如需要用 <code>new Service(String name)</code> 初始化 service，需要修改 Client 代码；</li> <li>如果想测试不同 Service 对象对 Client 的影响很困难，因为 service 的初始化被写死在了 Client 的构造函数中；</li> <li>如果 <code>new Service()</code> 过程非常缓慢，单测时我们希望用已经初始化好的 service 对象 Mock 掉这个过程也很困难。</li></ul> <p>上面将依赖在构造函数中直接初始化是一种 Hard init 方式，弊端在于两个类不够独立，不方便测试。我们还有另外一种 Init 方式，如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>
  <span class="token class-name">Service</span> service<span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token class-name">Client</span><span class="token punctuation">(</span><span class="token class-name">Service</span> service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>service <span class="token operator">=</span> service<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面代码中，我们将 service 对象作为构造函数的一个参数传入。在调用 Client 的构造方法之前外部就已经初始化好了 Service 对象。像这种非自己主动初始化依赖，而通过外部来传入依赖的方式，我们就称为依赖注入。</p> <p>依赖注入的基本原理是由外部的容器来保存对象之间的依赖关系，同时这些对象的实例化也由容器来实现，这个容器被称为依赖注入容器。实际应用中我们的系统可能存在大量的对象或者服务，对象之间的依赖关系非常复杂，比如 B 依赖 A，则 A 就要先于 B 被实例化，这就要求外部的容器能够分析出这些对象的依赖关系。许多依赖注入框架还支持多种注入方式，比如构造函数注入、属性注入、方法参数注入等。</p> <p>在典型的依赖注入模式中，存在以下几类角色：</p> <ul><li>被依赖和使用的对象，即 <code>Service</code></li> <li>使用服务的客户对象，即 <code>Client</code></li> <li>客户使用服务的接口定义，即 <code>Interface</code></li> <li>注入器：负责建立服务对象并提供给 <code>Client</code>，通常也负责建立客户对象</li></ul> <p>JS 实现依赖注入的方式有多种:</p> <ul><li>基于 Injector、Cache 和函数参数名的依赖注入</li> <li>AngularJS 中基于双 Injector 的依赖注入</li> <li>inversify.js——Javascript 技术栈中的 IoC 容器</li> <li>TypeScript 中基于装饰器和反射的依赖注入</li> <li>...</li></ul> <h3 id="原理与实现">原理与实现</h3> <p>在 VS Code 源码中有大量的服务（Services）分别提供不同模块的 API 以便其他模块调用。在需要依赖该服务的类构造函数中以装饰器（Decorators）修饰参数的形式声明依赖，调用者不需要显式的 new 这个服务，在调用者被创建时，这些依赖的服务也会被自动创建并传递给该调用者，同时不同的服务也可以相互依赖。这可以极大地降低程序耦合性，同时提高可维护性。</p> <p>Angular、Nest.js、InversifyJS 等框架都使用了依赖注入实现程序的解耦。VS Code 中也实现了一个轻量级的依赖注入模式，VS Code 中主要使用构造函数注入。</p> <p>首先需要定义一个类并在其构造函数中声明依赖的服务：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CodeApplication</span> <span class="token keyword">extends</span> <span class="token class-name">Disposable</span> <span class="token punctuation">{</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token constant">MACHINE_ID_KEY</span> <span class="token operator">=</span> <span class="token string">'telemetry.machineId'</span><span class="token punctuation">;</span>
	<span class="token keyword">private</span> windowsMainService<span class="token operator">:</span> IWindowsMainService <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

	<span class="token function">constructor</span><span class="token punctuation">(</span>
		<span class="token keyword">private</span> <span class="token keyword">readonly</span> mainIpcServer<span class="token operator">:</span> Server<span class="token punctuation">,</span>
		<span class="token keyword">private</span> <span class="token keyword">readonly</span> userEnv<span class="token operator">:</span> IProcessEnvironment<span class="token punctuation">,</span>
		<span class="token decorator"><span class="token at operator">@</span><span class="token function">IInstantiationService</span></span> <span class="token keyword">private</span> <span class="token keyword">readonly</span> instantiationService<span class="token operator">:</span> IInstantiationService<span class="token punctuation">,</span>
		<span class="token decorator"><span class="token at operator">@</span><span class="token function">ILogService</span></span> <span class="token keyword">private</span> <span class="token keyword">readonly</span> logService<span class="token operator">:</span> ILogService<span class="token punctuation">,</span>
		<span class="token decorator"><span class="token at operator">@</span><span class="token function">IEnvironmentService</span></span> <span class="token keyword">private</span> <span class="token keyword">readonly</span> environmentService<span class="token operator">:</span> IEnvironmentService<span class="token punctuation">,</span>
		<span class="token decorator"><span class="token at operator">@</span><span class="token function">ILifecycleService</span></span> <span class="token keyword">private</span> <span class="token keyword">readonly</span> lifecycleService<span class="token operator">:</span> ILifecycleService<span class="token punctuation">,</span>
		<span class="token decorator"><span class="token at operator">@</span><span class="token function">IConfigurationService</span></span> <span class="token keyword">private</span> <span class="token keyword">readonly</span> configurationService<span class="token operator">:</span> IConfigurationService<span class="token punctuation">,</span>
		<span class="token decorator"><span class="token at operator">@</span><span class="token function">IStateService</span></span> <span class="token keyword">private</span> <span class="token keyword">readonly</span> stateService<span class="token operator">:</span> IStateService<span class="token punctuation">,</span>
		<span class="token decorator"><span class="token at operator">@</span><span class="token function">ISignService</span></span> <span class="token keyword">private</span> <span class="token keyword">readonly</span> signService<span class="token operator">:</span> ISignService
	<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Javascript 里的装饰器目前处在<a href="https://github.com/tc39/proposal-decorators" target="_blank" rel="noopener noreferrer">建议征集的第二阶段<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，但在 TypeScript 中能够被附加到类声明、方法、访问符、属性或参数上。这里的 @IInstantiationService、@ILogService 等都是装饰器（Decorator），属于 TypeScript 中的参数装饰器。</p> <p>服务的 Decorator 、接口定义及具体实现一般如下：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 创建装饰器</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ILogService <span class="token operator">=</span> <span class="token generic-function"><span class="token function">createDecorator</span><span class="token generic class-name"><span class="token operator">&lt;</span>ILogService<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">'logService'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 接口</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ILogService</span> <span class="token keyword">extends</span> <span class="token class-name">IDisposable</span> <span class="token punctuation">{</span>
	_serviceBrand<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
	onDidChangeLogLevel<span class="token operator">:</span> Event<span class="token operator">&lt;</span>LogLevel<span class="token operator">&gt;</span><span class="token punctuation">;</span>

	<span class="token function">getLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> LogLevel<span class="token punctuation">;</span>
	<span class="token function">setLevel</span><span class="token punctuation">(</span>level<span class="token operator">:</span> LogLevel<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
	<span class="token function">trace</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
	<span class="token function">debug</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
	<span class="token function">info</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
	<span class="token function">warn</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
	<span class="token function">error</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> Error<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
	<span class="token function">critical</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> Error<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 接口具体实现</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ConsoleLogService</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractLogService</span> <span class="token keyword">implements</span> <span class="token class-name">ILogService</span> <span class="token punctuation">{</span>
  _serviceBrand<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>

	<span class="token function">constructor</span><span class="token punctuation">(</span>logLevel<span class="token operator">:</span> LogLevel <span class="token operator">=</span> <span class="token constant">DEFAULT_LOG_LEVEL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setLevel</span><span class="token punctuation">(</span>logLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">trace</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> LogLevel<span class="token punctuation">.</span>Trace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'%cTRACE'</span><span class="token punctuation">,</span> <span class="token string">'color: #888'</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token operator">...</span>

	<span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>VS Code 中依赖注入的实现主要在 <code>vs/platform/instantiation/common</code> 文件夹下，如下：</p> <div class="language- extra-class"><pre class="language-text"><code>├── descriptors.ts           # 服务实例包装类
├── extensions.ts            # 通用服务注册、获取服务
├── graph.ts                 # 基于有向图的依赖分析
├── instantiation.ts         # 服务实例(创建 Decorator、存储服务的依赖)
├── instantiationService.ts  # 容器
└── serviceCollection.ts     # 服务集合
</code></pre></div><p>我们在定义服务的 <code>Decorator</code> 时，是通过调用 <code>createDecorator</code> 函数实现的，用于在构造函数中声明依赖关系以方便注入依赖。<code>createDecorator</code> 的主要作用是返回一个装饰器。</p> <h4 id="decorator-的作用">Decorator 的作用</h4> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// vs/platform/instantiation/common/instantiation.ts</span>

<span class="token keyword">export</span> <span class="token keyword">namespace</span> _util <span class="token punctuation">{</span>
  <span class="token keyword">export</span> <span class="token keyword">const</span> serviceIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> ServiceIdentifier<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">DI_TARGET</span> <span class="token operator">=</span> <span class="token string">&quot;$di$target&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">DI_DEPENDENCIES</span> <span class="token operator">=</span> <span class="token string">&quot;$di$dependencies&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getServiceDependencies</span><span class="token punctuation">(</span>
    ctor<span class="token operator">:</span> <span class="token builtin">any</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> ServiceIdentifier<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">;</span> index<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span> optional<span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> ctor<span class="token punctuation">[</span><span class="token constant">DI_DEPENDENCIES</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">createDecorator</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>serviceId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> ServiceIdentifier<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 已经保存过的服务会直接返回其装饰器</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_util<span class="token punctuation">.</span>serviceIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>serviceId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> _util<span class="token punctuation">.</span>serviceIds<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>serviceId<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 声明装饰器</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token keyword">function</span><span class="token punctuation">(</span>target<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> index<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>length <span class="token operator">!==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token string">&quot;@IServiceName-decorator can only be used to decorate a parameter&quot;</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 将服务作为依赖保存在为目标类的属性中</span>
    <span class="token function">storeServiceDependency</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> target<span class="token punctuation">,</span> index<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  id<span class="token punctuation">.</span><span class="token function-variable function">toString</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> serviceId<span class="token punctuation">;</span>

  _util<span class="token punctuation">.</span>serviceIds<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>serviceId<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> id<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">storeServiceDependency</span><span class="token punctuation">(</span>
  id<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">,</span>
  target<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">,</span>
  index<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  optional<span class="token operator">:</span> <span class="token builtin">boolean</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>target<span class="token punctuation">[</span>_util<span class="token punctuation">.</span><span class="token constant">DI_TARGET</span><span class="token punctuation">]</span> <span class="token operator">===</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">[</span>_util<span class="token punctuation">.</span><span class="token constant">DI_DEPENDENCIES</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token punctuation">,</span> index<span class="token punctuation">,</span> optional <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">[</span>_util<span class="token punctuation">.</span><span class="token constant">DI_DEPENDENCIES</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> id<span class="token punctuation">,</span> index<span class="token punctuation">,</span> optional <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    target<span class="token punctuation">[</span>_util<span class="token punctuation">.</span><span class="token constant">DI_TARGET</span><span class="token punctuation">]</span> <span class="token operator">=</span> target<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>同时调用 <code>storeServiceDependency</code> 函数将传入的服务 ID (唯一的字符串)及索引保存在所装饰类的一个成员 <code>_util.DI_TARGET($di$dependencies)</code> 数组中。</p> <h4 id="instantiationservice-容器">InstantiationService 容器</h4> <p>VS Code 中容器是 InstantiationService，在 <code>src/vs/code/electron-main/main.ts</code> 的 <code>createServices</code> 方法中，通过创建容器并把服务注册到容器中。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> services <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span>
services<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>ILogService<span class="token punctuation">,</span> logService<span class="token punctuation">)</span><span class="token punctuation">;</span>
services<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>IConfigurationService<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationService</span><span class="token punctuation">(</span>environmentService<span class="token punctuation">.</span>settingsResource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
services<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>ILifecycleService<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SyncDescriptor</span><span class="token punctuation">(</span>LifecycleService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span>
<span class="token keyword">new</span> <span class="token class-name">InstantiationService</span><span class="token punctuation">(</span>services<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>VS Code 提供了服务集合类 <code>ServiceCollection</code>。在 VS Code 中，服务可以自动实例化、也可以手动实例化并注册到容器中。对于有其他依赖的服务（例如 <code>LifecycleService</code> 依赖于 <code>ILogService</code> 和 <code>IStateService</code>）需要用 <code>SyncDescriptor</code> 类封装一下保存在服务集合中。</p> <p><code>SyncDescriptor</code> 是一个用于包装需要被容器实例化的服务实例的描述符对象，它保存了服务实例的构造器和静态参数（需要被直接传递给构造函数）。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">SyncDescriptor<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">readonly</span> ctor<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
  <span class="token keyword">readonly</span> staticArguments<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">readonly</span> supportsDelayedInstantiation<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span>
    ctor<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">T</span><span class="token punctuation">,</span>
    staticArguments<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    supportsDelayedInstantiation<span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 服务的构造器</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctor <span class="token operator">=</span> ctor<span class="token punctuation">;</span>
    <span class="token comment">// 静态参数</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>staticArguments <span class="token operator">=</span> staticArguments<span class="token punctuation">;</span>
    <span class="token comment">// 是否支持延迟实例化</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>supportsDelayedInstantiation <span class="token operator">=</span> supportsDelayedInstantiation<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>InstantiationService</code> 是依赖注入的核心，当服务被注册到容器后，我们需要先手动实例化程序入口，在 VS Code 中即是 <code>CodeApplication</code>，容器（<code>InstantiationService</code>）保存着这些对象的依赖关系，所以 <code>CodeApplication</code> 也需要借助容器来实例化。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 这里第二和第三个参数是 CodeApplication 构造器的静态参数，需要手动传递进去</span>
instantiationService
  <span class="token punctuation">.</span><span class="token function">createInstance</span><span class="token punctuation">(</span>CodeApplication<span class="token punctuation">,</span> mainIpcServer<span class="token punctuation">,</span> instanceEnvironment<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">startup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>instantiationService.createInstance</code> 通过 <code>_util.getServiceDependencies</code> 能够自动处理依赖。</p> <p>同时也可以手动获取服务实例，需要调用 <code>instantiationService.invokeFunction</code> 方法，传入一个回调函数，其参数是一个访问器，当通过访问器获取指定服务时，容器会自动去分析它所依赖的服务并自动实例化后返回。</p> <div class="language-ts extra-class"><pre class="language-ts"><code>instantiationService<span class="token punctuation">.</span><span class="token function">invokeFunction</span><span class="token punctuation">(</span>accessor <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> logService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ILogService<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> authService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IAuthService<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>类实例化原理及基于有向图的依赖分析相对较复杂，篇幅有限，暂不做细致分析。</p> <h2 id="workbench-启动流程">Workbench 启动流程</h2> <h3 id="main-js">main.js</h3> <p>我们从 src/main.js 入手看，很显然可以看出来 main.js 负责初始化 Electron 应用。VS Code 源码中 main.js 如下：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// src/main.js</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">&quot;electron&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>app<span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">&quot;ready&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token string">&quot;trace&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> contentTracing <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">&quot;electron&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>contentTracing<span class="token punctuation">;</span>
    <span class="token keyword">const</span> traceOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
      categoryFilter<span class="token operator">:</span> args<span class="token punctuation">[</span><span class="token string">&quot;trace-category-filter&quot;</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span>
      traceOptions<span class="token operator">:</span> args<span class="token punctuation">[</span><span class="token string">&quot;trace-options&quot;</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">&quot;record-until-full,enable-sampling&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    contentTracing<span class="token punctuation">.</span><span class="token function">startRecording</span><span class="token punctuation">(</span>traceOptions<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">onReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">onReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">onReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token keyword">const</span> <span class="token function-variable function">startup</span> <span class="token operator">=</span> nlsConfig <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    nlsConfig<span class="token punctuation">.</span>_languagePackSupport <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">'VSCODE_NLS_CONFIG'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>nlsConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">'VSCODE_NODE_CACHED_DATA_DIR'</span><span class="token punctuation">]</span> <span class="token operator">=</span> cachedDataDir <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span>

    <span class="token comment">// Load main in AMD</span>
    perf<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'willLoadMainBundle'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'./bootstrap-amd'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">'vs/code/electron-main/main'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      perf<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'didLoadMainBundle'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>onReady 中读取了用户语言设置并劫持了默认的 require 为一个修改过的 loader，用它来加载 <code>src/vs/code/electron-main/main</code> 模块，这是 VSCode 真正的入口，负责解析环境变量和初始化主界面以及创建其他模块所依赖「Services」。<code>electron-main</code> 目录是需要使用 Electron 主进程 API 的源代码。</p> <h3 id="vs-code-electron-main-main-ts">vs/code/electron-main/main.ts</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// src/vs/code/electron-main/main</span>
<span class="token keyword">class</span> <span class="token class-name">CodeMain</span> <span class="token punctuation">{</span>
  <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token comment">// Launch</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">startup</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 启动</span>
  <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token function">startup</span><span class="token punctuation">(</span>args<span class="token operator">:</span> ParsedArgs<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> bufferLogService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferLogService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 使用创建的 services 创建「实例服务」</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>instantiationService<span class="token punctuation">,</span> instanceEnvironment<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createServices</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> bufferLogService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token comment">// Init services</span>
			<span class="token keyword">await</span> instantiationService<span class="token punctuation">.</span><span class="token function">invokeFunction</span><span class="token punctuation">(</span><span class="token keyword">async</span> accessor <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
				<span class="token keyword">const</span> environmentService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IEnvironmentService<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">const</span> configurationService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IConfigurationService<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">const</span> stateService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IStateService<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">try</span> <span class="token punctuation">{</span>
					<span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initServices</span><span class="token punctuation">(</span>environmentService<span class="token punctuation">,</span> configurationService <span class="token keyword">as</span> ConfigurationService<span class="token punctuation">,</span> stateService <span class="token keyword">as</span> StateService<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>

					<span class="token comment">// Show a dialog for errors that can be resolved by the user</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleStartupDataDirError</span><span class="token punctuation">(</span>environmentService<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token keyword">throw</span> error<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// Startup</span>
			<span class="token keyword">await</span> instantiationService<span class="token punctuation">.</span><span class="token function">invokeFunction</span><span class="token punctuation">(</span><span class="token keyword">async</span> accessor <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
				<span class="token keyword">const</span> environmentService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IEnvironmentService<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">const</span> logService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ILogService<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">const</span> lifecycleService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ILifecycleService<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">const</span> configurationService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IConfigurationService<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">const</span> mainIpcServer <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doStartup</span><span class="token punctuation">(</span>logService<span class="token punctuation">,</span> environmentService<span class="token punctuation">,</span> lifecycleService<span class="token punctuation">,</span> instantiationService<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				bufferLogService<span class="token punctuation">.</span>logger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpdLogService</span><span class="token punctuation">(</span><span class="token string">'main'</span><span class="token punctuation">,</span> environmentService<span class="token punctuation">.</span>logsPath<span class="token punctuation">,</span> bufferLogService<span class="token punctuation">.</span><span class="token function">getLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">once</span><span class="token punctuation">(</span>lifecycleService<span class="token punctuation">.</span>onWillShutdown<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>configurationService <span class="token keyword">as</span> ConfigurationService<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 实例服务创建 CodeApplication 实例并调用 startup</span>
				<span class="token keyword">return</span> instantiationService<span class="token punctuation">.</span><span class="token function">createInstance</span><span class="token punctuation">(</span>CodeApplication<span class="token punctuation">,</span> mainIpcServer<span class="token punctuation">,</span> instanceEnvironment<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			instantiationService<span class="token punctuation">.</span><span class="token function">invokeFunction</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>quit<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 创建 Services</span>
  <span class="token keyword">private</span> <span class="token function">createServices</span><span class="token punctuation">(</span>args<span class="token operator">:</span> ParsedArgs<span class="token punctuation">,</span> bufferLogService<span class="token operator">:</span> BufferLogService<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">[</span>IInstantiationService<span class="token punctuation">,</span> <span class="token keyword">typeof</span> process<span class="token punctuation">.</span>env<span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> services <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> environmentService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EnvironmentService</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> process<span class="token punctuation">.</span>execPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> logService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MultiplexLogService</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token keyword">new</span> <span class="token class-name">ConsoleLogMainService</span><span class="token punctuation">(</span><span class="token function">getLogLevel</span><span class="token punctuation">(</span>environmentService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      bufferLogService
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">&quot;exit&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> logService<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// environmentService 一些基本配置，包括运行目录、用户数据目录、工作区缓存目录等</span>
    services<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>IEnvironmentService<span class="token punctuation">,</span> environmentService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// logService 日志服务</span>
    services<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>ILogService<span class="token punctuation">,</span> logService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// LifecycleService 生命周期相关的一些方法</span>
    services<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>ILifecycleService<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SyncDescriptor</span><span class="token punctuation">(</span>LifecycleService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// StateService 持久化数据</span>
    services<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>IStateService<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SyncDescriptor</span><span class="token punctuation">(</span>StateService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ConfigurationService 配置项</span>
    services<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>
      IConfigurationService<span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">SyncDescriptor</span><span class="token punctuation">(</span>ConfigurationService<span class="token punctuation">,</span> <span class="token punctuation">[</span>
        environmentService<span class="token punctuation">.</span>appSettingsPath
      <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// RequestService 请求服务</span>
    services<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>IRequestService<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SyncDescriptor</span><span class="token punctuation">(</span>RequestService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// DiagnosticsService 诊断服务，包括程序运行性能分析及系统状态</span>
    services<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>IDiagnosticsService<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SyncDescriptor</span><span class="token punctuation">(</span>DiagnosticsService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InstantiationService</span><span class="token punctuation">(</span>services<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Main Startup</span>
<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CodeMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
code<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Services(服务) 是 VSCode 中一系列可以被注入的公共模块，这些 Services 分别负责不同的功能，通过 createServices 创建了几个基本服务，除了这些基本服务，VSCode 内还包含了大量的服务，如 IModeService、ICodeEditorService、IPanelService 等，通过 VSCode 实现的「依赖注入」模式，可以在需要用到这些服务的地方以 Decorator 的方式做为构造函数参数声明依赖，会被自动注入到类中。基础服务初始化完成后会加载 IPC 信道并创建 CodeApplication 实例，调用 startup 方法启动 code。</p> <h3 id="vs-code-electron-main-app-ts">vs/code/electron-main/app.ts</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// vs/code/electron-main/app.ts</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CodeApplication</span> <span class="token keyword">extends</span> <span class="token class-name">Disposable</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">startup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token comment">// Create Electron IPC Server</span>
    <span class="token keyword">const</span> electronIpcServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ElectronIPCServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Spawn shared process after the first window has opened and 3s have passed</span>
    <span class="token keyword">const</span> sharedProcess <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>instantiationService<span class="token punctuation">.</span><span class="token function">createInstance</span><span class="token punctuation">(</span>SharedProcess<span class="token punctuation">,</span> machineId<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userEnv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> sharedProcessClient <span class="token operator">=</span> sharedProcess<span class="token punctuation">.</span><span class="token function">whenReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>environmentService<span class="token punctuation">.</span>sharedIPCHandle<span class="token punctuation">,</span> <span class="token string">'main'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>lifecycleService<span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>LifecycleMainPhase<span class="token punctuation">.</span>AfterWindowOpen<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_register</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RunOnceScheduler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> userEnv <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getShellEnvironment</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logService<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>environmentService<span class="token punctuation">)</span><span class="token punctuation">;</span>

        sharedProcess<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span>userEnv<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Services</span>
    <span class="token keyword">const</span> appInstantiationService <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createServices</span><span class="token punctuation">(</span>machineId<span class="token punctuation">,</span> sharedProcess<span class="token punctuation">,</span> sharedProcessClient<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Setup Auth Handler</span>
    <span class="token keyword">const</span> authHandler <span class="token operator">=</span> appInstantiationService<span class="token punctuation">.</span><span class="token function">createInstance</span><span class="token punctuation">(</span>ProxyAuthHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_register</span><span class="token punctuation">(</span>authHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Open Windows</span>
    <span class="token keyword">const</span> windows <span class="token operator">=</span> appInstantiationService<span class="token punctuation">.</span><span class="token function">invokeFunction</span><span class="token punctuation">(</span>accessor <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">openFirstWindow</span><span class="token punctuation">(</span>accessor<span class="token punctuation">,</span> electronIpcServer<span class="token punctuation">,</span> sharedProcessClient<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Post Open Windows Tasks</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">afterWindowOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token function">openFirstWindow</span><span class="token punctuation">(</span>accessor<span class="token operator">:</span> ServicesAccessor<span class="token punctuation">,</span> electronIpcServer<span class="token operator">:</span> ElectronIPCServer<span class="token punctuation">,</span> sharedProcessClient<span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Client<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> ICodeWindow<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token comment">// Register more Main IPC services</span>
    <span class="token keyword">const</span> launchService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ILaunchService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> launchChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LaunchChannel</span><span class="token punctuation">(</span>launchService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mainIpcServer<span class="token punctuation">.</span><span class="token function">registerChannel</span><span class="token punctuation">(</span><span class="token string">'launch'</span><span class="token punctuation">,</span> launchChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Register more Electron IPC services</span>
    <span class="token keyword">const</span> updateService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IUpdateService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> updateChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpdateChannel</span><span class="token punctuation">(</span>updateService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    electronIpcServer<span class="token punctuation">.</span><span class="token function">registerChannel</span><span class="token punctuation">(</span><span class="token string">'update'</span><span class="token punctuation">,</span> updateChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> issueService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IIssueService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> issueChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IssueChannel</span><span class="token punctuation">(</span>issueService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    electronIpcServer<span class="token punctuation">.</span><span class="token function">registerChannel</span><span class="token punctuation">(</span><span class="token string">'issue'</span><span class="token punctuation">,</span> issueChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> workspacesService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IWorkspacesMainService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> workspacesChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WorkspacesChannel</span><span class="token punctuation">(</span>workspacesService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    electronIpcServer<span class="token punctuation">.</span><span class="token function">registerChannel</span><span class="token punctuation">(</span><span class="token string">'workspaces'</span><span class="token punctuation">,</span> workspacesChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> windowsService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IWindowsService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> windowsChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WindowsChannel</span><span class="token punctuation">(</span>windowsService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    electronIpcServer<span class="token punctuation">.</span><span class="token function">registerChannel</span><span class="token punctuation">(</span><span class="token string">'windows'</span><span class="token punctuation">,</span> windowsChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sharedProcessClient<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>client <span class="token operator">=&gt;</span> client<span class="token punctuation">.</span><span class="token function">registerChannel</span><span class="token punctuation">(</span><span class="token string">'windows'</span><span class="token punctuation">,</span> windowsChannel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> menubarService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IMenubarService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> menubarChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MenubarChannel</span><span class="token punctuation">(</span>menubarService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    electronIpcServer<span class="token punctuation">.</span><span class="token function">registerChannel</span><span class="token punctuation">(</span><span class="token string">'menubar'</span><span class="token punctuation">,</span> menubarChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> urlService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IURLService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> urlChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLServiceChannel</span><span class="token punctuation">(</span>urlService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    electronIpcServer<span class="token punctuation">.</span><span class="token function">registerChannel</span><span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">,</span> urlChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> storageMainService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IStorageMainService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> storageChannel <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_register</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GlobalStorageDatabaseChannel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logService<span class="token punctuation">,</span> storageMainService <span class="token keyword">as</span> StorageMainService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    electronIpcServer<span class="token punctuation">.</span><span class="token function">registerChannel</span><span class="token punctuation">(</span><span class="token string">'storage'</span><span class="token punctuation">,</span> storageChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Log level management</span>
    <span class="token keyword">const</span> logLevelChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LogLevelSetterChannel</span><span class="token punctuation">(</span>accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ILogService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    electronIpcServer<span class="token punctuation">.</span><span class="token function">registerChannel</span><span class="token punctuation">(</span><span class="token string">'loglevel'</span><span class="token punctuation">,</span> logLevelChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sharedProcessClient<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>client <span class="token operator">=&gt;</span> client<span class="token punctuation">.</span><span class="token function">registerChannel</span><span class="token punctuation">(</span><span class="token string">'loglevel'</span><span class="token punctuation">,</span> logLevelChannel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Signal phase: ready (services set)</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>lifecycleService<span class="token punctuation">.</span>phase <span class="token operator">=</span> LifecycleMainPhase<span class="token punctuation">.</span>Ready<span class="token punctuation">;</span>

		<span class="token comment">// Propagate to clients</span>
		<span class="token keyword">const</span> windowsMainService <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>windowsMainService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IWindowsMainService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>CodeApplication.startup</code> 中首先会启动 <code>SharedProcess</code> 共享进程，同时也创建了一些窗口相关的服务，包括 <code>WindowsManager</code>、<code>WindowsService</code>、<code>MenubarService</code> 等，负责窗口、多窗口管理及菜单等功能。</p> <p><code>CodeApplication.openFirstWindow</code> 负责处理首次开启窗口，这里会先创建一系列 Electron 的 IPC 频道，用于主进程和渲染进程间通信。其中 <code>window</code> 和 <code>logLevel</code> 频道还会被注册到 <code>sharedProcessClient</code>，<code>sharedProcessClient</code> 是主进程与共享进程（SharedProcess）进行通信的 client。<code>CodeApplication.openFirstWindow</code> 最终会根据 <code>environmentService</code> 提供的相关参数（<code>file_uri</code>、<code>folder_uri</code>）调用<code>windowsMainService.open</code> 方法打开窗口。</p> <h3 id="vs-code-electron-main-windows-ts">vs/code/electron-main/windows.ts</h3> <p>到这里还没有看到入口 HTML，我们继续看看 <code>src/vs/code/electron-main/windows.ts</code>:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token function">open</span><span class="token punctuation">(</span>openConfig<span class="token operator">:</span> IOpenConfiguration<span class="token punctuation">)</span><span class="token operator">:</span> ICodeWindow<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token comment">// Open based on config</span>
	<span class="token keyword">const</span> usedWindows <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doOpen</span><span class="token punctuation">(</span>openConfig<span class="token punctuation">,</span> workspacesToOpen<span class="token punctuation">,</span> foldersToOpen<span class="token punctuation">,</span> emptyToRestore<span class="token punctuation">,</span> emptyToOpen<span class="token punctuation">,</span> fileInputs<span class="token punctuation">,</span> foldersToAdd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>open</code> 方法里面最终调用 <code>doOpen</code>，<code>doOpen</code> 方法最终调用 <code>openInBrowserWindow</code> 方法：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// Create the window</span>
window <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>instantiationService<span class="token punctuation">.</span><span class="token function">createInstance</span><span class="token punctuation">(</span>CodeWindow<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  state<span class="token punctuation">,</span>
  extensionDevelopmentPath<span class="token operator">:</span> configuration<span class="token punctuation">.</span>extensionDevelopmentPath<span class="token punctuation">,</span>
  isExtensionTestHost<span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>configuration<span class="token punctuation">.</span>extensionTestsPath
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>关键的 <code>CodeWindow</code> 定义在 <code>src/vs/code/electron-main/window.ts</code>，初始化过程是多窗体管理类（windows.ts）调用 VS Code 主窗体（window.ts），所以 <code>open()</code> 最终返回了一个 <code>CodeWindow</code> 实例。</p> <p><code>CodeWindow</code> 中的 <code>load()</code> 负责加载 URL：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">public</span> <span class="token function">load</span><span class="token punctuation">(</span>config<span class="token operator">:</span> IWindowConfiguration<span class="token punctuation">,</span> isReload<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token comment">// Load URL</span>
  <span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'main:loadWindow'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_win<span class="token punctuation">.</span><span class="token function">loadURL</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token function">doGetUrl</span><span class="token punctuation">(</span>config<span class="token operator">:</span> object<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">require</span><span class="token punctuation">.</span><span class="token function">toUrl</span><span class="token punctuation">(</span><span class="token string">'vs/code/electron-browser/workbench/workbench.html'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?config=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">encodeURIComponent</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>HTML 出现了，VS Code 中 Electron 的 main process 流程我们顺便跟进完成。</p> <p>workbench.html:</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>utf-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span>
      <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Content-Security-Policy<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>default-src 'none'; img-src 'self' https: data: blob: vscode-remote:; media-src 'none'; child-src 'self'; object-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; connect-src 'self' https:; font-src 'self' https: vscode-remote:;<span class="token punctuation">&quot;</span></span>
    <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vs-dark<span class="token punctuation">&quot;</span></span> <span class="token attr-name">aria-label</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>

  <span class="token comment">&lt;!-- Startup via workbench.js --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>workbench.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>workbench.js:</p> <div class="language-ts extra-class"><pre class="language-ts"><code>bootstrapWindow<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>
  <span class="token punctuation">[</span>
    <span class="token string">&quot;vs/workbench/workbench.main&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;vs/nls!vs/workbench/workbench.main&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;vs/css!vs/workbench/workbench.main&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span>workbench<span class="token punctuation">,</span> configuration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    perf<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">&quot;didLoadWorkbenchMain&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> process<span class="token punctuation">[</span><span class="token string">&quot;lazyEnv&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      perf<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">&quot;main/startup&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// @ts-ignore</span>
      <span class="token keyword">return</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">&quot;vs/workbench/electron-browser/main&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    removeDeveloperKeybindingsAfterLoad<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">canModifyDOM</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>windowConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">showPartsSplash</span><span class="token punctuation">(</span>windowConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">beforeLoaderConfig</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>windowConfig<span class="token punctuation">,</span> loaderConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      loaderConfig<span class="token punctuation">.</span>recordStats <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">beforeRequire</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      perf<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">&quot;willLoadWorkbenchMain&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>加载 <code>vs/workbench/electron-browser/main</code>，并调用 <code>main()</code>。</p> <h3 id="vs-workbench-electron-browser-main-ts">vs/workbench/electron-browser/main.ts</h3> <p>前文中的大量代码只是为这里最终创建主界面做铺垫，<code>Workbench</code> 模块主要代码都在 <code>vs/workbench</code> 目录下，主要负责界面元素的创建和具体业务功能的实现。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// vs/workbench/electron-browser/main.ts</span>
<span class="token keyword">class</span> <span class="token class-name">CodeRendererMain</span> <span class="token keyword">extends</span> <span class="token class-name">Disposable</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token keyword">async</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建依赖的服务</span>
    <span class="token keyword">const</span> services <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 监听 DOMContentLoaded 事件</span>
    <span class="token keyword">await</span> <span class="token function">domContentLoaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'willStartWorkbench'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建 Workbench 实例</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>workbench <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Workbench</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">,</span> services<span class="token punctuation">.</span>serviceCollection<span class="token punctuation">,</span> services<span class="token punctuation">.</span>logService<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Layout</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_register</span><span class="token punctuation">(</span><span class="token function">addDisposableListener</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> EventType<span class="token punctuation">.</span><span class="token constant">RESIZE</span><span class="token punctuation">,</span> e <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onWindowResize</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Workbench Lifecycle</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_register</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>workbench<span class="token punctuation">.</span><span class="token function">onShutdown</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_register</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>workbench<span class="token punctuation">.</span><span class="token function">onWillShutdown</span><span class="token punctuation">(</span>event <span class="token operator">=&gt;</span> event<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>services<span class="token punctuation">.</span>storageService<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Startup</span>
    <span class="token keyword">const</span> instantiationService <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>workbench<span class="token punctuation">.</span><span class="token function">startup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Window</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_register</span><span class="token punctuation">(</span>instantiationService<span class="token punctuation">.</span><span class="token function">createInstance</span><span class="token punctuation">(</span>ElectronWindow<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Driver</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>configuration<span class="token punctuation">.</span>driver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      instantiationService<span class="token punctuation">.</span><span class="token function">invokeFunction</span><span class="token punctuation">(</span><span class="token keyword">async</span> accessor <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_register</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">registerWindowDriver</span><span class="token punctuation">(</span>accessor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Config Exporter</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>configuration<span class="token punctuation">[</span><span class="token string">'export-default-configuration'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      instantiationService<span class="token punctuation">.</span><span class="token function">createInstance</span><span class="token punctuation">(</span>DefaultConfigurationExportHelper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Logging</span>
    services<span class="token punctuation">.</span>logService<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">'workbench configuration'</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>configuration<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span>configuration<span class="token operator">:</span> IWindowConfiguration<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> renderer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CodeRendererMain</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> renderer<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>创建 <code>Workbench</code> 实例并调用 <code>workbench.startup</code> 开始构建主界面布局 Workbench。</p> <h3 id="vs-workbench-browser-workbench-ts">vs/workbench/browser/workbench.ts</h3> <p>支持我们才跟踪到 Workbench 的代码，Workbench 类继承自 Layout 类，是主界面布局的入口文件，实际布局操作会调用 Layout 抽象类的方法。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// vs/workbench/browser/workbench.ts</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Workbench</span> <span class="token keyword">extends</span> <span class="token class-name">Layout</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token function">startup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> IInstantiationService <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>

      <span class="token comment">// Configure emitter leak warning threshold</span>
      <span class="token function">setGlobalLeakWarningThreshold</span><span class="token punctuation">(</span><span class="token number">175</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Setup Intl for comparers</span>
      <span class="token function">setFileNameComparer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IdleValue</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> collator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intl</span><span class="token punctuation">.</span><span class="token function">Collator</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> numeric<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> sensitivity<span class="token operator">:</span> <span class="token string">'base'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
          collator<span class="token operator">:</span> collator<span class="token punctuation">,</span>
          collatorIsNumeric<span class="token operator">:</span> collator<span class="token punctuation">.</span><span class="token function">resolvedOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numeric
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// ARIA</span>
      <span class="token function">setARIAContainer</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Services(实例化依赖的服务)</span>
      <span class="token keyword">const</span> instantiationService <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initServices</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serviceCollection<span class="token punctuation">)</span><span class="token punctuation">;</span>

      instantiationService<span class="token punctuation">.</span><span class="token function">invokeFunction</span><span class="token punctuation">(</span><span class="token keyword">async</span> accessor <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> lifecycleService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ILifecycleService<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> storageService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IStorageService<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> configurationService <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IConfigurationService<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Layout(布局初始化：Services、Parts、Listeners、State)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initLayout</span><span class="token punctuation">(</span>accessor<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Registries</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">startRegistries</span><span class="token punctuation">(</span>accessor<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Context Keys</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_register</span><span class="token punctuation">(</span>instantiationService<span class="token punctuation">.</span><span class="token function">createInstance</span><span class="token punctuation">(</span>WorkbenchContextKeysHandler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Register Listeners(创建全局事件监听)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerListeners</span><span class="token punctuation">(</span>lifecycleService<span class="token punctuation">,</span> storageService<span class="token punctuation">,</span> configurationService<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Render Workbench(渲染工作区)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">renderWorkbench</span><span class="token punctuation">(</span>instantiationService<span class="token punctuation">,</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>INotificationService<span class="token punctuation">)</span> <span class="token keyword">as</span> NotificationService<span class="token punctuation">,</span> storageService<span class="token punctuation">,</span> configurationService<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Workbench Layout</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createWorkbenchLayout</span><span class="token punctuation">(</span>instantiationService<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Layout(计算布局)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">layout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Restore</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">restoreWorkbench</span><span class="token punctuation">(</span>accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IEditorService<span class="token punctuation">)</span><span class="token punctuation">,</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IEditorGroupsService<span class="token punctuation">)</span><span class="token punctuation">,</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IViewletService<span class="token punctuation">)</span><span class="token punctuation">,</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IPanelService<span class="token punctuation">)</span><span class="token punctuation">,</span> accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ILogService<span class="token punctuation">)</span><span class="token punctuation">,</span> lifecycleService<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">onUnexpectedError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> instantiationService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">onUnexpectedError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">throw</span> error<span class="token punctuation">;</span> <span class="token comment">// rethrow because this is a critical issue we cannot handle properly here</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Layout 类：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// vs/workbench/browser/layout.ts</span>
<span class="token keyword">export</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Layout</span> <span class="token keyword">extends</span> <span class="token class-name">Disposable</span>
  <span class="token keyword">implements</span> <span class="token class-name">IWorkbenchLayoutService</span> <span class="token punctuation">{</span>
  <span class="token keyword">protected</span> <span class="token keyword">readonly</span> state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">protected</span> <span class="token function">initLayout</span><span class="token punctuation">(</span>accessor<span class="token operator">:</span> ServicesAccessor<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">private</span> <span class="token function">registerLayoutListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">private</span> <span class="token function">onMenubarToggled</span><span class="token punctuation">(</span>visible<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">private</span> <span class="token function">onFullscreenChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">private</span> <span class="token function">doUpdateLayoutConfiguration</span><span class="token punctuation">(</span>skipLayout<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">private</span> <span class="token function">setSideBarPosition</span><span class="token punctuation">(</span>position<span class="token operator">:</span> Position<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">private</span> <span class="token function">initLayoutState</span><span class="token punctuation">(</span>
    lifecycleService<span class="token operator">:</span> ILifecycleService<span class="token punctuation">,</span>
    fileService<span class="token operator">:</span> IFileService
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">private</span> <span class="token function">resolveEditorsToOpen</span><span class="token punctuation">(</span>
    fileService<span class="token operator">:</span> IFileService
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>IResourceEditor<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token operator">|</span> IResourceEditor<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">private</span> <span class="token function">hasInitialFilesToOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">private</span> <span class="token function">updatePanelPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">registerPart</span><span class="token punctuation">(</span>part<span class="token operator">:</span> Part<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">protected</span> <span class="token function">getPart</span><span class="token punctuation">(</span>key<span class="token operator">:</span> Parts<span class="token punctuation">)</span><span class="token operator">:</span> Part <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">isRestored</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">hasFocus</span><span class="token punctuation">(</span>part<span class="token operator">:</span> Parts<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">getContainer</span><span class="token punctuation">(</span>part<span class="token operator">:</span> Parts<span class="token punctuation">)</span><span class="token operator">:</span> HTMLElement <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">isVisible</span><span class="token punctuation">(</span>part<span class="token operator">:</span> Parts<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">getTitleBarOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">getWorkbenchElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> HTMLElement <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">toggleZenMode</span><span class="token punctuation">(</span>skipLayout<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span> restoring <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">private</span> <span class="token function">setStatusBarHidden</span><span class="token punctuation">(</span>hidden<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span> skipLayout<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">private</span> <span class="token function">setIconExploration</span><span class="token punctuation">(</span>enabled<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">protected</span> <span class="token function">createWorkbenchLayout</span><span class="token punctuation">(</span>
    instantiationService<span class="token operator">:</span> IInstantiationService
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">layout</span><span class="token punctuation">(</span>options<span class="token operator">?</span><span class="token operator">:</span> ILayoutOptions<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">private</span> <span class="token function">layoutGrid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">private</span> <span class="token function">getPanelDimension</span><span class="token punctuation">(</span>position<span class="token operator">:</span> Position<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">isEditorLayoutCentered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">centerEditorLayout</span><span class="token punctuation">(</span>active<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span> skipLayout<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">resizePart</span><span class="token punctuation">(</span>part<span class="token operator">:</span> Parts<span class="token punctuation">,</span> sizeChange<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">setActivityBarHidden</span><span class="token punctuation">(</span>hidden<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span> skipLayout<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">setEditorHidden</span><span class="token punctuation">(</span>hidden<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span> skipLayout<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">setSideBarHidden</span><span class="token punctuation">(</span>hidden<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span> skipLayout<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">setPanelHidden</span><span class="token punctuation">(</span>hidden<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span> skipLayout<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">toggleMaximizedPanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">isPanelMaximized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">getSideBarPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Position <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">setMenubarVisibility</span><span class="token punctuation">(</span>
    visibility<span class="token operator">:</span> MenuBarVisibility<span class="token punctuation">,</span>
    skipLayout<span class="token operator">:</span> <span class="token builtin">boolean</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">getMenubarVisibility</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> MenuBarVisibility <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">getPanelPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Position <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">setPanelPosition</span><span class="token punctuation">(</span>position<span class="token operator">:</span> Position<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">private</span> <span class="token function">savePanelDimension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">private</span> <span class="token function">saveLayoutState</span><span class="token punctuation">(</span>e<span class="token operator">:</span> IWillSaveStateEvent<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>至此我们已经找到 Workbench 的关键代码，对于我们拓展主界面(Workbench)的视图，关键在于 Workbench 类的 <code>renderWorkbench</code> 方法,Layout 类的 <code>initLayout()</code> 方法、<code>createWorkbenchLayout()</code> 方法、<code>layout()</code> 方法。</p> <h2 id="拓展-workbench">拓展 Workbench</h2> <p>下图是 TaobaoEditor 的整体开发界面：</p> <p><img src="/assets/img/taobao-editor.da40887c.png" alt></p> <p>之前的文章中我们了解到 Workbench 主要分为以下几个部分：</p> <ul><li>标题栏: Title Bar</li> <li>活动栏: Activity Bar</li> <li>侧边栏: Side Bar</li> <li>面板: Panal</li> <li>编辑器群: Editor</li> <li>状态栏: Status Bar</li></ul> <p>VSC 的 UI 是由一个个 Part 组成的，每个 Part 由 Workbanch 统一管理，由 WorkbanchLayout 负责布局。每个 Part 功能独立，改变布局并不会对功能产生影响，添加新的 Part 可以添加新的功能比如右边栏和工具栏。</p> <p>很明显最上面的 Header Bar 和 Simulator 不是 VS Code 实现的，这个也没有办法直接通过插件拓展的方式去实现。那么像 Header Bar 和 Simulator 这样的 UI 是怎么实现的呢？我们通过实现如下的例子 Header Bar 来进行说明。</p> <p><img src="/assets/img/header-bar.a4c0ef30.png" alt></p> <p>src/vs/workbench 的目录结构：</p> <div class="language- extra-class"><pre class="language-text"><code>├── api
├── browser
│   ├── actions
│   ├── media
│   ├── parts
│   │   ├── activitybar
│   │   ├── editor
│   │   ├── panel
│   │   ├── statusbar
│   │   ├── ...
│   ├── actions.ts
│   ├── ...
│   ├── layout.ts
│   ├── legacyLayout.ts
│   ├── part.ts
│   └── workbench.ts
├── common
├── contrib
├── electron-browser
├── services
├── test
├── buildfile.js
├── workbench.main.css
├── workbench.main.nls.js
├── workbench.main.ts
├── workbench.web.main.css
├── workbench.web.main.nls.js
└── workbench.web.main.ts
</code></pre></div><h3 id="继承-part-类">继承 Part 类</h3> <p>这里我在 <code>src/vs/workbench/browser/parts</code> 增加一个文件夹 headerbar：</p> <div class="language- extra-class"><pre class="language-text"><code>├── media
│   ├── headerbarpart.css
└── headerbarPart.ts
</code></pre></div><p><code>src/vs/workbench/browser/parts/headerbar/headerbarPart.ts</code> 如下：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token string">&quot;vs/css!./media/Headerbarpart&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Part <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vs/workbench/browser/part&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> addClass <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vs/base/browser/dom&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  IInstantiationService<span class="token punctuation">,</span>
  ServiceIdentifier
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vs/platform/instantiation/common/instantiation&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  Parts<span class="token punctuation">,</span>
  IWorkbenchLayoutService
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vs/workbench/services/layout/browser/layoutService&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> IStorageService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vs/platform/storage/common/storage&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> IThemeService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vs/platform/theme/common/themeService&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> IHeaderBarService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vs/workbench/services/headerBar/browser/headerBarService&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> registerSingleton <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vs/platform/instantiation/common/extensions&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">ACTIVITY_BAR_BACKGROUND</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vs/workbench/common/theme&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HeaderbarPart</span> <span class="token keyword">extends</span> <span class="token class-name">Part</span> <span class="token keyword">implements</span> <span class="token class-name">IHeaderBarService</span> <span class="token punctuation">{</span>
  _serviceBrand<span class="token operator">:</span> ServiceIdentifier<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

  minimumWidth<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  maximumWidth<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  minimumHeight<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
  maximumHeight<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token decorator"><span class="token at operator">@</span><span class="token function">IStorageService</span></span> storageService<span class="token operator">:</span> IStorageService<span class="token punctuation">,</span>
    <span class="token decorator"><span class="token at operator">@</span><span class="token function">IThemeService</span></span> themeService<span class="token operator">:</span> IThemeService<span class="token punctuation">,</span>
    <span class="token decorator"><span class="token at operator">@</span><span class="token function">IWorkbenchLayoutService</span></span> layoutService<span class="token operator">:</span> IWorkbenchLayoutService<span class="token punctuation">,</span>
    <span class="token decorator"><span class="token at operator">@</span><span class="token function">IInstantiationService</span></span> instantiationService<span class="token operator">:</span> IInstantiationService
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>
      Parts<span class="token punctuation">.</span><span class="token constant">HEADERBAR_PART</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> hasTitle<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      themeService<span class="token punctuation">,</span>
      storageService<span class="token punctuation">,</span>
      layoutService
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">createContentArea</span><span class="token punctuation">(</span>parent<span class="token operator">:</span> HTMLElement<span class="token punctuation">)</span><span class="token operator">:</span> HTMLElement <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>element <span class="token operator">=</span> parent<span class="token punctuation">;</span>

    <span class="token keyword">const</span> content <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addClass</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> <span class="token string">&quot;header-wrapper&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    parent<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    content<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">&quot;header-bar&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> content<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">updateStyles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">updateStyles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> container <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getColor</span><span class="token punctuation">(</span><span class="token constant">ACTIVITY_BAR_BACKGROUND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">layout</span><span class="token punctuation">(</span>width<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> height<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">layoutContents</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> object <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> Parts<span class="token punctuation">.</span><span class="token constant">HEADERBAR_PART</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">registerSingleton</span><span class="token punctuation">(</span>IHeaderBarService<span class="token punctuation">,</span> HeaderbarPart<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>src/vs/workbench/services/headerBar/browser/headerBarService.ts</code>：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createDecorator <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vs/platform/instantiation/common/instantiation&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> IHeaderBarService <span class="token operator">=</span> <span class="token generic-function"><span class="token function">createDecorator</span><span class="token generic class-name"><span class="token operator">&lt;</span>IHeaderBarService<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  <span class="token string">&quot;headerBarService&quot;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">IHeaderBarService</span> <span class="token punctuation">{</span>
  _serviceBrand<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们的服务需要在 <code>workbench.main.ts</code> 和 <code>workbench.web.main.ts</code> 进行注册才能被 <code>workbench.initServices</code> 自动收集作为通用服务注入到容器内，被 <code>Layout.initLayout</code> 方法初始化。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">//#region --- workbench parts</span>
<span class="token operator">...</span>
<span class="token keyword">import</span> <span class="token string">'vs/workbench/browser/parts/headerbar/headerbarPart'</span><span class="token punctuation">;</span>
<span class="token operator">...</span>
<span class="token comment">//#endregion</span>
</code></pre></div><h3 id="修改-workbench-与-layout">修改 Workbench 与 Layout</h3> <p><code>src/vs/workbench/services/layout/browser/layoutService.ts</code>：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token keyword">enum</span> Parts <span class="token punctuation">{</span>
  <span class="token constant">TITLEBAR_PART</span> <span class="token operator">=</span> <span class="token string">&quot;workbench.parts.titlebar&quot;</span><span class="token punctuation">,</span>
  <span class="token constant">HEADERBAR_PART</span> <span class="token operator">=</span> <span class="token string">&quot;workbench.parts.headerbar&quot;</span><span class="token punctuation">,</span>
  <span class="token constant">ACTIVITYBAR_PART</span> <span class="token operator">=</span> <span class="token string">&quot;workbench.parts.activitybar&quot;</span><span class="token punctuation">,</span>
  <span class="token constant">SIDEBAR_PART</span> <span class="token operator">=</span> <span class="token string">&quot;workbench.parts.sidebar&quot;</span><span class="token punctuation">,</span>
  <span class="token constant">PANEL_PART</span> <span class="token operator">=</span> <span class="token string">&quot;workbench.parts.panel&quot;</span><span class="token punctuation">,</span>
  <span class="token constant">EDITOR_PART</span> <span class="token operator">=</span> <span class="token string">&quot;workbench.parts.editor&quot;</span><span class="token punctuation">,</span>
  <span class="token constant">STATUSBAR_PART</span> <span class="token operator">=</span> <span class="token string">&quot;workbench.parts.statusbar&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>src/vs/workbench/browser/workbench.ts#renderWorkbench</code>：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> Parts<span class="token punctuation">.</span><span class="token constant">TITLEBAR_PART</span><span class="token punctuation">,</span> role<span class="token operator">:</span> <span class="token string">&quot;contentinfo&quot;</span><span class="token punctuation">,</span> classes<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;titlebar&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> Parts<span class="token punctuation">.</span><span class="token constant">HEADERBAR_PART</span><span class="token punctuation">,</span> role<span class="token operator">:</span> <span class="token string">&quot;complementary&quot;</span><span class="token punctuation">,</span> classes<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;headerbar&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    id<span class="token operator">:</span> Parts<span class="token punctuation">.</span><span class="token constant">ACTIVITYBAR_PART</span><span class="token punctuation">,</span>
    role<span class="token operator">:</span> <span class="token string">&quot;navigation&quot;</span><span class="token punctuation">,</span>
    classes<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;activitybar&quot;</span><span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>sideBar<span class="token punctuation">.</span>position <span class="token operator">===</span> Position<span class="token punctuation">.</span><span class="token constant">LEFT</span> <span class="token operator">?</span> <span class="token string">&quot;left&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;right&quot;</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    id<span class="token operator">:</span> Parts<span class="token punctuation">.</span><span class="token constant">SIDEBAR_PART</span><span class="token punctuation">,</span>
    role<span class="token operator">:</span> <span class="token string">&quot;complementary&quot;</span><span class="token punctuation">,</span>
    classes<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;sidebar&quot;</span><span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>sideBar<span class="token punctuation">.</span>position <span class="token operator">===</span> Position<span class="token punctuation">.</span><span class="token constant">LEFT</span> <span class="token operator">?</span> <span class="token string">&quot;left&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;right&quot;</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    id<span class="token operator">:</span> Parts<span class="token punctuation">.</span><span class="token constant">EDITOR_PART</span><span class="token punctuation">,</span>
    role<span class="token operator">:</span> <span class="token string">&quot;main&quot;</span><span class="token punctuation">,</span>
    classes<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;editor&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    options<span class="token operator">:</span> <span class="token punctuation">{</span> restorePreviousState<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>editor<span class="token punctuation">.</span>restoreEditors <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    id<span class="token operator">:</span> Parts<span class="token punctuation">.</span><span class="token constant">PANEL_PART</span><span class="token punctuation">,</span>
    role<span class="token operator">:</span> <span class="token string">&quot;complementary&quot;</span><span class="token punctuation">,</span>
    classes<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;panel&quot;</span><span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>panel<span class="token punctuation">.</span>position <span class="token operator">===</span> Position<span class="token punctuation">.</span><span class="token constant">BOTTOM</span> <span class="token operator">?</span> <span class="token string">&quot;bottom&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;right&quot;</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> Parts<span class="token punctuation">.</span><span class="token constant">STATUSBAR_PART</span><span class="token punctuation">,</span> role<span class="token operator">:</span> <span class="token string">&quot;contentinfo&quot;</span><span class="token punctuation">,</span> classes<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;statusbar&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token punctuation">,</span> role<span class="token punctuation">,</span> classes<span class="token punctuation">,</span> options <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> partContainer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createPart</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> role<span class="token punctuation">,</span> classes<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>configurationService<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">&quot;workbench.useExperimentalGridLayout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// TODO@Ben cleanup once moved to grid</span>
    <span class="token comment">// Insert all workbench parts at the beginning. Issue #52531</span>
    <span class="token comment">// This is primarily for the title bar to allow overriding -webkit-app-region</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>partContainer<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">.</span>lastChild<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPart</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>partContainer<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>src/vs/workbench/browser/layout.ts</code>:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">protected</span> <span class="token function">initLayout</span><span class="token punctuation">(</span>accessor<span class="token operator">:</span> ServicesAccessor<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token comment">// Parts</span>
  accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IActivityBarService<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// not used, but called to ensure instantiated</span>
	accessor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IHeaderBarService<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">getContainer</span><span class="token punctuation">(</span>part<span class="token operator">:</span> Parts<span class="token punctuation">)</span><span class="token operator">:</span> HTMLElement <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>part<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> Parts<span class="token punctuation">.</span><span class="token constant">HEADERBAR_PART</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPart</span><span class="token punctuation">(</span>Parts<span class="token punctuation">.</span><span class="token constant">HEADERBAR_PART</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">protected</span> <span class="token function">createWorkbenchLayout</span><span class="token punctuation">(</span>instantiationService<span class="token operator">:</span> IInstantiationService<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> headerBar <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPart</span><span class="token punctuation">(</span>Parts<span class="token punctuation">.</span><span class="token constant">HEADERBAR_PART</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>configurationService<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">'workbench.useExperimentalGridLayout'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Create view wrappers for all parts</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>headerBarPartView <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">View</span><span class="token punctuation">(</span>headerBar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>workbenchGrid <span class="token operator">=</span> instantiationService<span class="token punctuation">.</span><span class="token function">createInstance</span><span class="token punctuation">(</span>
      WorkbenchLegacyLayout<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        titlebar<span class="token operator">:</span> titleBar<span class="token punctuation">,</span>
        activitybar<span class="token operator">:</span> activityBar<span class="token punctuation">,</span>
        editor<span class="token operator">:</span> editorPart<span class="token punctuation">,</span>
        sidebar<span class="token operator">:</span> sideBar<span class="token punctuation">,</span>
        panel<span class="token operator">:</span> panelPart<span class="token punctuation">,</span>
        statusbar<span class="token operator">:</span> statusBar<span class="token punctuation">,</span>
        headerbar<span class="token operator">:</span> headerBar
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token function">layoutGrid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token keyword">let</span> headerBarInGrid <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>workbenchGrid<span class="token punctuation">.</span><span class="token function">hasView</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>headerBarPartView<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> panelInGrid <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>workbenchGrid<span class="token punctuation">.</span><span class="token function">hasView</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>panelPartView<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
  <span class="token comment">// Add parts to grid</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>headerBarInGrid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>workbenchGrid<span class="token punctuation">.</span><span class="token function">addView</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>headerBarPartView<span class="token punctuation">,</span> Sizing<span class="token punctuation">.</span>Split<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>titleBarPartView<span class="token punctuation">,</span> Direction<span class="token punctuation">.</span>Down<span class="token punctuation">)</span><span class="token punctuation">;</span>
    headerBarInGrid <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>headerBar<span class="token punctuation">.</span>hidden<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>headerBarPartView<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>workbench 有两种布局模式：网格布局(Grid)和精确像素布局(WorkbenchLegacyLayout)。网格布局需要开启 settings 里面的<code>workbench.useExperimentalGridLayout</code>，设置为 true 生效；精确像素布局统一用绝对布局 + 计算的方式。VS Code 默认采用精确像素布局，主要逻辑在<code>src/vs/workbench/browser/legacyLayout.ts</code> 中。上面为了新增 headerbar，我们主要需要调整 activitybarContainer、sidebarContainer、editorContainer 的位置，修改 top 参数 <code>this.titlebarHeight</code> 为 <code>this.titlebarHeight + this.headerbarHeight</code>。</p> <h2 id="后记">后记</h2> <p>VS Code 整体架构非常复杂，但同时源码非常清晰明了，也极少有第三方依赖，核心模块大都是由自身实现，包括编辑器(Monaco)、依赖注入系统、模块加载（拦截加载器）、插件系统、语言服务、调试器前端及调试器协议等。本文重点围绕 Workbench 创建流程入手粗略的跟踪源码过程，对 Electron 进程模型及 VS Code 依赖注入系统的了解有助于我们理解整体流程中的关键代码。</p> <h2 id="参考">参考</h2> <ul><li><a href="https://electronjs.org/docs/tutorial/application-architecture" target="_blank" rel="noopener noreferrer">Electron Application Architecture<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://imweb.io/topic/5b3b72ab4d378e703a4f4435" target="_blank" rel="noopener noreferrer">你不知道的 Electron (一)：神奇的 remote 模块<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/ProtoTeam/blog/blob/master/201804/3.md" target="_blank" rel="noopener noreferrer">Dive Into Code: VSCode 源码阅读（一）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://juejin.im/post/5c4e86fe6fb9a049dc02a1b1" target="_blank" rel="noopener noreferrer">十几行代码实现一个 ts 依赖注入<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.cnblogs.com/front-end-ralph/p/5208045.html" target="_blank" rel="noopener noreferrer">细数 Javascript 技术栈中的四种依赖注入<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://zhuanlan.zhihu.com/p/59033621" target="_blank" rel="noopener noreferrer">VSCode 源码解读-Workbench<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://zhuanlan.zhihu.com/p/60228431" target="_blank" rel="noopener noreferrer">详解 VS Code 依赖注入的原理与实现<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <div data-v-3bd334e8><p class="descript" data-v-3bd334e8>写这些代码也许就一两个小时的事，写一篇大家好接受的文章需要几天的酝酿，如果文章对您有帮助请我喝杯咖啡吧！</p> <img src="/supportme.png" class="pay-code" data-v-3bd334e8> <div data-v-3bd334e8><div id="container"></div></div> <div class="footer" data-v-4f0df4b0 data-v-3bd334e8><p data-v-4f0df4b0>站点总访问量： 站点总访客数：</p> <p data-v-4f0df4b0>博客内容遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" data-v-4f0df4b0>知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></p> <p data-v-4f0df4b0>赵梦欢 © 2015 - 2023</p></div></div></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.f3e141ba.js" defer></script><script src="/assets/js/17.4f7ae4ec.js" defer></script><script src="/assets/js/18.c373a36e.js" defer></script><script src="/assets/js/34.124c31c0.js" defer></script>
  </body>
</html>
