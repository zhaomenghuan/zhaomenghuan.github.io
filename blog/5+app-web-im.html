<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>mui 初级入门教程（五）— 聊聊即时通讯（IM），基于环信 web im SDK | 匠心博客</title>
    <meta name="description" content="小青年,匠心,小青年博客,匠心博客,前端开发,android,技术宅,菜鸟教程,一个神奇的博客。">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.685c010a.css" as="style"><link rel="preload" href="/assets/js/app.f3e141ba.js" as="script"><link rel="preload" href="/assets/js/42.7de428af.js" as="script"><link rel="preload" href="/assets/js/18.c373a36e.js" as="script"><link rel="preload" href="/assets/js/34.124c31c0.js" as="script"><link rel="prefetch" href="/assets/js/1.1950ec81.js"><link rel="prefetch" href="/assets/js/10.7f857e71.js"><link rel="prefetch" href="/assets/js/100.e03c01d2.js"><link rel="prefetch" href="/assets/js/101.7b790a2f.js"><link rel="prefetch" href="/assets/js/102.a7aa77f9.js"><link rel="prefetch" href="/assets/js/103.d473991c.js"><link rel="prefetch" href="/assets/js/104.9fe8785c.js"><link rel="prefetch" href="/assets/js/105.7291ae49.js"><link rel="prefetch" href="/assets/js/106.2c35a2f4.js"><link rel="prefetch" href="/assets/js/107.a71ccb64.js"><link rel="prefetch" href="/assets/js/108.9d6f54a8.js"><link rel="prefetch" href="/assets/js/109.e77d12ca.js"><link rel="prefetch" href="/assets/js/11.5378ae65.js"><link rel="prefetch" href="/assets/js/12.9aca40f8.js"><link rel="prefetch" href="/assets/js/13.ce2b655c.js"><link rel="prefetch" href="/assets/js/14.7488ca24.js"><link rel="prefetch" href="/assets/js/15.9c07ac98.js"><link rel="prefetch" href="/assets/js/16.8f57294c.js"><link rel="prefetch" href="/assets/js/17.4f7ae4ec.js"><link rel="prefetch" href="/assets/js/19.c7be2474.js"><link rel="prefetch" href="/assets/js/2.7f7e5268.js"><link rel="prefetch" href="/assets/js/20.f8833113.js"><link rel="prefetch" href="/assets/js/21.e71dd521.js"><link rel="prefetch" href="/assets/js/22.92dc7b77.js"><link rel="prefetch" href="/assets/js/23.285557d3.js"><link rel="prefetch" href="/assets/js/24.a803551c.js"><link rel="prefetch" href="/assets/js/25.dbeaa19d.js"><link rel="prefetch" href="/assets/js/26.9ca97076.js"><link rel="prefetch" href="/assets/js/27.d1a2911b.js"><link rel="prefetch" href="/assets/js/28.25c216b3.js"><link rel="prefetch" href="/assets/js/29.9dc30af4.js"><link rel="prefetch" href="/assets/js/30.1e9d6e06.js"><link rel="prefetch" href="/assets/js/31.3d7dbe62.js"><link rel="prefetch" href="/assets/js/32.36371ba7.js"><link rel="prefetch" href="/assets/js/33.78edc66d.js"><link rel="prefetch" href="/assets/js/35.a5470008.js"><link rel="prefetch" href="/assets/js/36.acde7543.js"><link rel="prefetch" href="/assets/js/37.f6648812.js"><link rel="prefetch" href="/assets/js/38.1885784f.js"><link rel="prefetch" href="/assets/js/39.af4b4bbd.js"><link rel="prefetch" href="/assets/js/4.61024115.js"><link rel="prefetch" href="/assets/js/40.ec6e88a9.js"><link rel="prefetch" href="/assets/js/41.67d4e8b7.js"><link rel="prefetch" href="/assets/js/43.b4f51fa8.js"><link rel="prefetch" href="/assets/js/44.487d119d.js"><link rel="prefetch" href="/assets/js/45.2206665b.js"><link rel="prefetch" href="/assets/js/46.125163cc.js"><link rel="prefetch" href="/assets/js/47.8722f507.js"><link rel="prefetch" href="/assets/js/48.b8bfe77f.js"><link rel="prefetch" href="/assets/js/49.77fac897.js"><link rel="prefetch" href="/assets/js/5.3395f0b5.js"><link rel="prefetch" href="/assets/js/50.d68289a2.js"><link rel="prefetch" href="/assets/js/51.d9d70556.js"><link rel="prefetch" href="/assets/js/52.6a2c9e02.js"><link rel="prefetch" href="/assets/js/53.ff13cf8b.js"><link rel="prefetch" href="/assets/js/54.7e844902.js"><link rel="prefetch" href="/assets/js/55.80aa3d86.js"><link rel="prefetch" href="/assets/js/56.a4124774.js"><link rel="prefetch" href="/assets/js/57.55eb7355.js"><link rel="prefetch" href="/assets/js/58.7d0e2bc5.js"><link rel="prefetch" href="/assets/js/59.9cdd695c.js"><link rel="prefetch" href="/assets/js/6.77e8533c.js"><link rel="prefetch" href="/assets/js/60.54318be9.js"><link rel="prefetch" href="/assets/js/61.82e1ea82.js"><link rel="prefetch" href="/assets/js/62.b065e499.js"><link rel="prefetch" href="/assets/js/63.bb770dde.js"><link rel="prefetch" href="/assets/js/64.996fdbfd.js"><link rel="prefetch" href="/assets/js/65.54f3baf3.js"><link rel="prefetch" href="/assets/js/66.38d28ab3.js"><link rel="prefetch" href="/assets/js/67.5cf5a3bc.js"><link rel="prefetch" href="/assets/js/68.f2418476.js"><link rel="prefetch" href="/assets/js/69.162d06c4.js"><link rel="prefetch" href="/assets/js/7.a2cd9d6c.js"><link rel="prefetch" href="/assets/js/70.80f1252b.js"><link rel="prefetch" href="/assets/js/71.970dda3c.js"><link rel="prefetch" href="/assets/js/72.a073c997.js"><link rel="prefetch" href="/assets/js/73.674106d1.js"><link rel="prefetch" href="/assets/js/74.a0336873.js"><link rel="prefetch" href="/assets/js/75.37fbb329.js"><link rel="prefetch" href="/assets/js/76.a9439343.js"><link rel="prefetch" href="/assets/js/77.d52439f1.js"><link rel="prefetch" href="/assets/js/78.fbffcd6c.js"><link rel="prefetch" href="/assets/js/79.c6d73001.js"><link rel="prefetch" href="/assets/js/8.f0af9f9c.js"><link rel="prefetch" href="/assets/js/80.eab87966.js"><link rel="prefetch" href="/assets/js/81.9931436f.js"><link rel="prefetch" href="/assets/js/82.b29080c9.js"><link rel="prefetch" href="/assets/js/83.d94ed517.js"><link rel="prefetch" href="/assets/js/84.600be30f.js"><link rel="prefetch" href="/assets/js/85.a6938cc3.js"><link rel="prefetch" href="/assets/js/86.7dec6ed4.js"><link rel="prefetch" href="/assets/js/87.5d2c1dc9.js"><link rel="prefetch" href="/assets/js/88.8f2410d4.js"><link rel="prefetch" href="/assets/js/89.fe8c04e8.js"><link rel="prefetch" href="/assets/js/9.f542ab97.js"><link rel="prefetch" href="/assets/js/90.f25166a8.js"><link rel="prefetch" href="/assets/js/91.038ee701.js"><link rel="prefetch" href="/assets/js/92.19e610e0.js"><link rel="prefetch" href="/assets/js/93.22cd83c8.js"><link rel="prefetch" href="/assets/js/94.7495cfa6.js"><link rel="prefetch" href="/assets/js/95.f149c41d.js"><link rel="prefetch" href="/assets/js/96.cee91e1f.js"><link rel="prefetch" href="/assets/js/97.27a1bb57.js"><link rel="prefetch" href="/assets/js/98.67d4f125.js"><link rel="prefetch" href="/assets/js/99.35daa60c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.685c010a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">匠心博客</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/index.html" class="nav-link">博文</a></div><div class="nav-item"><a href="/book/index.html" class="nav-link">专栏</a></div><div class="nav-item"><a href="/note/index.html" class="nav-link">笔记</a></div><div class="nav-item"><a href="/nav/index.html" class="nav-link">导航</a></div><div class="nav-item"><a href="/about/index.html" class="nav-link">关于</a></div> <a href="https://github.com/zhaomenghuan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/index.html" class="nav-link">博文</a></div><div class="nav-item"><a href="/book/index.html" class="nav-link">专栏</a></div><div class="nav-item"><a href="/note/index.html" class="nav-link">笔记</a></div><div class="nav-item"><a href="/nav/index.html" class="nav-link">导航</a></div><div class="nav-item"><a href="/about/index.html" class="nav-link">关于</a></div> <a href="https://github.com/zhaomenghuan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>mui 初级入门教程（五）— 聊聊即时通讯（IM），基于环信 web im SDK</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/5%2Bapp-web-im.html#写在前面" class="sidebar-link">写在前面</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/5%2Bapp-web-im.html#准备工作" class="sidebar-link">准备工作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/5%2Bapp-web-im.html#_1-注册账号" class="sidebar-link">1.注册账号</a></li><li class="sidebar-sub-header"><a href="/blog/5%2Bapp-web-im.html#_2-下载-sdk" class="sidebar-link">2.下载 SDK</a></li><li class="sidebar-sub-header"><a href="/blog/5%2Bapp-web-im.html#_3-开发文档" class="sidebar-link">3.开发文档</a></li></ul></li><li><a href="/blog/5%2Bapp-web-im.html#项目实战" class="sidebar-link">项目实战</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/5%2Bapp-web-im.html#_1-用户注册功能" class="sidebar-link">1.用户注册功能</a></li><li class="sidebar-sub-header"><a href="/blog/5%2Bapp-web-im.html#_2-用户登录功能" class="sidebar-link">2.用户登录功能</a></li><li class="sidebar-sub-header"><a href="/blog/5%2Bapp-web-im.html#_3-页面传参深入探究" class="sidebar-link">3.页面传参深入探究</a></li><li class="sidebar-sub-header"><a href="/blog/5%2Bapp-web-im.html#_4-获取好友列表及添加好友" class="sidebar-link">4.获取好友列表及添加好友</a></li><li class="sidebar-sub-header"><a href="/blog/5%2Bapp-web-im.html#_5-数据绑定和本地缓存处理机制" class="sidebar-link">5.数据绑定和本地缓存处理机制</a></li><li class="sidebar-sub-header"><a href="/blog/5%2Bapp-web-im.html#_6-聊天消息封装" class="sidebar-link">6.聊天消息封装</a></li><li class="sidebar-sub-header"><a href="/blog/5%2Bapp-web-im.html#_7-单聊之文本消息" class="sidebar-link">7.单聊之文本消息</a></li></ul></li><li><a href="/blog/5%2Bapp-web-im.html#写在后面" class="sidebar-link">写在后面</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="mui-初级入门教程（五）—-聊聊即时通讯（im），基于环信-web-im-sdk">mui 初级入门教程（五）— 聊聊即时通讯（IM），基于环信 web im SDK</h1> <h2 id="写在前面">写在前面</h2> <p>感觉自从<code>qq</code>、微信这种<code>APP</code>用多了，现在都没啥人发短信了，现在什么<code>APP</code>都想加入<code>IM</code>的功能，曾经有段时间在折腾自己撸一个聊天的东西，也尝试过很多平台，今天这里给大家介绍一下从零开始自己做一个聊天的<code>app</code>功能。因为之前帮朋友做过一个基于环信的聊天功能，这里就以环信的平台为例举个例子说明。这篇文章注意想讲解一下集成这种第三方的一般实现方法，不会一下子就把所有的功能都集成，因为之前做环信主要是在微信上用，所以用的是环信的<code>Web IM</code>，遇到了蛮多坑，这次打算用<code>dcloud</code>这边的<code>mui</code>重新集成，所以在没有完全做完之前，所以也不知道有些坑具体能够在有限的时间内解决，本文仅供参考，欢迎大家去实践检验。在写这篇文章之前先贴一个<code>Dcloud</code>论坛中的资源帖，<a href="http://ask.dcloud.net.cn/article/649" target="_blank" rel="noopener noreferrer">【即时通信、im 问题汇总】<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="准备工作">准备工作</h2> <h3 id="_1-注册账号">1.注册账号</h3> <p>我们要先去<a href="http://www.easemob.com/product/im" target="_blank" rel="noopener noreferrer">环信官网<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>注册一个账号，然后在后台创建一个应用，因为我们后面在做功能的时候可以用后面发送消息及图片来测试收消息，用户管理在后台也可以看得一清二楚。</p> <p><img src="http://oo1uw74rb.bkt.clouddn.com/20160615001.png" alt="环信官网"></p> <p>创建成功后找到应用标识(AppKey)，这个在后期配置中会用到。</p> <h3 id="_2-下载-sdk">2.下载 SDK</h3> <p>http://www.easemob.com/download/im
这里我们使用的是<code>Web IM</code>，所以下载的<code>SDK</code>是<code>Web IM</code>版本，下载之后我们会看到一个演示<code>demo</code>,由于这个是<code>pc</code>版本，和我们需求不一致，所以我们只需要关心<code>sdk</code>目录下的文件和 sdk 集成需要修改的配置文件<code>easemob.im.config.js</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">-</span><span class="token constant">README</span><span class="token punctuation">.</span><span class="token constant">MD</span>：
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">-</span>index<span class="token punctuation">.</span>html：demo首页，包含sdk基础功能和浏览器兼容性的解决方案

<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">-</span><span class="token keyword">static</span><span class="token operator">/</span>：
	js<span class="token operator">/</span>：
		easemob<span class="token punctuation">.</span>im<span class="token punctuation">.</span>config<span class="token punctuation">.</span>js：sdk集成需要修改的配置文件
	css<span class="token operator">/</span>：
	img<span class="token operator">/</span>：
	sdk<span class="token operator">/</span>：<span class="token comment">/*sdk相关文件*/</span>
		release<span class="token punctuation">.</span>txt：各版本更新细节
		quickstart<span class="token punctuation">.</span>md：环信WebIM快速入门文档
		easemob<span class="token punctuation">.</span>im<span class="token operator">-</span><span class="token number">1.1</span><span class="token punctuation">.</span>js：js sdk
		easemob<span class="token punctuation">.</span>im<span class="token operator">-</span><span class="token number">1.1</span><span class="token punctuation">.</span>shim<span class="token punctuation">.</span>js：支持老版本sdk api
		strophe<span class="token punctuation">.</span>js：sdk依赖脚本
</code></pre></div><h3 id="_3-开发文档">3.开发文档</h3> <p>Web IM 介绍 http://docs.easemob.com/im/400webimintegration/10webimintro</p> <h2 id="项目实战">项目实战</h2> <p>由于这篇重在在于如何使用第三方开发<code>IM</code>，感觉说再多也诶有意义，直接上代码说明。不讲解过多的原理、细节，只讲究开发流程。</p> <h3 id="_1-用户注册功能">1.用户注册功能</h3> <p>首先我们在 hbuilder 中先新建一个项目<code>easemobIM</code>,然后把环信<code>sdk</code>文件夹和配置文件拷贝到我们的工程中。为了节约时间，下面的功能演示我是根据官方登录模板改的。
<strong>html/reg.html</strong></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">HTML</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>utf-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>../css/mui.min.css<span class="token punctuation">&quot;</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>../css/style.css<span class="token punctuation">&quot;</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
			<span class="token selector">.mui-input-group:first-child</span> <span class="token punctuation">{</span>
				<span class="token property">margin-top</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token selector">.mui-input-group label</span> <span class="token punctuation">{</span>
				<span class="token property">width</span><span class="token punctuation">:</span> 22%<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token selector">.mui-input-row label~input,
			.mui-input-row label~select,
			.mui-input-row label~textarea</span> <span class="token punctuation">{</span>
				<span class="token property">width</span><span class="token punctuation">:</span> 78%<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token selector">.mui-checkbox input[type=checkbox],
			.mui-radio input[type=radio]</span> <span class="token punctuation">{</span>
				<span class="token property">top</span><span class="token punctuation">:</span> 6px<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token selector">.mui-content-padded</span> <span class="token punctuation">{</span>
				<span class="token property">margin-top</span><span class="token punctuation">:</span> 25px<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token selector">.mui-btn</span> <span class="token punctuation">{</span>
				<span class="token property">padding</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>header</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mui-bar mui-bar-nav<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mui-action-back mui-icon mui-icon-left-nav mui-pull-left<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mui-title<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>注册<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>header</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mui-content<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mui-input-group<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mui-input-row<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">&gt;</span></span>手机<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>username<span class="token punctuation">'</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mui-input-clear mui-input<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>请输入手机号码<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mui-input-row<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">&gt;</span></span>昵称<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>nickname<span class="token punctuation">'</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mui-input-clear mui-input<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>请输入昵称<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mui-input-row<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">&gt;</span></span>密码<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>password<span class="token punctuation">'</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mui-input-clear mui-input<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>请输入密码<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mui-input-row<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">&gt;</span></span>确认<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>password_confirm<span class="token punctuation">'</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mui-input-clear mui-input<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>请确认密码<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mui-content-padded<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>reg<span class="token punctuation">'</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mui-btn mui-btn-block mui-btn-primary<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>注册<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>../js/mui.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
		<span class="token comment">&lt;!--sdk--&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>../sdk/strophe.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>../sdk/easemob.im-1.1.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>../sdk/easemob.im-1.1.shim.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!--兼容老版本sdk需引入此文件--&gt;</span>
		<span class="token comment">&lt;!--config--&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>../js/easemob.im.config.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
			mui<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// 输入参数</span>
			<span class="token keyword">var</span> regConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
				<span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token function">mui</span><span class="token punctuation">(</span><span class="token string">&quot;#username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
				<span class="token literal-property property">nickname</span><span class="token operator">:</span> <span class="token function">mui</span><span class="token punctuation">(</span><span class="token string">&quot;#nickname&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
				<span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token function">mui</span><span class="token punctuation">(</span><span class="token string">&quot;#password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
				<span class="token literal-property property">passwordConfirm</span><span class="token operator">:</span> <span class="token function">mui</span><span class="token punctuation">(</span><span class="token string">&quot;#password_confirm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
			<span class="token punctuation">}</span><span class="token punctuation">;</span>

			<span class="token comment">// 注册事件监听</span>
			<span class="token function">mui</span><span class="token punctuation">(</span><span class="token string">&quot;#reg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'tap'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token keyword">var</span> username <span class="token operator">=</span> regConfig<span class="token punctuation">.</span>username<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
				<span class="token keyword">var</span> nickname <span class="token operator">=</span> regConfig<span class="token punctuation">.</span>nickname<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
				<span class="token keyword">var</span> password <span class="token operator">=</span> regConfig<span class="token punctuation">.</span>password<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
				<span class="token keyword">var</span> passwordConfirm <span class="token operator">=</span> regConfig<span class="token punctuation">.</span>passwordConfirm<span class="token punctuation">.</span>value<span class="token punctuation">;</span>

				<span class="token comment">// 电话号码校验</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isMobile</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	                mui<span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span><span class="token string">&quot;电话号码格式不正确&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	                <span class="token keyword">return</span><span class="token punctuation">;</span>
	            <span class="token punctuation">}</span>
				<span class="token comment">// 昵称非空校验</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>nickname<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
					mui<span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span><span class="token string">'昵称不能为空'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">return</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token comment">// 密码非空校验</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
					mui<span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span><span class="token string">'密码不能为空'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">return</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token comment">// 密码重复校验</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>passwordConfirm <span class="token operator">!=</span> password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					mui<span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span><span class="token string">'密码两次输入不一致'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">return</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
               <span class="token comment">// 环信SDK注册</span>
				<span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
					<span class="token literal-property property">username</span> <span class="token operator">:</span> username<span class="token punctuation">,</span>
					<span class="token literal-property property">password</span> <span class="token operator">:</span> password<span class="token punctuation">,</span>
					<span class="token literal-property property">nickname</span> <span class="token operator">:</span> nickname<span class="token punctuation">,</span>
					<span class="token literal-property property">appKey</span> <span class="token operator">:</span> Easemob<span class="token punctuation">.</span>im<span class="token punctuation">.</span>config<span class="token punctuation">.</span>appkey<span class="token punctuation">,</span>
					<span class="token function-variable function">success</span> <span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token comment">//注册成功;</span>
						console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>
						mui<span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span><span class="token string">'注册成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span><span class="token punctuation">,</span>
					<span class="token function-variable function">error</span> <span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token comment">//注册失败;</span>
						console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						mui<span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span><span class="token string">'注册失败：'</span><span class="token operator">+</span>e<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span><span class="token punctuation">;</span>
				Easemob<span class="token punctuation">.</span>im<span class="token punctuation">.</span>Helper<span class="token punctuation">.</span><span class="token function">registerUser</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// 是否为电话号码</span>
			<span class="token keyword">function</span> <span class="token function">isMobile</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">var</span> validateReg <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">0?(13|14|15|18)[0-9]{9}</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> validateReg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

			<span class="token comment">// 是否为空</span>
			<span class="token keyword">function</span> <span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token keyword">var</span> validateReg <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\S+$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> validateReg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>这是注册页面的代码，我们首先要引入环信的<code>sdk</code>和<code>easemob.im.config.js</code>，并且将<code>easemob.im.config.js</code>中的<code>appkey</code>换成自己的，然后根据用户名/密码/昵称注册环信 Web IM，提交注册的代码为:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">username</span><span class="token operator">:</span> username<span class="token punctuation">,</span>
  <span class="token literal-property property">password</span><span class="token operator">:</span> password<span class="token punctuation">,</span>
  <span class="token literal-property property">nickname</span><span class="token operator">:</span> nickname<span class="token punctuation">,</span>
  <span class="token literal-property property">appKey</span><span class="token operator">:</span> Easemob<span class="token punctuation">.</span>im<span class="token punctuation">.</span>config<span class="token punctuation">.</span>appkey<span class="token punctuation">,</span>
  <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//注册成功;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mui<span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span><span class="token string">&quot;注册成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//注册失败;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mui<span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span><span class="token string">&quot;注册失败：&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
Easemob<span class="token punctuation">.</span>im<span class="token punctuation">.</span>Helper<span class="token punctuation">.</span><span class="token function">registerUser</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>我们注册完了后可以在环信后台【IM 用户】查看用户注册信息，我们我们用其他平台，只需要把这块的内容改成相应的内容就 OK。</p> <h3 id="_2-用户登录功能">2.用户登录功能</h3> <p>有了注册页面的经验，我们写登录页面也很简单，页面布局脚本和其他与登录逻辑无关的代码我这里不贴了，大家在我最后给的地址上下载完整代码，这里只讲解基本基本思路。环信登录优两种方法，一种是通过实例化<code>new Easemob.im.Connection()</code>建立连接，一种是使用工具类<code>Easemob.im.Helper.login2UserGrid(options)</code>，我们刚刚注册就是使用了工具类，为了便于大家后面的学习，我们在这里把两种方法都说一下：</p> <h4 id="实例化new-easemob-im-connection-建立连接">实例化<code>new Easemob.im.Connection()</code>建立连接</h4> <p><strong>1.创建连接</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> conn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Easemob<span class="token punctuation">.</span>im<span class="token punctuation">.</span>Connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>2.初始化连接</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>conn<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">onOpened</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;成功登录&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    conn<span class="token punctuation">.</span><span class="token function">setPresence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>3.初始化连接</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 打开连接</span>
conn<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">user</span><span class="token operator">:</span> username<span class="token punctuation">,</span>
  <span class="token literal-property property">pwd</span><span class="token operator">:</span> password<span class="token punctuation">,</span>
  <span class="token literal-property property">appKey</span><span class="token operator">:</span> Easemob<span class="token punctuation">.</span>im<span class="token punctuation">.</span>config<span class="token punctuation">.</span>appkey
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>这里我们需要注意的是<code>open()</code>方法中需要配置的属性是<code>user</code>和<code>pwd</code>，这和我们注册时的有区别，要注意哦！</p></blockquote> <p>这里需要说明的是<code>init()</code>是环信提供的一个通用的方法，比如后面我们要用到的接收文本消息、图片消息等一系列的回调方法都写在这个里面，<code>onOpened()</code>方法主要是用于当执行<code>conn.open()</code>方法时需要执行的方法，我们一般会把页面需要初始化的逻辑写在<code>onOpened()</code>中，比如查询好友。</p> <p><strong>完整代码：</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 输入参数</span>
<span class="token keyword">var</span> loginConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token function">mui</span><span class="token punctuation">(</span><span class="token string">&quot;#username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token function">mui</span><span class="token punctuation">(</span><span class="token string">&quot;#password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 创建一个新的连接</span>
<span class="token keyword">var</span> conn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Easemob<span class="token punctuation">.</span>im<span class="token punctuation">.</span>Connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 初始化连接</span>
conn<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">onOpened</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mui<span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span><span class="token string">&quot;成功登录&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    conn<span class="token punctuation">.</span><span class="token function">setPresence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mui<span class="token punctuation">.</span><span class="token function">openWindow</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&quot;html/tab-webview-main.html&quot;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">extras</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">username</span><span class="token operator">:</span> loginConfig<span class="token punctuation">.</span>username<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
        <span class="token literal-property property">password</span><span class="token operator">:</span> loginConfig<span class="token punctuation">.</span>password<span class="token punctuation">.</span>value
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 登录事件监听</span>
<span class="token function">mui</span><span class="token punctuation">(</span><span class="token string">&quot;#login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;tap&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> username <span class="token operator">=</span> loginConfig<span class="token punctuation">.</span>username<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
  <span class="token keyword">var</span> password <span class="token operator">=</span> loginConfig<span class="token punctuation">.</span>password<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
  <span class="token comment">// 电话号码校验</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isMobile</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mui<span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span><span class="token string">&quot;电话号码格式不正确&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 密码非空校验</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mui<span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span><span class="token string">&quot;密码不能为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 打开连接</span>
  conn<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">user</span><span class="token operator">:</span> username<span class="token punctuation">,</span>
    <span class="token literal-property property">pwd</span><span class="token operator">:</span> password<span class="token punctuation">,</span>
    <span class="token literal-property property">appKey</span><span class="token operator">:</span> Easemob<span class="token punctuation">.</span>im<span class="token punctuation">.</span>config<span class="token punctuation">.</span>appkey
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="工具类easemob-im-helper-login2usergrid-options-建立连接">工具类<code>Easemob.im.Helper.login2UserGrid(options)</code>建立连接</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 登录</span>
<span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">user</span><span class="token operator">:</span> username<span class="token punctuation">,</span>
  <span class="token literal-property property">pwd</span><span class="token operator">:</span> password<span class="token punctuation">,</span>
  <span class="token literal-property property">appKey</span><span class="token operator">:</span> Easemob<span class="token punctuation">.</span>im<span class="token punctuation">.</span>config<span class="token punctuation">.</span>appkey<span class="token punctuation">,</span>
  <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mui<span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span><span class="token string">&quot;成功登录&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mui<span class="token punctuation">.</span><span class="token function">openWindow</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&quot;html/tab-webview-main.html&quot;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">extras</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">username</span><span class="token operator">:</span> loginConfig<span class="token punctuation">.</span>username<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
        <span class="token literal-property property">password</span><span class="token operator">:</span> loginConfig<span class="token punctuation">.</span>password<span class="token punctuation">.</span>value
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mui<span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span><span class="token string">&quot;成功失败:&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
Easemob<span class="token punctuation">.</span>im<span class="token punctuation">.</span>Helper<span class="token punctuation">.</span><span class="token function">login2UserGrid</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上面我们用了两种方法讲解了登录的方法，各有优劣，第二种只做登录的工作，代码也比较简洁，但是当我们的页面是多个页面时我们的登录状态是不能检测到的，这个时候我们还是需要在每个页面通过创建连接初始化，所以我们在页面跳转过程加入了拓展参数<code>extras</code>传递参数，然后在登陆后的页面接收就可以。</p> <h3 id="_3-页面传参深入探究">3.页面传参深入探究</h3> <p>为了尽可能简单的演示我们的功能，我这里不使用个性化的设计，就用官方模板组中的【mui 底部选项卡（webview 模式）】进行展示。新建模板文件如下：</p> <p><img src="http://i.imgur.com/JvDZUCk.png" alt></p> <p>我们去掉第一个选项卡，只保留消息<code>tab-webview-subpage-chat.html</code>、通讯录<code>tab-webview-subpage-contact.html</code>、设置<code>tab-webview-subpage-setting.html</code>三个选项卡。</p> <h4 id="拓展参数extras传值">拓展参数<code>extras</code>传值</h4> <p>上一小节中，我们在登陆页面通过拓展参数<code>extras</code>传值，在主页面接收数据的方法为：</p> <div class="language-js extra-class"><pre class="language-js"><code>mui<span class="token punctuation">.</span><span class="token function">plusReady</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> self <span class="token operator">=</span> plus<span class="token punctuation">.</span>webview<span class="token punctuation">.</span><span class="token function">currentWebview</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> username <span class="token operator">=</span> self<span class="token punctuation">.</span>username<span class="token punctuation">;</span>
  <span class="token keyword">var</span> password <span class="token operator">=</span> self<span class="token punctuation">.</span>password<span class="token punctuation">;</span>
  mui<span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span><span class="token string">&quot;username:&quot;</span> <span class="token operator">+</span> username <span class="token operator">+</span> <span class="token string">&quot;&lt;br /&gt;&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;password:&quot;</span> <span class="token operator">+</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在主界面<code>mui.plusReady</code>方法里面拿到值，然后可以在创建子<code>webview</code>时候用拓展参数传值，然后在子页用下面的方法用同样的方法可以拿到值。但是其实我们不需要父页面向子页面发消息，直接在子页面通过这个找到父页面对象就 OK 了，如下：
<strong>子页面代码：</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>mui<span class="token punctuation">.</span><span class="token function">plusReady</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> self <span class="token operator">=</span> plus<span class="token punctuation">.</span>webview<span class="token punctuation">.</span><span class="token function">currentWebview</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> username <span class="token operator">=</span> self<span class="token punctuation">.</span>username<span class="token punctuation">;</span>
  <span class="token keyword">var</span> password <span class="token operator">=</span> self<span class="token punctuation">.</span>password<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;username:&quot;</span> <span class="token operator">+</span> username <span class="token operator">+</span> <span class="token string">&quot;password:&quot;</span> <span class="token operator">+</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="预加载时使用mui-fire-传值">预加载时使用<code>mui.fire()</code>传值</h4> <p>这里需要特别说明一下的是我们有时候想要预加载我们的主页面，这里我们有个地方我需要特别注意的是，我们需要用<code>mui.fire()</code>传递参数：</p> <blockquote><p>mui.fire(target,event,data)</p></blockquote> <p>特别提醒一下：<code>target</code>是需要接受参数的<code>webview</code>对象，而不是<code>id</code>，在这个地方我出过错误，当时一直没有察觉，如果是<code>id</code>，需要使用<code>plus.webview.getWebviewById(id)</code>进行转换。</p> <p>比如我们在登陆页面使用<code>preload</code>预加载，代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">...</span>
<span class="token keyword">var</span> mainPage <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
mui<span class="token punctuation">.</span><span class="token function">plusReady</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	mainPage <span class="token operator">=</span> mui<span class="token punctuation">.</span><span class="token function">preload</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
		<span class="token string-property property">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">'html/tab-webview-main.html'</span><span class="token punctuation">,</span>
		<span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">'main'</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">...</span>
</code></pre></div><p><strong>登陆按钮监听事件中的 success 方法：</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>mui<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span>mainPage<span class="token punctuation">,</span> <span class="token string">&quot;show&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">username</span><span class="token operator">:</span> loginConfig<span class="token punctuation">.</span>username<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
  <span class="token literal-property property">password</span><span class="token operator">:</span> loginConfig<span class="token punctuation">.</span>password<span class="token punctuation">.</span>value
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  mui<span class="token punctuation">.</span><span class="token function">openWindow</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">&quot;main&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">show</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">aniShow</span><span class="token operator">:</span> <span class="token string">&quot;pop-in&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">waiting</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">autoShow</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在主页面中通过自定义<code>show</code>事件获得参数：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> username <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  password <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token comment">// 页面传参数事件监听</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;show&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获得事件参数</span>
  username <span class="token operator">=</span> event<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>username<span class="token punctuation">;</span>
  password <span class="token operator">=</span> event<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>password<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;username:&quot;</span> <span class="token operator">+</span> username <span class="token operator">+</span> <span class="token string">&quot;password:&quot;</span> <span class="token operator">+</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>我们需要注意的是我们刚刚在登录页面的账号密码传递到了<code>tab-webview-main.html</code>主页面，但是我们的每个子页面没有拿到账号密码。这里就有个容易犯错的地方，我们可能会直接在创建子<code>webview</code>时候通过拓展参数<code>extras</code>传值。</p> <blockquote><ul><li>经过试验发现经过预加载的主界面<code>tab-webview-main.html</code>的<code>mui.plusReady</code>方法比页面的自定义事件监听先执行，这是因为我们通过预加载的时候其实已经就执行了<code>mui.plusReady</code>方法，而自定义事件是在<code>webview</code>打开的时候执行。当主界面被预加载时，子页面的<code>loaded</code>事件也随着完成，创建子页面的时候我们根本就没有拿到数据怎么传，自然在子页得到的是<code>undefined</code>。我们这个时候如果想在主界面生成子页面的时候通过拓展参数<code>extras</code>传递给子页面根本行不通！</li></ul></blockquote> <ul><li><p>当需要接受参数的<code>webview</code>已经完成<code>loaded</code>事件，我们就不能使用拓展参数<code>extras</code>传参数，这个时候我们可以使用<code>webview.evalJS()</code>或者<code>mui.fire()</code>;另外我们使用<code>webview.evalJS()</code>或者<code>mui.fire()</code>时，接收参数的页面的<code>loaded</code>事件也必须发生才能使用。</p></li> <li><p>mui 传参数只能相互关联的两个 webview 之间传，比如 A 页面打开 B 页面，B 页面打开 C 页面，A 页面可以传值给 B 页面，但是 A 页面不能传值给 C 页面，我们可以通过 B 页面传给 C 页面。</p></li></ul> <p><strong>验证一个 webview 的 loaded 事件是否完成的方法：</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> ws <span class="token operator">=</span> plus<span class="token punctuation">.</span>webview<span class="token punctuation">.</span><span class="token function">getWebviewById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
ws<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
  <span class="token string">&quot;loaded&quot;</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Loaded: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">getURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token boolean">false</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>验证一个 webview 的 show 事件是否完成的方法：</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> ws <span class="token operator">=</span> plus<span class="token punctuation">.</span>webview<span class="token punctuation">.</span><span class="token function">currentWebview</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ws<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
  <span class="token string">&quot;show&quot;</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Webview Showed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token boolean">false</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>说这两个监听事件有啥用处呢，我们在预加载<code>webview</code>的时候，预加载完成的过程，<code>loaded</code>事件也随之完成，但是只有页面被打开时，<code>show</code>事件才完成，我们可以选择合适的时机发送或者接受参数。</p> <p>这里需要说明的是如果你想<code>localstorage</code>、<code>Storage</code>等本地存储传值，完全可以不用<code>extras</code>或者<code>mui.fire()</code>，当然还可以用<code>url</code>传参数。</p> <p>因为当初就是为了一个想法，预加载试试，然后试着试着各种问题，不过也因此明白了很多规则和调试方法，在这里提出来顺便总结一下页面传参需要注意的问题，免得新手在此花了很多冤枉时间，搞得现在都快忘了前面写了啥。其实这一部分可以独立出来，但是总感觉这种东西不是啥难事，脱离实际去讲总觉得不合适。</p> <h3 id="_4-获取好友列表及添加好友">4.获取好友列表及添加好友</h3> <h4 id="获取好友列表">获取好友列表</h4> <p>我们在登陆页面与环信的服务器建立了联系，但是由于我们执行跳转了，我们依然还需要在需要请求数据时候在当前页面再次建立连接，前面我们讲到可以通过实例化<code>new Easemob.im.Connection()</code>建立连接，我们这里可以在当前页面实例化建立连接，而不是使用登录时的登陆工具类。实例化<code>new Easemob.im.Connection()</code>的三个步骤大家可以查看前面的内容，这里需要说明的是我们获取好友列表是在<code>conn.init</code>方法的<code>onOpened : function(){};</code> 中添加 <code>getRoster</code> 回调方法，从而获取好友列表。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 创建连接</span>
<span class="token keyword">var</span> conn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Easemob<span class="token punctuation">.</span>im<span class="token punctuation">.</span>Connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 初始化连接</span>
conn<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">onOpened</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// mui.toast(&quot;成功登录&quot;);</span>
    conn<span class="token punctuation">.</span><span class="token function">setPresence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//设置在线状态</span>
    conn<span class="token punctuation">.</span><span class="token function">getRoster</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">roster</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>roster<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取当前登录人的好友列表</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token keyword">in</span> roster<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">var</span> ros <span class="token operator">=</span> roster<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//好友的对象</span>
          <span class="token comment">//ros.name为好友名称</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

mui<span class="token punctuation">.</span><span class="token function">plusReady</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> self <span class="token operator">=</span> plus<span class="token punctuation">.</span>webview<span class="token punctuation">.</span><span class="token function">currentWebview</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> username <span class="token operator">=</span> self<span class="token punctuation">.</span>username<span class="token punctuation">;</span>
  <span class="token keyword">var</span> password <span class="token operator">=</span> self<span class="token punctuation">.</span>password<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;username:&quot;</span> <span class="token operator">+</span> username <span class="token operator">+</span> <span class="token string">&quot;password:&quot;</span> <span class="token operator">+</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 打开连接</span>
  conn<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">user</span><span class="token operator">:</span> username<span class="token punctuation">,</span>
    <span class="token literal-property property">pwd</span><span class="token operator">:</span> password<span class="token punctuation">,</span>
    <span class="token literal-property property">appKey</span><span class="token operator">:</span> Easemob<span class="token punctuation">.</span>im<span class="token punctuation">.</span>config<span class="token punctuation">.</span>appkey
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>很显然我们在执行后是空的，因为从开始到现在我们都是自己和自己玩，都没有找朋友，那下面我们就去找朋友，之所以先要把这个先写出来，因为这个我觉得是基本逻辑，你待会儿加了好友，怎么看，就通过这里查询，然后才能说后面的聊天。</p> <h4 id="添加好友">添加好友</h4> <p>首先我们得去邀请对方吧，那么我们得知道对方的号码吧，上面我们用的是手机号码作为用户名，为的就是保证用户<code>ID</code>唯一性。</p> <p><strong>邀请发起方：</strong></p> <p>我们通过执行<code>conn.subscribe</code>可以发起邀请，添加发起方，获取要添加好友名称，参数为：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  to<span class="token operator">:</span> user<span class="token punctuation">,</span>  <span class="token comment">//对方用户名</span>
  message<span class="token operator">:</span><span class="token string">&quot;加个好友呗&quot;</span>  <span class="token comment">//对方收到的消息</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里我们在头部右上角叫一个添加好友按钮：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>addfriend<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mui-btn mui-btn-blue mui-btn-link mui-pull-right<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>添加<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>为了简单演示，我们直接弹出一个输入对话框：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 添加好友</span>
<span class="token function">mui</span><span class="token punctuation">(</span><span class="token string">&quot;#addfriend&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;tap&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  e<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>gesture<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> btnArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;确定&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;取消&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  mui<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span>
    <span class="token string">&quot;请输入你要添加的好友的用户名：&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;手机号&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;邀请好友&quot;</span><span class="token punctuation">,</span>
    btnArray<span class="token punctuation">,</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>index <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> user <span class="token operator">=</span> e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        conn<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token literal-property property">to</span><span class="token operator">:</span> user<span class="token punctuation">,</span>
          <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">&quot;加个好友呗&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mui<span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span><span class="token string">&quot;邀请发送成功！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        mui<span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span><span class="token string">&quot;你取消了发送！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>需要说明的是如果添加好友是一个单独的页面，或者说所在页面没有和环信建立连接，依然还有进行前面说的三步连接。</p></blockquote> <p><strong>邀请接受方：</strong>
被添加方，在 con.init 方法中调用 handlePresence 回调方法。</p> <div class="language-js extra-class"><pre class="language-js"><code>conn<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">//收到联系人订阅请求的回调方法</span>
  <span class="token function-variable function">onPresence</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">handlePresence</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//easemobwebim-sdk中收到联系人订阅请求的处理方法，具体的type值所对应的值请参考xmpp协议规范</span>
<span class="token keyword">var</span> <span class="token function-variable function">handlePresence</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  mui<span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> user <span class="token operator">=</span> e<span class="token punctuation">.</span>from<span class="token punctuation">;</span>
  <span class="token comment">//（发送者希望订阅接收者的出席信息）</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">&quot;subscribe&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mui<span class="token punctuation">.</span><span class="token function">confirm</span><span class="token punctuation">(</span><span class="token string">&quot;有人要添加你为好友&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;添加好友&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;确定&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;取消&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>
      <span class="token parameter">e</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>index <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//同意添加好友操作的实现方法</span>
        conn<span class="token punctuation">.</span><span class="token function">subscribed</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token literal-property property">to</span><span class="token operator">:</span> user<span class="token punctuation">,</span>
          <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">&quot;[resp:true]&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mui<span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span><span class="token string">&quot;你同意添加好友请求&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//拒绝添加好友的方法处理</span>
        conn<span class="token punctuation">.</span><span class="token function">unsubscribed</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token literal-property property">to</span><span class="token operator">:</span> user<span class="token punctuation">,</span>
          <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">&quot;rejectAddFriend&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mui<span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span><span class="token string">&quot;你拒绝了添加好友&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>前面登陆注册一直很顺利，没啥问题，但是做这个请求好友的时候就出问题了，我们在发送好友请求的时候，然后切换账号登陆的时候接受不到消息。调了好久才发现一些问题：</p> <ul><li>我们发送好友的消息在主界面，所以我初始化了连接，接受消息的在子页面也初始化了连接，居然有时候会有提示<code>onflict</code>，有两种方法：第一，主界面不做任何请求的事，点击添加好友时候，父页面给子页面发消息，然后子页面执行请求添加好友；第二，所有的初始化请求放在主界面，然后收到消息给对应的子页面发消息，为了减少请求，个人采用第二种方法。</li> <li>当解决上面的冲突问题，为什么登录后收不到消息？这里有个略坑的是环信文档中查询好友时候把<code>onOpened</code>中的这句<code>conn.setPresence();</code>屏蔽了，然后就收不到消息。查文档 <a href="http://docs.easemob.com/im/400webimintegration/80webimfaq" target="_blank" rel="noopener noreferrer">常见问题<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中说：登录之后需要设置在线状态，才能收到消息。请检查登录成功后是否调用过 conn.setPresence();。加上果然没问题了。。。</li></ul> <p>剩下的功能我们主要看这个文档 <a href="http://docs.easemob.com/im/400webimintegration/25intiate" target="_blank" rel="noopener noreferrer">初始化连接<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，主要是说明了初始化时候的一些回调函数的基本用法，我们这里先来看看<code>onPresence</code>，这个是<strong>收到联系人订阅请求的回调方法</strong>，基本数据类型如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;from&quot;</span><span class="token operator">:</span><span class="token string">&quot;xxxxxxxxxxx&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;to&quot;</span><span class="token operator">:</span><span class="token string">&quot;yyyyyyyyyyy&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;fromJid&quot;</span><span class="token operator">:</span><span class="token string">&quot;jszblog#musicbox_xxxxxxxxxxx@easemob.com&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;toJid&quot;</span><span class="token operator">:</span><span class="token string">&quot;jszblog#musicbox_yyyyyyyyyyy@easemob.com&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;subscribe&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;chatroom&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token string">&quot;destroy&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token string">&quot;status&quot;</span><span class="token operator">:</span><span class="token string">&quot;加个好友呗&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>这里的 xxxxxxxxxxx 和 yyyyyyyyyyy 是电话号码，以为我是用电话作为用户名的，出于隐私保护用字母代替。</p></blockquote> <p>当我们切换账号会发现查询好友的地方可以查到好友，下面我们就进行好友列表展示，然后就是和好友聊天咯。</p> <h3 id="_5-数据绑定和本地缓存处理机制">5.数据绑定和本地缓存处理机制</h3> <p>当我们重新登录的时候打印<code>roster</code>时会得到下面的<code>json</code>对象：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">subscription</span><span class="token operator">:</span> <span class="token string">&quot;from&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">jid</span><span class="token operator">:</span> <span class="token string">&quot;jszblog#musicbox_xxxxxxxxxxx@easemob.com&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;xxxxxxxxxxx&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">groups</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>为了考虑如果用户没有联网或者数据不能及时更新也能够正常看到历史记录，这里我们考虑做缓存，由于环信<code>web im</code>不具备缓存功能，所以我们这里采用本地存储作为缓存的方案，本地存储可以使用<code>5+</code>中的<code>storage</code>模块，也可以使用<code>localStorage</code>、<code>sessionStorage</code>，由于<code>storage</code>模块中的数据有效域不同，可在应用内跨域操作，数据存储期是持久化的，并且没有容量限制，这里我们采用这个方案，至于如果想把本案例中的例子用于浏览器端的同志，可以采用<code>localStorage</code>作缓存功能。</p> <p><code>html5+</code>中的<code>storage</code>模块比较简单，文档中介绍了几个基本方法，具体看看文档就可以学会使用，文档见 <a href="http://www.html5plus.org/doc/zh_cn/storage.html" target="_blank" rel="noopener noreferrer">【storage】<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <blockquote><p>plus.storage.setItem(key, value);</p></blockquote> <p><code>plus.storage.setItem</code>在存储时是以<code>key-value</code>的形式存储，我们可以在查询到好友信息时候，将对象转换成字符串存储在本地，<code>JSON.stringify()</code>将<code>json</code>对象转换成<code>json</code>字符串。</p> <div class="language-js extra-class"><pre class="language-js"><code>plus<span class="token punctuation">.</span>storage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">&quot;roster&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>roster<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>plus.storage.getItem(key);</p></blockquote> <p>我们在子页面通过<code>plus.storage.getItem</code>获取存储的字符串，然后通过<code>JSON.parse()</code>将字符串转化成对象获取相关信息。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> roster <span class="token operator">=</span> plus<span class="token punctuation">.</span>storage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">&quot;roster&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>roster<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们现在要做的无非是将信息展示出来，但是这里有用的信息目前只有 name，毕竟没有上传文件，所以也不存在头像、昵称、签名这种个性化信息。如何把<code>json</code>信息展示出来前面的文章中我们是使用直接生成<code>dom</code>节点或者拼接<code>html</code>字符串，但是这种过于繁琐，当然也有人使用【js 模板引擎】，本来准备早点在文章中给一些新手介绍一下<code>vue.js</code>这种<code>MV-*</code>框架，但是考虑本文中实例的性能，暂且还是用之前用过的一个 js 模板引擎<a href="https://github.com/aui/artTemplate" target="_blank" rel="noopener noreferrer">artTemplate<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，文档戳这里：https://github.com/aui/artTemplate。
<code>artTemplate</code>有简洁语法版和原生语法版，就是使用语法不一样而已，这里我使用简洁语法版，戳这里下载—— <a href="https://raw.githubusercontent.com/aui/artTemplate/master/dist/template.js" target="_blank" rel="noopener noreferrer">下载地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>为了简单，我们采用模板中通讯录的 html 结构，文档中有这样的一个例子：</p> <p><strong>编写模板：</strong>
使用一个 <code>type=&quot;text/html&quot;</code> 的 <code>script</code> 标签存放模板：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>test<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/html<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span>title<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>ul<span class="token operator">&gt;</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span>each list <span class="token keyword">as</span> value i<span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span>索引 <span class="token punctuation">{</span><span class="token punctuation">{</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span> ：<span class="token punctuation">{</span><span class="token punctuation">{</span>value<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token operator">/</span>each<span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>渲染模板：</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&quot;标签&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">list</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;文艺&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;博客&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;摄影&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;电影&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;民谣&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;旅行&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;吉他&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> html <span class="token operator">=</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;content&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> html<span class="token punctuation">;</span>
</code></pre></div><p>具体语法参考这里：<a href="https://github.com/aui/artTemplate/wiki/syntax:simple" target="_blank" rel="noopener noreferrer">artTemplate 简洁版语法<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>我们可以这样写：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mui-content<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!--内容--&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>roster-cnt<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mui-table-view mui-table-view-striped mui-table-view-condensed<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

&lt;<span class="token comment">&lt;!--模板--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>roster-tpl<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/html<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
	<span class="token punctuation">{</span><span class="token punctuation">{</span>each roster <span class="token keyword">as</span> value index<span class="token punctuation">}</span><span class="token punctuation">}</span>
			<span class="token operator">&lt;</span>li <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;mui-table-view-cell&quot;</span> data<span class="token operator">-</span>chatname<span class="token operator">=</span><span class="token string">&quot;{{value.name}}&quot;</span><span class="token operator">&gt;</span>
					<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;mui-slider-cell&quot;</span><span class="token operator">&gt;</span>
							<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;oa-contact-cell mui-table&quot;</span><span class="token operator">&gt;</span>
									<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;oa-contact-avatar mui-table-cell&quot;</span><span class="token operator">&gt;</span>
											<span class="token operator">&lt;</span>img src<span class="token operator">=</span><span class="token string">&quot;http://placehold.it/60x60&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
									<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
									<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;oa-contact-content mui-table-cell&quot;</span><span class="token operator">&gt;</span>
											<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;mui-clearfix&quot;</span><span class="token operator">&gt;</span>
													<span class="token operator">&lt;</span>h4 <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;oa-contact-name&quot;</span><span class="token operator">&gt;</span>小青年<span class="token operator">&lt;</span><span class="token operator">/</span>h4<span class="token operator">&gt;</span>
													<span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;oa-contact-position mui-h6&quot;</span><span class="token operator">&gt;</span>湖北<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
											<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
											<span class="token operator">&lt;</span>p <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;oa-contact-email mui-h6&quot;</span><span class="token operator">&gt;</span>
													<span class="token punctuation">{</span><span class="token punctuation">{</span>value<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token punctuation">}</span>
											<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
									<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
							<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
					<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
	<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token operator">/</span>each<span class="token punctuation">}</span><span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>mui<span class="token punctuation">.</span><span class="token function">plusReady</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> roster <span class="token operator">=</span> plus<span class="token punctuation">.</span>storage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">&quot;roster&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// console.log(roster);</span>
  <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">roster</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>roster<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> html <span class="token operator">=</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token string">&quot;roster-tpl&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;roster-cnt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> html<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>我们其实可以直接先遍历找到<code>name</code>然后填充就<code>ok</code>，这为了后续方便添加昵称、地址、头像等个性化地址，直接使用<code>artTemplate</code>的<code>each</code>方法。</p> <h3 id="_6-聊天消息封装">6.聊天消息封装</h3> <p>当我们完成了前面登陆、注册、添加好友等功能，我们就进行最重要的内容了，既然是聊天功能，当然要聊起来，不然就不叫<code>IM</code>，但是很多人一开始就太过于关注聊天这个功能，而忽略了前面的基础过程，导致对<code>api</code>不熟悉，自然些聊天过程也是漏洞百出，代码逻辑混乱，所以也就放弃了。本文为即时通讯第一篇，没有介绍过多原理，也没有介绍聊天过程的高级功能，仅作为新手入门的基础篇介绍，后面会再深入探究更多内容。废话不多说，我们继续看文档写下面的内容。</p> <p>我们先新建一个<code>single-chat.html</code>，本文不打算基于<code>html mui</code>中的页面去构建聊天页面，打算从零开始写。</p> <p>首先我们需要在刚刚那个通讯录页面里面点击进入聊天页面，将用户名的值传到聊天页面，我们可以直接在创建的时候用拓展参数传，或者预加载打开时用<code>mui.fire()</code>,不多说，自己参考第三小节。</p> <p>我们先说说布局的问题，先上图</p> <p><img src="http://oo1uw74rb.bkt.clouddn.com/20160615002.png" alt="clipboard.png"></p> <p>对应的布局详细代码如下：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.chat-history-date</span><span class="token punctuation">{</span>
  display<span class="token punctuation">:</span> block<span class="token punctuation">;</span>
  padding-top<span class="token punctuation">:</span> 5px<span class="token punctuation">;</span>
  text-align<span class="token punctuation">:</span> center<span class="token punctuation">;</span>
  font-size<span class="token punctuation">:</span> 12px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.chat-receiver,.chat-sender</span><span class="token punctuation">{</span>
  margin<span class="token punctuation">:</span> 5px<span class="token punctuation">;</span>
    <span class="token property">clear</span><span class="token punctuation">:</span>both<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
<span class="token selector">.chat-avatar img</span><span class="token punctuation">{</span>
    <span class="token property">width</span><span class="token punctuation">:</span> 40px<span class="token punctuation">;</span>
    <span class="token property">height</span><span class="token punctuation">:</span> 40px<span class="token punctuation">;</span>
    <span class="token property">border-radius</span><span class="token punctuation">:</span> 50%<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.chat-receiver .chat-avatar</span><span class="token punctuation">{</span>
  float<span class="token punctuation">:</span> left<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.chat-sender .chat-avatar</span><span class="token punctuation">{</span>
  float<span class="token punctuation">:</span> right<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.chat-content</span><span class="token punctuation">{</span>
  position<span class="token punctuation">:</span> relative<span class="token punctuation">;</span>
  max-width<span class="token punctuation">:</span> 60%<span class="token punctuation">;</span>
    <span class="token property">min-height</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
  margin<span class="token punctuation">:</span> 0 10px 10px 10px<span class="token punctuation">;</span>
    <span class="token property">padding</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
    <span class="token property">font-size</span><span class="token punctuation">:</span>15px<span class="token punctuation">;</span>
    <span class="token property">border-radius</span><span class="token punctuation">:</span>7px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.chat-content img</span><span class="token punctuation">{</span>
  width<span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.chat-receiver .chat-content</span><span class="token punctuation">{</span>
  float<span class="token punctuation">:</span> left<span class="token punctuation">;</span>
  color<span class="token punctuation">:</span> #383838<span class="token punctuation">;</span>
    <span class="token property">background-color</span><span class="token punctuation">:</span> #f5f5f5<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.chat-sender .chat-content</span><span class="token punctuation">{</span>
    <span class="token property">float</span><span class="token punctuation">:</span>right<span class="token punctuation">;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #ffffff<span class="token punctuation">;</span>
    <span class="token property">background-color</span><span class="token punctuation">:</span> #15b5e9<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.chat-triangle</span><span class="token punctuation">{</span>
  position<span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
  top<span class="token punctuation">:</span>6px<span class="token punctuation">;</span>
  width<span class="token punctuation">:</span>0px<span class="token punctuation">;</span>
  height<span class="token punctuation">:</span>0px<span class="token punctuation">;</span>
    <span class="token property">border-width</span><span class="token punctuation">:</span>8px<span class="token punctuation">;</span>
    <span class="token property">border-style</span><span class="token punctuation">:</span>solid<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.chat-receiver .chat-triangle</span><span class="token punctuation">{</span>
  left<span class="token punctuation">:</span>-16px<span class="token punctuation">;</span>
    <span class="token property">border-color</span><span class="token punctuation">:</span>transparent #f5f5f5 transparent transparent<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.chat-sender .chat-triangle</span><span class="token punctuation">{</span>
  right<span class="token punctuation">:</span>-16px<span class="token punctuation">;</span>
    <span class="token property">border-color</span><span class="token punctuation">:</span>transparent transparent transparent #15b5e9<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!--消息最后历史时间--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>chat-history-date<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>01:59<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--接收文本消息--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>chat-receiver<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>chat-avatar<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>../img/chat-1.png<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>chat-content<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>chat-triangle<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>如果是接受消息，请使用.chat-receiver类，如果是发送消息，请使用.chat-sender，头像是.chat-avatar类，内容是.chat-content类。.chat-content下如果是span标签则为文本消息，若为img标签则为图片消息。<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--发送文本消息--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>chat-sender<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>chat-avatar<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>../img/chat-2.png<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>chat-content<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>chat-triangle<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>如果你要修改聊天气泡的背景颜色，请修改.chat-content的background-color和.chat-triangle的border-color<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--发送图片消息--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>chat-sender<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>chat-avatar<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>../img/chat-2.png<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>chat-content<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>chat-triangle<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>../img/test.jpg<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>我们的消息分为发送和收到两种情况，上面是静态效果，我们下面需要做的事获取数据然后动态展示，现在我们先封装一下页面展示效果的代码。这里我们使用两种方法，一种是直接用<code>js</code>生成<code>dom</code>节点，这种使用于结构固定后面不需要改动的，直接用一个<code>js function</code>封装，每次调用一行代码就可以直接显示内容，这样想想都觉得很棒。</p> <p>老司机，别说话，快看代码！</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * @description 显示消息
 * @param {String} who 消息来源,可选参数: {params} 'sender','receiver'
 * @param {Object} type 消息类型,可选参数: {params} 'text','url','img'
 * @param {JSON} data 消息数据,可选参数: {params}
 * ('text'和'url'类型的msg是文字，img类型的msg是img地址)
 */</span>
<span class="token keyword">var</span> <span class="token function-variable function">appendMsg</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">who<span class="token punctuation">,</span> type<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 生成节点</span>
  <span class="token keyword">var</span> <span class="token function-variable function">domCreat</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 基本节点</span>
  <span class="token keyword">var</span> msgItem <span class="token operator">=</span> <span class="token function">domCreat</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    avatarBox <span class="token operator">=</span> <span class="token function">domCreat</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    contentBox <span class="token operator">=</span> <span class="token function">domCreat</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    avatar <span class="token operator">=</span> <span class="token function">domCreat</span><span class="token punctuation">(</span><span class="token string">&quot;img&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    triangle <span class="token operator">=</span> <span class="token function">domCreat</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 头像节点</span>
  avatarBox<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">&quot;chat-avatar&quot;</span><span class="token punctuation">;</span>
  avatar<span class="token punctuation">.</span>src <span class="token operator">=</span> who <span class="token operator">==</span> <span class="token string">&quot;sender&quot;</span> <span class="token operator">?</span> data<span class="token punctuation">.</span>senderAvatar <span class="token operator">:</span> data<span class="token punctuation">.</span>receiverAvatar<span class="token punctuation">;</span>
  avatarBox<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>avatar<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 内容节点</span>
  contentBox<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">&quot;chat-content&quot;</span><span class="token punctuation">;</span>
  triangle<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">&quot;chat-triangle&quot;</span><span class="token punctuation">;</span>
  contentBox<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>triangle<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 消息类型</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">&quot;text&quot;</span><span class="token operator">:</span>
      <span class="token keyword">var</span> msgTextNode <span class="token operator">=</span> <span class="token function">domCreat</span><span class="token punctuation">(</span><span class="token string">&quot;span&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> textnode <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
      msgTextNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>textnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      contentBox<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>msgTextNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">&quot;url&quot;</span><span class="token operator">:</span>
      <span class="token keyword">var</span> msgUrlNode <span class="token operator">=</span> <span class="token function">domCreat</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> textnode <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;http://&quot;</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data<span class="token punctuation">.</span>msg <span class="token operator">=</span> <span class="token string">&quot;http://&quot;</span> <span class="token operator">+</span> data<span class="token punctuation">.</span>msg<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      msgUrlNode<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;href&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
      msgUrlNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>textnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      contentBox<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>msgUrlNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">&quot;img&quot;</span><span class="token operator">:</span>
      <span class="token keyword">var</span> msgImgNode <span class="token operator">=</span> <span class="token function">domCreat</span><span class="token punctuation">(</span><span class="token string">&quot;img&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      msgImgNode<span class="token punctuation">.</span>src <span class="token operator">=</span> data<span class="token punctuation">.</span>msg<span class="token punctuation">;</span>
      contentBox<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>msgImgNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 节点连接</span>
  msgItem<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">&quot;chat-&quot;</span> <span class="token operator">+</span> who<span class="token punctuation">;</span>
  msgItem<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>avatarBox<span class="token punctuation">)</span><span class="token punctuation">;</span>
  msgItem<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>contentBox<span class="token punctuation">)</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>msgItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>其实后面我们拓展也很容易的，只需要不断加<code>type</code>类型就<code>ok</code>，这些都是<code>dom</code>操作的基本方法，如果对一些方法不熟悉，建议看看相关的内容。这里遵照<code>JSDoc+</code>规范还加上了使用参数提示，在<code>hbuilder</code>使用可以查看参数含义，再也不用担心写代码时忘记了参数含义。</p> <p>这里我们也可以用模板引擎的办法去封装，代码如下：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>msg-tpl<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/html<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
	<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;chat-{{who}}&quot;</span><span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;chat-avatar&quot;</span><span class="token operator">&gt;</span>
				<span class="token operator">&lt;</span>img src<span class="token operator">=</span><span class="token string">&quot;{{avatar}}&quot;</span><span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;chat-content&quot;</span><span class="token operator">&gt;</span>
				<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;chat-triangle&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
				<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token keyword">if</span> type<span class="token operator">==</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
				<span class="token operator">&lt;</span>span<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span>msg<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
		<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token keyword">else</span> <span class="token keyword">if</span> type<span class="token operator">==</span><span class="token string">&quot;url&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
				<span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">&quot;{{msg}}&quot;</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span>msg<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
		<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token keyword">else</span> <span class="token keyword">if</span> type<span class="token operator">==</span><span class="token string">&quot;img&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
				<span class="token operator">&lt;</span>img src<span class="token operator">=</span><span class="token string">&quot;{{msg}}&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
		<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token operator">/</span><span class="token keyword">if</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
		<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>模板渲染：</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * @description 显示消息
 * @param {String} who 消息来源,可选参数: {params} 'sender','receiver'
 * @param {Object} type 消息类型,可选参数: {params} 'text','url','img'
 * @param {JSON} data 消息数据,可选参数: {params}
 * ('text'和'url'类型的msg是文字，img类型的msg是img地址)
 */</span>
<span class="token keyword">var</span> <span class="token function-variable function">appendMsg</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">who<span class="token punctuation">,</span> type<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> html <span class="token operator">=</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token string">&quot;msg-tpl&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">who</span><span class="token operator">:</span> who<span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> type<span class="token punctuation">,</span>
    <span class="token literal-property property">avatar</span><span class="token operator">:</span> who <span class="token operator">==</span> <span class="token string">&quot;sender&quot;</span> <span class="token operator">?</span> data<span class="token punctuation">.</span>senderAvatar <span class="token operator">:</span> data<span class="token punctuation">.</span>receiverAvatar<span class="token punctuation">,</span>
    <span class="token literal-property property">msg</span><span class="token operator">:</span> data<span class="token punctuation">.</span>msg
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">+=</span> html<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>大家使用也很简单，调用方法如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">appendMsg</span><span class="token punctuation">(</span><span class="token string">&quot;sender&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">el</span><span class="token operator">:</span> <span class="token string">&quot;#msg-list&quot;</span><span class="token punctuation">,</span> <span class="token comment">//消息容器</span>
  <span class="token literal-property property">senderAvatar</span><span class="token operator">:</span> <span class="token string">&quot;../img/chat-1.png&quot;</span><span class="token punctuation">,</span> <span class="token comment">//发送者头像</span>
  <span class="token literal-property property">receiverAvatar</span><span class="token operator">:</span> <span class="token string">&quot;../img/chat-2.png&quot;</span><span class="token punctuation">,</span> <span class="token comment">//接收者头像</span>
  <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">&quot;你好&quot;</span> <span class="token comment">//消息内容</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果大家觉得每次调用还要填写容器 id，头像地址这种基本固定的内容很麻烦，大家也可以继续封装：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 消息初始化
 */</span>
<span class="token keyword">var</span> msgInit <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">el</span><span class="token operator">:</span> <span class="token string">&quot;#msg-list&quot;</span><span class="token punctuation">,</span> <span class="token comment">//消息容器</span>
  <span class="token literal-property property">senderAvatar</span><span class="token operator">:</span> <span class="token string">&quot;../img/chat-1.png&quot;</span><span class="token punctuation">,</span> <span class="token comment">//发送者头像</span>
  <span class="token literal-property property">receiverAvatar</span><span class="token operator">:</span> <span class="token string">&quot;../img/chat-2.png&quot;</span> <span class="token comment">//接收者头像</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @description 展示消息精简版
 * @param {String} who 消息来源,可选参数: {params} 'sender','receiver'
 * @param {Object} type 消息类型,可选参数: {params} 'text','url','img'
 * @param {Object} msg ('text'和'url'类型的msg是文字，img类型的msg是img地址)
 */</span>
<span class="token keyword">var</span> <span class="token function-variable function">msgShow</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">who<span class="token punctuation">,</span> type<span class="token punctuation">,</span> msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">appendMsg</span><span class="token punctuation">(</span>who<span class="token punctuation">,</span> type<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">el</span><span class="token operator">:</span> msgInit<span class="token punctuation">.</span>el<span class="token punctuation">,</span>
    <span class="token literal-property property">senderAvatar</span><span class="token operator">:</span> msgInit<span class="token punctuation">.</span>senderAvatar<span class="token punctuation">,</span>
    <span class="token literal-property property">receiverAvatar</span><span class="token operator">:</span> msgInit<span class="token punctuation">.</span>receiverAvatar<span class="token punctuation">,</span>
    <span class="token literal-property property">msg</span><span class="token operator">:</span> msg
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>调用方法很简单：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">msgShow</span><span class="token punctuation">(</span><span class="token string">&quot;sender&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;你好&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>两种方法实现封装的函数一样，这里只是给大家演示一下对于这种动态结构的<code>html</code>的一些方法，当然只要你愿意，你可以直接用字符串拼接，或者用<code>&lt;template&gt;&lt;/template&gt;</code>标签自己做一个这样的模板引擎，或者使用使用更加方便的<code>mvc</code>或<code>mvvm</code>框架。</p> <p>之所以要花大篇幅内容将这些基础内容，是因为看到很多人代码写得那叫一个混乱，如果接口啥的一改，我相信这些人会疯掉，因为代码缺乏一定的通用性，没有把变与不变的内容分别拿出来。当然我们上面其实有些东西没有封装进去，比如用户名或者昵称，这在群聊中是有必要的，这里只是以最简单的例子来说明，大家可以根据自己的业务需求自由发挥。</p> <h3 id="_7-单聊之文本消息">7.单聊之文本消息</h3> <h4 id="基本思路">基本思路</h4> <p>其实写到这里本篇基本也算告一段落，但是考虑到很多新手对于收发消息很多还是有一些问题，我们这里就还是把文本消息发送接收写完了再收篇。</p> <p>上面我们我们讲了怎么把消息展示出来，但是毕竟聊起来数据是动态的，那么发送接收数据是很重要的一步，先来写发送消息。我们先定义一个底部的输入框加按钮，代码如下：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/css<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">footer</span> <span class="token punctuation">{</span>
  position<span class="token punctuation">:</span> fixed<span class="token punctuation">;</span>
  width<span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
  height<span class="token punctuation">:</span> 50px<span class="token punctuation">;</span>
  min-height<span class="token punctuation">:</span> 50px<span class="token punctuation">;</span>
  border-top<span class="token punctuation">:</span> solid 1px #bbb<span class="token punctuation">;</span>
  left<span class="token punctuation">:</span> 0px<span class="token punctuation">;</span>
  bottom<span class="token punctuation">:</span> 0px<span class="token punctuation">;</span>
  overflow<span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>
  padding<span class="token punctuation">:</span> 0px 50px<span class="token punctuation">;</span>
  background-color<span class="token punctuation">:</span> #fafafa<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.footer-left</span> <span class="token punctuation">{</span>
  position<span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
  width<span class="token punctuation">:</span> 50px<span class="token punctuation">;</span>
  height<span class="token punctuation">:</span> 50px<span class="token punctuation">;</span>
  left<span class="token punctuation">:</span> 0px<span class="token punctuation">;</span>
  bottom<span class="token punctuation">:</span> 0px<span class="token punctuation">;</span>
  text-align<span class="token punctuation">:</span> center<span class="token punctuation">;</span>
  vertical-align<span class="token punctuation">:</span> middle<span class="token punctuation">;</span>
  line-height<span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
  padding<span class="token punctuation">:</span> 12px 4px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.footer-right</span> <span class="token punctuation">{</span>
  position<span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
  width<span class="token punctuation">:</span> 50px<span class="token punctuation">;</span>
  height<span class="token punctuation">:</span> 50px<span class="token punctuation">;</span>
  right<span class="token punctuation">:</span> 0px<span class="token punctuation">;</span>
  bottom<span class="token punctuation">:</span> 0px<span class="token punctuation">;</span>
  text-align<span class="token punctuation">:</span> center<span class="token punctuation">;</span>
  vertical-align<span class="token punctuation">:</span> middle<span class="token punctuation">;</span>
  line-height<span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
  padding<span class="token punctuation">:</span> 12px 5px<span class="token punctuation">;</span>
  display<span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.footer-center</span> <span class="token punctuation">{</span>
  height<span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
  padding<span class="token punctuation">:</span> 5px 0px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.footer-center [class*=input]</span> <span class="token punctuation">{</span>
  width<span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
  height<span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
  border-radius<span class="token punctuation">:</span> 5px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.footer-center .input-text</span> <span class="token punctuation">{</span>
  background<span class="token punctuation">:</span> #fff<span class="token punctuation">;</span>
  border<span class="token punctuation">:</span> solid 1px #ddd<span class="token punctuation">;</span>
  padding<span class="token punctuation">:</span> 10px <span class="token important">!important</span><span class="token punctuation">;</span>
  font-size<span class="token punctuation">:</span> 16px <span class="token important">!important</span><span class="token punctuation">;</span>
  line-height<span class="token punctuation">:</span> 18px <span class="token important">!important</span><span class="token punctuation">;</span>
  font-family<span class="token punctuation">:</span> verdana <span class="token important">!important</span><span class="token punctuation">;</span>
  overflow<span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">footer .mui-icon</span> <span class="token punctuation">{</span>
    color<span class="token punctuation">:</span> #000<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">footer .mui-icon:active</span> <span class="token punctuation">{</span>
  color<span class="token punctuation">:</span> #007AFF <span class="token important">!important</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.footer-right span</span><span class="token punctuation">{</span>
  color<span class="token punctuation">:</span> #0062CC<span class="token punctuation">;</span>
  line-height<span class="token punctuation">:</span> 30px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mui-content<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>msg-list<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>footer</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>footer-left<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>msg-choose-img<span class="token punctuation">'</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mui-icon mui-icon-camera<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">font-size</span><span class="token punctuation">:</span> 28px<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>footer-center<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>msg-text<span class="token punctuation">'</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>input-text<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>footer-right<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>msg-send-text<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>发送<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>footer</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>为了代码整洁规范，方便后期封装，参考<code>hello mui</code>中<code>im-chat.html</code>的写法，我们先定义一下<code>ui</code>控件对象：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// UI控件对象</span>
<span class="token keyword">var</span> ui <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token function">mui</span><span class="token punctuation">(</span><span class="token string">&quot;.mui-content&quot;</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">msgList</span><span class="token operator">:</span> <span class="token function">mui</span><span class="token punctuation">(</span><span class="token string">&quot;#msg-list&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">footer</span><span class="token operator">:</span> <span class="token function">mui</span><span class="token punctuation">(</span><span class="token string">&quot;footer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">msgChooseImg</span><span class="token operator">:</span> <span class="token function">mui</span><span class="token punctuation">(</span><span class="token string">&quot;#msg-choose-img&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">msgText</span><span class="token operator">:</span> <span class="token function">mui</span><span class="token punctuation">(</span><span class="token string">&quot;#msg-text&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">msgSendText</span><span class="token operator">:</span> <span class="token function">mui</span><span class="token punctuation">(</span><span class="token string">&quot;#msg-send-text&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>发送文本消息很简单：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 发送文本消息</span>
ui<span class="token punctuation">.</span>msgSendText<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;tap&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">sendText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 发送文本</span>
<span class="token keyword">var</span> <span class="token function-variable function">sendText</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> msg <span class="token operator">=</span> ui<span class="token punctuation">.</span>msgText<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;gm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&lt;br/&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> validateReg <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\S+$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>
  <span class="token comment">// 获得键盘焦点</span>
  <span class="token function">msgTextFocus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>validateReg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 消息展示出来</span>
    <span class="token function">msgShow</span><span class="token punctuation">(</span><span class="token string">&quot;sender&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 发送文本消息到环信服务器</span>
    conn<span class="token punctuation">.</span><span class="token function">sendTextMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">to</span><span class="token operator">:</span> chatName<span class="token punctuation">,</span> <span class="token comment">//用户登录名，SDK根据AppKey和domain组织jid，如easemob-demo#chatdemoui_**TEST**@easemob.com，中&quot;to:TEST&quot;,下同</span>
      <span class="token literal-property property">msg</span><span class="token operator">:</span> msg<span class="token punctuation">,</span> <span class="token comment">//文本消息</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;chat&quot;</span>
      <span class="token comment">//ext :{&quot;extmsg&quot;:&quot;extends messages&quot;}//用户自扩展的消息内容（群聊用法相同）</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 清空文本框</span>
    ui<span class="token punctuation">.</span>msgText<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// 恢复输入框高度(因为我们这里是50px，你可以写一个全局变量)</span>
    ui<span class="token punctuation">.</span>footer<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token string">&quot;50px&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// 保持输入状态</span>
    mui<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span>ui<span class="token punctuation">.</span>msgText<span class="token punctuation">,</span> <span class="token string">&quot;input&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 这一句让内容滚动起来</span>
    <span class="token function">msgScrollTop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    mui<span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span><span class="token string">&quot;文本消息不能为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>这里的<code>msgTextFocus();</code>和<code>msgScrollTop();</code>是封装的两个方法，具体的且看下文。</p> <p>再来说说收消息，我们需要在<code>conn.init()</code>配置设置收到消息的回调函数<code>onTextMessage</code>:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 初始化连接</span>
conn<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">onOpened</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//mui.toast(&quot;成功登录&quot;);</span>
    conn<span class="token punctuation">.</span><span class="token function">setPresence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 收到文本消息时的回调函数</span>
  <span class="token function-variable function">onTextMessage</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// console.log(JSON.stringify(message));</span>
    <span class="token keyword">var</span> from <span class="token operator">=</span> message<span class="token punctuation">.</span>from<span class="token punctuation">;</span> <span class="token comment">//消息的发送者</span>
    <span class="token keyword">var</span> msg <span class="token operator">=</span> message<span class="token punctuation">.</span>data<span class="token punctuation">;</span> <span class="token comment">//文本消息体</span>
    <span class="token comment">//mui.toast(msg);</span>
    <span class="token comment">// 收到文本消息在页面展示</span>
    <span class="token function">msgShow</span><span class="token punctuation">(</span><span class="token string">&quot;receiver&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">msgScrollTop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 收到图片消息时的回调函数</span>
  <span class="token function-variable function">onPictureMessage</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">handlePictureMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>至此我们完成了基本的文本消息收发功能，但是有几个细节是需要处理的，比如我们上面说的两个函数啥意思，我们没有解释。</p> <h4 id="获得输入框焦点事件和强制弹出软键盘">获得输入框焦点事件和强制弹出软键盘</h4> <p>我们如果不做处理，在输入框失去焦点时软键盘会自动收回软键盘，这样很影响聊天时候的用户体验。这个时候我们可以在输入完内容，准备发送时，保持输入状态<code>mui.trigger(ui.msgText, 'input', null);</code>。</p> <p>让输入框获得焦点的方法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 获得输入框键盘焦点</span>
<span class="token keyword">var</span> <span class="token function-variable function">msgTextFocus</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ui<span class="token punctuation">.</span>msgText<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ui<span class="token punctuation">.</span>msgText<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>强制弹出软键盘的方法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 强制弹出软键盘</span>
<span class="token keyword">var</span> <span class="token function-variable function">showKeyboard</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mui<span class="token punctuation">.</span>os<span class="token punctuation">.</span>ios<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> webView <span class="token operator">=</span> plus<span class="token punctuation">.</span>webview<span class="token punctuation">.</span><span class="token function">currentWebview</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nativeInstanceObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    webView<span class="token punctuation">.</span><span class="token function">plusCallMethod</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">setKeyboardDisplayRequiresUserAction</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mui<span class="token punctuation">.</span>os<span class="token punctuation">.</span>android<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> Context <span class="token operator">=</span> plus<span class="token punctuation">.</span>android<span class="token punctuation">.</span><span class="token function">importClass</span><span class="token punctuation">(</span><span class="token string">&quot;android.content.Context&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> InputMethodManager <span class="token operator">=</span> plus<span class="token punctuation">.</span>android<span class="token punctuation">.</span><span class="token function">importClass</span><span class="token punctuation">(</span>
      <span class="token string">&quot;android.view.inputmethod.InputMethodManager&quot;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> main <span class="token operator">=</span> plus<span class="token punctuation">.</span>android<span class="token punctuation">.</span><span class="token function">runtimeMainActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> imm <span class="token operator">=</span> main<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span><span class="token constant">INPUT_METHOD_SERVICE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    imm<span class="token punctuation">.</span><span class="token function">toggleSoftInput</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> InputMethodManager<span class="token punctuation">.</span><span class="token constant">SHOW_FORCED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="聊天消息高度调整">聊天消息高度调整</h4> <p>聊天消息如何发送或者收到一条自己往上滚动呢？我们看 qq 消息就是最后一条消息就会自动出现在输入框之上，调整方法是使用<code>scrollTop</code>方法，通过计算<code>scrollHeight</code>和`offsetHeight 的高度，实现调整。对这些高度不理解？看这里：</p> <ul><li><p><a href="http://www.cnblogs.com/polk6/p/5051935.html" target="_blank" rel="noopener noreferrer">HTML 获取屏幕、浏览器、页面的高度宽度<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="http://ask.dcloud.net.cn/article/205" target="_blank" rel="noopener noreferrer">深入理解高度。获取屏幕、webview、软键盘高度<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li></ul> <p>其实这个地方有很多技术细节，比如消息高度虽然可以获取，但是要实现局部滚动，那么必须禁止浏览器默认的滚动模式，具体可以看看这篇文章的实现原理<a href="https://isux.tencent.com/inner-scroll-layout.html" target="_blank" rel="noopener noreferrer">浅议内滚动布局<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>具体 css 样式设置方法：</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">html,
body</span> <span class="token punctuation">{</span>
  height<span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
  margin<span class="token punctuation">:</span> 0px<span class="token punctuation">;</span>
  padding<span class="token punctuation">:</span> 0px<span class="token punctuation">;</span>
  overflow<span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>
  -webkit-touch-callout<span class="token punctuation">:</span> none<span class="token punctuation">;</span>
  -webkit-user-select<span class="token punctuation">:</span> none<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.mui-content</span><span class="token punctuation">{</span>
  height<span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
  padding<span class="token punctuation">:</span> 44px 0px 50px 0px<span class="token punctuation">;</span>
  overflow<span class="token punctuation">:</span> auto<span class="token punctuation">;</span>
  background-color<span class="token punctuation">:</span> #eaeaea<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">#msg-list</span> <span class="token punctuation">{</span>
  height<span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
  overflow<span class="token punctuation">:</span> auto<span class="token punctuation">;</span>
  -webkit-overflow-scrolling<span class="token punctuation">:</span> touch<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>调用的函数封装如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 消息滚动</span>
<span class="token keyword">var</span> <span class="token function-variable function">msgScrollTop</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ui<span class="token punctuation">.</span>msgList<span class="token punctuation">.</span>scrollTop <span class="token operator">=</span> ui<span class="token punctuation">.</span>msgList<span class="token punctuation">.</span>scrollHeight <span class="token operator">+</span> ui<span class="token punctuation">.</span>msgList<span class="token punctuation">.</span>offsetHeight<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="输入框高度如何自适应">输入框高度如何自适应</h4> <p>不多说直接上代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 输入框监听事件</span>
ui<span class="token punctuation">.</span>msgText<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;input&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">msgTextFocus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ui<span class="token punctuation">.</span>footer<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scrollHeight <span class="token operator">+</span> <span class="token string">&quot;px&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="解决长按导致致键盘关闭的问题">解决长按导致致键盘关闭的问题</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 解决长按“发送”按钮，导致键盘关闭的问题；</span>
ui<span class="token punctuation">.</span>msgSendText<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;touchstart&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">msgTextFocus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ui<span class="token punctuation">.</span>msgSendText<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;touchmove&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">msgTextFocus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>当做到这里我们基本要讲解的够新手去理解了，但是对于项目功能实现来说，远远不够，毕竟只是文字发送接收，那么图片、语音、地址等等高级功能呢，我们这篇文章限于篇幅不可能一一道来，只能后面再做补充。这里希望更多人参与到其中进行贡献。这里可以放出地址了，详情代码请关注这里：<a href="https://github.com/zhaomenghuan/mui-demo/tree/master/example/easemobIM" target="_blank" rel="noopener noreferrer">https://github.com/zhaomenghuan/mui-demo/tree/master/example/easemobIM<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。后期功能拓展和 bug 修复都贵提交到这里，欢迎大家贡献。</p> <h2 id="写在后面">写在后面</h2> <p><s>由于这段时间确实有点忙，这篇文章也花了很多时间去码字，去修改，改了很多次，才有这篇文章，希望能够给新手一些启示和帮助吧！本文不是着重讲环信 sdk 怎么用，而是讲解这个过程中可能会遇到的一些问题和实现思路，所以不建议新手直接拿最后的代码改之类的，还是看懂了思路再说，所以至于这个 IM 更多的功能后期会不会继续开发，暂时是未知数，所以大家不要等待，欢迎大神多多贡献分享相关代码，这样方便更多人学习使用。</s></p> <p>2018.05.25 更新说明：</p> <p>这篇文章2016年06月15日发布，在这之后很多人因为这篇文章找我定制过 IM 的功能，当前文章中的版本和后续的版本可能存在诸多差异，由于精力有限没办法去更正文章中的差异，但是基本思路应该是相通的。如果有类似需求的朋友，我这边可以提供付费版源码，如果需要通过邮件联系我：1028317108@qq.com。</p> <div data-v-3bd334e8><p class="descript" data-v-3bd334e8>写这些代码也许就一两个小时的事，写一篇大家好接受的文章需要几天的酝酿，如果文章对您有帮助请我喝杯咖啡吧！</p> <img src="/supportme.png" class="pay-code" data-v-3bd334e8> <div data-v-3bd334e8><div id="container"></div></div> <div class="footer" data-v-4f0df4b0 data-v-3bd334e8><p data-v-4f0df4b0>站点总访问量： 站点总访客数：</p> <p data-v-4f0df4b0>博客内容遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" data-v-4f0df4b0>知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></p> <p data-v-4f0df4b0>赵梦欢 © 2015 - 2023</p></div></div></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.f3e141ba.js" defer></script><script src="/assets/js/42.7de428af.js" defer></script><script src="/assets/js/18.c373a36e.js" defer></script><script src="/assets/js/34.124c31c0.js" defer></script>
  </body>
</html>
