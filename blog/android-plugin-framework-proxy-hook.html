<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Android 插件化原理学习 —— Hook 机制之动态代理 | 匠心博客</title>
    <meta name="description" content="小青年,匠心,小青年博客,匠心博客,前端开发,android,技术宅,菜鸟教程,一个神奇的博客。">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.685c010a.css" as="style"><link rel="preload" href="/assets/js/app.f3e141ba.js" as="script"><link rel="preload" href="/assets/js/20.f8833113.js" as="script"><link rel="preload" href="/assets/js/18.c373a36e.js" as="script"><link rel="preload" href="/assets/js/34.124c31c0.js" as="script"><link rel="prefetch" href="/assets/js/1.1950ec81.js"><link rel="prefetch" href="/assets/js/10.7f857e71.js"><link rel="prefetch" href="/assets/js/100.e03c01d2.js"><link rel="prefetch" href="/assets/js/101.7b790a2f.js"><link rel="prefetch" href="/assets/js/102.a7aa77f9.js"><link rel="prefetch" href="/assets/js/103.d473991c.js"><link rel="prefetch" href="/assets/js/104.9fe8785c.js"><link rel="prefetch" href="/assets/js/105.7291ae49.js"><link rel="prefetch" href="/assets/js/106.2c35a2f4.js"><link rel="prefetch" href="/assets/js/107.a71ccb64.js"><link rel="prefetch" href="/assets/js/108.9d6f54a8.js"><link rel="prefetch" href="/assets/js/109.e77d12ca.js"><link rel="prefetch" href="/assets/js/11.5378ae65.js"><link rel="prefetch" href="/assets/js/12.9aca40f8.js"><link rel="prefetch" href="/assets/js/13.ce2b655c.js"><link rel="prefetch" href="/assets/js/14.7488ca24.js"><link rel="prefetch" href="/assets/js/15.9c07ac98.js"><link rel="prefetch" href="/assets/js/16.8f57294c.js"><link rel="prefetch" href="/assets/js/17.4f7ae4ec.js"><link rel="prefetch" href="/assets/js/19.c7be2474.js"><link rel="prefetch" href="/assets/js/2.7f7e5268.js"><link rel="prefetch" href="/assets/js/21.e71dd521.js"><link rel="prefetch" href="/assets/js/22.92dc7b77.js"><link rel="prefetch" href="/assets/js/23.285557d3.js"><link rel="prefetch" href="/assets/js/24.a803551c.js"><link rel="prefetch" href="/assets/js/25.dbeaa19d.js"><link rel="prefetch" href="/assets/js/26.9ca97076.js"><link rel="prefetch" href="/assets/js/27.d1a2911b.js"><link rel="prefetch" href="/assets/js/28.25c216b3.js"><link rel="prefetch" href="/assets/js/29.9dc30af4.js"><link rel="prefetch" href="/assets/js/30.1e9d6e06.js"><link rel="prefetch" href="/assets/js/31.3d7dbe62.js"><link rel="prefetch" href="/assets/js/32.36371ba7.js"><link rel="prefetch" href="/assets/js/33.78edc66d.js"><link rel="prefetch" href="/assets/js/35.a5470008.js"><link rel="prefetch" href="/assets/js/36.acde7543.js"><link rel="prefetch" href="/assets/js/37.f6648812.js"><link rel="prefetch" href="/assets/js/38.1885784f.js"><link rel="prefetch" href="/assets/js/39.af4b4bbd.js"><link rel="prefetch" href="/assets/js/4.61024115.js"><link rel="prefetch" href="/assets/js/40.ec6e88a9.js"><link rel="prefetch" href="/assets/js/41.67d4e8b7.js"><link rel="prefetch" href="/assets/js/42.7de428af.js"><link rel="prefetch" href="/assets/js/43.b4f51fa8.js"><link rel="prefetch" href="/assets/js/44.487d119d.js"><link rel="prefetch" href="/assets/js/45.2206665b.js"><link rel="prefetch" href="/assets/js/46.125163cc.js"><link rel="prefetch" href="/assets/js/47.8722f507.js"><link rel="prefetch" href="/assets/js/48.b8bfe77f.js"><link rel="prefetch" href="/assets/js/49.77fac897.js"><link rel="prefetch" href="/assets/js/5.3395f0b5.js"><link rel="prefetch" href="/assets/js/50.d68289a2.js"><link rel="prefetch" href="/assets/js/51.d9d70556.js"><link rel="prefetch" href="/assets/js/52.6a2c9e02.js"><link rel="prefetch" href="/assets/js/53.ff13cf8b.js"><link rel="prefetch" href="/assets/js/54.7e844902.js"><link rel="prefetch" href="/assets/js/55.80aa3d86.js"><link rel="prefetch" href="/assets/js/56.a4124774.js"><link rel="prefetch" href="/assets/js/57.55eb7355.js"><link rel="prefetch" href="/assets/js/58.7d0e2bc5.js"><link rel="prefetch" href="/assets/js/59.9cdd695c.js"><link rel="prefetch" href="/assets/js/6.77e8533c.js"><link rel="prefetch" href="/assets/js/60.54318be9.js"><link rel="prefetch" href="/assets/js/61.82e1ea82.js"><link rel="prefetch" href="/assets/js/62.b065e499.js"><link rel="prefetch" href="/assets/js/63.bb770dde.js"><link rel="prefetch" href="/assets/js/64.996fdbfd.js"><link rel="prefetch" href="/assets/js/65.54f3baf3.js"><link rel="prefetch" href="/assets/js/66.38d28ab3.js"><link rel="prefetch" href="/assets/js/67.5cf5a3bc.js"><link rel="prefetch" href="/assets/js/68.f2418476.js"><link rel="prefetch" href="/assets/js/69.162d06c4.js"><link rel="prefetch" href="/assets/js/7.a2cd9d6c.js"><link rel="prefetch" href="/assets/js/70.80f1252b.js"><link rel="prefetch" href="/assets/js/71.970dda3c.js"><link rel="prefetch" href="/assets/js/72.a073c997.js"><link rel="prefetch" href="/assets/js/73.674106d1.js"><link rel="prefetch" href="/assets/js/74.a0336873.js"><link rel="prefetch" href="/assets/js/75.37fbb329.js"><link rel="prefetch" href="/assets/js/76.a9439343.js"><link rel="prefetch" href="/assets/js/77.d52439f1.js"><link rel="prefetch" href="/assets/js/78.fbffcd6c.js"><link rel="prefetch" href="/assets/js/79.c6d73001.js"><link rel="prefetch" href="/assets/js/8.f0af9f9c.js"><link rel="prefetch" href="/assets/js/80.eab87966.js"><link rel="prefetch" href="/assets/js/81.9931436f.js"><link rel="prefetch" href="/assets/js/82.b29080c9.js"><link rel="prefetch" href="/assets/js/83.d94ed517.js"><link rel="prefetch" href="/assets/js/84.600be30f.js"><link rel="prefetch" href="/assets/js/85.a6938cc3.js"><link rel="prefetch" href="/assets/js/86.7dec6ed4.js"><link rel="prefetch" href="/assets/js/87.5d2c1dc9.js"><link rel="prefetch" href="/assets/js/88.8f2410d4.js"><link rel="prefetch" href="/assets/js/89.fe8c04e8.js"><link rel="prefetch" href="/assets/js/9.f542ab97.js"><link rel="prefetch" href="/assets/js/90.f25166a8.js"><link rel="prefetch" href="/assets/js/91.038ee701.js"><link rel="prefetch" href="/assets/js/92.19e610e0.js"><link rel="prefetch" href="/assets/js/93.22cd83c8.js"><link rel="prefetch" href="/assets/js/94.7495cfa6.js"><link rel="prefetch" href="/assets/js/95.f149c41d.js"><link rel="prefetch" href="/assets/js/96.cee91e1f.js"><link rel="prefetch" href="/assets/js/97.27a1bb57.js"><link rel="prefetch" href="/assets/js/98.67d4f125.js"><link rel="prefetch" href="/assets/js/99.35daa60c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.685c010a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">匠心博客</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/index.html" class="nav-link">博文</a></div><div class="nav-item"><a href="/book/index.html" class="nav-link">专栏</a></div><div class="nav-item"><a href="/note/index.html" class="nav-link">笔记</a></div><div class="nav-item"><a href="/nav/index.html" class="nav-link">导航</a></div><div class="nav-item"><a href="/about/index.html" class="nav-link">关于</a></div> <a href="https://github.com/zhaomenghuan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/index.html" class="nav-link">博文</a></div><div class="nav-item"><a href="/book/index.html" class="nav-link">专栏</a></div><div class="nav-item"><a href="/note/index.html" class="nav-link">笔记</a></div><div class="nav-item"><a href="/nav/index.html" class="nav-link">导航</a></div><div class="nav-item"><a href="/about/index.html" class="nav-link">关于</a></div> <a href="https://github.com/zhaomenghuan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>Android 插件化原理学习 —— Hook 机制之动态代理</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/android-plugin-framework-proxy-hook.html#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/android-plugin-framework-proxy-hook.html#插件化框架" class="sidebar-link">插件化框架</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/android-plugin-framework-proxy-hook.html#代理模式" class="sidebar-link">代理模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/android-plugin-framework-proxy-hook.html#静态代理" class="sidebar-link">静态代理</a></li><li class="sidebar-sub-header"><a href="/blog/android-plugin-framework-proxy-hook.html#动态代理" class="sidebar-link">动态代理</a></li></ul></li><li><a href="/blog/android-plugin-framework-proxy-hook.html#初识-hook-机制" class="sidebar-link">初识 Hook 机制</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/android-plugin-framework-proxy-hook.html#activity-启动过程" class="sidebar-link">Activity 启动过程</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/android-plugin-framework-proxy-hook.html#学习案例" class="sidebar-link">学习案例</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/android-plugin-framework-proxy-hook.html#参考" class="sidebar-link">参考</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="android-插件化原理学习-——-hook-机制之动态代理">Android 插件化原理学习 —— Hook 机制之动态代理</h1> <h2 id="前言">前言</h2> <p>为了实现 App 的快速迭代更新，基于 H5 Hybrid 的解决方案有很多，由于 webview 本身的性能问题，也随之出现了很多基于 JS 引擎实现的原生渲染的方案，例如 React Native、weex 等，而国内一线大厂基本上主要还是 Android 插件化解决大部分的更新问题，对于部分是采用 webview 或者 React Native 这种方案，而对于 Android 插件化采用的技术对于 Android Framewrok 的理解要求很高，真正实现落地的方案都还是有难度，对于非 Android Native 开发的人员更是有技术门槛。插件化可以很好的解决 Android 运行的一些问题，本文站在学习者的角度去尝试理解插件化到底解决了什么问题。</p> <h2 id="插件化框架">插件化框架</h2> <p>如下是主流的插件化框架之间的对比:</p> <table><thead><tr><th style="text-align:left">特性</th> <th style="text-align:center">DynamicLoadApk</th> <th style="text-align:center">DynamicAPK</th> <th style="text-align:center">Small</th> <th style="text-align:center">DroidPlugin</th> <th style="text-align:center">VirtualAPK</th></tr></thead> <tbody><tr><td style="text-align:left">支持四大组件</td> <td style="text-align:center">只支持 Activity</td> <td style="text-align:center">只支持 Activity</td> <td style="text-align:center">只支持 Activity</td> <td style="text-align:center">全支持</td> <td style="text-align:center">全支持</td></tr> <tr><td style="text-align:left">无需在宿主 manifest 中预注册</td> <td style="text-align:center">√</td> <td style="text-align:center">×</td> <td style="text-align:center">√</td> <td style="text-align:center">√</td> <td style="text-align:center">√</td></tr> <tr><td style="text-align:left">插件可以依赖宿主</td> <td style="text-align:center">√</td> <td style="text-align:center">√</td> <td style="text-align:center">√</td> <td style="text-align:center">×</td> <td style="text-align:center">√</td></tr> <tr><td style="text-align:left">支持 PendingIntent</td> <td style="text-align:center">×</td> <td style="text-align:center">×</td> <td style="text-align:center">×</td> <td style="text-align:center">√</td> <td style="text-align:center">√</td></tr> <tr><td style="text-align:left">Android 特性支持</td> <td style="text-align:center">大部分</td> <td style="text-align:center">大部分</td> <td style="text-align:center">大部分</td> <td style="text-align:center">几乎全部</td> <td style="text-align:center">几乎全部</td></tr> <tr><td style="text-align:left">兼容性适配</td> <td style="text-align:center">一般</td> <td style="text-align:center">一般</td> <td style="text-align:center">中等</td> <td style="text-align:center">高</td> <td style="text-align:center">高</td></tr> <tr><td style="text-align:left">插件构建</td> <td style="text-align:center">无</td> <td style="text-align:center">部署 aapt</td> <td style="text-align:center">Gradle 插件</td> <td style="text-align:center">无</td> <td style="text-align:center">Gradle 插件</td></tr></tbody></table> <p>如果你要加载一个插件，并且这个插件无需和宿主有任何耦合，也无需和宿主进行通信，并且你也不想对这个插件重新打包，那么推荐选择 DroidPlugin；除此之外，在同类的开源中，推荐大家选择 VirtualAPK。</p> <h2 id="代理模式">代理模式</h2> <p>代理模式是为一个对象提供一个代用品或占位符，以便控制对它的访问。使用代理可以屏蔽内部实现细节，后续内部有变动对于外部调用者来说是封闭的，符合开放-封闭原则。用户可以放心地请求代理，他只关心是否能得到想要的结果。在任何使用本体的地方都可以替换成使用代理，从而实现实现和调用松耦合。</p> <p><strong>不用代理模式：</strong></p> <p><img src="/assets/img/no-proxy.3b702d64.png" alt="不用代理模式"></p> <p><strong>使用代理模式：</strong></p> <p><img src="/assets/img/with-proxy.f00779d6.png" alt="使用代理模式"></p> <h3 id="静态代理">静态代理</h3> <p>例如我们有两个接口：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Subject1.java</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Subject1</span> <span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Subject2.java</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Subject2</span> <span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">method3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们分别实现这两个接口：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// RealSubject1.java</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RealSubject1</span> <span class="token keyword">implements</span> <span class="token class-name">Subject1</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Logger</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token class-name">RealSubject1</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;我是RealSubject1的方法1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Logger</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token class-name">RealSubject1</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;我是RealSubject1的方法2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// RealSubject2.java</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RealSubject2</span> <span class="token keyword">implements</span> <span class="token class-name">Subject2</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Logger</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token class-name">RealSubject2</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;我是RealSubject2的方法1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Logger</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token class-name">RealSubject2</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;我是RealSubject2的方法2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Logger</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token class-name">RealSubject2</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;我是RealSubject2的方法3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果不使用代理模式，我们一般会直接实例化 RealSubject1 和 RealSubject2 类对象。使用代理，我们一般都需要建立一个代理类。在 Java 等语言中，代理和本体都需要显式地实现同一个接口，一方面接口保证了它们会拥 有同样的方法，另一方面，面向接口编程迎合依赖倒置原则，通过接口进行向上转型，从而避开 编译器的类型检查，代理和本体将来可以被替换使用。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 静态代理类（为了保持行为的一致性，代理类和委托类通常会实现相同的接口）
 * ProxySubject1.java
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProxySubject1</span> <span class="token keyword">implements</span> <span class="token class-name">Subject1</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token class-name">Subject1</span> subject1<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">ProxySubject1</span><span class="token punctuation">(</span><span class="token class-name">Subject1</span> subject1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subject1 <span class="token operator">=</span> subject1<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Logger</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token class-name">ProxySubject1</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;我是代理,我会在执行实体方法1之前先做一些预处理的工作&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    subject1<span class="token punctuation">.</span><span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Logger</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token class-name">ProxySubject1</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;我是代理,我会在执行实体方法2之前先做一些预处理的工作&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    subject1<span class="token punctuation">.</span><span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用代理后我们对 RealSubject1 的操作换成对 ProxySubject1 对象的操作，如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ProxySubject1</span> proxySubject1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProxySubject1</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RealSubject1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
proxySubject1<span class="token punctuation">.</span><span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
proxySubject1<span class="token punctuation">.</span><span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

结果：
<span class="token punctuation">[</span><span class="token class-name">ProxySubject1</span><span class="token punctuation">]</span> <span class="token operator">:</span> 我是代理<span class="token punctuation">,</span>我会在执行实体方法<span class="token number">1</span>之前先做一些预处理的工作
<span class="token punctuation">[</span><span class="token class-name">RealSubject1</span><span class="token punctuation">]</span> <span class="token operator">:</span> 我是<span class="token class-name">RealSubject1</span>的方法<span class="token number">1</span>
<span class="token punctuation">[</span><span class="token class-name">ProxySubject1</span><span class="token punctuation">]</span> <span class="token operator">:</span> 我是代理<span class="token punctuation">,</span>我会在执行实体方法<span class="token number">2</span>之前先做一些预处理的工作
<span class="token punctuation">[</span><span class="token class-name">RealSubject1</span><span class="token punctuation">]</span> <span class="token operator">:</span> 我是<span class="token class-name">RealSubject1</span>的方法<span class="token number">2</span>
<span class="token punctuation">[</span><span class="token class-name">ProxySubject2</span><span class="token punctuation">]</span> <span class="token operator">:</span> 我是代理<span class="token punctuation">,</span>我会在执行实体方法<span class="token number">1</span>之前先做一些预处理的工作
<span class="token punctuation">[</span><span class="token class-name">RealSubject2</span><span class="token punctuation">]</span> <span class="token operator">:</span> 我是<span class="token class-name">RealSubject2</span>的方法<span class="token number">1</span>
<span class="token punctuation">[</span><span class="token class-name">ProxySubject2</span><span class="token punctuation">]</span> <span class="token operator">:</span> 我是代理<span class="token punctuation">,</span>我会在执行实体方法<span class="token number">2</span>之前先做一些预处理的工作
<span class="token punctuation">[</span><span class="token class-name">RealSubject2</span><span class="token punctuation">]</span> <span class="token operator">:</span> 我是<span class="token class-name">RealSubject2</span>的方法<span class="token number">2</span>
</code></pre></div><p>显然当我们想代理 RealSubject2 按照这种方式我们仍然需要建立一个类去处理，这也是静态代理的局限性。如果写一个代理类就能对上面两个都能代理就好了,动态代理就解决了这个问题。</p> <h3 id="动态代理">动态代理</h3> <p>在 java 的动态代理机制中，有两个重要的类或接口，一个是 InvocationHandler(Interface)、另一个则是 Proxy(Class)，这一个类和接口是实现我们动态代理所必须用到的。</p> <p>动态代理的步骤：</p> <ul><li>写一个 InvocationHandler 的实现类，并实现 invoke 方法，<code>return method.invoke(...);</code>。</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
  * @param proxy 指代我们所代理的那个真实对象
  * @param method 指代的是我们所要调用真实对象的某个方法的Method对象
  * @param args 指代的是调用真实对象某个方法时接受的参数
  */</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span><span class="token punctuation">;</span>
</code></pre></div><p>每一个动态代理类都必须要实现 InvocationHandler 这个接口，并且每个代理类的实例都关联到了一个 handler，当我们通过代理对象调用一个方法的时候，这个方法的调用就会被转发为由 InvocationHandler 这个接口的 invoke 方法来进行调用。</p> <ul><li>使用 Proxy 类的 newProxyInstance 方法生成一个代理对象。例如: 生成 Subject1 的代理对象，注意第三个参数中要将一个实体对象传入。</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
  * @param loader 一个ClassLoader对象，定义了由哪个ClassLoader对象来对生成的代理对象进行加载
  * @param interfaces 一个Interface对象的数组，表示的是我将要给我需要代理的对象提供一组什么接口，如果我提供了一组接口给它，那么这个代理对象就宣称实现了该接口(多态)，这样我就能调用这组接口中的方法了
  * @param h 一个InvocationHandler对象，表示的是当我这个动态代理对象在调用方法的时候，会关联到哪一个InvocationHandler对象上
  */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> interfaces<span class="token punctuation">,</span> <span class="token class-name">InvocationHandler</span> h<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalArgumentException</span>
</code></pre></div><p>例如：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>
  <span class="token class-name">Subject1</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token class-name">Subject1</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">DynamicProxyHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RealSubject1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Proxy 这个类的作用就是用来动态创建一个代理对象的类，它提供了许多的方法，但是我们用的最多的就是 newProxyInstance 这个方法。</p> <p>使用动态代理完成上述静态代理中的功能：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DynamicProxyHandler</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token class-name">Object</span> object<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">DynamicProxyHandler</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>object <span class="token operator">=</span> object<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token class-name">Logger</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token class-name">DynamicProxyHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;我正在动态代理[&quot;</span> <span class="token operator">+</span> object<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]的[&quot;</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]方法&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
    * 调用Proxy.newProxyInstance即可生成一个代理对象
    *
    * @param object
    * @return
    */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 传入被代理对象的classloader实现的接口, 还有DynamicProxyHandler的对象即可。</span>
    <span class="token keyword">return</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>object<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      object<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">DynamicProxyHandler</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>动态代理调用如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Subject1</span> dynamicProxyHandler1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Subject1</span><span class="token punctuation">)</span> <span class="token class-name">DynamicProxyHandler</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RealSubject1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
dynamicProxyHandler1<span class="token punctuation">.</span><span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
dynamicProxyHandler1<span class="token punctuation">.</span><span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="初识-hook-机制">初识 Hook 机制</h2> <p>上述我们对一个方法的调用采用了动态代理的办法，如果我们自己创建代理对象，然后把原始对象替换为我们的代理对象，那么就可以在这个代理对象为所欲为了，修改参数，替换返回值，我们称之为 Hook。下面我们 Hook 掉 startActivity 这个方法，使得每次调用这个方法之前输出一条日志；当然，这个输入日志有点点弱，只是为了展示原理；只要你想，你想可以替换参数，拦截这个 startActivity 过程，使得调用它导致启动某个别的 Activity，指鹿为马！</p> <p>首先我们得找到被 Hook 的对象，我称之为 Hook 点；什么样的对象比较好 Hook 呢？自然是容易找到的对象。什么样的对象容易找到？<strong>静态变量和单例</strong>。在一个进程之内，静态变量和单例变量是相对不容易发生变化的，因此非常容易定位，而普通的对象则要么无法标志，要么容易改变。我们根据这个原则找到所谓的 Hook 点。</p> <p>对于 startActivity 过程有两种方式：Context.startActivity 和 Activity.startActivity。这里暂不分析其中的区别，以 Activity.startActivity 为例说明整个过程的调用栈。</p> <p>Activity 中的 startActivity 最终都是由 startActivityForResult 来实现的。</p> <p><strong>Activity#startActivityForResult：</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startActivityForResult</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequiresPermission</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 一般的 Activity 其 mParent 为 null，mParent 常用在 ActivityGroup 中，ActivityGroup 已废弃</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mParent <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      options <span class="token operator">=</span> <span class="token function">transferSpringboardActivityOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 这里会启动新的Activity，核心功能都在 mMainThread.getApplicationThread() 中完成</span>
      <span class="token class-name">Instrumentation<span class="token punctuation">.</span>ActivityResult</span> ar <span class="token operator">=</span>
          mInstrumentation<span class="token punctuation">.</span><span class="token function">execStartActivity</span><span class="token punctuation">(</span>
              <span class="token keyword">this</span><span class="token punctuation">,</span> mMainThread<span class="token punctuation">.</span><span class="token function">getApplicationThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mToken<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
              intent<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ar <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          mMainThread<span class="token punctuation">.</span><span class="token function">sendActivityResult</span><span class="token punctuation">(</span>
              mToken<span class="token punctuation">,</span> mEmbeddedID<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> ar<span class="token punctuation">.</span><span class="token function">getResultCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              ar<span class="token punctuation">.</span><span class="token function">getResultData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>requestCode <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          mStartedActivity <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">cancelInputsAndStartExitTransition</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          mParent<span class="token punctuation">.</span><span class="token function">startActivityFromChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// Note we want to go through this method for compatibility with</span>
          <span class="token comment">// existing applications that may have overridden it.</span>
          mParent<span class="token punctuation">.</span><span class="token function">startActivityFromChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span> requestCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以发现，真正打开 activity 的实现在 Instrumentation 的 execStartActivity 方法中。</p> <p><strong>Instrumentation#execStartActivity：</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ActivityResult</span> <span class="token function">execStartActivity</span><span class="token punctuation">(</span>
        <span class="token class-name">Context</span> who<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> contextThread<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> token<span class="token punctuation">,</span> <span class="token class-name">Activity</span> target<span class="token punctuation">,</span>
        <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 核心功能在这个whoThread中完成，其内部scheduleLaunchActivity方法用于完成activity的打开</span>
    <span class="token class-name">IApplicationThread</span> whoThread <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span><span class="token punctuation">)</span> contextThread<span class="token punctuation">;</span>
    <span class="token class-name">Uri</span> referrer <span class="token operator">=</span> target <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> target<span class="token punctuation">.</span><span class="token function">onProvideReferrer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>referrer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        intent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">EXTRA_REFERRER</span><span class="token punctuation">,</span> referrer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mActivityMonitors <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mSync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token class-name">N</span> <span class="token operator">=</span> mActivityMonitors<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token class-name">N</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token class-name">ActivityMonitor</span> am <span class="token operator">=</span> mActivityMonitors<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">ActivityResult</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>am<span class="token punctuation">.</span><span class="token function">ignoreMatchingSpecificIntents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    result <span class="token operator">=</span> am<span class="token punctuation">.</span><span class="token function">onStartActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    am<span class="token punctuation">.</span>mHits<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>am<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>who<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> intent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    am<span class="token punctuation">.</span>mHits<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>am<span class="token punctuation">.</span><span class="token function">isBlocking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> requestCode <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">?</span> am<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        intent<span class="token punctuation">.</span><span class="token function">migrateExtraStreamToClipData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        intent<span class="token punctuation">.</span><span class="token function">prepareToLeaveProcess</span><span class="token punctuation">(</span>who<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 这里才是真正打开 Activity 的地方，核心功能在 whoThread 中完成。</span>
        <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">startActivity</span><span class="token punctuation">(</span>whoThread<span class="token punctuation">,</span> who<span class="token punctuation">.</span><span class="token function">getBasePackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span>
                    intent<span class="token punctuation">.</span><span class="token function">resolveTypeIfNeeded</span><span class="token punctuation">(</span>who<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    token<span class="token punctuation">,</span> target <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> target<span class="token punctuation">.</span>mEmbeddedID <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                    requestCode<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 这个方法是专门抛异常的，它会对结果进行检查，如果无法打开activity，</span>
		    <span class="token comment">// 则抛出诸如ActivityNotFoundException类似的各种异常</span>
        <span class="token function">checkStartActivityResult</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Failure from system&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果我们想深入了解 Activity 启动过程我们需要接着 Android 源码看下去，但是对于本文中我们初步了解 Hook 机制足以。</p> <p>我们的目的是替换掉系统默认逻辑，对于 Activity#startActivityForResult 的方法里面核心逻辑就是 mInstrumentation 属性的 execStartActivity 方法，而这里的 mInstrumentation 属性在 Activity 类中恰好是一个单例，在 Activity 类的 attach 方法里面被赋值，我们可以在 attach 之后使用反射机制对 mInstrumentation 属性进行重新赋值。attach() 方法调用完成后，就自然而然的调用了 Activity 的 onCreate() 方法了。</p> <p>我们需要修改 mInstrumentation 这个字段为我们的代理对象，我们使用静态代理实现这个代理对象。这里我们使用 EvilInstrumentation 作为代理对象。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EvilInstrumentation</span> <span class="token keyword">extends</span> <span class="token class-name">Instrumentation</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Instrumentation</span> instrumentation<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">EvilInstrumentation</span><span class="token punctuation">(</span><span class="token class-name">Instrumentation</span> instrumentation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>instrumentation <span class="token operator">=</span> instrumentation<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">ActivityResult</span> <span class="token function">execStartActivity</span><span class="token punctuation">(</span>
            <span class="token class-name">Context</span> who<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> contextThread<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> token<span class="token punctuation">,</span> <span class="token class-name">Activity</span> target<span class="token punctuation">,</span>
            <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;who = [&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>who<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;], &quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;contextThread = [&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>contextThread<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;], &quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;token = [&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;], &quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;target = [&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;], &quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;intent = [&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;], &quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;requestCode = [&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;], &quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;options = [&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
        <span class="token class-name">Logger</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token class-name">EvilInstrumentation</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;执行了startActivity, 参数如下: &quot;</span> <span class="token operator">+</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Method</span> execStartActivity <span class="token operator">=</span> <span class="token class-name">Instrumentation</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;execStartActivity&quot;</span><span class="token punctuation">,</span>
                    <span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                    <span class="token class-name">IBinder</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                    <span class="token class-name">IBinder</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                    <span class="token class-name">Activity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                    <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                    <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                    <span class="token class-name">Bundle</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">ActivityResult</span><span class="token punctuation">)</span> execStartActivity<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>instrumentation<span class="token punctuation">,</span> who<span class="token punctuation">,</span> contextThread<span class="token punctuation">,</span> token<span class="token punctuation">,</span> target<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>采用反射直接修改 Activity 中的 mInstrumentation 属性，从而实现偷梁换柱——用代理对象替换原始对象。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 拿到原始的 mInstrumentation字段</span>
<span class="token class-name">Field</span> mInstrumentationField <span class="token operator">=</span> <span class="token class-name">Activity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">&quot;mInstrumentation&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mInstrumentationField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建代理对象</span>
<span class="token class-name">Instrumentation</span> originalInstrumentation <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Instrumentation</span><span class="token punctuation">)</span> mInstrumentationField<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>
mInstrumentationField<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">EvilInstrumentation</span><span class="token punctuation">(</span>originalInstrumentation<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这段 Hook 的逻辑放在 Activity 的 onCreate 里面即可生效。</p> <p>对于 Context 类的 startActivity 方法的 Hook 实现可以参考 weishu 大神的 <a href="http://weishu.me/2016/01/28/understand-plugin-framework-proxy-hook/" target="_blank" rel="noopener noreferrer">Android 插件化原理解析——Hook 机制之动态代理<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，本文也是基于 weishu 大神的文章在学习过程记录的内容。</p> <h2 id="activity-启动过程">Activity 启动过程</h2> <p>上述例子中我们只是完成了一个最基础的 Hook 功能，然而大部分插件化框架提供了十分丰富的功能，例如：插件化支持首先要解决的一点就是插件里的 Activity 并未在宿主程序的 AndroidMainfest.xml 注册。常规方法肯定无法直接启动插件的 Activity，这个时候就需要去了解 Activity 的启动流程。</p> <p><img src="/assets/img/start_activity_process.d24d91d3.png" alt></p> <p>完整的流程如下：</p> <p><img src="/assets/img/full-activity-process.9cea326c.png" alt></p> <p>注: 可以在 <a href="http://androidxref.com/" target="_blank" rel="noopener noreferrer">http://androidxref.com/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 在线查看 Android 源码。</p> <p>上图列出的是启动一个 Activity 的主要过程，具体步骤如下：</p> <ol><li>Activity 调用 startActivity，实际会调用 Instrumentation 类的 execStartActivity 方法，Instrumentation 是系统用来监控 Activity 运行的一个类，Activity 的整个生命周期都有它的影子。</li> <li>通过跨进程的 Binder 调用，进入到 ActivityManagerService 中，其内部会处理 Activity 栈。之后又通过跨进程调用进入到需要调用的 Activity 所在的进程中。</li> <li>ApplicationThread 是一个 Binder 对象，其运行在 Binder 线程池中，内部包含一个 H 类，该类继承于类 Handler。ApplicationThread 将启动需要调用的 Activity 的信息通过 H 对象发送给主线程。</li> <li>主线程拿到需要调用的 Activity 的信息后，调用 Instrumentation 类的 newActivity 方法，其内通过 ClassLoader 创建 Activity 实例。</li></ol> <p>下面介绍如何通过 hook 的方式启动插件中的 Activity，需要解决以下两个问题：</p> <ul><li>插件中的 Activity 没有在 AndroidManifest 中注册，如何绕过检测。</li> <li>如何构造 Activity 实例，同步生命周期。</li></ul> <p>我们这里使用最简单的一种实现方式：先在 Manifest 中预埋 StubActivity，启动时 hook 上图第 1 步，将 Intent 替换成 StubActivity。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// StubActivity.java</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StubActivity</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TARGET_COMPONENT</span> <span class="token operator">=</span> <span class="token string">&quot;TARGET_COMPONENT&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们上面在 EvilInstrumentation 类里面实现了 execStartActivity 方法，现在我们在这里再加一些额外的逻辑。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ActivityResult</span> <span class="token function">execStartActivity</span><span class="token punctuation">(</span><span class="token class-name">Context</span> who<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> contextThread<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> token<span class="token punctuation">,</span> <span class="token class-name">Activity</span> target<span class="token punctuation">,</span>
    <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;who = [&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>who<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;], &quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;contextThread = [&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>contextThread<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;], &quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;token = [&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;], &quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;target = [&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;], &quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;intent = [&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;], &quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;requestCode = [&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;], &quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;options = [&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token class-name">Logger</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token class-name">EvilInstrumentation</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;执行了startActivity, 参数如下: &quot;</span> <span class="token operator">+</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 在此处先将 intent 原本的 Component 保存起来, 然后创建一个新的 intent。</span>
    <span class="token comment">// 使用 StubActivity 并替换掉原本的 Activity, 以达通过 AMS 验证的目的,然后等 AMS 验证通过后再将其还原。</span>
    <span class="token class-name">Intent</span> replaceIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token class-name">StubActivity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    replaceIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span><span class="token class-name">StubActivity</span><span class="token punctuation">.</span><span class="token constant">TARGET_COMPONENT</span><span class="token punctuation">,</span> intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    intent <span class="token operator">=</span> replaceIntent<span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">Method</span> execStartActivity <span class="token operator">=</span> <span class="token class-name">Instrumentation</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span>
                <span class="token string">&quot;execStartActivity&quot;</span><span class="token punctuation">,</span>
                <span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                <span class="token class-name">IBinder</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                <span class="token class-name">IBinder</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                <span class="token class-name">Activity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                <span class="token class-name">Bundle</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">ActivityResult</span><span class="token punctuation">)</span> execStartActivity<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>instrumentation<span class="token punctuation">,</span> who<span class="token punctuation">,</span> contextThread<span class="token punctuation">,</span> token<span class="token punctuation">,</span> target<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过这种&quot;移花接木&quot;的方式绕过 AMS 验证，但是这里我们并没有完成对我们原本需要真正打开的 Activity 的创建。这里我们需要监听 Activity 的创建过程，然后在适当的适合将原本需要打开的 Activity 还原回来。</p> <p>在 <a href="http://androidxref.com/8.0.0_r4/xref/frameworks/base/core/java/android/app/ActivityThread.java" target="_blank" rel="noopener noreferrer">ActivityThread<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 类中有一个重要的消息处理的方法 sendMessage。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token number">2644</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">int</span> what<span class="token punctuation">,</span> <span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token keyword">int</span> arg1<span class="token punctuation">,</span> <span class="token keyword">int</span> arg2<span class="token punctuation">,</span> <span class="token keyword">boolean</span> async<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">2645</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_MESSAGES</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>
<span class="token number">2646</span>            <span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;SCHEDULE &quot;</span> <span class="token operator">+</span> what <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> mH<span class="token punctuation">.</span><span class="token function">codeToString</span><span class="token punctuation">(</span>what<span class="token punctuation">)</span>
<span class="token number">2647</span>            <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> arg1 <span class="token operator">+</span> <span class="token string">&quot; / &quot;</span> <span class="token operator">+</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2648</span>        <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token class-name">Message</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2649</span>        msg<span class="token punctuation">.</span>what <span class="token operator">=</span> what<span class="token punctuation">;</span>
<span class="token number">2650</span>        msg<span class="token punctuation">.</span>obj <span class="token operator">=</span> obj<span class="token punctuation">;</span>
<span class="token number">2651</span>        msg<span class="token punctuation">.</span>arg1 <span class="token operator">=</span> arg1<span class="token punctuation">;</span>
<span class="token number">2652</span>        msg<span class="token punctuation">.</span>arg2 <span class="token operator">=</span> arg2<span class="token punctuation">;</span>
<span class="token number">2653</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>async<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">2654</span>            msg<span class="token punctuation">.</span><span class="token function">setAsynchronous</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2655</span>        <span class="token punctuation">}</span>
<span class="token number">2656</span>        mH<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2657</span>    <span class="token punctuation">}</span>
</code></pre></div><p>最终都会落实到 <code>mH.sendMessage(msg);</code> 的调用，继续追踪这个 mH 对象，我们会发现是 H 对象的实例化对象。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">H</span> mH <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">H</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">H</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1585</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_MESSAGES</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;&gt;&gt;&gt; handling: &quot;</span> <span class="token operator">+</span> <span class="token function">codeToString</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1586</span>            <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">1587</span>                <span class="token keyword">case</span> <span class="token constant">LAUNCH_ACTIVITY</span><span class="token operator">:</span> <span class="token punctuation">{</span>
<span class="token number">1588</span>                    <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">,</span> <span class="token string">&quot;activityStart&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1589</span>                    <span class="token keyword">final</span> <span class="token class-name">ActivityClientRecord</span> r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ActivityClientRecord</span><span class="token punctuation">)</span> msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
<span class="token number">1590</span>
<span class="token number">1591</span>                    r<span class="token punctuation">.</span>packageInfo <span class="token operator">=</span> <span class="token function">getPackageInfoNoCheck</span><span class="token punctuation">(</span>
<span class="token number">1592</span>                            r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span> r<span class="token punctuation">.</span>compatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1593</span>                    <span class="token function">handleLaunchActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;LAUNCH_ACTIVITY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1594</span>                    <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">1595</span>                <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>我们知道 Handler 消息机制用于同进程的线程间通信, Handler 是工作线程向 UI 主线程发送消息，工作线程通过 mHandler 向其成员变量 MessageQueue 中添加新 Message，主线程一直处于 loop() 方法内，当收到新的 Message 时按照一定规则分发给相应的 handleMessage() 方法来处理。</p> <p>类似于对上述 mInstrumentation 实例化对象 hook 一样，这里我们可以对 mH 对象进行 hook。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 将替换的activity在此时还原回来
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">doHandlerHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> activityThreadClass <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;android.app.ActivityThread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Method</span> currentActivityThread <span class="token operator">=</span> activityThreadClass<span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">&quot;currentActivityThread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> activityThread <span class="token operator">=</span> currentActivityThread<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Field</span> mHField <span class="token operator">=</span> activityThreadClass<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">&quot;mH&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mHField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Handler</span> mH <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Handler</span><span class="token punctuation">)</span> mHField<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>activityThread<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Field</span> mCallbackField <span class="token operator">=</span> <span class="token class-name">Handler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">&quot;mCallback&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mCallbackField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mCallbackField<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mH<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ActivityThreadHandlerCallback</span><span class="token punctuation">(</span>mH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对于 Handler.Callback 的 hook 实现如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ActivityThreadHandlerCallback</span> <span class="token keyword">implements</span> <span class="token class-name">Handler<span class="token punctuation">.</span>Callback</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Handler</span> mBaseHandler<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ActivityThreadHandlerCallback</span><span class="token punctuation">(</span><span class="token class-name">Handler</span> mBaseHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mBaseHandler <span class="token operator">=</span> mBaseHandler<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Logger</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token class-name">ActivityThreadHandlerCallback</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;接受到消息了msg:&quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what <span class="token operator">==</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Object</span> obj <span class="token operator">=</span> msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
                <span class="token class-name">Field</span> intentField <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">&quot;intent&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                intentField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Intent</span> intent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">)</span> intentField<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name">Intent</span> targetIntent <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getParcelableExtra</span><span class="token punctuation">(</span><span class="token class-name">StubActivity</span><span class="token punctuation">.</span><span class="token constant">TARGET_COMPONENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                intent<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span>targetIntent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">&quot;intentField&quot;</span><span class="token punctuation">,</span> targetIntent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchFieldException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        mBaseHandler<span class="token punctuation">.</span><span class="token function">handleMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们设置在 handleMessage 里面还原我们最开始替换的 Activity，至此我们就实现了对于 startActivity 的完整 hook，但是这个过程中仍然存在很多问题，我们需要进一步去深入探索才能去理解和更好实现插件化框架的内容。</p> <h2 id="学习案例">学习案例</h2> <p>本文学习案例地址：<a href="https://github.com/zhaomenghuan/android-plugin-framework" target="_blank" rel="noopener noreferrer">android-plugin-framework<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="参考">参考</h2> <ul><li><a href="http://www.androidblog.cn/index.php/Index/detail/id/16" target="_blank" rel="noopener noreferrer">Android 博客周刊专题之＃插件化开发＃<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/didi/VirtualAPK/wiki" target="_blank" rel="noopener noreferrer">VirtualAPK Wiki<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/DroidPluginTeam/DroidPlugin/blob/master/readme_cn.md" target="_blank" rel="noopener noreferrer">DroidPlugin Wiki<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/tiann/understand-plugin-framework" target="_blank" rel="noopener noreferrer">understand-plugin-framework<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://weishu.me/2016/01/28/understand-plugin-framework-proxy-hook/" target="_blank" rel="noopener noreferrer">Android 插件化原理解析——Hook 机制之动态代理<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://blog.csdn.net/singwhatiwanna/article/details/18154335" target="_blank" rel="noopener noreferrer">Android 源码分析-Activity 的启动过程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://shuwoom.com/?p=142" target="_blank" rel="noopener noreferrer">APP 的启动过程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <div data-v-3bd334e8><p class="descript" data-v-3bd334e8>写这些代码也许就一两个小时的事，写一篇大家好接受的文章需要几天的酝酿，如果文章对您有帮助请我喝杯咖啡吧！</p> <img src="/supportme.png" class="pay-code" data-v-3bd334e8> <div data-v-3bd334e8><div id="container"></div></div> <div class="footer" data-v-4f0df4b0 data-v-3bd334e8><p data-v-4f0df4b0>站点总访问量： 站点总访客数：</p> <p data-v-4f0df4b0>博客内容遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" data-v-4f0df4b0>知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></p> <p data-v-4f0df4b0>赵梦欢 © 2015 - 2023</p></div></div></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.f3e141ba.js" defer></script><script src="/assets/js/20.f8833113.js" defer></script><script src="/assets/js/18.c373a36e.js" defer></script><script src="/assets/js/34.124c31c0.js" defer></script>
  </body>
</html>
