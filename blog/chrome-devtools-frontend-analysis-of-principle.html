<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Chrome DevTools Frontend 运行原理浅析 | 匠心博客</title>
    <meta name="description" content="小青年,匠心,小青年博客,匠心博客,前端开发,android,技术宅,菜鸟教程,一个神奇的博客。">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.685c010a.css" as="style"><link rel="preload" href="/assets/js/app.f3e141ba.js" as="script"><link rel="preload" href="/assets/js/9.f542ab97.js" as="script"><link rel="preload" href="/assets/js/18.c373a36e.js" as="script"><link rel="preload" href="/assets/js/34.124c31c0.js" as="script"><link rel="prefetch" href="/assets/js/1.1950ec81.js"><link rel="prefetch" href="/assets/js/10.7f857e71.js"><link rel="prefetch" href="/assets/js/100.e03c01d2.js"><link rel="prefetch" href="/assets/js/101.7b790a2f.js"><link rel="prefetch" href="/assets/js/102.a7aa77f9.js"><link rel="prefetch" href="/assets/js/103.d473991c.js"><link rel="prefetch" href="/assets/js/104.9fe8785c.js"><link rel="prefetch" href="/assets/js/105.7291ae49.js"><link rel="prefetch" href="/assets/js/106.2c35a2f4.js"><link rel="prefetch" href="/assets/js/107.a71ccb64.js"><link rel="prefetch" href="/assets/js/108.9d6f54a8.js"><link rel="prefetch" href="/assets/js/109.e77d12ca.js"><link rel="prefetch" href="/assets/js/11.5378ae65.js"><link rel="prefetch" href="/assets/js/12.9aca40f8.js"><link rel="prefetch" href="/assets/js/13.ce2b655c.js"><link rel="prefetch" href="/assets/js/14.7488ca24.js"><link rel="prefetch" href="/assets/js/15.9c07ac98.js"><link rel="prefetch" href="/assets/js/16.8f57294c.js"><link rel="prefetch" href="/assets/js/17.4f7ae4ec.js"><link rel="prefetch" href="/assets/js/19.c7be2474.js"><link rel="prefetch" href="/assets/js/2.7f7e5268.js"><link rel="prefetch" href="/assets/js/20.f8833113.js"><link rel="prefetch" href="/assets/js/21.e71dd521.js"><link rel="prefetch" href="/assets/js/22.92dc7b77.js"><link rel="prefetch" href="/assets/js/23.285557d3.js"><link rel="prefetch" href="/assets/js/24.a803551c.js"><link rel="prefetch" href="/assets/js/25.dbeaa19d.js"><link rel="prefetch" href="/assets/js/26.9ca97076.js"><link rel="prefetch" href="/assets/js/27.d1a2911b.js"><link rel="prefetch" href="/assets/js/28.25c216b3.js"><link rel="prefetch" href="/assets/js/29.9dc30af4.js"><link rel="prefetch" href="/assets/js/30.1e9d6e06.js"><link rel="prefetch" href="/assets/js/31.3d7dbe62.js"><link rel="prefetch" href="/assets/js/32.36371ba7.js"><link rel="prefetch" href="/assets/js/33.78edc66d.js"><link rel="prefetch" href="/assets/js/35.a5470008.js"><link rel="prefetch" href="/assets/js/36.acde7543.js"><link rel="prefetch" href="/assets/js/37.f6648812.js"><link rel="prefetch" href="/assets/js/38.1885784f.js"><link rel="prefetch" href="/assets/js/39.af4b4bbd.js"><link rel="prefetch" href="/assets/js/4.61024115.js"><link rel="prefetch" href="/assets/js/40.ec6e88a9.js"><link rel="prefetch" href="/assets/js/41.67d4e8b7.js"><link rel="prefetch" href="/assets/js/42.7de428af.js"><link rel="prefetch" href="/assets/js/43.b4f51fa8.js"><link rel="prefetch" href="/assets/js/44.487d119d.js"><link rel="prefetch" href="/assets/js/45.2206665b.js"><link rel="prefetch" href="/assets/js/46.125163cc.js"><link rel="prefetch" href="/assets/js/47.8722f507.js"><link rel="prefetch" href="/assets/js/48.b8bfe77f.js"><link rel="prefetch" href="/assets/js/49.77fac897.js"><link rel="prefetch" href="/assets/js/5.3395f0b5.js"><link rel="prefetch" href="/assets/js/50.d68289a2.js"><link rel="prefetch" href="/assets/js/51.d9d70556.js"><link rel="prefetch" href="/assets/js/52.6a2c9e02.js"><link rel="prefetch" href="/assets/js/53.ff13cf8b.js"><link rel="prefetch" href="/assets/js/54.7e844902.js"><link rel="prefetch" href="/assets/js/55.80aa3d86.js"><link rel="prefetch" href="/assets/js/56.a4124774.js"><link rel="prefetch" href="/assets/js/57.55eb7355.js"><link rel="prefetch" href="/assets/js/58.7d0e2bc5.js"><link rel="prefetch" href="/assets/js/59.9cdd695c.js"><link rel="prefetch" href="/assets/js/6.77e8533c.js"><link rel="prefetch" href="/assets/js/60.54318be9.js"><link rel="prefetch" href="/assets/js/61.82e1ea82.js"><link rel="prefetch" href="/assets/js/62.b065e499.js"><link rel="prefetch" href="/assets/js/63.bb770dde.js"><link rel="prefetch" href="/assets/js/64.996fdbfd.js"><link rel="prefetch" href="/assets/js/65.54f3baf3.js"><link rel="prefetch" href="/assets/js/66.38d28ab3.js"><link rel="prefetch" href="/assets/js/67.5cf5a3bc.js"><link rel="prefetch" href="/assets/js/68.f2418476.js"><link rel="prefetch" href="/assets/js/69.162d06c4.js"><link rel="prefetch" href="/assets/js/7.a2cd9d6c.js"><link rel="prefetch" href="/assets/js/70.80f1252b.js"><link rel="prefetch" href="/assets/js/71.970dda3c.js"><link rel="prefetch" href="/assets/js/72.a073c997.js"><link rel="prefetch" href="/assets/js/73.674106d1.js"><link rel="prefetch" href="/assets/js/74.a0336873.js"><link rel="prefetch" href="/assets/js/75.37fbb329.js"><link rel="prefetch" href="/assets/js/76.a9439343.js"><link rel="prefetch" href="/assets/js/77.d52439f1.js"><link rel="prefetch" href="/assets/js/78.fbffcd6c.js"><link rel="prefetch" href="/assets/js/79.c6d73001.js"><link rel="prefetch" href="/assets/js/8.f0af9f9c.js"><link rel="prefetch" href="/assets/js/80.eab87966.js"><link rel="prefetch" href="/assets/js/81.9931436f.js"><link rel="prefetch" href="/assets/js/82.b29080c9.js"><link rel="prefetch" href="/assets/js/83.d94ed517.js"><link rel="prefetch" href="/assets/js/84.600be30f.js"><link rel="prefetch" href="/assets/js/85.a6938cc3.js"><link rel="prefetch" href="/assets/js/86.7dec6ed4.js"><link rel="prefetch" href="/assets/js/87.5d2c1dc9.js"><link rel="prefetch" href="/assets/js/88.8f2410d4.js"><link rel="prefetch" href="/assets/js/89.fe8c04e8.js"><link rel="prefetch" href="/assets/js/90.f25166a8.js"><link rel="prefetch" href="/assets/js/91.038ee701.js"><link rel="prefetch" href="/assets/js/92.19e610e0.js"><link rel="prefetch" href="/assets/js/93.22cd83c8.js"><link rel="prefetch" href="/assets/js/94.7495cfa6.js"><link rel="prefetch" href="/assets/js/95.f149c41d.js"><link rel="prefetch" href="/assets/js/96.cee91e1f.js"><link rel="prefetch" href="/assets/js/97.27a1bb57.js"><link rel="prefetch" href="/assets/js/98.67d4f125.js"><link rel="prefetch" href="/assets/js/99.35daa60c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.685c010a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">匠心博客</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/index.html" class="nav-link">博文</a></div><div class="nav-item"><a href="/book/index.html" class="nav-link">专栏</a></div><div class="nav-item"><a href="/note/index.html" class="nav-link">笔记</a></div><div class="nav-item"><a href="/nav/index.html" class="nav-link">导航</a></div><div class="nav-item"><a href="/about/index.html" class="nav-link">关于</a></div> <a href="https://github.com/zhaomenghuan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/index.html" class="nav-link">博文</a></div><div class="nav-item"><a href="/book/index.html" class="nav-link">专栏</a></div><div class="nav-item"><a href="/note/index.html" class="nav-link">笔记</a></div><div class="nav-item"><a href="/nav/index.html" class="nav-link">导航</a></div><div class="nav-item"><a href="/about/index.html" class="nav-link">关于</a></div> <a href="https://github.com/zhaomenghuan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>Chrome DevTools Frontend 运行原理浅析</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/chrome-devtools-frontend-analysis-of-principle.html#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/chrome-devtools-frontend-analysis-of-principle.html#devtools-工作原理" class="sidebar-link">DevTools 工作原理</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/chrome-devtools-frontend-analysis-of-principle.html#源码下载及编译" class="sidebar-link">源码下载及编译</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/chrome-devtools-frontend-analysis-of-principle.html#安装-depot-tools-工具" class="sidebar-link">安装 depot_tools 工具</a></li><li class="sidebar-sub-header"><a href="/blog/chrome-devtools-frontend-analysis-of-principle.html#基于-chrome-运行-devtools" class="sidebar-link">基于 Chrome 运行 DevTools</a></li><li class="sidebar-sub-header"><a href="/blog/chrome-devtools-frontend-analysis-of-principle.html#基于-devserver-运行-devtools" class="sidebar-link">基于 DevServer 运行 DevTools</a></li></ul></li><li><a href="/blog/chrome-devtools-frontend-analysis-of-principle.html#源码整体分析" class="sidebar-link">源码整体分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/chrome-devtools-frontend-analysis-of-principle.html#目录结构" class="sidebar-link">目录结构</a></li><li class="sidebar-sub-header"><a href="/blog/chrome-devtools-frontend-analysis-of-principle.html#application-modules-extensions" class="sidebar-link">Application &amp; Modules &amp; Extensions</a></li></ul></li><li><a href="/blog/chrome-devtools-frontend-analysis-of-principle.html#inspector-启动流程" class="sidebar-link">Inspector 启动流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/chrome-devtools-frontend-analysis-of-principle.html#npm-start-命令流程" class="sidebar-link">npm start 命令流程</a></li><li class="sidebar-sub-header"><a href="/blog/chrome-devtools-frontend-analysis-of-principle.html#startapplication-启动流程" class="sidebar-link">startApplication 启动流程</a></li><li class="sidebar-sub-header"><a href="/blog/chrome-devtools-frontend-analysis-of-principle.html#js-与-embedder-通信机制" class="sidebar-link">JS 与 Embedder 通信机制</a></li></ul></li><li><a href="/blog/chrome-devtools-frontend-analysis-of-principle.html#devtools-frontend-ui-组件机制" class="sidebar-link">DevTools Frontend UI 组件机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/chrome-devtools-frontend-analysis-of-principle.html#widget" class="sidebar-link">Widget</a></li><li class="sidebar-sub-header"><a href="/blog/chrome-devtools-frontend-analysis-of-principle.html#createappui" class="sidebar-link">createAppUI</a></li><li class="sidebar-sub-header"><a href="/blog/chrome-devtools-frontend-analysis-of-principle.html#实例化-inspectorview" class="sidebar-link">实例化 InspectorView</a></li><li class="sidebar-sub-header"><a href="/blog/chrome-devtools-frontend-analysis-of-principle.html#实例化-simpleapp" class="sidebar-link">实例化 SimpleApp</a></li></ul></li><li><a href="/blog/chrome-devtools-frontend-analysis-of-principle.html#frontend-与-backend-的通信机制" class="sidebar-link">Frontend 与 Backend 的通信机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/chrome-devtools-frontend-analysis-of-principle.html#target-models-agents" class="sidebar-link">Target &amp; Models &amp; Agents</a></li><li class="sidebar-sub-header"><a href="/blog/chrome-devtools-frontend-analysis-of-principle.html#初始化-main-connection" class="sidebar-link">初始化 Main Connection</a></li><li class="sidebar-sub-header"><a href="/blog/chrome-devtools-frontend-analysis-of-principle.html#devtools-protocol-client" class="sidebar-link">DevTools Protocol Client</a></li></ul></li><li><a href="/blog/chrome-devtools-frontend-analysis-of-principle.html#总结" class="sidebar-link">总结</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/chrome-devtools-frontend-analysis-of-principle.html#参考" class="sidebar-link">参考</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="chrome-devtools-frontend-运行原理浅析">Chrome DevTools Frontend 运行原理浅析</h1> <h2 id="前言">前言</h2> <p><a href="https://zhaomenghuan.js.org/blog/chrome-devtools.html" target="_blank" rel="noopener noreferrer">《深入理解 Chrome DevTools》<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>一文中从整体上介绍了 Chrome DevTools 及 Electron 中集成 DevTools 实现调试器的基本原理，目前主流的小程序 IDE 调试器都是集成 Chrome DevTools Frontend 实现，主要有两种实现方式：</p> <ul><li>不修改 Chrome 调试器源代码，使用默认的 chrome-devtools 协议，所有定制化需求都通过 Chrome DevTools Extensions 实现；(微信方案)</li> <li>修改 Chrome 调试器源代码，使用 http 协议，hard code 方式或提供 Chrome DevTools Extensions 运行环境进行定制。(阿里、百度方案)</li></ul> <p>这两种方式都需要对 Devtools Frontend 项目的代码有一定的了解，本文尝试从源码角度入手，体系化理解 DevTools Frontend 和 DevTools Extensions 运行机制，从而更完善的定制调试器功能。</p> <h2 id="devtools-工作原理">DevTools 工作原理</h2> <p>Chrome DevTools 是辅助开发者进行 Web 开发的重要调试工具，DevTools 是 Chromium 的一部分，可整体集成于 Electron 应用中。</p> <p>DevTools 主要由四部分组成：</p> <ul><li><a href="https://github.com/ChromeDevTools/devtools-frontend/wiki/Frontend" target="_blank" rel="noopener noreferrer">Frontend<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：调试器前端，默认由 Chromium 内核层集成，DevTools Frontend 是一个 Web 应用程序；</li> <li><a href="https://github.com/ChromeDevTools/devtools-frontend/wiki/Chromium-Backend" target="_blank" rel="noopener noreferrer">Backend<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：调试器后端，Chromium、V8 或 Node.js；</li> <li><a href="https://chromedevtools.github.io/devtools-protocol" target="_blank" rel="noopener noreferrer">Protocol<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：调试协议，调试器前端和后端使用此协议通信。 它分为代表被检查实体的语义方面的域。 每个域定义类型、命令（从前端发送到后端的消息）和事件（从后端发送到前端的消息）。该协议基于 <a href="https://www.jsonrpc.org/specification" target="_blank" rel="noopener noreferrer">json rpc 2.0<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 运行；</li> <li><a href="https://github.com/ChromeDevTools/devtools-frontend/wiki/Message-Channels" target="_blank" rel="noopener noreferrer">Message Channels<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：消息通道，消息通道是在后端和前端之间发送协议消息的一种方式。包括：Embedder Channel、WebSocket Channel、Chrome Extensions Channel、USB/ADB Channel。</li></ul> <p>这四部分的交互逻辑如下图所示：</p> <p><img src="/assets/img/devtools-parts.a062dd6e.png" alt></p> <h2 id="源码下载及编译">源码下载及编译</h2> <p>DevTools Frontend 项目属于 <a href="https://chromium.googlesource.com/?format=HTML" target="_blank" rel="noopener noreferrer">Chromium<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 项目的子项目，代码托管在 Google 开源仓库上，代码开源从这里下载：<a href="https://chromium.googlesource.com/devtools/devtools-frontend/" target="_blank" rel="noopener noreferrer">Chromium DevTools Frontend<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 或 <a href="https://github.com/ChromeDevTools/devtools-frontend" target="_blank" rel="noopener noreferrer">GitHub DevTools Frontend<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 镜像。DevTools Frontend 项目和 Chromium 项目一样，也是基于 GN 构建，GN 是一种元构建系统，生成 Ninja 构建文件，编译速度快，效率上比基于 python 的 GYP 快了近 20 倍。</p> <p>下载 DevTools Frontend 代码，发现在构建时执行 <code>gn gen out/Default</code> 报错，这是因为没有下载 depot_tools 工具，所以没有 gn 命令。</p> <p>发现百度小程序又一个简化编译流程的方案：<a href="https://songyaru.github.io/doc-backup/devtools/front-end" target="_blank" rel="noopener noreferrer">如何定制 chrome 开发者工具<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，但是考虑到后续可维护性，尽可能保持和源码结构、编译方式的一致性，这里还是按照官方的方式编译，后面确实有不方便的时候再考虑自定义编译流程。</p> <h3 id="安装-depot-tools-工具">安装 depot_tools 工具</h3> <p>下载 depot_tools 源码：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">git</span> clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
</code></pre></div><p>打开 ~/.bash_profile 文件，将 depot_tools 添加到 PATH 中 (/path/to/depot_tools 为你 depot_tools 本地的路径)：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span>:/path/to/depot_tools
</code></pre></div><p>执行环境变量立即生效命令：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">source</span> ~/.bash_profile
</code></pre></div><h3 id="基于-chrome-运行-devtools">基于 Chrome 运行 DevTools</h3> <p>Chrome DevTools Frontend 可以检出并独立于 Chromium 作为独立项目构建。 主要优点是不必检出并构建 Chromium，但是在此工作流程中也无法运行布局测试。</p> <h4 id="检出代码">检出代码</h4> <p>通过下面的命令可以只检出 DevTools frontend 的代码：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">mkdir</span> devtools
<span class="token builtin class-name">cd</span> devtools
fetch devtools-frontend
</code></pre></div><h4 id="构建">构建</h4> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> devtools-frontend
gn gen out/Default
autoninja <span class="token parameter variable">-C</span> out/Default
</code></pre></div><p>构建生成的文件在 out/Default/resources/inspector 中。</p> <h4 id="更新代码">更新代码</h4> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">git</span> fetch origin
<span class="token function">git</span> checkout origin/master
gclient <span class="token function">sync</span>
</code></pre></div><h4 id="运行">运行</h4> <p>可以启动 Chrome (M79 或更高版本) 并与自定义的 DevTools frontend 一起运行。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&lt;</span>path-to-chrome<span class="token operator">&gt;</span>/chrome --custom-devtools-frontend<span class="token operator">=</span>file://<span class="token variable"><span class="token variable">$(</span>realpath out/Default/resources/inspector<span class="token variable">)</span></span>
</code></pre></div><h3 id="基于-devserver-运行-devtools">基于 DevServer 运行 DevTools</h3> <p>可以使用 DevTools Frontend 项目中的 npm start 命令来启动 <a href="https://www.google.com/chrome/canary/" target="_blank" rel="noopener noreferrer">Chrome canary<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 版本并启动 DevTools DevServer。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> devtools/devtools-frontend
<span class="token function">npm</span> start
</code></pre></div><p>npm start 相当于同时执行了 npm run chrome 和 npm run server 命令。默认情况下，服务在端口 8090 上运行，远程调试端口为 9222，也可以在启动服务的时候设置一些参数修改。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 设置服务端口</span>
<span class="token assign-left variable">PORT</span><span class="token operator">=</span><span class="token number">3000</span> <span class="token function">npm</span> run server
<span class="token comment"># 设置远程调试端口</span>
<span class="token assign-left variable">REMOTE_DEBUGGING_PORT</span><span class="token operator">=</span><span class="token number">9333</span> <span class="token function">npm</span> run server
<span class="token comment"># 设置 Chromium Commit</span>
CHROMIUM_COMMIT <span class="token operator">=</span> 813208daf9e9821657e55ef7c40a14815efdcf49 <span class="token function">npm</span> run server
</code></pre></div><p>执行完 npm start 命令会自动打开 Chrome，并且打开 localhost:9222，选择您要调试的目标。</p> <p><img src="/assets/img/frontend-devserver-running.2b724800.png" alt></p> <p>再新建一个窗口，打开要远程调试的目标，这样就可以实现远程调试调试了，这里的 inspector.html 就是由我们自定义的 DevTools Frontend 提供。</p> <p><img src="/assets/img/frontend-devserver-remotedebug.b351400b.png" alt></p> <h2 id="源码整体分析">源码整体分析</h2> <h3 id="目录结构">目录结构</h3> <p>DevTools Frontend 源码的目录结构如下：</p> <div class="language- extra-class"><pre class="language-text"><code>├── build_overrides // Build 配置文件
├── build           // GN 模板和配置、Python 构建脚本(https://chromium.googlesource.com/chromium/src/build.git)
├── buildtools      // 构建工具 (https://chromium.googlesource.com/chromium/src/buildtools.git)
├── front_end       // devtools frontent 代码
|   ├── root        //
|   |   ├── Runtime.js  // 包含存储数据并可以检索的简单类，加载相应数据的帮助函数
|   ├── sdk
|   |   ├──
|   ├── ui
|   |   ├──
|   ├── devtools_compatibility.js
|   ├── externs.js
|   ├── root.js
|   ├── RuntimeInstantiator.js   // 解析配置加载 Modules，实例化 Runtime
|   ├── ...
|   ├── devtools_app.html // devtools_app 应用入口
|   ├── devtools_app.js
|   ├── devtools_app.json
|   ├── ...
|   ├── inspector.html    // inspector 应用入口
|   ├── inspector.js      // inspector 应用逻辑
|   ├── inspector.json    // inspector 描述文件
|   ├── ...
|   ├── node_app.html     // node_app 应用入口
|   ├── node_app.js
|   ├── node_app.json
|   ├── ...
├── scripts         // 编译、测试脚本
├── test
├── third_party
├── v8
├── .gn             // GN build 的 “源文件”，指定 Build 配置文件位置
├── BUILD.gn
├── DEPS            // Python 脚本，用来设定包含路径
└── WATCHLISTS
</code></pre></div><h3 id="application-modules-extensions">Application &amp; Modules &amp; Extensions</h3> <p>DevTools Frontend 项目核心逻辑在 front_end 中，front_end 是由 Application 和 Modules 组成。Application 是不同的调试器前端应用，类型分为：devtools_app、inspector、node_app、js_app、ndb_app、toolbox、worker_app 等，应用配置文件为 ${apppName}.json，modules 参数定义了依赖的模块，extends 定义继承配置的应用。应用的区别在于依赖的 Modules 不同，例如 inspector 比 devtools_app 仅仅多了一个 screencast 模块。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// inspector.json</span>
<span class="token punctuation">{</span>
  <span class="token comment">// 依赖的模块</span>
  <span class="token property">&quot;modules&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;screencast&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;autostart&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// 继承的应用</span>
  <span class="token property">&quot;extends&quot;</span><span class="token operator">:</span> <span class="token string">&quot;devtools_app&quot;</span><span class="token punctuation">,</span>
  <span class="token comment">// 是否有 html 页面</span>
  <span class="token property">&quot;has_html&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre></div><p>front_end 下的文件夹是具体的 module，module 通过文件夹下的 module.json 配置文件进行定义，配置文件有以下几个属性：</p> <ul><li>scripts：模块中包含的 JavaScript 文件数组，这里的路径名称是相对于 module.json 的位置；</li> <li>skip_compilation：类似于脚本，但是 Closure Compiler 不会对这些文件进行类型检查；</li> <li>resources：模块使用的非 JavaScript 文件数组；</li> <li>dependencies：模块使用的其他模块的数组；</li> <li>extensions：具有 type 属性的对象数组。 扩展可以通过运行时系统查询，并可以通过任何模块中的代码进行访问。类型包括 &quot;setting&quot;、&quot;view&quot;，&quot;context-menu-item&quot;。例如可以按如下方式注册出现在设置屏幕中的设置：</li></ul> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;extensions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;setting&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;settingName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;interdimensionalWarpEnabled&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;settingType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;boolean&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;defaultValue&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token property">&quot;storageType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;session&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Show web pages from other dimensions&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    ...
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>DevTools Frontend 通过 Module 和 Extension 机制为 Application 增加了“插件化”的能力，然后通过配置进行灵活的组装。Cordova 也是提供了类似的机制，看来整体思想上都是相通的。</p> <h2 id="inspector-启动流程">Inspector 启动流程</h2> <h3 id="npm-start-命令流程">npm start 命令流程</h3> <p>npm start 启动脚本是 scripts/hosted_mode/start_chrome_and_server.js，通过 childProcess.fork 启动 Chrome 和开发 Server。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> childProcess <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> chrome <span class="token operator">=</span> childProcess<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token string">'scripts/hosted_mode/launch_chrome.js'</span><span class="token punctuation">,</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> childProcess<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token string">'scripts/hosted_mode/server.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

chrome<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  server<span class="token punctuation">.</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>launch_chrome 中的主要逻辑如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">launchChrome</span><span class="token punctuation">(</span><span class="token parameter">filePath<span class="token punctuation">,</span> chromeArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Launching Chrome from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Chrome args:'</span><span class="token punctuation">,</span> chromeArgs<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> child<span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    child <span class="token operator">=</span> childProcess<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> chromeArgs<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">stdio</span><span class="token operator">:</span> <span class="token string">'inherit'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">onLaunchChromeError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  child<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> onLaunchChromeError<span class="token punctuation">)</span><span class="token punctuation">;</span>
  child<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span> onExit<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">onExit</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Exited Chrome with code'</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>查看 Chrome Canary 启动文件在电脑上的地址，设置启动参数，然后调用 childProcess.spawn 启动。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Windows:</span>
<span class="token keyword">const</span> suffix <span class="token operator">=</span> <span class="token string">'\\Google\\Chrome SxS\\Application\\chrome.exe'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> prefixes <span class="token operator">=</span> <span class="token punctuation">[</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">LOCALAPPDATA</span><span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PROGRAMFILES</span><span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">'PROGRAMFILES(X86)'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> prefixes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> prefix <span class="token operator">=</span> prefixes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    chromeCanaryPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>prefix<span class="token punctuation">,</span> suffix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fs<span class="token punctuation">.</span><span class="token function">accessSync</span><span class="token punctuation">(</span>chromeCanaryPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Mac OS：</span>
<span class="token keyword">const</span> lsregister <span class="token operator">=</span> <span class="token string">'/System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/LaunchServices.framework/Versions/A/Support/lsregister'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> chromeCanaryPath <span class="token operator">=</span> <span class="token function">shellOutput</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lsregister<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> -dump | grep -i 'applications/google chrome canary.app$' | awk '{$1=&quot;&quot;; print $0}' | head -n 1</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
chromeExecPath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chromeCanaryPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/Contents/MacOS/Google Chrome Canary</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
</code></pre></div><p>启动参数获取如下，主要是配置远程调试端口(--remote-debugging-port)、自定义 DevTools Frontend(--custom-devtools-frontend)及重定向 user-data 目录(--user-data-dir)。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">REMOTE_DEBUGGING_PORT</span> <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REMOTE_DEBUGGING_PORT</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">9222</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">SERVER_PORT</span> <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">8090</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> chromeArgs <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">--remote-debugging-port=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">REMOTE_DEBUGGING_PORT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">--custom-devtools-frontend=http://localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">SERVER_PORT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/front_end/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">'--no-first-run'</span><span class="token punctuation">,</span>
  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">REMOTE_DEBUGGING_PORT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">#custom=true</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">'https://devtools.chrome.com'</span><span class="token punctuation">,</span>
  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">--user-data-dir=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">CHROME_PROFILE_PATH</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>开发 Server 就是定义了一个 Node.js 的 Http 服务器，可以通过 Http 服务的方式访问 frontend_end 代码。我们知道 DevTools Frontend 就是一个前端项目，可以通过 <a href="http://localhost:8090/front_end/inspector.html" target="_blank" rel="noopener noreferrer">http://localhost:8090/front_end/inspector.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>  访问。</p> <h3 id="startapplication-启动流程">startApplication 启动流程</h3> <p>调试器前端入口是 inspector.html 文件，我们可以看到引用了 root.js 和 inspector.js。项目中有多个调试器前端应用，根据不同的功能我们选择不同的调试器，这里我们选择最场景的 inspector.hrml 进行分析。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">doctype</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>utf-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Content-Security-Policy<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>object-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https://chrome-devtools-frontend.appspot.com<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>referrer<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>no-referrer<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>root.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>inspector.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>undocked<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>-blink-dev-tools<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>root.js 中主要是引入一堆 JS 模块。inspector.js 中通过 startApplication 启动应用。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token string">'./devtools_app.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>startApplication<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./RuntimeInstantiator.js'</span><span class="token punctuation">;</span>

<span class="token function">startApplication</span><span class="token punctuation">(</span><span class="token string">'inspector'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>从 <a href="https://github.com/ChromeDevTools/devtools-frontend/commit/6d51bf00ea3cdb7ef4d935bb52c15e25708f21fb" target="_blank" rel="noopener noreferrer">Factor out Runtime to root/Runtime.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 可以知道 RuntimeInstantiator.js 是程序入口。 startApplication 定义在 RuntimeInstantiator.js 中。
RuntimeInstantiator.js  中定义了 Root 对象，Root 对象下挂载了 Runtime 、allDescriptors、applicationDescriptor 三个对象。
allDescriptors 对象是所有的描述符(Descriptor)的集合，通过解析每个模块的 module.json 获取。</p> <p><img src="/assets/img/all-descriptors.c861ca48.png" alt></p> <p>applicationDescriptor 是当前应用的描述对象。</p> <p><img src="/assets/img/application-descriptor.6bb8518a.png" alt></p> <p>startApplication 的具体实现为：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * @param {string} appName
 * @return {!Promise.&lt;void&gt;}
 */</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">startApplication</span><span class="token punctuation">(</span><span class="token parameter">appName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">timeStamp</span><span class="token punctuation">(</span><span class="token string">'Root.Runtime.startApplication'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 步骤1:优先遍历 Root.allDescriptors 生成 Object&lt;string, RootModule.Runtime.ModuleDescriptor&gt;} 类型的对象</span>
  <span class="token keyword">const</span> allDescriptorsByName <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> Root<span class="token punctuation">.</span>allDescriptors<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> d <span class="token operator">=</span> Root<span class="token punctuation">.</span>allDescriptors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    allDescriptorsByName<span class="token punctuation">[</span>d<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> d<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Root<span class="token punctuation">.</span>applicationDescriptor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 步骤2:如果当前应用的描述对象(Root.applicationDescriptor)不存在，通过 XMLHttpRequest 的方式加载 `${appName}.json` 文件</span>
    <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">await</span> RootModule<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span><span class="token function">loadResourcePromise</span><span class="token punctuation">(</span>appName <span class="token operator">+</span> <span class="token string">'.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Root<span class="token punctuation">.</span>applicationDescriptor <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> descriptor <span class="token operator">=</span> Root<span class="token punctuation">.</span>applicationDescriptor<span class="token punctuation">;</span>
    <span class="token comment">// 步骤3:递归加载依赖的 Modules 合并到 Root.applicationDescriptor 的 modules 对象(Array&lt;{ name: string, tyle: 'autostart' | 'remote' } 类型).</span>
    <span class="token comment">// 应用的描述对象(applicationDescriptor) 中的 extends 字段指的是继承关系(inspector =&gt; devtools_app =&gt; shell)</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span>extends<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      data <span class="token operator">=</span> <span class="token keyword">await</span> RootModule<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span><span class="token function">loadResourcePromise</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span>extends <span class="token operator">+</span> <span class="token string">'.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      descriptor <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      Root<span class="token punctuation">.</span>applicationDescriptor<span class="token punctuation">.</span>modules <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>modules<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>Root<span class="token punctuation">.</span>applicationDescriptor<span class="token punctuation">.</span>modules<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
	
  <span class="token comment">// 步骤4:遍历 Root.applicationDescriptor.modules，生成 moduleJSONPromises，coreModuleNames 对象</span>
  <span class="token keyword">const</span> configuration <span class="token operator">=</span> Root<span class="token punctuation">.</span>applicationDescriptor<span class="token punctuation">.</span>modules<span class="token punctuation">;</span>
  <span class="token keyword">const</span> moduleJSONPromises <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> coreModuleNames <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> configuration<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> descriptor <span class="token operator">=</span> configuration<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> name <span class="token operator">=</span> descriptor<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> moduleJSON <span class="token operator">=</span> allDescriptorsByName<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>moduleJSON<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      moduleJSONPromises<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>moduleJSON<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 加载模块下的 module.json 文件</span>
      moduleJSONPromises<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
          RootModule<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span><span class="token function">loadResourcePromise</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">'/module.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 模块有 autostart | remote 两种类型，将 autostart 类型的模块加入到核心模块</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>descriptor<span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'autostart'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      coreModuleNames<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
	
  <span class="token comment">// 步骤5:所有的 module.json 读取完成，生成 moduleDescriptors 对象(Array&lt;RootModule.Runtime.ModuleDescriptor&gt; 类型),</span>
  <span class="token comment">// 并将 moduleDescriptors 传入 Runtime 实例化函数，生成 Runtime 对象实例化对象 runtime 挂载在全局对象上</span>
  <span class="token keyword">const</span> moduleDescriptors <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>moduleJSONPromises<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> moduleDescriptors<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    moduleDescriptors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name <span class="token operator">=</span> configuration<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    moduleDescriptors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>condition <span class="token operator">=</span> configuration<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'condition'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    moduleDescriptors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>remote <span class="token operator">=</span> configuration<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'remote'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  self<span class="token punctuation">.</span>runtime <span class="token operator">=</span> RootModule<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">forceNew</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> moduleDescriptors<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 步骤6:加载并自启动核心模块</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>coreModuleNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> self<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">loadAutoStartModules</span><span class="token punctuation">(</span>coreModuleNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">appStartedPromiseCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>实例化 Runtime 对象流程：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Runtime</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * @private
   * @param {!Array.&lt;!ModuleDescriptor&gt;} descriptors
   */</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">descriptors</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/** @type {!Array&lt;!Module&gt;} */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_modules <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">/** @type {!Object&lt;string, !Module&gt;} */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_modulesMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">/** @type {!Array&lt;!Extension&gt;} */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_extensions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">/** @type {!Object&lt;string, function(new:Object):void&gt;} */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_cachedTypeClasses <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">/** @type {!Object&lt;string, !ModuleDescriptor&gt;} */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_descriptorsMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token comment">// 注册模块</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> descriptors<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_registerModule</span><span class="token punctuation">(</span>descriptors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">/**
   * @param {!ModuleDescriptor} descriptor
   */</span>
  <span class="token function">_registerModule</span><span class="token punctuation">(</span><span class="token parameter">descriptor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 根据描述符(Descriptor)对象实例化模块</span>
    <span class="token keyword">const</span> module <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_modules<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_modulesMap<span class="token punctuation">[</span>descriptor<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> module<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Module</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * @param {!Runtime} manager
   * @param {!ModuleDescriptor} descriptor
   */</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">manager<span class="token punctuation">,</span> descriptor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 持有 Runtime 实例对象 runtime</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_manager <span class="token operator">=</span> manager<span class="token punctuation">;</span>
    <span class="token comment">// 持有描述符对象 descriptor(RootModule.Runtime.ModuleDescriptor类型)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_descriptor <span class="token operator">=</span> descriptor<span class="token punctuation">;</span>
    <span class="token comment">// 模块名称</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_name <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
    <span class="token comment">// 依赖的拓展列表(Array&lt;!Extension&gt; 类型)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_extensions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token comment">// {!Map&lt;string, !Array&lt;!Extension&gt;&gt;}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_extensionsByClassName <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> extensions <span class="token operator">=</span> <span class="token comment">/** @type {?Array.&lt;!RuntimeExtensionDescriptor&gt;} */</span> <span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span>extensions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 遍历 descriptor 对象下的 extensions</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> extensions <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> extensions<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 实例化模块下的扩展</span>
      <span class="token keyword">const</span> extension <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Extension</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> extensions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_manager<span class="token punctuation">.</span>_extensions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>extension<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_extensions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>extension<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_loadedForTest <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Extension</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
  * @param {!Module} moduleParam
  * @param {!RuntimeExtensionDescriptor} descriptor
  */</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">moduleParam<span class="token punctuation">,</span> descriptor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_module <span class="token operator">=</span> moduleParam<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_descriptor <span class="token operator">=</span> descriptor<span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>_type <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_hasTypeClass <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_type<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'@'</span><span class="token punctuation">;</span>

    <span class="token comment">/**
    * @type {?string}
    */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_className <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>className <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_factoryName <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>factoryName <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Runtime 初始化完成后，意味着 Runtime 对象与 Module 对象、Module 对象与模块下的 Extension 对象建立了联系，但是没有完成任何代码的加载。</p> <p>步骤 6 主要是加载并启动核心模块，核心模块是在步骤 4 中根据 type 字段标记的，核心模块如下：</p> <p><code>bindings</code>、<code>common</code>、<code>components</code>、<code>console_counters</code>、<code>dom_extension</code>、<code>extensions</code>、<code>host</code>、<code>main</code>、<code>persistence</code>、<code>platform</code>、<code>protocol_client</code>、<code>sdk</code>、<code>browser_sdk</code>、<code>root</code>、<code>services</code>、<code>text_utils</code>、<code>ui</code>、<code>workspace</code>、<code>screencast</code>。</p> <p>Module 类的 _loadPromise 方法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">_loadPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">enabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Module '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_name <span class="token operator">+</span> <span class="token string">' is not enabled'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_pendingLoadPromise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_pendingLoadPromise<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> dependencies <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_descriptor<span class="token punctuation">.</span>dependencies<span class="token punctuation">;</span>
  <span class="token keyword">const</span> dependencyPromises <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// module.json 中 dependencies 配置制定了 Module 的依赖，先保证依赖 Module 加载</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> dependencies <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> dependencies<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dependencyPromises<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_manager<span class="token punctuation">.</span>_modulesMap<span class="token punctuation">[</span>dependencies<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">_loadPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>_pendingLoadPromise <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>dependencyPromises<span class="token punctuation">)</span>
  	<span class="token comment">// 加载 resources</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_loadResources</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  	<span class="token comment">// 加载 Module JS</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_loadModules</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  	<span class="token comment">// 加载 Scripts</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_loadScripts</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  	<span class="token comment">// Module 加载完成标识，构造函数中初始化为 false</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_loadedForTest <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_pendingLoadPromise<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>_loadPromise 的核心逻辑就是处理模块间的依赖关系及模块内的资源引用。module.json 中 dependencies 字段配置了 Module 的依赖 Module，先保证依赖 Module 完成加载，依赖 Module 加载完成后再加载 Module 自身的资源 (resources、modules、scripts)。这里需要注意一个容易混淆的概念，Module 是指 front_end 文件夹下定义的模块，modules 是指 ES Module 规范的 JS 代码。</p> <p>_loadModules 加载的实际就是 JS 代码，加载逻辑如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">_loadModules</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_descriptor<span class="token punctuation">.</span>modules <span class="token operator">||</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_descriptor<span class="token punctuation">.</span>modules<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> namespace <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_computeNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// @ts-ignore Legacy global namespace instantation</span>
  self<span class="token punctuation">[</span>namespace<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">[</span>namespace<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> legacyFileName <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-legacy.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> fileName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_descriptor<span class="token punctuation">.</span>modules<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>legacyFileName<span class="token punctuation">)</span> <span class="token operator">?</span> legacyFileName <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

  <span class="token comment">// TODO(crbug.com/1011811): Remove eval when we use TypeScript which does support dynamic imports</span>
  <span class="token keyword">return</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">import('../</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">')</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>核心模块加载完了，Inspector 应用就启动起来了，但是至此我们还是没有搞清楚程序是怎么完成页面渲染初始化的呢？像多数应用一样，Inspector 也是通过 “main” 函数启动的。</p> <p>上面说的核心模块中有一个 main 模块，module.json 如下：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;extensions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@Common.AppProvider&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;className&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Main.SimpleAppProvider&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;order&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      	...
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;extensions&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;host&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;platform&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;sdk&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;persistence&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;modules&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;main.js&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;main-legacy.js&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;SimpleApp.js&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;ExecutionContextSelector.js&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;MainImpl.js&quot;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>modules 最后一个文件是 MainImpl.js，里面定义了 MainImpl 类：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">MainImpl</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    MainImpl<span class="token punctuation">.</span>_instanceForTest <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token function">runOnWindowLoad</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_loaded</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">_loaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">timeStamp</span><span class="token punctuation">(</span><span class="token string">'Main._loaded'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> Runtime<span class="token punctuation">.</span>appStarted<span class="token punctuation">;</span>
    Root<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span><span class="token function">setPlatform</span><span class="token punctuation">(</span>Host<span class="token punctuation">.</span>Platform<span class="token punctuation">.</span><span class="token function">platform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Root<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span><span class="token function">setL10nCallback</span><span class="token punctuation">(</span>ls<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Host<span class="token punctuation">.</span>InspectorFrontendHost<span class="token punctuation">.</span>InspectorFrontendHostInstance<span class="token punctuation">.</span><span class="token function">getPreferences</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_gotPreferences</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token keyword">new</span> <span class="token class-name">MainImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>MainImpl 构造函数中的 runOnWindowLoad 方法定义在 Platform 模块。Platform 模块包含一堆全局的公用方法(例如 runOnWindowLoad、unescapeCssString、base64ToSize)和 JS API 的扩展(例如 string-utilities、number-utilities、array-utilities)，无其他的外部依赖，按理来说他应该叫 utils。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// platform/utilities.js</span>
self<span class="token punctuation">.</span><span class="token function-variable function">runOnWindowLoad</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">windowLoaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    self<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span> windowLoaded<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token string">'complete'</span> <span class="token operator">||</span> document<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token string">'interactive'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span> windowLoaded<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>当页面加载完成，然后执行 _loaded 方法。_loaded 方法中有一个关于 Promise 非常有意思的写法。在 RuntimeInstantiator.js 中定义了 Runtime.appStarted：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> appStartedPromiseCallback<span class="token punctuation">;</span>
Runtime<span class="token punctuation">.</span>appStarted <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">fulfil</span> <span class="token operator">=&gt;</span> appStartedPromiseCallback <span class="token operator">=</span> fulfil<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这里的 await Runtime.appStarted 什么都没有返回，乍一看好像这里没有什么用啊？那么你屏蔽 startApplication 方法中的 appStartedPromiseCallback 试试，就会发现页面不渲染。</p> <p>这里也是防止 _load 方法触发的时候其他 Module 还没有加载完，等所有的模块加载完了再调用 appStartedPromiseCallback() 让 await Runtime.appStarted 结束，从而继续执行下面的代码。 appStartedPromiseCallback()  执行完，意味着 startApplication 方法真正执行完成。</p> <h3 id="js-与-embedder-通信机制">JS 与 Embedder 通信机制</h3> <p>MainImpl _load 方法调用了一个 <code>Host.InspectorFrontendHost.InspectorFrontendHostInstance</code> 对象下的 <code>getPreferences</code> 方法。</p> <div class="language-js extra-class"><pre class="language-js"><code>Host<span class="token punctuation">.</span>InspectorFrontendHost<span class="token punctuation">.</span>InspectorFrontendHostInstance<span class="token punctuation">.</span><span class="token function">getPreferences</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_gotPreferences</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这里的 <code>Host.InspectorFrontendHost.InspectorFrontendHostInstance</code> 对象是在 <code>host/InspectorFrontendHost.js</code> 中定义的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// @ts-ignore Global injected by devtools-compatibility.js</span>
<span class="token keyword">export</span> <span class="token keyword">let</span> InspectorFrontendHostInstance <span class="token operator">=</span> window<span class="token punctuation">.</span>InspectorFrontendHost<span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">initializeInspectorFrontendHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> proto<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>InspectorFrontendHostInstance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Instantiate stub for web-hosted mode if necessary.</span>
      <span class="token comment">// @ts-ignore Global injected by devtools-compatibility.js</span>
      window<span class="token punctuation">.</span>InspectorFrontendHost <span class="token operator">=</span> InspectorFrontendHostInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InspectorFrontendHostStub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Otherwise add stubs for missing methods that are declared in the interface.</span>
      proto <span class="token operator">=</span> <span class="token class-name">InspectorFrontendHostStub</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> name <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>proto<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> stub <span class="token operator">=</span> proto<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// @ts-ignore Global injected by devtools-compatibility.js</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> stub <span class="token operator">!==</span> <span class="token string">'function'</span> <span class="token operator">||</span> InspectorFrontendHostInstance<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>
            <span class="token string">'Incompatible embedder: method Host.InspectorFrontendHost.'</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">' is missing. Using stub instead.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// @ts-ignore Global injected by devtools-compatibility.js</span>
        InspectorFrontendHostInstance<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> stub<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Attach the events object.</span>
    InspectorFrontendHostInstance<span class="token punctuation">.</span>events <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Common<span class="token punctuation">.</span>ObjectWrapper<span class="token punctuation">.</span>ObjectWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// FIXME: This file is included into both apps, since the devtools_app needs the InspectorFrontendHostAPI only,</span>
  <span class="token comment">// so the host instance should not initialized there.</span>
  <span class="token function">initializeInspectorFrontendHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// @ts-ignore Global injected by devtools-compatibility.js</span>
  window<span class="token punctuation">.</span>InspectorFrontendAPI <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InspectorFrontendAPIImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>InspectorFrontendHostInstanc</code>e 初始化值是 <code>window.InspectorFrontendHost</code> (在 devtools-compatibility.js 中定义)。 调用 <code>initializeInspectorFrontendHost()</code> 时，会给 <code>InspectorFrontendHostInstance</code> 重新赋值。如果 <code>window.InspectorFrontendHost</code> 不存在，就实例化 <code>InspectorFrontendHostStub</code> 对象，将实例赋值给 <code>window.InspectorFrontendHost</code> 和 <code>InspectorFrontendHostInstance</code>；否则将 <code>InspectorFrontendHostStub</code> 原型链上的方法合并到 <code>InspectorFrontendHostInstance</code> 上。</p> <p><img src="/assets/img/host-module.a6e5f1c7.png" alt></p> <p>我们在分析 startApplication 过程中没有地方加载 devtools-compatibility.js，全局搜索会发现 BUILD.gn 中定义了：</p> <div class="language-js extra-class"><pre class="language-js"><code>devtools_embedder_scripts <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">&quot;front_end/devtools_compatibility.js&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;front_end/Tests.js&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre></div><p>调试过程中加载的是浏览器默认的文件：devtools://devtools/bundled/devtools_compatibility.js。devtools_compatibility.js 实际上是由 Embedder 自动注入到前端，具体实现可以看 <a href="https://cs.chromium.org/chromium/src/content/browser/devtools/devtools_frontend_host_impl.cc" target="_blank" rel="noopener noreferrer">devtools_frontend_host_impl.cc<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。我们知道 InspectorFrontendHostInstance 的方法通过 devtools_compatibility.js 定义，比如上面的 getPreferences 方法定位为：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> InspectorFrontendHostImpl <span class="token operator">=</span> <span class="token keyword">class</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token comment">/**
   * @override
   * @param {function(!Object&lt;string, string&gt;)} callback
   */</span>
  <span class="token function">getPreferences</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    DevToolsAPI<span class="token punctuation">.</span><span class="token function">sendMessageToEmbedder</span><span class="token punctuation">(</span><span class="token string">'getPreferences'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">/** @type {function(?Object)} */</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>

window<span class="token punctuation">.</span>InspectorFrontendHost <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InspectorFrontendHostImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这里调用的 DevToolsAPI 对象定义在 devtools_compatibility.js 中，整体调用流程为：</p> <p><img src="/assets/img/DevToolsAPI.a009fd04.png" alt></p> <p>DevToolsAPI 是挂载全局的对象，调用 DevToolsAPI.sendMessageToEmbedder(method, args, callback) 方法时，生成  callId，将 callId、callback 以 Key-Value 的方式保存在 _callbacks 对象中，最后调用DevToolsHost.sendMessageToEmbedder 方法实现 JS 层调用 Native 层。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * @param {string} method
 * @param {!Array.&lt;*&gt;} args
 * @param {?function(?Object)} callback
 */</span>
<span class="token function">sendMessageToEmbedder</span><span class="token punctuation">(</span><span class="token parameter">method<span class="token punctuation">,</span> args<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> callId <span class="token operator">=</span> <span class="token operator">++</span><span class="token keyword">this</span><span class="token punctuation">.</span>_lastCallId<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_callbacks<span class="token punctuation">[</span>callId<span class="token punctuation">]</span> <span class="token operator">=</span> callback<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string-property property">'id'</span><span class="token operator">:</span> callId<span class="token punctuation">,</span> <span class="token string-property property">'method'</span><span class="token operator">:</span> method<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    message<span class="token punctuation">.</span>params <span class="token operator">=</span> args<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  DevToolsHost<span class="token punctuation">.</span><span class="token function">sendMessageToEmbedder</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>DevToolsHost.sendMessageToEmbedder 是原生方法，在原生层定义，将我们调用的方法名和参数进行序列化发到原生层。Native 层调用 DevToolsAPI.embedderMessageAck 方法将回调结果返回，具体实现参考：<a href="https://cs.chromium.org/chromium/src/content/shell/browser/shell_devtools_bindings.cc?type=cs&q=DevToolsAPI.embedderMessageAck&sq=package:chromium&g=0&l=434" target="_blank" rel="noopener noreferrer">ShellDevToolsBindings::SendMessageAck<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <div class="language-cplus extra-class"><pre class="language-text"><code>void ShellDevToolsBindings::SendMessageAck(int request_id,
                                           const base::Value* arg) {
  base::Value id_value(request_id);
  CallClientFunction(&quot;DevToolsAPI.embedderMessageAck&quot;, &amp;id_value, arg, nullptr);
}
</code></pre></div><p>JS 层 DevToolsAPI.embedderMessageAck 执行时根据 id(调用时的 callId) 获取回调函数然后执行，执行示意图如下：</p> <p><img src="/assets/img/embedderMessageAck.abaf9670.png" alt></p> <h2 id="devtools-frontend-ui-组件机制">DevTools Frontend UI 组件机制</h2> <h3 id="widget">Widget</h3> <p>DevTools Frontend 没有采用&quot;关注点分离&quot;(采用 HTML、CSS、JS 三种技术分离)的方式构建 UI，而是采用组件化方式，ui 模块中定义了 Widget。Widget 其实和前端 Web Component 组件概念类似，包含完整的生命周期管理，提供方法和事件更新组件状态，通过 JS 的方式构建 UI。Widget 包含 element 属性，还可以包含 ShadowRoot 和 CSS。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Widget</span> <span class="token keyword">extends</span> <span class="token class-name">Common<span class="token punctuation">.</span>ObjectWrapper<span class="token punctuation">.</span>ObjectWrapper</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">isWebComponent<span class="token punctuation">,</span> delegatesFocus</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">parentWidget</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">isShowing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">wasShown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">willHide</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">onResize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">onLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token function">ownerViewDisposed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token function">show</span><span class="token punctuation">(</span><span class="token parameter">parentElement<span class="token punctuation">,</span> insertBefore</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token function">showWidget</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token function">hideWidget</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token function">detach</span><span class="token punctuation">(</span><span class="token parameter">overrideHideOnDetach</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token function">doResize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token function">doLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token function">registerRequiredCSS</span><span class="token punctuation">(</span><span class="token parameter">cssFile</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token function">calculateConstraints</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过 Widget 相关的 API 创建布局：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> parentWidget <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UI<span class="token punctuation">.</span>Widget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> childWidget <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UI<span class="token punctuation">.</span>Widget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
childWidget<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span>parentWidget<span class="token punctuation">.</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Widget 可以显示在任何其他 Widget 元素上，也可以显示在 Widget 元素的任何后代上。</p> <p>Widgets 类型的组件：</p> <ul><li>SplitWidget：SplitWidget 有两个子 Widget，并且它们之间有一个边框，边框可以由用户调整大小；</li> <li>VBox：Flex 垂直布局容器，CSS 值为 flex-direction: column；子类包括：RootView、InspectorView、Panel、TabbedPane、ContainerWidget、ListWidget 等；</li> <li>HBox：Flex 水平布局容器，CSS 值为 flex-direction: row，子类包括：FilterBar、SegmentedButton 等</li></ul> <h3 id="createappui">createAppUI</h3> <p>前面的启动流程中我分析了Root 模块中 startApplication 的启动流程及 Host 模块中 JS 与 Embedder 的通信机制，但是对于 UI 元素是如何展示在页面的没有分析，我们接着 main 模块 MainImpl.js 中的流程进行</p> <p>分析。MainImpl.js 中通过 InspectorFrontendHostInstance.getPreferences 获取到了首选项 (Preferences) 相关参数，然后调用 _createSettings 方法配置 Experiments、Settings 相关对象的初始化。设置初始化完成后，调用 _createAppUI 方法，开始创建应用视图。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// main/MainImpl.js</span>
<span class="token keyword">async</span> <span class="token function">_createAppUI</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  MainImpl<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'Main._createAppUI'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 初始化 ViewManager(视图管理器)，UI.viewManager._views (Map&lt;string, ProvidedView&gt; 类型）</span>
  self<span class="token punctuation">.</span><span class="token constant">UI</span><span class="token punctuation">.</span>viewManager <span class="token operator">=</span> <span class="token constant">UI</span><span class="token punctuation">.</span>ViewManager<span class="token punctuation">.</span>ViewManager<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Request filesystems early, we won't create connections until callback is fired. Things will happen in parallel.</span>
  self<span class="token punctuation">.</span>Persistence<span class="token punctuation">.</span>isolatedFileSystemManager <span class="token operator">=</span>
    Persistence<span class="token punctuation">.</span>IsolatedFileSystemManager<span class="token punctuation">.</span>IsolatedFileSystemManager<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> themeSetting <span class="token operator">=</span> Common<span class="token punctuation">.</span>Settings<span class="token punctuation">.</span>Settings<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createSetting</span><span class="token punctuation">(</span><span class="token string">'uiTheme'</span><span class="token punctuation">,</span> <span class="token string">'systemPreferred'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token constant">UI</span><span class="token punctuation">.</span>UIUtils<span class="token punctuation">.</span><span class="token function">initializeUIUtils</span><span class="token punctuation">(</span>document<span class="token punctuation">,</span> themeSetting<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// document 节点注入 className，注入全局 CSS 样式</span>
  <span class="token constant">UI</span><span class="token punctuation">.</span>UIUtils<span class="token punctuation">.</span><span class="token function">installComponentRootStyles</span><span class="token punctuation">(</span><span class="token comment">/** @type {!Element} */</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// keydown、beforecopy、copy、cut、paste、contextmenu 事件处理</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_addMainEventListeners</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> canDock <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>Root<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span><span class="token function">queryParam</span><span class="token punctuation">(</span><span class="token string">'can_dock'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span><span class="token constant">UI</span><span class="token punctuation">.</span>zoomManager <span class="token operator">=</span> <span class="token constant">UI</span><span class="token punctuation">.</span>ZoomManager<span class="token punctuation">.</span>ZoomManager<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span><span class="token literal-property property">forceNew</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">win</span><span class="token operator">:</span> window<span class="token punctuation">,</span> <span class="token literal-property property">frontendHost</span><span class="token operator">:</span> Host<span class="token punctuation">.</span>InspectorFrontendHost<span class="token punctuation">.</span>InspectorFrontendHostInstance<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 初始化 InspectorView</span>
  self<span class="token punctuation">.</span><span class="token constant">UI</span><span class="token punctuation">.</span>inspectorView <span class="token operator">=</span> <span class="token constant">UI</span><span class="token punctuation">.</span>InspectorView<span class="token punctuation">.</span>InspectorView<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 上下文菜单初始化(鼠标点击右键或者按下键盘上的菜单键时被触发)</span>
  <span class="token constant">UI</span><span class="token punctuation">.</span>ContextMenu<span class="token punctuation">.</span>ContextMenu<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 初始化 ContextMenu 监听事件</span>
  <span class="token constant">UI</span><span class="token punctuation">.</span>ContextMenu<span class="token punctuation">.</span>ContextMenu<span class="token punctuation">.</span><span class="token function">installHandler</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 初始化 Tooltip 监听事件</span>
  <span class="token constant">UI</span><span class="token punctuation">.</span>Tooltip<span class="token punctuation">.</span>Tooltip<span class="token punctuation">.</span><span class="token function">installHandler</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 初始化 SDK.ConsoleModel</span>
  self<span class="token punctuation">.</span><span class="token constant">SDK</span><span class="token punctuation">.</span>consoleModel <span class="token operator">=</span> <span class="token constant">SDK</span><span class="token punctuation">.</span>ConsoleModel<span class="token punctuation">.</span>ConsoleModel<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 初始化 devtools dock 控制器</span>
  self<span class="token punctuation">.</span>Components<span class="token punctuation">.</span>dockController <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Components<span class="token punctuation">.</span>DockController<span class="token punctuation">.</span>DockController</span><span class="token punctuation">(</span>canDock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 初始化 SDK.NetworkManager</span>
  self<span class="token punctuation">.</span><span class="token constant">SDK</span><span class="token punctuation">.</span>multitargetNetworkManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SDK<span class="token punctuation">.</span>NetworkManager<span class="token punctuation">.</span>MultitargetNetworkManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 初始化 SDK.DOMDebuggerModel(管理 DOM 断点、DOM 事件断点等)</span>
  self<span class="token punctuation">.</span><span class="token constant">SDK</span><span class="token punctuation">.</span>domDebuggerManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SDK<span class="token punctuation">.</span>DOMDebuggerModel<span class="token punctuation">.</span>DOMDebuggerManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 初始化 SDK.TargetManager</span>
  <span class="token constant">SDK</span><span class="token punctuation">.</span>SDKModel<span class="token punctuation">.</span>TargetManager<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
    <span class="token constant">SDK</span><span class="token punctuation">.</span>SDKModel<span class="token punctuation">.</span>Events<span class="token punctuation">.</span>SuspendStateChanged<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_onSuspendStateChanged</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  self<span class="token punctuation">.</span><span class="token constant">UI</span><span class="token punctuation">.</span>shortcutsScreen <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UI<span class="token punctuation">.</span>ShortcutsScreen<span class="token punctuation">.</span>ShortcutsScreen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// set order of some sections explicitly</span>
  self<span class="token punctuation">.</span><span class="token constant">UI</span><span class="token punctuation">.</span>shortcutsScreen<span class="token punctuation">.</span><span class="token function">section</span><span class="token punctuation">(</span>Common<span class="token punctuation">.</span>UIString<span class="token punctuation">.</span><span class="token function">UIString</span><span class="token punctuation">(</span><span class="token string">'Elements Panel'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span><span class="token constant">UI</span><span class="token punctuation">.</span>shortcutsScreen<span class="token punctuation">.</span><span class="token function">section</span><span class="token punctuation">(</span>Common<span class="token punctuation">.</span>UIString<span class="token punctuation">.</span><span class="token function">UIString</span><span class="token punctuation">(</span><span class="token string">'Styles Pane'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span><span class="token constant">UI</span><span class="token punctuation">.</span>shortcutsScreen<span class="token punctuation">.</span><span class="token function">section</span><span class="token punctuation">(</span>Common<span class="token punctuation">.</span>UIString<span class="token punctuation">.</span><span class="token function">UIString</span><span class="token punctuation">(</span><span class="token string">'Debugger'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span><span class="token constant">UI</span><span class="token punctuation">.</span>shortcutsScreen<span class="token punctuation">.</span><span class="token function">section</span><span class="token punctuation">(</span>Common<span class="token punctuation">.</span>UIString<span class="token punctuation">.</span><span class="token function">UIString</span><span class="token punctuation">(</span><span class="token string">'Console'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 初始化 WorkSpace (位于 Resource 面板内)</span>
  self<span class="token punctuation">.</span>Workspace<span class="token punctuation">.</span>fileManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Workspace<span class="token punctuation">.</span>FileManager<span class="token punctuation">.</span>FileManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span>Workspace<span class="token punctuation">.</span>workspace <span class="token operator">=</span> Workspace<span class="token punctuation">.</span>Workspace<span class="token punctuation">.</span>WorkspaceImpl<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 初始化 Bindings</span>
  self<span class="token punctuation">.</span>Bindings<span class="token punctuation">.</span>networkProjectManager <span class="token operator">=</span> Bindings<span class="token punctuation">.</span>NetworkProject<span class="token punctuation">.</span>NetworkProjectManager<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span>Bindings<span class="token punctuation">.</span>resourceMapping <span class="token operator">=</span> Bindings<span class="token punctuation">.</span>ResourceMapping<span class="token punctuation">.</span>ResourceMapping<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">forceNew</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">targetManager</span><span class="token operator">:</span> <span class="token constant">SDK</span><span class="token punctuation">.</span>SDKModel<span class="token punctuation">.</span>TargetManager<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">workspace</span><span class="token operator">:</span> Workspace<span class="token punctuation">.</span>Workspace<span class="token punctuation">.</span>WorkspaceImpl<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">new</span> <span class="token class-name">Bindings<span class="token punctuation">.</span>PresentationConsoleMessageHelper<span class="token punctuation">.</span>PresentationConsoleMessageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span>Bindings<span class="token punctuation">.</span>cssWorkspaceBinding <span class="token operator">=</span> Bindings<span class="token punctuation">.</span>CSSWorkspaceBinding<span class="token punctuation">.</span>CSSWorkspaceBinding<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">forceNew</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">targetManager</span><span class="token operator">:</span> <span class="token constant">SDK</span><span class="token punctuation">.</span>SDKModel<span class="token punctuation">.</span>TargetManager<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">workspace</span><span class="token operator">:</span> Workspace<span class="token punctuation">.</span>Workspace<span class="token punctuation">.</span>WorkspaceImpl<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span>Bindings<span class="token punctuation">.</span>debuggerWorkspaceBinding <span class="token operator">=</span> Bindings<span class="token punctuation">.</span>DebuggerWorkspaceBinding<span class="token punctuation">.</span>DebuggerWorkspaceBinding<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">forceNew</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">targetManager</span><span class="token operator">:</span> <span class="token constant">SDK</span><span class="token punctuation">.</span>SDKModel<span class="token punctuation">.</span>TargetManager<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">workspace</span><span class="token operator">:</span> Workspace<span class="token punctuation">.</span>Workspace<span class="token punctuation">.</span>WorkspaceImpl<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span>Bindings<span class="token punctuation">.</span>breakpointManager <span class="token operator">=</span> Bindings<span class="token punctuation">.</span>BreakpointManager<span class="token punctuation">.</span>BreakpointManager<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">forceNew</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">workspace</span><span class="token operator">:</span> Workspace<span class="token punctuation">.</span>Workspace<span class="token punctuation">.</span>WorkspaceImpl<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">targetManager</span><span class="token operator">:</span> <span class="token constant">SDK</span><span class="token punctuation">.</span>SDKModel<span class="token punctuation">.</span>TargetManager<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">debuggerWorkspaceBinding</span><span class="token operator">:</span> Bindings<span class="token punctuation">.</span>DebuggerWorkspaceBinding<span class="token punctuation">.</span>DebuggerWorkspaceBinding<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 初始化 ExtensionServer</span>
  self<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>extensionServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Extensions<span class="token punctuation">.</span>ExtensionServer<span class="token punctuation">.</span>ExtensionServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
  <span class="token keyword">new</span> <span class="token class-name">Persistence<span class="token punctuation">.</span>FileSystemWorkspaceBinding<span class="token punctuation">.</span>FileSystemWorkspaceBinding</span><span class="token punctuation">(</span>
    Persistence<span class="token punctuation">.</span>IsolatedFileSystemManager<span class="token punctuation">.</span>IsolatedFileSystemManager<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Workspace<span class="token punctuation">.</span>Workspace<span class="token punctuation">.</span>WorkspaceImpl<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span>Persistence<span class="token punctuation">.</span>persistence <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Persistence<span class="token punctuation">.</span>Persistence<span class="token punctuation">.</span>PersistenceImpl</span><span class="token punctuation">(</span>
    Workspace<span class="token punctuation">.</span>Workspace<span class="token punctuation">.</span>WorkspaceImpl<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Bindings<span class="token punctuation">.</span>BreakpointManager<span class="token punctuation">.</span>BreakpointManager<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span>Persistence<span class="token punctuation">.</span>networkPersistenceManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Persistence<span class="token punctuation">.</span>NetworkPersistenceManager<span class="token punctuation">.</span>NetworkPersistenceManager</span><span class="token punctuation">(</span>
    Workspace<span class="token punctuation">.</span>Workspace<span class="token punctuation">.</span>WorkspaceImpl<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">new</span> <span class="token class-name">ExecutionContextSelector</span><span class="token punctuation">(</span><span class="token constant">SDK</span><span class="token punctuation">.</span>SDKModel<span class="token punctuation">.</span>TargetManager<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span><span class="token constant">UI</span><span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span>Bindings<span class="token punctuation">.</span>blackboxManager <span class="token operator">=</span> Bindings<span class="token punctuation">.</span>BlackboxManager<span class="token punctuation">.</span>BlackboxManager<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">forceNew</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">debuggerWorkspaceBinding</span><span class="token operator">:</span> Bindings<span class="token punctuation">.</span>DebuggerWorkspaceBinding<span class="token punctuation">.</span>DebuggerWorkspaceBinding<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
  <span class="token comment">// 中断监听器(初始化 SDK.DebuggerModel.Events.DebuggerPaused 事件监听)</span>
  <span class="token keyword">new</span> <span class="token class-name">PauseListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  self<span class="token punctuation">.</span><span class="token constant">UI</span><span class="token punctuation">.</span>actionRegistry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UI<span class="token punctuation">.</span>ActionRegistry<span class="token punctuation">.</span>ActionRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span><span class="token constant">UI</span><span class="token punctuation">.</span>shortcutRegistry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UI<span class="token punctuation">.</span>ShortcutRegistry<span class="token punctuation">.</span>ShortcutRegistry</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token constant">UI</span><span class="token punctuation">.</span>actionRegistry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token constant">UI</span><span class="token punctuation">.</span>ShortcutsScreen<span class="token punctuation">.</span>ShortcutsScreen<span class="token punctuation">.</span><span class="token function">registerShortcuts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_registerForwardedShortcuts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_registerMessageSinkListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  MainImpl<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'Main._createAppUI'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 初始化 Common.AppProvider 插件</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_showAppUI</span><span class="token punctuation">(</span><span class="token keyword">await</span> self<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">extension</span><span class="token punctuation">(</span>Common<span class="token punctuation">.</span>AppProvider<span class="token punctuation">.</span>AppProvider<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>_createAppUI 方法主要是核心模块的初始化，这里我只分析其中部分的具体实现，如果想比较系统的过一遍，可以通过 DevTools 打断点走一遍流程。</p> <h4 id="实例化-viewmanager">实例化 ViewManager</h4> <p>视图管理器 (ViewManager) 提供了对于对于视图插件 (View Extension) 的管理，包括对视图插件的初始化、访问，展示。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ViewManager</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/** @type {!Map&lt;string, !View&gt;} */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_views <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/** @type {!Map&lt;string, string&gt;} */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_locationNameByViewId <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// Runtime 实例化过程保存了 _extensions 变量，筛选出 view 类型的 extensions</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> extension <span class="token keyword">of</span> self<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">extensions</span><span class="token punctuation">(</span><span class="token string">'view'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> descriptor <span class="token operator">=</span> extension<span class="token punctuation">.</span><span class="token function">descriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_views<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ProvidedView</span><span class="token punctuation">(</span>extension<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_locationNameByViewId<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> descriptor<span class="token punctuation">[</span><span class="token string">'location'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">view</span><span class="token punctuation">(</span><span class="token parameter">viewId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_views<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>viewId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">showView</span><span class="token punctuation">(</span><span class="token parameter">viewId<span class="token punctuation">,</span> userGesture<span class="token punctuation">,</span> omitFocus</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> view <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_views<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>viewId<span class="token punctuation">)</span><span class="token punctuation">;</span>
   	<span class="token operator">...</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Runtime 实例化过程保存了 _extensions 变量，通过 runtime.extensions('view') 方法筛选出 view 类型的 extensions，ProvidedView 是一个类，对如下对 extension 对象进行解析然后生成一个实例保存到成员变量 _views 中。可以通过 view 方法获取 View Extension，通过 showView 显示 View Extension。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;view&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;location&quot;</span><span class="token operator">:</span> <span class="token string">&quot;panel&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;elements&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Elements&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;order&quot;</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;className&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Elements.ElementsPanel&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="实例化-inspectorview">实例化 InspectorView</h3> <p>调试器视图 (InspectorView) 定义 DevTools 调试面板的布局，提供对调试面板管理的功能。DevTools Frontend InspectorView 层级为：</p> <p><img src="/assets/img/InspectorView.9325f09c.png" alt></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">InspectorView</span> <span class="token keyword">extends</span> <span class="token class-name">VBox</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    GlassPane<span class="token punctuation">.</span><span class="token function">setContainer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setMinimumSize</span><span class="token punctuation">(</span><span class="token number">240</span><span class="token punctuation">,</span> <span class="token number">72</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// DevTools sidebar is a vertical split of panels tabbed pane and a drawer.</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_drawerSplitWidget <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SplitWidget</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">'Inspector.drawerSplitViewState'</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_drawerSplitWidget<span class="token punctuation">.</span><span class="token function">hideSidebar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_drawerSplitWidget<span class="token punctuation">.</span><span class="token function">hideDefaultResizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_drawerSplitWidget<span class="token punctuation">.</span><span class="token function">enableShowModeSaving</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将 _drawerSplitWidget 填加到 element 作为子视图</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_drawerSplitWidget<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create drawer tabbed pane.</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_drawerTabbedLocation <span class="token operator">=</span>
        ViewManager<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createTabbedLocation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_showDrawer</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'drawer-view'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> moreTabsButton <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_drawerTabbedLocation<span class="token punctuation">.</span><span class="token function">enableMoreTabsButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    moreTabsButton<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>ls<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">More Tools</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_drawerTabbedPane <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_drawerTabbedLocation<span class="token punctuation">.</span><span class="token function">tabbedPane</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_drawerTabbedPane<span class="token punctuation">.</span><span class="token function">setMinimumSize</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">27</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">...</span>

    <span class="token comment">// 创建选项卡视图</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_tabbedLocation <span class="token operator">=</span> ViewManager<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createTabbedLocation</span><span class="token punctuation">(</span>
        Host<span class="token punctuation">.</span>InspectorFrontendHost<span class="token punctuation">.</span>InspectorFrontendHostInstance<span class="token punctuation">.</span><span class="token function">bringToFront</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>
            Host<span class="token punctuation">.</span>InspectorFrontendHost<span class="token punctuation">.</span>InspectorFrontendHostInstance<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'panel'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> Root<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span><span class="token function">queryParam</span><span class="token punctuation">(</span><span class="token string">'panel'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>_tabbedPane <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_tabbedLocation<span class="token punctuation">.</span><span class="token function">tabbedPane</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_tabbedPane<span class="token punctuation">.</span><span class="token function">registerRequiredCSS</span><span class="token punctuation">(</span><span class="token string">'ui/inspectorViewTabbedPane.css'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_tabbedPane<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>TabbedPaneEvents<span class="token punctuation">.</span>TabSelected<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_tabSelected<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_tabbedPane<span class="token punctuation">.</span><span class="token function">setAccessibleName</span><span class="token punctuation">(</span>Common<span class="token punctuation">.</span>UIString<span class="token punctuation">.</span><span class="token function">UIString</span><span class="token punctuation">(</span><span class="token string">'Panels'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Store the initial selected panel for use in launch histograms</span>
    Host<span class="token punctuation">.</span>userMetrics<span class="token punctuation">.</span><span class="token function">setLaunchPanel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_tabbedPane<span class="token punctuation">.</span>selectedTabId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>Host<span class="token punctuation">.</span>InspectorFrontendHost<span class="token punctuation">.</span><span class="token function">isUnderTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_tabbedPane<span class="token punctuation">.</span><span class="token function">setAutoSelectFirstItemOnShow</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_drawerSplitWidget<span class="token punctuation">.</span><span class="token function">setMainWidget</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_tabbedPane<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>_keyDownBound <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_keyDown</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Host<span class="token punctuation">.</span>InspectorFrontendHost<span class="token punctuation">.</span>InspectorFrontendHostInstance<span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
        Host<span class="token punctuation">.</span>InspectorFrontendHostAPI<span class="token punctuation">.</span>Events<span class="token punctuation">.</span>ShowPanel<span class="token punctuation">,</span> <span class="token function">showPanel</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * @this {InspectorView}
     * @param {!Common.EventTarget.EventTargetEvent} event
     */</span>
    <span class="token keyword">function</span> <span class="token function">showPanel</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> panelName <span class="token operator">=</span> <span class="token comment">/** @type {string} */</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">showPanel</span><span class="token punctuation">(</span>panelName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">addPanel</span><span class="token punctuation">(</span><span class="token parameter">view</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">hasPanel</span><span class="token punctuation">(</span><span class="token parameter">panelName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">panel</span><span class="token punctuation">(</span><span class="token parameter">panelName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">showPanel</span><span class="token punctuation">(</span><span class="token parameter">panelName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们知道如果要实现一个选项卡，我们需要构造两部分：选项卡标题组、选项卡内容，选项卡标题切换会切换选项卡内容。上面的 _tabbedPane 对象就是创建了一个选项卡对象。具体实现逻辑为：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>_tabbedLocation <span class="token operator">=</span> ViewManager<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createTabbedLocation</span><span class="token punctuation">(</span>
   Host<span class="token punctuation">.</span>InspectorFrontendHost<span class="token punctuation">.</span>InspectorFrontendHostInstance<span class="token punctuation">.</span><span class="token function">bringToFront</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>
     Host<span class="token punctuation">.</span>InspectorFrontendHost<span class="token punctuation">.</span>InspectorFrontendHostInstance<span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token string">'panel'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> Root<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span><span class="token function">queryParam</span><span class="token punctuation">(</span><span class="token string">'panel'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>createTabbedLocation 方法中实例化 _TabbedLocation 类，第二个参数是 location，_TabbedLocation 中将 location 筛选出 location 为 'panel' 的 _views，通过 _tabbedPane.appendTab 添加为 Tab。我们可以通过 UI.inspectorView._tabbedPane 对 Tab 进行操作。例如下面的逻辑：</p> <p>隐藏默认面板：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> tabbedPane <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token constant">UI</span><span class="token punctuation">.</span>inspectorView<span class="token punctuation">.</span>_tabbedPane<span class="token punctuation">;</span>
tabbedPane<span class="token punctuation">.</span><span class="token function">closeTab</span><span class="token punctuation">(</span><span class="token string">'elements'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>监听 TabbedPane 事件：</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token constant">UI</span><span class="token punctuation">.</span>inspectorView<span class="token punctuation">.</span>_tabbedPane<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token constant">UI</span><span class="token punctuation">.</span>TabbedPane<span class="token punctuation">.</span>Events<span class="token punctuation">.</span>TabSelected<span class="token punctuation">,</span> tabSelectedCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span><span class="token constant">UI</span><span class="token punctuation">.</span>inspectorView<span class="token punctuation">.</span>_tabbedPane<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>TabbedPaneEvents<span class="token punctuation">.</span>TabClosed<span class="token punctuation">,</span> tabClosedCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span><span class="token constant">UI</span><span class="token punctuation">.</span>inspectorView<span class="token punctuation">.</span>_tabbedPane<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>TabbedPaneEvents<span class="token punctuation">.</span>TabOrderChanged<span class="token punctuation">,</span> tabClosedCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="实例化-simpleapp">实例化 SimpleApp</h3> <p>_createAppUI() 最后一行代码显示 App 的 UI。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_showAppUI</span><span class="token punctuation">(</span><span class="token keyword">await</span> self<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">extension</span><span class="token punctuation">(</span>Common<span class="token punctuation">.</span>AppProvider<span class="token punctuation">.</span>AppProvider<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>通过 extension 方法获取 AppProvider 类，实例化 AppProvider。</p> <p>main 模块 module.json 中注册了 AppProvider Extension：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
	<span class="token string-property property">&quot;extensions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
		<span class="token punctuation">{</span>
			<span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@Common.AppProvider&quot;</span><span class="token punctuation">,</span>
			<span class="token string-property property">&quot;className&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Main.SimpleAppProvider&quot;</span><span class="token punctuation">,</span>
			<span class="token string-property property">&quot;order&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>
	<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过 Extension type 获取插件类，然后获取 AppProvider 的实例化对象 ，传入到 _showAppUI 方法中进行初始化。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">_showAppUI</span><span class="token punctuation">(</span><span class="token parameter">appProvider</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    MainImpl<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'Main._showAppUI'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token comment">/** @type {!Common.AppProvider.AppProvider} */</span> <span class="token punctuation">(</span>appProvider<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// It is important to kick controller lifetime after apps are instantiated.</span>
    self<span class="token punctuation">.</span>Components<span class="token punctuation">.</span>dockController<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token punctuation">.</span><span class="token function">presentUI</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token operator">...</span>
     <span class="token comment">// Allow UI cycles to repaint prior to creating connection.</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_initializeTarget</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    MainImpl<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'Main._showAppUI'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>实例化 AppProvider 实际上是初始化 SimpleAppProvider 类，SimpleAppProvider 类的 createApp 方法中进行实例化 SimpleApp。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">SimpleApp</span> <span class="token punctuation">{</span>
  <span class="token function">presentUI</span><span class="token punctuation">(</span><span class="token parameter">document</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> rootView <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UI<span class="token punctuation">.</span>RootView<span class="token punctuation">.</span>RootView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    self<span class="token punctuation">.</span><span class="token constant">UI</span><span class="token punctuation">.</span>inspectorView<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span>rootView<span class="token punctuation">.</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rootView<span class="token punctuation">.</span><span class="token function">attachToDocument</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rootView<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>presentUI 方法生成 RootView 实例 rootView 视图对象，将 inspectorView 视图对象添加到 rootView 视图对象，rootView 视图挂载于 document.body 上，至此完成了 DOM 的生成和挂载。</p> <h2 id="frontend-与-backend-的通信机制">Frontend 与 Backend 的通信机制</h2> <h3 id="target-models-agents">Target &amp; Models &amp; Agents</h3> <p>MainImpl.js 后续流程的 _initializeTarget 和 _lateInitialization 两个方法分别加载 <code>early-initialization</code> 和 <code>late-initialization</code> 类型的 Extension。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">_initializeTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    MainImpl<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'Main._initializeTarget'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> instances <span class="token operator">=</span>
        <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">extensions</span><span class="token punctuation">(</span><span class="token string">'early-initialization'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">extension</span> <span class="token operator">=&gt;</span> extension<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> instance <span class="token keyword">of</span> instances<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token comment">/** @type {!Common.Runnable.Runnable} */</span> <span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Used for browser tests.</span>
    Host<span class="token punctuation">.</span>InspectorFrontendHost<span class="token punctuation">.</span>InspectorFrontendHostInstance<span class="token punctuation">.</span><span class="token function">readyForTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Asynchronously run the extensions.</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_lateInitialization</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    MainImpl<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'Main._initializeTarget'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Application 在初始化 <code>early-initialization</code> 类型时关联的主模块：</p> <ul><li>devtools_app：InspectorMain.InspectorMain</li> <li>js_app：JsMain.JsMain</li> <li>node_app：NodeMain.NodeMain</li> <li>worker_app：WorkerMain.WorkerMain</li></ul> <p>devtools_app 中会根据 <code>early-initialization</code> 类型找到 <code>inspector_main</code> 模块的 InspectorMain 类，然后获取插件实例，调用 run 方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// inspector_main/InspectorMain.js</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">InspectorMainImpl</span> <span class="token keyword">extends</span> <span class="token class-name">Common<span class="token punctuation">.</span>ObjectWrapper<span class="token punctuation">.</span>ObjectWrapper</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> firstCall <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token constant">SDK</span><span class="token punctuation">.</span>Connections<span class="token punctuation">.</span><span class="token function">initMainConnection</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> type <span class="token operator">=</span> Root<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span><span class="token function">queryParam</span><span class="token punctuation">(</span><span class="token string">'v8only'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant">SDK</span><span class="token punctuation">.</span>SDKModel<span class="token punctuation">.</span>Type<span class="token punctuation">.</span>Node <span class="token operator">:</span> <span class="token constant">SDK</span><span class="token punctuation">.</span>SDKModel<span class="token punctuation">.</span>Type<span class="token punctuation">.</span>Frame<span class="token punctuation">;</span>
      <span class="token keyword">const</span> waitForDebuggerInPage <span class="token operator">=</span> type <span class="token operator">===</span> <span class="token constant">SDK</span><span class="token punctuation">.</span>SDKModel<span class="token punctuation">.</span>Type<span class="token punctuation">.</span>Frame <span class="token operator">&amp;&amp;</span> Root<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span><span class="token function">queryParam</span><span class="token punctuation">(</span><span class="token string">'panel'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'sources'</span><span class="token punctuation">;</span>
      <span class="token comment">// 创建 Target 对象</span>
      <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token constant">SDK</span><span class="token punctuation">.</span>SDKModel<span class="token punctuation">.</span>TargetManager<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createTarget</span><span class="token punctuation">(</span>
          <span class="token string">'main'</span><span class="token punctuation">,</span> Common<span class="token punctuation">.</span>UIString<span class="token punctuation">.</span><span class="token function">UIString</span><span class="token punctuation">(</span><span class="token string">'Main'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> waitForDebuggerInPage<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面代码中的 TargetManager 管理 Target 对象，Target 对象管理模型 (Model) 与代理 (Agent) 之间的通信。createTarget 会创建一个 name 为 Target 对象。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">createTarget</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> type<span class="token punctuation">,</span> parentTarget<span class="token punctuation">,</span> sessionId<span class="token punctuation">,</span> waitForDebuggerInPage<span class="token punctuation">,</span> connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> target <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">Target</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> type<span class="token punctuation">,</span> parentTarget<span class="token punctuation">,</span> sessionId <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_isSuspended<span class="token punctuation">,</span> connection <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>waitForDebuggerInPage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">.</span><span class="token function">pageAgent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">waitForDebugger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 创建 Models 对象，_modelObservers Multimap 类型，观察并收集 Model 对象</span>
  target<span class="token punctuation">.</span><span class="token function">createModels</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_modelObservers<span class="token punctuation">.</span><span class="token function">keysArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 添加到 TargetManager _targets 集合中</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_targets<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Iterate over a copy. _observers might be modified during iteration.</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> observer <span class="token keyword">of</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>_observers<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    observer<span class="token punctuation">.</span><span class="token function">targetAdded</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> modelClass <span class="token keyword">of</span> target<span class="token punctuation">.</span><span class="token function">models</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> model <span class="token operator">=</span> <span class="token comment">/** @type {!SDKModel} */</span> <span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">models</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>modelClass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">modelAdded</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> modelClass<span class="token punctuation">,</span> model<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_modelListeners<span class="token punctuation">.</span><span class="token function">keysArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> info <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_modelListeners<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> model <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>modelClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        model<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> info<span class="token punctuation">.</span>listener<span class="token punctuation">,</span> info<span class="token punctuation">.</span>thisObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> target<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Model 是与后端同步的前端数据对象，Model 对象包含：</p> <p><code>SDK.NetworkManager</code>、<code>SDK.SecurityOriginManager</code>、<code>SDK.ResourceTreeModel</code>、<code>SDK.RuntimeModel</code>、<code>SDK.DebuggerModel</code>、<code>SDK.CPUProfilerModel</code>、<code>SDK.DOMModel</code>、<code>SDK.CSSModel</code>、<code>SDK.DOMDebuggerModel</code>、<code>SDK.OverlayModel</code>、<code>SDK.EmulationModel</code>、<code>SDK.LogModel</code>、<code>SDK.ServiceWorkerManager</code>、<code>Components.TargetDetachedDialog</code>、<code>SDK.ChildTargetManager</code> 等。</p> <p><strong>获取 Target 对象：</strong></p> <ul><li>window.SDK.targetManager.mainTarget()：获取主连接对象</li> <li>window.SDK.targetManager.targetById(id)：根据 id 获取连接对象</li></ul> <p>**获取 Target 对象的 models：**target.models()</p> <p>Agent 是与前端同步的后端数据对象，Agent 对象与 <a href="https://chromedevtools.github.io/devtools-protocol/" target="_blank" rel="noopener noreferrer">Chrome DevTools Protocol<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中的 Domain 一一对应，Agent 对象包括：</p> <p><code>inspectorAgent</code>、<code>pageAgent</code>、<code>networkAgent</code>、<code>runtimeAgent</code>、<code>debuggerAgent</code>、<code>consoleAgent</code>、<code>domAgent</code>、<code>cssAgent</code>、<code>profilerAgent</code>、<code>timelineAgent</code>、<code>workerAgent</code> 等。</p> <p>Target 继承自 TargetBase 类，TargetBase 类构建函数将 <code>inspectorBackend._agentPrototypes</code> 按照 domian 分类挂载到 _agents 对象上。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">TargetBase</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">needsNodeJSPatching<span class="token punctuation">,</span> parentTarget<span class="token punctuation">,</span> sessionId<span class="token punctuation">,</span> connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token operator">...</span>
        <span class="token comment">/** @type {!Object&lt;string,!_AgentPrototype&gt;} */</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_agents <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>domain<span class="token punctuation">,</span> agentPrototype<span class="token punctuation">]</span> <span class="token keyword">of</span> inspectorBackend<span class="token punctuation">.</span>_agentPrototypes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>_agents<span class="token punctuation">[</span>domain<span class="token punctuation">]</span> <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token comment">/** @type {!_AgentPrototype} */</span> <span class="token punctuation">(</span>agentPrototype<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>_agents<span class="token punctuation">[</span>domain<span class="token punctuation">]</span><span class="token punctuation">.</span>_target <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      	<span class="token operator">...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>front_end/generated/InspectorBackendCommands.js</code> 是根据调试协议自动生成的文件，<code>InspectorBackendCommands.js</code> 中通过 <code>inspectorBackend.registerCommand</code> 注册调用 <code>_agentPrototype</code> 方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">_agentPrototype</span><span class="token punctuation">(</span><span class="token parameter">domain</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_agentPrototypes<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>domain<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_agentPrototypes<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">_AgentPrototype</span><span class="token punctuation">(</span>domain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_addAgentGetterMethodToProtocolTargetPrototype</span><span class="token punctuation">(</span>domain<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token comment">/** @type {!_AgentPrototype} */</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_agentPrototypes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>domain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>inspectorBackend._agentPrototypes</code> 是 <code>Map&lt;domain, _AgentPrototype&gt;</code> 类型，同时通过 <code>_addAgentGetterMethodToProtocolTargetPrototype</code> 将 <code>{domian}Agent</code> 方法挂载 <code>TargetBase</code> 原型上。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> methodName <span class="token operator">=</span> domain<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> upperCaseLength<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> domain<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>upperCaseLength<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'Agent'</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @this {TargetBase}
 */</span>
<span class="token keyword">function</span> <span class="token function">agentGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_agents<span class="token punctuation">[</span>domain<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">TargetBase</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>methodName<span class="token punctuation">]</span> <span class="token operator">=</span> agentGetter<span class="token punctuation">;</span>
</code></pre></div><h3 id="初始化-main-connection">初始化 Main Connection</h3> <p>initMainConnection 方法中是 Connection 具体过程：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// sdk/Connections.js</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">initMainConnection</span><span class="token punctuation">(</span><span class="token parameter">createMainTarget<span class="token punctuation">,</span> websocketConnectionLost</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ProtocolClient<span class="token punctuation">.</span>InspectorBackend<span class="token punctuation">.</span>Connection<span class="token punctuation">.</span><span class="token function">setFactory</span><span class="token punctuation">(</span><span class="token function">_createMainConnection</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> websocketConnectionLost<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">createMainTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Host<span class="token punctuation">.</span>InspectorFrontendHost<span class="token punctuation">.</span>InspectorFrontendHostInstance<span class="token punctuation">.</span><span class="token function">connectionReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Host<span class="token punctuation">.</span>InspectorFrontendHost<span class="token punctuation">.</span>InspectorFrontendHostInstance<span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
      Host<span class="token punctuation">.</span>InspectorFrontendHostAPI<span class="token punctuation">.</span>Events<span class="token punctuation">.</span>ReattachMainTarget<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        TargetManager<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mainTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">createMainTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">_createMainConnection</span><span class="token punctuation">(</span><span class="token parameter">websocketConnectionLost</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> wsParam <span class="token operator">=</span> Root<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span><span class="token function">queryParam</span><span class="token punctuation">(</span><span class="token string">'ws'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> wssParam <span class="token operator">=</span> Root<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span><span class="token function">queryParam</span><span class="token punctuation">(</span><span class="token string">'wss'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>wsParam <span class="token operator">||</span> wssParam<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ws <span class="token operator">=</span> wsParam <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ws://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>wsParam<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">wss://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>wssParam<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WebSocketConnection</span><span class="token punctuation">(</span>ws<span class="token punctuation">,</span> websocketConnectionLost<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Host<span class="token punctuation">.</span>InspectorFrontendHost<span class="token punctuation">.</span>InspectorFrontendHostInstance<span class="token punctuation">.</span><span class="token function">isHostedMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StubConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MainConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从 _createMainConnection 方法我们可以看到建立 Main Connection 的方式有三种：</p> <ul><li>Query Params 模式：实例化 WebSocketConnection 对象，建立 WebSocket Channel，远程调试就是基于这种模式；</li> <li>HostedMode 模式：实例化 StubConnection 对象，建立 Embedder Channel，Inspected Window 与 DevTools Page 的通信就是这种模式；</li> <li>MainConnection 模式：实例化 MainConnection 对象，具体是什么待进一步研究。</li></ul> <p>**获取 Target 的 connection：**SDK.targetManager.mainTarget().router().connection()</p> <p><strong>Inspector.html Query Params：</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token literal-property property">http</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">8090</span><span class="token operator">/</span>front_end<span class="token operator">/</span>inspector<span class="token punctuation">.</span>html<span class="token operator">?</span>experiments<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>can_dock<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>dockSide<span class="token operator">=</span>right<span class="token operator">&amp;</span>ws<span class="token operator">=</span>localhost<span class="token operator">:</span><span class="token number">9222</span><span class="token operator">/</span>devtools<span class="token operator">/</span>page<span class="token operator">/</span>1FFDE891<span class="token operator">-</span>34F1<span class="token operator">-</span>485C<span class="token operator">-</span><span class="token constant">A0CB</span><span class="token operator">-</span>066EBF852E53
</code></pre></div><ul><li>experiments=true：强制 DevTools 实验功能可用</li> <li>can_dock=true&amp;dockSide=right：设置 DevTools dock 方式</li> <li>ws=…：Target WebSocket Server URL</li></ul> <h3 id="devtools-protocol-client">DevTools Protocol Client</h3> <p>上面 Connections.js 中建立了 WebSocket Channel 或 Embedder Channel，借助于通信通道能够实现调试器前端与后端的交互。类似于 HTTP 协议一样，调试器定义了调试协议(DevTools Protocol)，DevTools Frontend 中实现了一个 Protocol Client (protocol_client / InspectorBackend.js)，通过 sendMessage 发送协议消息，_onMessage 接收协议消息。</p> <p>Chrome 可以通过 Protocol monitor 工具来查看调试协议。</p> <p><img src="/assets/img/protocol-monitor.544ef78f.png" alt></p> <p>调试协议把操作划分为不同的域 (domain) ，比如 DOM、Debugger、Network、Console 和 Timeline 等，可以理解为 DevTools 中的不同功能模块，每个域 (domain) 定义了支持的 command 及监听的 event。每个 command 包含 request 和 response 两部分，request 部分指定的操作以及操作相关的参数，response 部分表明操作状态，成功或失败。command 和 event 中可能涉及到非基本数据类型，在 domain 中被归为 Type，比如：<code>'frameId': &lt;FrameId&gt;</code>，其中 FrameId 为非基本数据类型。</p> <p><img src="/assets/img/devtools-protocol.176cdba9.png" alt></p> <p>DevTools Frontend 中关于 Chrome DevTools Protocol 的处理是借助 Agent 对象给 Protocol Server 发送消息，例如 DOMModel 对象请问 Document 内容：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * @return {!Promise&lt;?DOMDocument&gt;}
 */</span>
<span class="token keyword">async</span> <span class="token function">_requestDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> documentPayload <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_agent<span class="token punctuation">.</span><span class="token function">getDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_pendingDocumentRequestPromise<span class="token punctuation">;</span>
		
	<span class="token keyword">if</span> <span class="token punctuation">(</span>documentPayload<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_setDocument</span><span class="token punctuation">(</span>documentPayload<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>只要按照对应的规范构建通信协议消息也可以实现类似的功能，比如我们也可以通过下面的方式向 WebView 中注入 JS 代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">SDK</span><span class="token punctuation">.</span>targetManager<span class="token punctuation">.</span><span class="token function">mainTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendRawMessage</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
  <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'Runtime.evaluate'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">params</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">expression</span><span class="token operator">:</span> <span class="token string">'injectScript()'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>WebView 内核层收到 Runtime.evaluate 消息后就可以执行 Runtime.evaluate 相关的方法实现代码执行。原理上和 RPC 机制类似，可以实现远程过程调用。</p> <h2 id="总结">总结</h2> <p>本文从编译 Chrome DevTools Frontend 源码入手，介绍了调试器启动流程、UI 组件机制、DevTools 前后端通信机制等多个重要部分，文章内容较长适合结合源码一起看，详细看完本文您对 Devtools 整体的运行原理有一定的认知，当然 Chrome DevTools Frontend 中模块较多，没有办法一一完整讲解，不过熟悉了整体的设计思路其他模块也是类似的机制，另外在 Chrome DevTools 中 Extension 机制是非常重要的部分，由于 Extension 机制涉及到和 Chromium 内核的交互，本文暂未展开分析其运行机制。</p> <h2 id="参考">参考</h2> <ul><li><a href="https://medium.com/@paul_irish/1e671bf659bb" target="_blank" rel="noopener noreferrer">The Hello World of Chrome DevTools Hacking<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://docs.google.com/document/d/1WNF-KqRSzPLUUfZqQG5AFeU_Ll8TfWYcJasa_XGf7ro/view" target="_blank" rel="noopener noreferrer">Contributing to Chrome DevTools<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://chromium.googlesource.com/chromium/src/tools/gn/+/48062805e19b4697c5fbd926dc649c78b6aaa138/README.md" target="_blank" rel="noopener noreferrer">What is GN?<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://blog.csdn.net/weixin_44701535/article/details/88355958" target="_blank" rel="noopener noreferrer">跨平台：GN实践详解（ninja, 编译, windows/mac/android实战）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://memoryza.gitbook.io/chromedevtools-devtools-frontend/" target="_blank" rel="noopener noreferrer">DevTools Frontend 源码分析<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://bit.ly/how-blink-works" target="_blank" rel="noopener noreferrer">How Blink works<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://jasonlaster.github.io/js/devtools/2015/03/01/devtools-paused.html" target="_blank" rel="noopener noreferrer">What happens when DevTools Pauses<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://blog.csdn.net/rogeryi/article/details/48179851" target="_blank" rel="noopener noreferrer">理解 Embedder，理解 Chromium 的系统层次结构<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://juejin.im/post/5a8bc11d5188257a5c6076fe" target="_blank" rel="noopener noreferrer">DevTools 架构浅析<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <div data-v-3bd334e8><p class="descript" data-v-3bd334e8>写这些代码也许就一两个小时的事，写一篇大家好接受的文章需要几天的酝酿，如果文章对您有帮助请我喝杯咖啡吧！</p> <img src="/supportme.png" class="pay-code" data-v-3bd334e8> <div data-v-3bd334e8><div id="container"></div></div> <div class="footer" data-v-4f0df4b0 data-v-3bd334e8><p data-v-4f0df4b0>站点总访问量： 站点总访客数：</p> <p data-v-4f0df4b0>博客内容遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" data-v-4f0df4b0>知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></p> <p data-v-4f0df4b0>赵梦欢 © 2015 - 2023</p></div></div></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.f3e141ba.js" defer></script><script src="/assets/js/9.f542ab97.js" defer></script><script src="/assets/js/18.c373a36e.js" defer></script><script src="/assets/js/34.124c31c0.js" defer></script>
  </body>
</html>
