<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>微信小程序技术原理分析 | 匠心博客</title>
    <meta name="description" content="小青年,匠心,小青年博客,匠心博客,前端开发,android,技术宅,菜鸟教程,一个神奇的博客。">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.685c010a.css" as="style"><link rel="preload" href="/assets/js/app.f3e141ba.js" as="script"><link rel="preload" href="/assets/js/5.3395f0b5.js" as="script"><link rel="preload" href="/assets/js/18.c373a36e.js" as="script"><link rel="preload" href="/assets/js/34.124c31c0.js" as="script"><link rel="prefetch" href="/assets/js/1.1950ec81.js"><link rel="prefetch" href="/assets/js/10.7f857e71.js"><link rel="prefetch" href="/assets/js/100.e03c01d2.js"><link rel="prefetch" href="/assets/js/101.7b790a2f.js"><link rel="prefetch" href="/assets/js/102.a7aa77f9.js"><link rel="prefetch" href="/assets/js/103.d473991c.js"><link rel="prefetch" href="/assets/js/104.9fe8785c.js"><link rel="prefetch" href="/assets/js/105.7291ae49.js"><link rel="prefetch" href="/assets/js/106.2c35a2f4.js"><link rel="prefetch" href="/assets/js/107.a71ccb64.js"><link rel="prefetch" href="/assets/js/108.9d6f54a8.js"><link rel="prefetch" href="/assets/js/109.e77d12ca.js"><link rel="prefetch" href="/assets/js/11.5378ae65.js"><link rel="prefetch" href="/assets/js/12.9aca40f8.js"><link rel="prefetch" href="/assets/js/13.ce2b655c.js"><link rel="prefetch" href="/assets/js/14.7488ca24.js"><link rel="prefetch" href="/assets/js/15.9c07ac98.js"><link rel="prefetch" href="/assets/js/16.8f57294c.js"><link rel="prefetch" href="/assets/js/17.4f7ae4ec.js"><link rel="prefetch" href="/assets/js/19.c7be2474.js"><link rel="prefetch" href="/assets/js/2.7f7e5268.js"><link rel="prefetch" href="/assets/js/20.f8833113.js"><link rel="prefetch" href="/assets/js/21.e71dd521.js"><link rel="prefetch" href="/assets/js/22.92dc7b77.js"><link rel="prefetch" href="/assets/js/23.285557d3.js"><link rel="prefetch" href="/assets/js/24.a803551c.js"><link rel="prefetch" href="/assets/js/25.dbeaa19d.js"><link rel="prefetch" href="/assets/js/26.9ca97076.js"><link rel="prefetch" href="/assets/js/27.d1a2911b.js"><link rel="prefetch" href="/assets/js/28.25c216b3.js"><link rel="prefetch" href="/assets/js/29.9dc30af4.js"><link rel="prefetch" href="/assets/js/30.1e9d6e06.js"><link rel="prefetch" href="/assets/js/31.3d7dbe62.js"><link rel="prefetch" href="/assets/js/32.36371ba7.js"><link rel="prefetch" href="/assets/js/33.78edc66d.js"><link rel="prefetch" href="/assets/js/35.a5470008.js"><link rel="prefetch" href="/assets/js/36.acde7543.js"><link rel="prefetch" href="/assets/js/37.f6648812.js"><link rel="prefetch" href="/assets/js/38.1885784f.js"><link rel="prefetch" href="/assets/js/39.af4b4bbd.js"><link rel="prefetch" href="/assets/js/4.61024115.js"><link rel="prefetch" href="/assets/js/40.ec6e88a9.js"><link rel="prefetch" href="/assets/js/41.67d4e8b7.js"><link rel="prefetch" href="/assets/js/42.7de428af.js"><link rel="prefetch" href="/assets/js/43.b4f51fa8.js"><link rel="prefetch" href="/assets/js/44.487d119d.js"><link rel="prefetch" href="/assets/js/45.2206665b.js"><link rel="prefetch" href="/assets/js/46.125163cc.js"><link rel="prefetch" href="/assets/js/47.8722f507.js"><link rel="prefetch" href="/assets/js/48.b8bfe77f.js"><link rel="prefetch" href="/assets/js/49.77fac897.js"><link rel="prefetch" href="/assets/js/50.d68289a2.js"><link rel="prefetch" href="/assets/js/51.d9d70556.js"><link rel="prefetch" href="/assets/js/52.6a2c9e02.js"><link rel="prefetch" href="/assets/js/53.ff13cf8b.js"><link rel="prefetch" href="/assets/js/54.7e844902.js"><link rel="prefetch" href="/assets/js/55.80aa3d86.js"><link rel="prefetch" href="/assets/js/56.a4124774.js"><link rel="prefetch" href="/assets/js/57.55eb7355.js"><link rel="prefetch" href="/assets/js/58.7d0e2bc5.js"><link rel="prefetch" href="/assets/js/59.9cdd695c.js"><link rel="prefetch" href="/assets/js/6.77e8533c.js"><link rel="prefetch" href="/assets/js/60.54318be9.js"><link rel="prefetch" href="/assets/js/61.82e1ea82.js"><link rel="prefetch" href="/assets/js/62.b065e499.js"><link rel="prefetch" href="/assets/js/63.bb770dde.js"><link rel="prefetch" href="/assets/js/64.996fdbfd.js"><link rel="prefetch" href="/assets/js/65.54f3baf3.js"><link rel="prefetch" href="/assets/js/66.38d28ab3.js"><link rel="prefetch" href="/assets/js/67.5cf5a3bc.js"><link rel="prefetch" href="/assets/js/68.f2418476.js"><link rel="prefetch" href="/assets/js/69.162d06c4.js"><link rel="prefetch" href="/assets/js/7.a2cd9d6c.js"><link rel="prefetch" href="/assets/js/70.80f1252b.js"><link rel="prefetch" href="/assets/js/71.970dda3c.js"><link rel="prefetch" href="/assets/js/72.a073c997.js"><link rel="prefetch" href="/assets/js/73.674106d1.js"><link rel="prefetch" href="/assets/js/74.a0336873.js"><link rel="prefetch" href="/assets/js/75.37fbb329.js"><link rel="prefetch" href="/assets/js/76.a9439343.js"><link rel="prefetch" href="/assets/js/77.d52439f1.js"><link rel="prefetch" href="/assets/js/78.fbffcd6c.js"><link rel="prefetch" href="/assets/js/79.c6d73001.js"><link rel="prefetch" href="/assets/js/8.f0af9f9c.js"><link rel="prefetch" href="/assets/js/80.eab87966.js"><link rel="prefetch" href="/assets/js/81.9931436f.js"><link rel="prefetch" href="/assets/js/82.b29080c9.js"><link rel="prefetch" href="/assets/js/83.d94ed517.js"><link rel="prefetch" href="/assets/js/84.600be30f.js"><link rel="prefetch" href="/assets/js/85.a6938cc3.js"><link rel="prefetch" href="/assets/js/86.7dec6ed4.js"><link rel="prefetch" href="/assets/js/87.5d2c1dc9.js"><link rel="prefetch" href="/assets/js/88.8f2410d4.js"><link rel="prefetch" href="/assets/js/89.fe8c04e8.js"><link rel="prefetch" href="/assets/js/9.f542ab97.js"><link rel="prefetch" href="/assets/js/90.f25166a8.js"><link rel="prefetch" href="/assets/js/91.038ee701.js"><link rel="prefetch" href="/assets/js/92.19e610e0.js"><link rel="prefetch" href="/assets/js/93.22cd83c8.js"><link rel="prefetch" href="/assets/js/94.7495cfa6.js"><link rel="prefetch" href="/assets/js/95.f149c41d.js"><link rel="prefetch" href="/assets/js/96.cee91e1f.js"><link rel="prefetch" href="/assets/js/97.27a1bb57.js"><link rel="prefetch" href="/assets/js/98.67d4f125.js"><link rel="prefetch" href="/assets/js/99.35daa60c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.685c010a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">匠心博客</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/index.html" class="nav-link">博文</a></div><div class="nav-item"><a href="/book/index.html" class="nav-link">专栏</a></div><div class="nav-item"><a href="/note/index.html" class="nav-link">笔记</a></div><div class="nav-item"><a href="/nav/index.html" class="nav-link">导航</a></div><div class="nav-item"><a href="/about/index.html" class="nav-link">关于</a></div> <a href="https://github.com/zhaomenghuan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/index.html" class="nav-link">博文</a></div><div class="nav-item"><a href="/book/index.html" class="nav-link">专栏</a></div><div class="nav-item"><a href="/note/index.html" class="nav-link">笔记</a></div><div class="nav-item"><a href="/nav/index.html" class="nav-link">导航</a></div><div class="nav-item"><a href="/about/index.html" class="nav-link">关于</a></div> <a href="https://github.com/zhaomenghuan" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>微信小程序技术原理分析</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/wechat-miniprogram-principle-analysis.html#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/wechat-miniprogram-principle-analysis.html#双线程模型" class="sidebar-link">双线程模型</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/wechat-miniprogram-principle-analysis.html#开发工具" class="sidebar-link">开发工具</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/wechat-miniprogram-principle-analysis.html#调试逻辑层" class="sidebar-link">调试逻辑层</a></li><li class="sidebar-sub-header"><a href="/blog/wechat-miniprogram-principle-analysis.html#调试视图层" class="sidebar-link">调试视图层</a></li><li class="sidebar-sub-header"><a href="/blog/wechat-miniprogram-principle-analysis.html#逆向技巧" class="sidebar-link">逆向技巧</a></li></ul></li><li><a href="/blog/wechat-miniprogram-principle-analysis.html#基础库" class="sidebar-link">基础库</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/wechat-miniprogram-principle-analysis.html#整体架构" class="sidebar-link">整体架构</a></li><li class="sidebar-sub-header"><a href="/blog/wechat-miniprogram-principle-analysis.html#wawebview-源码结构" class="sidebar-link">WAWebview 源码结构</a></li><li class="sidebar-sub-header"><a href="/blog/wechat-miniprogram-principle-analysis.html#waservice-源码结构" class="sidebar-link">WAService 源码结构</a></li><li class="sidebar-sub-header"><a href="/blog/wechat-miniprogram-principle-analysis.html#foundation-模块" class="sidebar-link">Foundation 模块</a></li><li class="sidebar-sub-header"><a href="/blog/wechat-miniprogram-principle-analysis.html#exparser-模块" class="sidebar-link">Exparser 模块</a></li><li class="sidebar-sub-header"><a href="/blog/wechat-miniprogram-principle-analysis.html#virtual-dom-模块" class="sidebar-link">Virtual DOM 模块</a></li><li class="sidebar-sub-header"><a href="/blog/wechat-miniprogram-principle-analysis.html#weixinjsbridge-模块" class="sidebar-link">WeixinJSBridge 模块</a></li></ul></li><li><a href="/blog/wechat-miniprogram-principle-analysis.html#编译原理" class="sidebar-link">编译原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/wechat-miniprogram-principle-analysis.html#编译-wxml" class="sidebar-link">编译 WXML</a></li></ul></li><li><a href="/blog/wechat-miniprogram-principle-analysis.html#通信原理" class="sidebar-link">通信原理</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/wechat-miniprogram-principle-analysis.html#启动流程" class="sidebar-link">启动流程</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/wechat-miniprogram-principle-analysis.html#总结" class="sidebar-link">总结</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/wechat-miniprogram-principle-analysis.html#参考" class="sidebar-link">参考</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="微信小程序技术原理分析">微信小程序技术原理分析</h1> <h2 id="前言">前言</h2> <p>互联网生态演进：超级 APP + 小程序成为「轻应用时代」下的新生态。</p> <p><img src="/assets/img/background.80469eb5.png" alt></p> <p>一方面微信、支付宝等各家小程序平台遍地开花，另一方面移动开发插件化技术逐渐没落，移动应用构建的方式在悄悄的发生变化。对于企业应用形态而言，也在逐步发生变化，超级 APP（移动门户）+ 轻应用是一种新的流行趋势。微信、支付宝是互联网生态下的“移动门户”，手机银行是金融典型的 ToC “移动门户”。</p> <p>小程序方式构建应用是大趋势，被越来越多的企业用户看到其中的优势，构建一个跨多端平台的小程序开发平台是一种思路，帮助企业用户构建一个具备小程序能力的“移动门户”也是一种思路。本文主要调研微信小程序运行时的基本原理，从而构建一个适合我们自己平台的小程序运行框架。</p> <h2 id="双线程模型">双线程模型</h2> <p>小程序的渲染层和逻辑层分别由两个线程管理：渲染层的界面使用 WebView 进行渲染；逻辑层采用 JSCore 运行 JavaScript 代码。一个小程序存在多个界面，所以渲染层存在多个 WebView。这两个线程间的通信经由小程序 Native 侧中转，逻辑层发送网络请求也经由 Native 侧转发，小程序的通信模型下图所示。</p> <p><img src="/assets/img/wechat-miniprogram-framework.ad156d1c.png" alt></p> <p>小程序的双层架构思想可以追溯到 PWA，但又有所扬弃。</p> <table><thead><tr><th style="text-align:center"></th> <th style="text-align:center">PWA</th> <th style="text-align:center">小程序框架</th></tr></thead> <tbody><tr><td style="text-align:center">逻辑层</td> <td style="text-align:center">以 Service Worker 为载体。开发者需编写业务逻辑、管理资源缓存。</td> <td style="text-align:center">以 JSCore 或 V8 引擎为载体。开发者只需编写业务逻辑。</td></tr> <tr><td style="text-align:center">渲染层</td> <td style="text-align:center">基于 Web 网页的单页或多标签页方案。</td> <td style="text-align:center">基于多个 WebView 组成的页面栈。</td></tr></tbody></table> <p>小程序框架与 PWA 相比，小程序的开发者可以更聚焦于业务逻辑，而无需关注静态资源的缓存。小程序包的缓存和更新机制交由小程序框架自动完成，开发者可以在适当时机通过 API 影响这一过程。小程序的渲染层由多个 WebView 组成的页面栈构成，这与 PWA 相比有着更接近移动端原生应用的用户体验。同时，小程序的开发者也能更从容地处理多页面间跳转时页面状态的变化。</p> <p>类似于微信 JSSDK 这样的 Hybrid 技术，微信小程序的界面主要由成熟的 Web 技术渲染，辅之以大量的接口提供丰富的客户端原生能力。同时，每个小程序页面都是用不同的 WebView 去渲染，这样可以提供更好的交互体验，更贴近原生体验，也避免了单个 WebView 的任务过于繁重。此外，界面渲染这一块我们定义了一套内置组件以统一体验，并且提供一些基础和通用的能力，进一步降低开发者的学习门槛。值得一提的是，内置组件有一部分较复杂组件是用客户端原生实现的同层渲染，以提供更好的性能。</p> <p><strong>为什么要这么设计呢？</strong></p> <blockquote><p>为了管控和安全，微信小程序阻止开发者使用一些浏览器提供的，诸如跳转页面、操作 DOM、动态执行脚本的开放性接口。将逻辑层与视图层进行分离，视图层和逻辑层之间只有数据的通信，可以防止开发者随意操作界面，更好的保证了用户数据安全。</p></blockquote> <p>微信小程序视图层是 WebView，逻辑层是 JS 引擎。三端的脚本执行环境以及用于渲染非原生组件的环境是各不相同的：</p> <table><thead><tr><th style="text-align:center">运行环境</th> <th style="text-align:center">逻辑层</th> <th style="text-align:center">渲染层</th></tr></thead> <tbody><tr><td style="text-align:center">Android</td> <td style="text-align:center">V8</td> <td style="text-align:center">Chromium 定制内核</td></tr> <tr><td style="text-align:center">iOS</td> <td style="text-align:center">JavaScriptCore</td> <td style="text-align:center">WKWebView</td></tr> <tr><td style="text-align:center">小程序开发者工具</td> <td style="text-align:center">NWJS</td> <td style="text-align:center">Chrome WebView</td></tr></tbody></table> <p>我们看一下单 WebView 实例与小程序双线程多实例下代码执行的差异点。</p> <p><img src="/assets/img/double-thread.811619b1.png" alt></p> <p>单 WebView 模式下，Page 视图与 App 逻辑共享同一个 JSContext，这样所有的页面可以共享全局的数据和方法，能够实现全局的状态管理。多 WebView 模式下，每一个 WebView 都有一个独立的 JSContext，虽然可以通过窗口通信实现数据传递，但是无法共享数据和方法，对于全局的状态管理也相对比较复杂，抽离一个通用的 WebView 或者 JS Engine 作为应用的 JSContext 就可以解决这些问题，但是同时引入了其他问题：视图和逻辑如何通信，在小程序里面数据更新后视图是异步更新的。</p> <p>双线程交互的生命周期图示：</p> <p><img src="/assets/img/lifecycle.45dd5c41.png" alt></p> <h2 id="开发工具">开发工具</h2> <p>微信开发者工具是基于 <code>NW.js</code> 构建，主要由工具栏、模拟器、编辑器、调试器四大部分组成。通过 <strong>微信开发者工具</strong> =&gt; <strong>调试</strong> =&gt; <strong>调试微信微信开发者工具</strong> 可以打开小程序 IDE DevTools 面板。通过 DevTools 审查我们可以发现模拟器是通过 WebView 展示页面。微信小程序是双线程的设计，所以存在视图层和逻辑层两个 WebView。</p> <h3 id="调试逻辑层">调试逻辑层</h3> <p>在微信开发者工具中，Workbench 的 DevTools 调试器默认与模拟器逻辑层连接，所以 DevTools 中的 Console 面板进行输入 JS 脚本，JS 脚本实际的执行环境是逻辑层的 JS Context，对于逻辑层的调试，可以直接在调试器中进行。编译运行你的小程序项目，然后打开控制台，输入 <code>document</code> 并回车，就可以看到小程序逻辑层 WebView，如下图：</p> <p><img src="/assets/img/appservice-webview.62ee73c1.png" alt></p> <h3 id="调试视图层">调试视图层</h3> <p>模拟器视图层 WebView 的就相对逻辑层麻烦一些，需要在 IDE 的 DevTools 下中注入 JS 打开视图层 WebView 的 DevTools。</p> <p>IDE DevTools 面板的 Console Panel 输入：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 查找 WebView 元素</span>
<span class="token function">$$</span><span class="token punctuation">(</span><span class="token string">'webview'</span><span class="token punctuation">)</span>
<span class="token comment">// 打开 视图层 WebView DevTools</span>
<span class="token function">$$</span><span class="token punctuation">(</span><span class="token string">'webview'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">showDevTools</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre></div><p>然后就可以在视图层 WebView 的 DevTools 中进行调试了。</p> <p><img src="/assets/img/pageframe-webview.0257377b.png" alt></p> <h3 id="逆向技巧">逆向技巧</h3> <h4 id="获取基础库">获取基础库</h4> <p>我们如何能够拿到视图层和逻辑层 WebView 加载的文件呢？</p> <ul><li>基于 Sources 面板的 Save AS 功能获取代码</li></ul> <p><img src="/assets/img/sources-save-as.ef04d1fc.png" alt></p> <ul><li>基于开发者工具内置命令 <code>openVendor()</code> 找到 .wxvpkg 包获取代码</li></ul> <p>在开发者工具中使用 <code>help()</code> 方法，可以查看一些指令和方法。</p> <p><img src="/assets/img/help-command.1046d833.png" alt></p> <p><code>openVendor</code> 命令可以打开微信开发者工具在小程序框架所在目录。我们可以在微信小程序 IDE 控制台输入 openVendor 命令，可以打开微信小程序开发工具的资源目录：</p> <p><img src="/assets/img/openVendor.e285fda9.png" alt></p> <p>我们可以看到有 <code>wcc</code>、<code>wcsc</code>，小程序各版本的基础库包 <code>.wxvpkg</code>。<code>.wxvpkg</code> 文件可以使用 <a href="https://github.com/leo9960/wechat-app-unpack" target="_blank" rel="noopener noreferrer">wechat-app-unpack<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 解开，解开后里面就是 <code>WAService.js</code> 和 <code>WAWebView.js</code> 等代码。</p> <ul><li>利用 <a href="https://github.com/iBotPeaches/Apktool" target="_blank" rel="noopener noreferrer">apktool<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 反编译微信客户端</li></ul> <p>我们可以找到 <code>wxa_library</code> 文件夹，这个和上面微信开发工具中 <code>.wxvpkg</code> 包解开的结构很类似，这就是小程序的基础库。</p> <h4 id="反编译代码">反编译代码</h4> <ul><li>利用 <a href="https://github.com/leo9960/wechat-app-unpack" target="_blank" rel="noopener noreferrer">wechat-app-unpack<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 模块解包</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>python2 unwxapkg<span class="token punctuation">.</span>py <span class="token punctuation">[</span>filename<span class="token punctuation">]</span>
</code></pre></div><p>解开后的目录结构：</p> <p><img src="/assets/img/wxvpkg.5dababcc.png" alt></p> <p>客户端中的 .wxvpkg 包比 IDE WeappVendor 文件夹下的包多一些文件。</p> <ul><li>利用 <a href="https://www.npmjs.com/package/js-beautify" target="_blank" rel="noopener noreferrer">js-beautify<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 美化代码</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>find <span class="token punctuation">.</span> <span class="token operator">-</span>type f <span class="token operator">-</span>name <span class="token string">'*.js'</span> <span class="token operator">-</span>exec js<span class="token operator">-</span>beautify <span class="token operator">-</span>r <span class="token operator">-</span>s <span class="token number">2</span> <span class="token operator">-</span>p <span class="token operator">-</span>f <span class="token string">'{}'</span> \<span class="token punctuation">;</span>
</code></pre></div><ul><li>利用 <a href="http://jsnice.org" target="_blank" rel="noopener noreferrer">jsnice<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 美化代码</li></ul> <p><img src="/assets/img/jsnice.6762a3c8.png" alt></p> <p>关于代码的逆向还原细节本文暂不做详细介绍，后面专门写文章展开讲解。</p> <h2 id="基础库">基础库</h2> <h3 id="整体架构">整体架构</h3> <p>小程序的基础库是 JavaScript 编写的，基础库提供组件和 API，处理数据绑定、组件系统、事件系统、通信系统等一系列框架逻辑，可以被注入到渲染层和逻辑层运行。在渲染层可以用各类组件组建界面的元素，在逻辑层可以用各类 API 来处理各种逻辑。PageView 可以是 WebView、React-Native-Like、Flutter 来渲染，详细架构设计可以参考：<a href="https://ppt.geekbang.org/slide/show?cid=42&pid=2338" target="_blank" rel="noopener noreferrer">基于小程序技术栈的微信客户端跨平台实践<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p><img src="/assets/img/weapp-architecture.7e7b2004.png" alt></p> <p>小程序的基础库主要分为：</p> <ul><li>WAWebview：小程序视图层基础库，提供视图层基础能力</li> <li>WAService：小程序逻辑层基础库，提供逻辑层基础能力</li></ul> <p>微信小程序基础库更新过程可能会对基础库有些变更，下面就 v2.10.4 版本对基础库进行分析：</p> <h3 id="wawebview-源码结构">WAWebview 源码结构</h3> <p>借助于 VS Code 折叠功能，将基础库中 WAWebview 文件美化后，并且进行必要的模块结构拆分，可以看到代码主要结构如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> __wxLibrary <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">fileName</span><span class="token operator">:</span> <span class="token string">'WAWebview.js'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">envType</span><span class="token operator">:</span> <span class="token string">'WebView'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">contextType</span><span class="token operator">:</span> <span class="token string">'others'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">execStart</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> __WAWebviewStartTime__ <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> __libVersionInfo__ <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string-property property">&quot;updateTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2020.4.4 10:25:02&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2.10.4&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * core-js 模块
 */</span>
<span class="token operator">!</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">,</span> o<span class="token punctuation">,</span> Ye</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> n <span class="token operator">=</span> <span class="token function">i</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      o <span class="token operator">=</span> <span class="token string">&quot;__core-js_shared__&quot;</span><span class="token punctuation">,</span>
      r <span class="token operator">=</span> n<span class="token punctuation">[</span>o<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>n<span class="token punctuation">[</span>o<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    e<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> r<span class="token punctuation">[</span>e<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>r<span class="token punctuation">[</span>e<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> __wxConfig<span class="token punctuation">;</span>
<span class="token keyword">var</span> __wxTest__ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">wxRunOnDebug</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">e</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 基础模块
 */</span>
<span class="token keyword">var</span> <span class="token function-variable function">Foundation</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">nativeTrans</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 消息通信模块
 */</span>
<span class="token keyword">var</span> <span class="token function-variable function">WeixinJSBridge</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 监听 nativeTrans 相关事件
 */</span>
<span class="token operator">!</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 解析配置
 */</span>
<span class="token operator">!</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  __wxConfig <span class="token operator">=</span> <span class="token function">_</span><span class="token punctuation">(</span>__wxConfig<span class="token punctuation">)</span><span class="token punctuation">,</span> __wxConfig <span class="token operator">=</span> <span class="token function">v</span><span class="token punctuation">(</span>__wxConfig<span class="token punctuation">)</span><span class="token punctuation">,</span> Foundation<span class="token punctuation">.</span><span class="token function">onConfigReady</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">m</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> n <span class="token operator">?</span> __wxConfig<span class="token punctuation">.</span>__readyHandler <span class="token operator">=</span> <span class="token constant">A</span> <span class="token operator">:</span> d <span class="token operator">?</span> Foundation<span class="token punctuation">.</span><span class="token function">onBridgeReady</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    WeixinJSBridge<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;onWxConfigReady&quot;</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">:</span> Foundation<span class="token punctuation">.</span><span class="token function">onLibraryReady</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 异常捕获（error、onunhandledrejection）
 */</span>
<span class="token operator">!</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Foundation<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;unhandledRejection&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">||</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Uncaught (in promise)&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>reason<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token string">&quot;object&quot;</span> <span class="token operator">==</span> <span class="token keyword">typeof</span> e <span class="token operator">&amp;&amp;</span> <span class="token string">&quot;function&quot;</span> <span class="token operator">==</span> <span class="token keyword">typeof</span> e<span class="token punctuation">.</span>addEventListener <span class="token operator">?</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;unhandledrejection&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">t</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">reason</span><span class="token operator">:</span> e<span class="token punctuation">.</span>reason<span class="token punctuation">,</span>
      <span class="token literal-property property">promise</span><span class="token operator">:</span> e<span class="token punctuation">.</span>promise
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> t<span class="token punctuation">;</span>
    t <span class="token operator">=</span> e<span class="token punctuation">.</span>error<span class="token punctuation">,</span> Foundation<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span> <span class="token operator">||</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Uncaught&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token operator">===</span> e<span class="token punctuation">.</span>onunhandledrejection <span class="token operator">&amp;&amp;</span> Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token string">&quot;onunhandledrejection&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">value</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">t</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">reason</span><span class="token operator">:</span> <span class="token punctuation">(</span>e <span class="token operator">=</span> e <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reason<span class="token punctuation">,</span>
        <span class="token literal-property property">promise</span><span class="token operator">:</span> e<span class="token punctuation">.</span>promise
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 原生缓冲区
 */</span>
<span class="token keyword">var</span> <span class="token function-variable function">NativeBuffer</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> WeixinNativeBuffer <span class="token operator">=</span> NativeBuffer<span class="token punctuation">;</span>
<span class="token keyword">var</span> NativeBuffer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 日志模块：wxConsole、wxPerfConsole、wxNativeConsole、__webviewConsole__
 */</span>
<span class="token keyword">var</span> wxConsole <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;log&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;info&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;warn&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;debug&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;time&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;timeEnd&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;group&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;groupEnd&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> t</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> e<span class="token punctuation">[</span>t<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> e
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> wxPerfConsole <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;log&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;info&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;warn&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;time&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;timeEnd&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;trace&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;profile&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;profileSync&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> t</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> e<span class="token punctuation">[</span>t<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> e
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">wxNativeConsole</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">__webviewConsole__</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 上报模块
 */</span>
<span class="token keyword">var</span> <span class="token function-variable function">Reporter</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> <span class="token constant">L</span><span class="token punctuation">,</span> <span class="token constant">O</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">Perf</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>

<span class="token comment">/**
 * 视图层 API
 */</span>
<span class="token keyword">var</span> <span class="token function-variable function">__webViewSDK__</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> <span class="token constant">L</span><span class="token punctuation">,</span> <span class="token constant">O</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>
<span class="token keyword">var</span> wx <span class="token operator">=</span> __webViewSDK__<span class="token punctuation">.</span>wx<span class="token punctuation">;</span>

<span class="token comment">/**
 * 组件系统
 */</span>
<span class="token keyword">var</span> <span class="token function-variable function">exparser</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 框架粘合层
 * 
 * 使用 exparser.registerBehavior 和 exparser.registerElement 方法注册内置组件
 * 转发 window、wx 对象上到事件转发到 exparser
 */</span>
<span class="token operator">!</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> t</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> t</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> t</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Virtual DOM 
 */</span>
<span class="token keyword">var</span> __virtualDOMDataThread__ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token function-variable function">__virtualDOM__</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * __webviewEngine__
 */</span>
<span class="token keyword">var</span> <span class="token function-variable function">__webviewEngine__</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 注入默认样式到页面
 */</span>
<span class="token operator">!</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token keyword">function</span> <span class="token function">e</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">var</span> e <span class="token operator">=</span> <span class="token function">i</span><span class="token punctuation">(</span><span class="token string">'...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    __wxConfig<span class="token punctuation">.</span>isReady <span class="token operator">?</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token operator">!==</span> __wxConfig<span class="token punctuation">.</span>theme <span class="token operator">&amp;&amp;</span> <span class="token function">i</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> e<span class="token punctuation">.</span>nextElementSibling<span class="token punctuation">)</span> <span class="token operator">:</span> __wxConfig<span class="token punctuation">.</span><span class="token function">onReady</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">void</span> <span class="token number">0</span> <span class="token operator">!==</span> __wxConfig<span class="token punctuation">.</span>theme <span class="token operator">&amp;&amp;</span> <span class="token function">i</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> e<span class="token punctuation">.</span>nextElementSibling<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  window<span class="token punctuation">.</span>document <span class="token operator">&amp;&amp;</span> <span class="token string">&quot;complete&quot;</span> <span class="token operator">===</span> window<span class="token punctuation">.</span>document<span class="token punctuation">.</span>readyState <span class="token operator">?</span> <span class="token function">e</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> window<span class="token punctuation">.</span>onload <span class="token operator">=</span> e
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> __WAWebviewEndTime__ <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">typeof</span> __wxLibrary<span class="token punctuation">.</span>onEnd <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> __wxLibrary<span class="token punctuation">.</span><span class="token function">onEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
__wxLibrary <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
</code></pre></div><p>WAWebview 主要由以下几个部分组件：</p> <ul><li><code>Foundation</code>: 基础模块</li> <li><code>WeixinJSBridge</code>: 消息通信模块</li> <li><code>exparser</code>: 组件系统模块</li> <li><code>__virtualDOM__</code>: Virtual DOM 模块</li> <li><code>__webViewSDK__</code>: WebView SDK 模块</li> <li><code>Reporter</code>: 日志上报模块(异常和性能统计数据)</li></ul> <h3 id="waservice-源码结构">WAService 源码结构</h3> <p>WAService 的整体结构如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> __wxLibrary <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">fileName</span><span class="token operator">:</span> <span class="token string">'WAService.js'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">envType</span><span class="token operator">:</span> <span class="token string">'Service'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">contextType</span><span class="token operator">:</span> <span class="token string">'App:Uncertain'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">execStart</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> __WAServiceStartTime__ <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">global</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> __exportGlobal__ <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> __libVersionInfo__ <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;updateTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2020.4.4 10:25:02&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2.10.4&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> __Function__ <span class="token operator">=</span> global<span class="token punctuation">.</span>Function<span class="token punctuation">;</span>
  <span class="token keyword">var</span> Function <span class="token operator">=</span> __Function__<span class="token punctuation">;</span>

  <span class="token comment">/**
   * core-js 模块
   */</span>
  <span class="token operator">!</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">r<span class="token punctuation">,</span> o<span class="token punctuation">,</span> Ke</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> __wxTest__ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> <span class="token function-variable function">wxRunOnDebug</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">e</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> __wxConfig<span class="token punctuation">;</span>
  <span class="token comment">/**
   * 基础模块
   */</span>
  <span class="token keyword">var</span> <span class="token function-variable function">Foundation</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>

  <span class="token keyword">var</span> <span class="token function-variable function">nativeTrans</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * 消息通信模块
   */</span>
  <span class="token keyword">var</span> <span class="token function-variable function">WeixinJSBridge</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * 监听 nativeTrans 相关事件
   */</span>
  <span class="token operator">!</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * 解析配置
   */</span>
  <span class="token operator">!</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * 异常捕获（error、onunhandledrejection）
   */</span>
  <span class="token operator">!</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * 原生缓冲区
   */</span>
  <span class="token keyword">var</span> <span class="token function-variable function">NativeBuffer</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  WeixinNativeBuffer <span class="token operator">=</span> NativeBuffer<span class="token punctuation">;</span>
  NativeBuffer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> wxConsole <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;log&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;info&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;warn&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;debug&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;time&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;timeEnd&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;group&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;groupEnd&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> t</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> e<span class="token punctuation">[</span>t<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> e
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> wxPerfConsole <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;log&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;info&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;warn&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;time&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;timeEnd&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;trace&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;profile&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;profileSync&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> t</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> e<span class="token punctuation">[</span>t<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> e
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> <span class="token function-variable function">wxNativeConsole</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Worker 模块
   */</span>
  <span class="token keyword">var</span> <span class="token function-variable function">WeixinWorker</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * JSContext
   */</span>
  <span class="token keyword">var</span> <span class="token function-variable function">JSContext</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>

  <span class="token keyword">var</span> <span class="token function-variable function">__appServiceConsole__</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> <span class="token constant">N</span><span class="token punctuation">,</span> <span class="token constant">R</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>

  <span class="token keyword">var</span> <span class="token function-variable function">Protect</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> <span class="token function-variable function">Reporter</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> <span class="token constant">N</span><span class="token punctuation">,</span> <span class="token constant">R</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>

  <span class="token keyword">var</span> <span class="token function-variable function">__subContextEngine__</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> <span class="token function-variable function">__waServiceInit__</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">__doWAServiceInit__</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> e<span class="token punctuation">;</span>
    <span class="token string">&quot;undefined&quot;</span> <span class="token operator">!=</span> <span class="token keyword">typeof</span> wx <span class="token operator">&amp;&amp;</span> wx<span class="token punctuation">.</span>version <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>e <span class="token operator">=</span> wx<span class="token punctuation">.</span>version<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">__waServiceInit__</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e <span class="token operator">&amp;&amp;</span> <span class="token string">&quot;undefined&quot;</span> <span class="token operator">!=</span> <span class="token keyword">typeof</span> __exportGlobal__ <span class="token operator">&amp;&amp;</span> __exportGlobal__<span class="token punctuation">.</span>wx <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>__exportGlobal__<span class="token punctuation">.</span>wx<span class="token punctuation">.</span>version <span class="token operator">=</span> e<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  __subContextEngine__<span class="token punctuation">.</span><span class="token function">isIsolateContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  __subContextEngine__<span class="token punctuation">.</span><span class="token function">isIsolateContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">__doWAServiceInit__</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  __subContextEngine__<span class="token punctuation">.</span><span class="token function">initAppRelatedContexts</span><span class="token punctuation">(</span>__exportGlobal__<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> __WAServiceEndTime__ <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">typeof</span> __wxLibrary<span class="token punctuation">.</span>onEnd <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> __wxLibrary<span class="token punctuation">.</span><span class="token function">onEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
__wxLibrary <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
</code></pre></div><p>WAService 基本组成：</p> <ul><li><code>Foundation</code>: 基础模块</li> <li><code>WeixinJSBridge</code>: 消息通信模块</li> <li><code>WeixinNativeBuffer</code>: 原生 <code>Buffer</code></li> <li><code>WeixinWorker</code>: <code>Worker</code> 线程</li> <li><code>JSContext</code>: JS Engine Context</li> <li><code>Protect</code>: JS 保护的对象</li> <li><code>__subContextEngine__</code>: 提供 <code>App</code>、<code>Page</code>、<code>Component</code>、<code>Behavior</code>、<code>getApp</code>、<code>getCurrentPages</code> 等方法</li></ul> <h3 id="foundation-模块">Foundation 模块</h3> <p>基础模块提供环境变量 env、发布订阅 EventEmitter、配置/基础库/通信桥 Ready 事件。</p> <p><img src="/assets/img/foundation.0c3bdadf.png" alt></p> <h3 id="exparser-模块">Exparser 模块</h3> <p>小程序的视图是在 WebView 里渲染的，为解决管控与安全，小程序里面不能使用 Web 组件和动态执行 JavaScript。Exparser 是微信小程序的组件组织框架，内置在小程序基础库中，为小程序的各种组件提供基础的支持。小程序内的所有组件，包括内置组件和自定义组件，都由 Exparser 组织管理。Exparser 的组件模型与 WebComponents 标准中的 ShadowDOM 高度相似。Exparser 会维护整个页面的节点树相关信息，包括节点的属性、事件绑定等，相当于一个简化版的 Shadow DOM 实现。</p> <p>Exparser 的主要特点包括以下几点：</p> <ul><li>基于 Shadow DOM 模型：模型上与 WebComponents 的 ShadowDOM 高度相似，但不依赖浏览器的原生支持，也没有其他依赖库；实现时，还针对性地增加了其他 API 以支持小程序组件编程。</li> <li>可在纯 JS 环境中运行：这意味着逻辑层也具有一定的组件树组织能力。</li> <li>高效轻量：性能表现好，在组件实例极多的环境下表现尤其优异，同时代码尺寸也较小。</li></ul> <p>小程序中，所有节点树相关的操作都依赖于 Exparser，包括 WXML 到页面最终节点树的构建、createSelectorQuery 调用和自定义组件特性等。</p> <h3 id="virtual-dom-模块">Virtual DOM 模块</h3> <p>Virtual DOM 模块提供了如下几个方法：</p> <p><img src="/assets/img/virtualdom-object.1fc4be47.png" alt></p> <p>接口与 <a href="https://github.com/Matt-Esch/virtual-dom" target="_blank" rel="noopener noreferrer">virtual-dom<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 类似，这里特别的地方在于它所 diff 和生成的并不是原生 DOM，而是各种模拟了 DOM 接口的 wx- element 对象。</p> <h3 id="weixinjsbridge-模块">WeixinJSBridge 模块</h3> <p>WeixinJSBridge 提供了视图层 JS 与 Native、视图层与逻辑层之间消息通信的机制，提供了如下几个方法:</p> <table><thead><tr><th style="text-align:center">方法名</th> <th style="text-align:center">作用</th></tr></thead> <tbody><tr><td style="text-align:center">invoke</td> <td style="text-align:center">JS 调用 Native API</td></tr> <tr><td style="text-align:center">invokeCallbackHandler</td> <td style="text-align:center">Native 传递 invoke 方法回调结果</td></tr> <tr><td style="text-align:center">on</td> <td style="text-align:center">JS 监听 Native 消息</td></tr> <tr><td style="text-align:center">publish</td> <td style="text-align:center">视图层发布消息</td></tr> <tr><td style="text-align:center">subscribe</td> <td style="text-align:center">订阅逻辑层的消息</td></tr> <tr><td style="text-align:center">subscribeHandler</td> <td style="text-align:center">视图层和逻辑层消息订阅转发</td></tr> <tr><td style="text-align:center">setCustomPublishHandler</td> <td style="text-align:center">自定义消息转发</td></tr></tbody></table> <h2 id="编译原理">编译原理</h2> <p>微信开发者工具和微信客户端都无法直接运行小程序的源码，因此我们需要对小程序的源码进行编译。代码编译过程包括本地预处理、本地编译和服务器编译。为了快速预览，微信开发者工具模拟器运行的代码只经过本地预处理、本地编译，没有服务器编译过程，而微信客户端运行的代码是额外经过服务器编译的。</p> <p>微信官方提供了 <code>wcc</code> 和 <code>wcsc</code> 两个编译工具，<code>wcc</code> 编译器可以将 <code>wxml</code> 文件编译成 <code>JS</code> 文件，<code>wcsc</code> 编译器可以将 <code>wxss</code> 文件编译成 <code>JS</code> 文件。</p> <h3 id="编译-wxml">编译 WXML</h3> <p>我们这里一步步去研究微信官方编译器，先研究看看 wcc 做了什么事情。</p> <p>例如编译 wxml 为 JS：</p> <p>index.wxml:</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>window<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{ text }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>借助 <a href="https://www.npmjs.com/package/miniprogram-compiler" target="_blank" rel="noopener noreferrer">miniprogram-compiler<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 转化：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> miniprogramCompiler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;miniprogram-compiler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> compileResult <span class="token operator">=</span> miniprogramCompiler<span class="token punctuation">.</span><span class="token function">wxmlToJs</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">&quot;index.wxml.js&quot;</span><span class="token punctuation">,</span> compileResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>编译之后的代码为：</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span>__wcc_version__ <span class="token operator">=</span> <span class="token string">'v0.5vv_20181221_syb_scopedata'</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span>__wcc_version_info__ <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">customComponents</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">fixZeroRpx</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">propValueDeepCopy</span><span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> $gwxc<span class="token punctuation">;</span>
<span class="token keyword">var</span> $gaic <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function-variable function">$gwx</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> global</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
<span class="token keyword">return</span> $gwx<span class="token punctuation">;</span>
</code></pre></div><p>我们深入 <code>miniprogramCompiler.wxmlToJs</code> 源码最终会发现调用的是 <code>wcc</code>，这个正是微信开发工具下的编译工具。</p> <p>通过上述编译生存的代码我们发现，调用 <code>$gwx</code> 函数会再生成一个有返回值的函数，于是我们执行如下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">$gwx</span><span class="token punctuation">(</span><span class="token string">&quot;index.wxml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>得出如下内容：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;tag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;wx-page&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;children&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;tag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;wx-view&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;attr&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;children&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;tag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;wx-text&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;attr&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;class&quot;</span><span class="token operator">:</span> <span class="token string">&quot;window&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;children&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token property">&quot;raw&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;generics&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;raw&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;generics&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这是一个类似 Virtual DOM 的对象，交给了 WAWebivew 来渲染，标签名为 wx-view、wx-text。</p> <p>上面的 wx-text 是没有绑定数据的，那么上面的 Virtual DOM 是怎么变成真实的 DOM 呢？$gwx 是一个闭包函数，$gwx 函数第一个参数是 path，页面 wxml 文件的路径；global 参数应该是顶层对象。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">$gwx</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> global</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>path <span class="token operator">&amp;&amp;</span> e_<span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span>__wxml_comp_version__ <span class="token operator">=</span> <span class="token number">0.02</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">env<span class="token punctuation">,</span> dd<span class="token punctuation">,</span> global</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      $gwxc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> root <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">&quot;wx-page&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
      root<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> main <span class="token operator">=</span> e_<span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">.</span>f<span class="token punctuation">;</span>
      cs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> global <span class="token operator">===</span> <span class="token string">&quot;undefined&quot;</span><span class="token punctuation">)</span> global <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      global<span class="token punctuation">.</span>f <span class="token operator">=</span> <span class="token function">$gdc</span><span class="token punctuation">(</span>f_<span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token keyword">typeof</span> window<span class="token punctuation">.</span>__webview_engine_version__ <span class="token operator">!=</span> <span class="token string">&quot;undefined&quot;</span> <span class="token operator">&amp;&amp;</span>
        window<span class="token punctuation">.</span>__webview_engine_version__ <span class="token operator">+</span> <span class="token number">1e-6</span> <span class="token operator">&gt;=</span> <span class="token number">0.02</span> <span class="token operator">+</span> <span class="token number">1e-6</span> <span class="token operator">&amp;&amp;</span>
        window<span class="token punctuation">.</span>__mergeData__
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 合并 Data 数据</span>
        env <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">__mergeData__</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> dd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">main</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> root<span class="token punctuation">,</span> global<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">_tsd</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          <span class="token keyword">typeof</span> window<span class="token punctuation">.</span>__webview_engine_version__ <span class="token operator">==</span> <span class="token string">&quot;undefined&quot;</span> <span class="token operator">||</span>
          window<span class="token punctuation">.</span>__webview_engine_version__ <span class="token operator">+</span> <span class="token number">1e-6</span> <span class="token operator">&lt;</span> <span class="token number">0.01</span> <span class="token operator">+</span> <span class="token number">1e-6</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">_ev</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cs<span class="token punctuation">,</span> env<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> root<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>window.__webview_engine_version__</code> 大于等于 0.02 版本的使用 <code>window.__mergeData__</code> 进行数据 merge，这里可以推测 dd 参数是新数据，env 是当前数据。这里的 <code>window.__mergeData__</code> 是在 WAWebview 中定义的：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token constant">E</span> <span class="token operator">=</span> window<span class="token punctuation">.</span>__virtualDOM__<span class="token punctuation">;</span>
<span class="token operator">...</span>
window<span class="token punctuation">.</span>__mergeData__ <span class="token operator">=</span> <span class="token constant">E</span><span class="token punctuation">.</span><span class="token function">getMergeDataFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这里的 <code>window.__virtualDOM__</code> 是基础库中 Virtual DOM 的实现。</p> <p>如果我们直接执行下面的代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// $gwx 是 WXML 编译后得到的函数，根据页面路径获取页面结构生成函数</span>
<span class="token keyword">const</span> generateFunction <span class="token operator">=</span> <span class="token function">$gwx</span><span class="token punctuation">(</span><span class="token string">&quot;pages/index/index.wxml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> virtualTree <span class="token operator">=</span> <span class="token function">generateFunction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'Hello World'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>virtualTree<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>可以得到如下的 Virtual DOM 结构：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string-property property">&quot;tag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;wx-page&quot;</span><span class="token punctuation">,</span>
  <span class="token string-property property">&quot;children&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string-property property">&quot;tag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;wx-view&quot;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;attr&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;children&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token string-property property">&quot;tag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;wx-text&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;attr&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string-property property">&quot;class&quot;</span><span class="token operator">:</span> <span class="token string">&quot;name&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;children&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;raw&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;generics&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;raw&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;generics&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>setData 的机制如下：</p> <p><img src="/assets/img/miniprogram-virtual-dom.eca4c9b6.jpeg" alt></p> <h2 id="通信原理">通信原理</h2> <p>小程序逻辑层和渲染层的通信会由 Native （微信客户端）做中转，逻辑层发送网络请求也经由 Native 转发。</p> <p><strong>视图层组件</strong>:</p> <p>内置组件中有部分组件是利用到客户端原生提供的能力，既然需要客户端原生提供的能力，那就会涉及到视图层与客户端的交互通信。这层通信机制在 iOS 和安卓系统的实现方式并不一样，iOS 是利用了 WKWebView 的提供 messageHandlers 特性，而在安卓则是往 WebView 的 window 对象注入一个原生方法，最终会封装成 WeiXinJSBridge 这样一个兼容层，主要提供了调用（invoke）和监听（on）这两种方法。</p> <p>我们知道微信小程序逻辑层没有浏览器的 DOM/BOM，视图层的更新借助于 Virtual DOM。用 JS 对象模拟 DOM 树 -&gt; 比较两棵虚拟 DOM 树的差异 -&gt; 把差异应用到真正的 DOM 树上，状态更新的时候，通过对比前后 JS 对象变化，进而改变视图层的 Dom 树。实际上，在视图层与客户端的交互通信中，开发者只是间接调用的，真正调用是在组件的内部实现中。开发者插入一个原生组件，一般而言，组件运行的时候被插入到 DOM 树中，会调用客户端接口，通知客户端在哪个位置渲染一块原生界面。在后续开发者更新组件属性时，同样地，也会调用客户端提供的更新接口来更新原生界面的某些部分。</p> <p><strong>逻辑层接口</strong>:</p> <p>逻辑层与客户端原生通信机制与渲染层类似，不同在于，iOS 平台可以往 JavaScripCore 框架注入一个全局的原生方法，而安卓方面则是跟渲染层一致的。</p> <p>同样地，开发者也是间接地调用到与客户端原生通信的底层接口。一般我们会对逻辑层接口做层封装后才暴露给开发者，封装的细节可能是统一入参、做些参数校验、兼容各平台或版本问题等等。</p> <h2 id="启动流程">启动流程</h2> <p>通过分析 <code>WAPageFrame.html</code> 文件，我们可以得到小程序的启动执行流程大致如下：</p> <p><img src="/assets/img/wxapp-booting.9417b39b.png" alt></p> <p><strong>第一步：初始化全局变量</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> __wxRoute<span class="token punctuation">,</span>
  __wxRouteBegin<span class="token punctuation">,</span>
  __wxAppCurrentFile__<span class="token punctuation">,</span>
  __wxAppData <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  __wxAppCode__ <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  __vd_version_info__ <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">Behavior</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">definePlugin</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">requirePlugin</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
global <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> $gwx<span class="token punctuation">,</span>
  __workerVendorCode__ <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  __workersCode__ <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  __WeixinWorker <span class="token operator">=</span> <span class="token punctuation">(</span>WeixinWorker <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> __wxConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> __devtoolsConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><code>__wxRoute</code>: 用于指向当前正在加载的页面路径</li> <li><code>__wxRouteBegin</code>: 用于标志 Page 的正确注册</li> <li><code>__wxAppCurrentFile__</code>: 用于指向当前正在加载的 JS 文件</li> <li><code>__wxAppData</code>: 小程序每个页面的 data 域对象，如下：</li> <li><code>__wxAppCode__</code>: 在开发者工具中分为两类值，<code>json</code> 类型和 <code>wxml</code> 类型。以 <code>.json</code> 结尾的，其 <code>key</code> 值为开发者代码中对应的 <code>json</code> 文件的内容，<code>.wxml</code> 结尾的，其 key 值为通过调用 <code>$gwx('./pages/index/index.wxml')</code> 将得到一个可执行函数，通过调用这个函数可得到一个标识节点关系的 JSON 树。</li> <li><code>Component</code>: 自定义组件构造器</li> <li><code>Behavior</code>: 自定义组件 behavior 构造器</li> <li><code>definePlugin</code>: 自定义插件的构造器</li> <li><code>global</code>: 全局对象</li> <li><code>__WeixinWorker</code>: 多线程构造器</li> <li><code>__wxConfig</code>: 对象是根据全局配置和页面配置生成的配置对象，如下：</li></ul> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;pages&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;pages/index/index&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pages/logs/logs&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;resizable&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">&quot;debug&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">&quot;widgets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;customClose&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">&quot;workers&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;navigateToMiniProgramAppIdList&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;cloud&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">&quot;global&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;window&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;backgroundTextStyle&quot;</span><span class="token operator">:</span> <span class="token string">&quot;light&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;navigationBarBackgroundColor&quot;</span><span class="token operator">:</span> <span class="token string">&quot;#fff&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;navigationBarTitleText&quot;</span><span class="token operator">:</span> <span class="token string">&quot;WeChat&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;navigationBarTextStyle&quot;</span><span class="token operator">:</span> <span class="token string">&quot;black&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;page&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;pages/index/index.html&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;window&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;usingComponents&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;pages/logs/logs.html&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;window&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;navigationBarTitleText&quot;</span><span class="token operator">:</span> <span class="token string">&quot;查看启动日志&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;usingComponents&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;networkTimeout&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;request&quot;</span><span class="token operator">:</span> <span class="token number">60000</span><span class="token punctuation">,</span>
    <span class="token property">&quot;uploadFile&quot;</span><span class="token operator">:</span> <span class="token number">60000</span><span class="token punctuation">,</span>
    <span class="token property">&quot;connectSocket&quot;</span><span class="token operator">:</span> <span class="token number">60000</span><span class="token punctuation">,</span>
    <span class="token property">&quot;downloadFile&quot;</span><span class="token operator">:</span> <span class="token number">60000</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;ext&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;extAppid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;mainPlugins&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;__warning__&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;entryPagePath&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pages/index/index.html&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;tabBar&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;list&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;appType&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;urlCheck&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;wxAppInfo&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;maxRequestConcurrent&quot;</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token property">&quot;maxUploadConcurrent&quot;</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token property">&quot;maxDownloadConcurrent&quot;</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token property">&quot;maxWorkerConcurrent&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;accountInfo&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;appId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;nickname&quot;</span><span class="token operator">:</span> <span class="token string">&quot;赞同技术&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;icon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;platform&quot;</span><span class="token operator">:</span> <span class="token string">&quot;devtools&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;appLaunchInfo&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;scene&quot;</span><span class="token operator">:</span> <span class="token number">1001</span><span class="token punctuation">,</span> <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pages/index/index&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;env&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;USER_DATA_PATH&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://usr&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;envVersion&quot;</span><span class="token operator">:</span> <span class="token string">&quot;develop&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>第二步：加载框架（WAService.js）</strong></p> <p>我们调用的 API 等核心主要是 <code>__waServiceInit__</code> 部分，主要结构如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">__waServiceInit__</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> <span class="token function-variable function">bta</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function-variable function">cta</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">,</span>
    dta <span class="token operator">=</span> cta<span class="token punctuation">.</span>wx<span class="token punctuation">;</span>

  <span class="token string">&quot;undefined&quot;</span> <span class="token operator">!=</span> <span class="token keyword">typeof</span> __exportGlobal__ <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>__exportGlobal__<span class="token punctuation">.</span>wx <span class="token operator">=</span> dta<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> <span class="token function-variable function">eta</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function-variable function">gta</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function-variable function">hta</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> t<span class="token punctuation">,</span> n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  hta<span class="token punctuation">.</span>Page<span class="token punctuation">,</span> hta<span class="token punctuation">.</span>Component<span class="token punctuation">,</span> hta<span class="token punctuation">.</span>Behavior<span class="token punctuation">,</span> hta<span class="token punctuation">.</span>App<span class="token punctuation">,</span> hta<span class="token punctuation">.</span>getApp<span class="token punctuation">,</span> hta<span class="token punctuation">.</span>getCurrentPages<span class="token punctuation">;</span>
  <span class="token string">&quot;undefined&quot;</span> <span class="token operator">!=</span> <span class="token keyword">typeof</span> __exportGlobal__ <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>
    __exportGlobal__<span class="token punctuation">.</span>Page <span class="token operator">=</span> hta<span class="token punctuation">.</span>Page<span class="token punctuation">,</span>
    __exportGlobal__<span class="token punctuation">.</span>Component <span class="token operator">=</span> hta<span class="token punctuation">.</span>Component<span class="token punctuation">,</span>
    __exportGlobal__<span class="token punctuation">.</span>Behavior <span class="token operator">=</span> hta<span class="token punctuation">.</span>Behavior<span class="token punctuation">,</span>
    __exportGlobal__<span class="token punctuation">.</span>__webview_engine_version__ <span class="token operator">=</span> <span class="token number">.02</span><span class="token punctuation">,</span>
    __exportGlobal__<span class="token punctuation">.</span>App <span class="token operator">=</span> hta<span class="token punctuation">.</span>App<span class="token punctuation">,</span>
    __exportGlobal__<span class="token punctuation">.</span>getApp <span class="token operator">=</span> hta<span class="token punctuation">.</span>getApp<span class="token punctuation">,</span>
    __exportGlobal__<span class="token punctuation">.</span>getCurrentPages <span class="token operator">=</span> hta<span class="token punctuation">.</span>getCurrentPages<span class="token punctuation">,</span>
    __exportGlobal__<span class="token punctuation">.</span>__pageComponent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> <span class="token function-variable function">qta</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    qta<span class="token punctuation">.</span>definePlugin<span class="token punctuation">,</span> qta<span class="token punctuation">.</span>requirePlugin<span class="token punctuation">;</span>

  <span class="token comment">// 定义 define require 方法</span>
  <span class="token operator">!</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> tta <span class="token operator">=</span> require<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__exportGlobal__<span class="token punctuation">.</span>definePlugin <span class="token operator">=</span> qta<span class="token punctuation">.</span>definePlugin<span class="token punctuation">,</span>
    __exportGlobal__<span class="token punctuation">.</span>requirePlugin <span class="token operator">=</span> qta<span class="token punctuation">.</span>requirePlugin<span class="token punctuation">,</span>
    <span class="token string">&quot;function&quot;</span> <span class="token operator">==</span> <span class="token keyword">typeof</span> __passWAServiceGlobal__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> uta <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    uta<span class="token punctuation">.</span>__appServiceEngine__ <span class="token operator">=</span> hta<span class="token punctuation">,</span>
    uta<span class="token punctuation">.</span>__appServiceSDK__ <span class="token operator">=</span> cta<span class="token punctuation">,</span>
    uta<span class="token punctuation">.</span>__virtualDOM__ <span class="token operator">=</span> gta<span class="token punctuation">,</span>
    uta<span class="token punctuation">.</span>__subContextEngine__ <span class="token operator">=</span> __subContextEngine__<span class="token punctuation">,</span>
    uta<span class="token punctuation">.</span>Reporter <span class="token operator">=</span> Reporter<span class="token punctuation">,</span>
    uta<span class="token punctuation">.</span>exparser <span class="token operator">=</span> eta<span class="token punctuation">,</span>
    uta<span class="token punctuation">.</span>WeixinJSBridge <span class="token operator">=</span> WeixinJSBridge<span class="token punctuation">,</span>
    uta<span class="token punctuation">.</span>Protect <span class="token operator">=</span> Protect<span class="token punctuation">,</span>
    <span class="token function">__passWAServiceGlobal__</span><span class="token punctuation">(</span>uta<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><code>__waServiceInit__</code> 中定义了框架核心对象，如：<code>__appServiceEngine__</code>、<code>__virtualDOM__</code>、<code>exparser</code>。其中<code>__appServiceEngine__</code> 提供了框架最基本的对外接口，如 <code>App</code>、<code>Page</code>、<code>Component</code>、<code>Behavior</code>、<code>getApp</code>、<code>getCurrentPages</code> 等方法；<code>exparser</code> 提供了框架底层的能力，如实例化组件，数据变化监听，View 层与逻辑层的交互等；<code>__virtualDOM__</code> 则起着连接 <code>__appServiceEngine__</code> 和 <code>exparser</code> 的作用，如对开发者传入 <code>Page</code> 方法的对象进行格式化再传入 <code>exparser</code> 的对应方法处理。</p> <p><strong>第三步：业务代码的加载</strong></p> <p>在小程序中，开发者的 JavaScript 代码会被打包为 AMD 规范的 JS 模块：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;pages/index/index.js&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>
  <span class="token parameter">require<span class="token punctuation">,</span>
  module<span class="token punctuation">,</span>
  exports<span class="token punctuation">,</span>
  window<span class="token punctuation">,</span>
  document<span class="token punctuation">,</span>
  frames<span class="token punctuation">,</span>
  self<span class="token punctuation">,</span>
  location<span class="token punctuation">,</span>
  navigator<span class="token punctuation">,</span>
  localStorage<span class="token punctuation">,</span>
  history<span class="token punctuation">,</span>
  Caches<span class="token punctuation">,</span>
  screen<span class="token punctuation">,</span>
  alert<span class="token punctuation">,</span>
  confirm<span class="token punctuation">,</span>
  prompt<span class="token punctuation">,</span>
  fetch<span class="token punctuation">,</span>
  XMLHttpRequest<span class="token punctuation">,</span>
  WebSocket<span class="token punctuation">,</span>
  webkit<span class="token punctuation">,</span>
  WeixinJSCore<span class="token punctuation">,</span>
  Reporter<span class="token punctuation">,</span>
  print<span class="token punctuation">,</span>
  <span class="token constant">URL</span><span class="token punctuation">,</span>
  DOMParser<span class="token punctuation">,</span>
  upload<span class="token punctuation">,</span>
  preview<span class="token punctuation">,</span>
  build<span class="token punctuation">,</span>
  showDecryptedInfo<span class="token punctuation">,</span>
  cleanAppCache<span class="token punctuation">,</span>
  syncMessage<span class="token punctuation">,</span>
  checkProxy<span class="token punctuation">,</span>
  showSystemInfo<span class="token punctuation">,</span>
  openVendor<span class="token punctuation">,</span>
  openToolsLog<span class="token punctuation">,</span>
  showRequestInfo<span class="token punctuation">,</span>
  help<span class="token punctuation">,</span>
  showDebugInfoTable<span class="token punctuation">,</span>
  closeDebug<span class="token punctuation">,</span>
  showDebugInfo<span class="token punctuation">,</span>
  __global<span class="token punctuation">,</span>
  loadBabelMod<span class="token punctuation">,</span>
  WeixinJSBridge</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

  <span class="token comment">// index.js 代码</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>AMD</code> 规范接口，通过 <code>define</code> 定义一个模块，使用 <code>require</code> 来应用一个模块。上面说了 <code>WAService</code> 里定义了两个方法：<code>require</code> 和 <code>define</code> 用来定义和使用业务代码。首先 <code>define</code> 限制了模块可使用的其他模块，如 <code>window</code>，<code>document</code>；其次 <code>require</code> 在使用模块时只会传入 <code>require</code> 和 <code>module</code>，也就是说参数中的其他模块在定义的模块中都是 <code>undefined</code>，这也是不能在小程序中获取一些浏览器环境对象的原因。</p> <p>在小程序中，<code>JavaScript</code> 代码的加载方式和在浏览器中也有些不同，其加载顺序是首先加载项目中其他 js 文件（非注册程序和注册页面的 js 文件），其次是注册程序的 <code>app.js</code>，然后是自定义组件 js 文件，最后才是注册页面的 js 代码。而且小程序对于在 <code>app.js</code> 以及注册页面的 js 代码都会加载完成后立即使用 <code>require</code> 方法执行模块中的程序。其他的代码则需要在程序中使用 <code>require</code> 方法才会被执行。</p> <p><strong>第四步：加载 app.js 与注册程序</strong></p> <p>在 app.js 加载完成后，小程序会使用 <code>require('app.js')</code> 注册程序，即对 App 方法进行调用。App 方法是对 <code>__appServiceEngine__.App</code> 方法的引用。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 注册 app.js，初始化 App</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;app.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> decodePathName <span class="token operator">=</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span><span class="token string">&quot;pages/index/index&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
__wxAppCode__<span class="token punctuation">[</span>decodePathName <span class="token operator">+</span> <span class="token string">&quot;.json&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">usingComponents</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
__wxAppCode__<span class="token punctuation">[</span>decodePathName <span class="token operator">+</span> <span class="token string">&quot;.wxml&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">$gwx</span><span class="token punctuation">(</span><span class="token string">&quot;./&quot;</span> <span class="token operator">+</span> decodePathName <span class="token operator">+</span> <span class="token string">&quot;.wxml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> decodePathName <span class="token operator">=</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span><span class="token string">&quot;pages/logs/logs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
__wxAppCode__<span class="token punctuation">[</span>decodePathName <span class="token operator">+</span> <span class="token string">&quot;.json&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">navigationBarTitleText</span><span class="token operator">:</span> <span class="token string">&quot;查看启动日志&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">usingComponents</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
__wxAppCode__<span class="token punctuation">[</span>decodePathName <span class="token operator">+</span> <span class="token string">&quot;.wxml&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">$gwx</span><span class="token punctuation">(</span><span class="token string">&quot;./&quot;</span> <span class="token operator">+</span> decodePathName <span class="token operator">+</span> <span class="token string">&quot;.wxml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> decodePathName <span class="token operator">=</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span><span class="token string">&quot;pages/index/index&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
__wxRoute <span class="token operator">=</span> decodePathName<span class="token punctuation">;</span>
__wxRouteBegin <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
__wxAppCurrentFile__ <span class="token operator">=</span> decodePathName <span class="token operator">+</span> <span class="token string">&quot;.js&quot;</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span>decodePathName <span class="token operator">+</span> <span class="token string">&quot;.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> decodePathName <span class="token operator">=</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span><span class="token string">&quot;pages/logs/logs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
__wxRoute <span class="token operator">=</span> decodePathName<span class="token punctuation">;</span>
__wxRouteBegin <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
__wxAppCurrentFile__ <span class="token operator">=</span> decodePathName <span class="token operator">+</span> <span class="token string">&quot;.js&quot;</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span>decodePathName <span class="token operator">+</span> <span class="token string">&quot;.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>下图是框架对于 App 方法调用时的处理流程：</p> <p><img src="/assets/img/App.d864ccc9.jpg" alt></p> <p><code>App()</code> 函数用来注册一个小程序，接收一个 object 对象参数，其指定小程序的生命周期函数等，<code>getApp()</code> 函数可以用来获取到小程序实例。<code>App()</code> 和 <code>getApp()</code> 的函数声明如下：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">declare</span> <span class="token keyword">const</span> App<span class="token operator">:</span> App<span class="token punctuation">.</span>AppConstructor<span class="token punctuation">;</span>
<span class="token keyword">declare</span> <span class="token keyword">const</span> getApp<span class="token operator">:</span> App<span class="token punctuation">.</span>GetApp<span class="token punctuation">;</span>
</code></pre></div><p>完整的参考：<a href="https://github.com/wechat-miniprogram/api-typings/blob/master/types/wx/lib.wx.app.d.ts" target="_blank" rel="noopener noreferrer">lib.wx.app.d.ts<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>微信小程序 <code>App</code> 和 <code>getApp</code> 的源码混淆了，内部实现不方便我们去追踪，这里我们先不深究，后面参考 wepet、hera 等框架我们再看一下微信小程序早期版本实现。</p> <p><strong>第五步：加载自定义组件代码以及注册自定义组件</strong></p> <p>自定义组件在 app.js 之后被加载，小程序会在这个过程中加载完所有的自定义组件，并且是加载完成后自动注册，只有注册完成后才会加载下一个自定义组件的代码。</p> <p>下图是框架对于 Component 方法处理流程：</p> <p><img src="/assets/img/Component.be7e53e6.jpg" alt></p> <p><code>Component()</code> 的函数声明如下：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">declare</span> <span class="token keyword">function</span> <span class="token function">Component</span><span class="token punctuation">(</span>options<span class="token operator">:</span> BaseComponent<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
</code></pre></div><p>完整的参考：<a href="https://github.com/wechat-miniprogram/api-typings/blob/master/types/wx/lib.wx.component.d.ts" target="_blank" rel="noopener noreferrer">lib.wx.component.d.ts<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><strong>第六步：加载页面代码和注册页面</strong></p> <p>加载页面代码的处理流程和加载自定义组件一样，都是加载完成后先注册页面，然后才会加载下一个页面。</p> <p>下图是注册一个页面时框架对于 Page 方法的处理流程：</p> <p><img src="/assets/img/Page.581fef25.png" alt></p> <p><code>Page()</code> 和 <code>getCurrentPages()</code> 的函数声明如下：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">declare</span> <span class="token keyword">const</span> Page<span class="token operator">:</span> Page<span class="token punctuation">.</span>PageConstructor<span class="token punctuation">;</span>
<span class="token keyword">declare</span> <span class="token keyword">const</span> getCurrentPages<span class="token operator">:</span> Page<span class="token punctuation">.</span>GetCurrentPages<span class="token punctuation">;</span>
</code></pre></div><p>完整的参考：<a href="https://github.com/wechat-miniprogram/api-typings/blob/master/types/wx/lib.wx.page.d.ts" target="_blank" rel="noopener noreferrer">lib.wx.page.d.ts<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><strong>第七步：等待页面 Ready 和 Page 实例化</strong></p> <p>严格来讲是等待浏览器 <code>Ready</code>，小程序虽然有部分原生的组件，不过本质上还是一个 web 程序。在小程序中切换页面或打开页面时会触发 <code>onAppRoute</code> 事件，小程序框架通过 <code>wx.onAppRoute</code> 注册页面切换的处理程序，在所有程序就绪后，以 <code>entryPagePath</code> 作为入口使用 <code>appLaunch</code> 的方式进入页面。</p> <h2 id="总结">总结</h2> <p>古人说 “纸上得来终觉浅，绝知此事要躬行”，真正自己看完源码动手写一些例子对这句话理解更深。很多网文分析得也很好很深，但是作者看到的内容和我们自己看到的还是差距很大，另外源码一直在不断演化，有时候会存在过时的情况，正如本文 2019 年初写了一个初版，2020 年再看的时候差距很大，所以加了一些新的认知，记录一下自己在做这块的收获。本文是一个学习过程记录，还是要自己亲自动手实践才能理解更深。</p> <h2 id="参考">参考</h2> <ul><li><a href="https://developers.weixin.qq.com/ebook?action=get_post_info&docid=0008aeea9a8978ab0086a685851c0a" target="_blank" rel="noopener noreferrer">微信小程序开发指南<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://zaiyewujiang.cn/2019/08/23/mp-view/" target="_blank" rel="noopener noreferrer">小程序视图层源码分析<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://zaiyewujiang.cn/2019/08/27/mp-logic/" target="_blank" rel="noopener noreferrer">小程序逻辑层源码分析<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://juejin.im/post/5afaaef4f265da0b8336e6c3" target="_blank" rel="noopener noreferrer">从源码看微信小程序启动过程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://kangzubin.com/wxapp-App-Page-function" target="_blank" rel="noopener noreferrer">浅析微信小程序 App() 和 Page() 函数的内部实现<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.jianshu.com/p/51ac882ea9f4" target="_blank" rel="noopener noreferrer">让别人的小程序运行在自己的 app 中<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.cnblogs.com/wintersun/p/8207083.html" target="_blank" rel="noopener noreferrer">微信小程序性能优化之一<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/wechat-miniprogram/api-typings" target="_blank" rel="noopener noreferrer">微信小程序 API 的 TypeScript 类型定义文件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <blockquote><p>免责声明：本文仅用于交流学习使用, 不得用于商业用途。</p></blockquote> <div data-v-3bd334e8><p class="descript" data-v-3bd334e8>写这些代码也许就一两个小时的事，写一篇大家好接受的文章需要几天的酝酿，如果文章对您有帮助请我喝杯咖啡吧！</p> <img src="/supportme.png" class="pay-code" data-v-3bd334e8> <div data-v-3bd334e8><div id="container"></div></div> <div class="footer" data-v-4f0df4b0 data-v-3bd334e8><p data-v-4f0df4b0>站点总访问量： 站点总访客数：</p> <p data-v-4f0df4b0>博客内容遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" data-v-4f0df4b0>知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></p> <p data-v-4f0df4b0>赵梦欢 © 2015 - 2023</p></div></div></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.f3e141ba.js" defer></script><script src="/assets/js/5.3395f0b5.js" defer></script><script src="/assets/js/18.c373a36e.js" defer></script><script src="/assets/js/34.124c31c0.js" defer></script>
  </body>
</html>
